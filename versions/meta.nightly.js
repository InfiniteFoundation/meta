"use strict";var meta={};meta.engine=null,meta.device=null,meta.element=null,meta.elementId="",meta.canvas=null,meta.ctx=null,meta.width=0,meta.height=0,meta.channels={},meta.shaders=null,meta.view=null,meta.loadingView=null,meta.world=null,meta.camera=null,meta.shader=null,meta.version="1.1.2",meta.enableDefault=!0,meta.enablemeta=!0,meta.enableWebGL=!0,meta.enableAdaptive=!0,meta.tUpdate=1e3/60,meta.unitSize=1,meta.unitRatio=1,meta.maxUnitSize=1,meta.maxUnitRatio=1,meta.utils={},meta.modules={},meta.importUrl="http://infinite-games.com/store/",meta._cache={ismetaAdded:!1,init:null,load:null,ready:null,scripts:null,pendingScripts:null,numScriptsToLoad:0,resolutions:null,currResolution:null},meta.Engine=function(){this.controllers=[],this.controllersToRemove=[],this._timers=[],this._timersToRemove=[],this._numTimers=0,this.unsubscribesetLeft=0,this.unsubscribesetTop=0,this._onResizeCB=null,this._onVisibilityChangeCB=null,this._onFullScreenChangeCB=null,this._onFocusCB=null,this._onBlurCB=null,this._onCtxLostCB=null,this._onCtxRestoredCB=null,this._chnResize=null,this._chnFocus=null,this._chnFullScreen=null,this._chnAdapt=null,this.isCreated=!1,this.isFocus=!1,this.isWebGL=!1,this.isInited=!1,this.isLoaded=!1,this.isLoading=!1,this.isCtrlLoaded=!1,this.isReady=!1,this.pause=!1,this.projection=null,this._updateLoop=null,this._renderLoop=null,this.tUpdate=0,this.tRender=0,this.tFPS=0,this.tNow=0,this.fps=0,this._fpsCounter=0,this.frameID=0,this.updateFrameID=0,this.enablePauseOnBlur=!0},meta.Engine.prototype={create:function(){if(this.isCreated)return console.error("[meta.Engine.create]:","Engine instance is already created."),void 0;console.log("%c META v"+meta.version+" ","background: #000; color: white; font-size: 12px; padding: 2px 0 1px 0;"),console.log("%cBrowser: %c"+meta.device.name+" "+meta.device.version+"	","font-weight: bold; padding: 2px 0 1px 0;","padding: 2px 0 1px 0;"),meta.enablemeta&&this._createmeta(),meta.shaders={},meta.views={},meta.camera=new meta.Camera,this._chnResize=meta.createChannel(meta.Event.RESIZE),this._chnFocus=meta.createChannel(meta.Event.FOCUS),this._chnFullScreen=meta.createChannel(meta.Event.FULLSCREEN),this._chnAdapt=meta.createChannel(meta.Event.ADAPT),meta.View.prototype._chnAddedToView=meta.createChannel(meta.Event.ADDED_TO_VIEW),meta.View.prototype._chnRemovedFromView=meta.createChannel(meta.Event.REMOVED_FROM_VIEW),this._resolveElement(),this._createCanvas(),this.sortAdaptions(),this.onResize(),meta.world=new meta.World(this.width,this.height);var self=this;this._onResizeCB=function(event){self.onResize()},this._onFocusCB=function(event){self.onFocusChange(!0)},this._onBlurCB=function(event){self.onFocusChange(!1)},window.addEventListener("resize",this._onResizeCB,!1),window.addEventListener("orientationchange",this._onResizeCB,!1),meta.device.hidden?(this._onVisibilityChangeCB=function(){self.onVisibilityChange()},document.addEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB)):(window.addEventListener("focus",this._onFocusCB),window.addEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&(this._onFullScreenChangeCB=function(){self.onFullScreenChangeCB()},document.addEventListener(meta.device.fullScreenOnChange,this._onFullScreenChangeCB)),this.tNow=Date.now(),this.start(),this.isCreated=!0},release:function(){return this.isCreated?(this._chnFocus.remove(),this._chnResize.remove(),this._chnFullScreen.remove(),this._chnAdapt.remove(),window.removeEventListener("resize",this._onResizeCB),window.removeEventListener("orientationchange",this._onResizeCB),meta.device.hidden?document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB):(window.removeEventListener("focus",this._onFocusCB),window.removeEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB),this.isWebGL&&(window.removeEventListener("webglcontextlost",this._onCtxLostCB),window.removeEventListener("webglcontextrestored",this._onCtxRestoredCB)),meta.removeAllControllers(),meta.channels=null,meta.shaders=null,meta.views=null,meta.view=null,meta.world=null,meta.shader=null,this.isCreated=!1,void 0):(console.error("[meta.Engine.release]:","Can't release uninitialized engine instance."),void 0)},start:function(){var masterView=new meta.View("master");meta.views.master=masterView,meta.view=masterView;var loadingView=new meta.View("loading");loadingView.z=999999,meta.view.loading=loadingView,meta.loadingView=loadingView,meta._cache.init&&"function"==typeof meta._cache.init&&meta._cache.init(),this._addCorePlugins(),this.isInited=!0,console.log(" "),this._load()},_load:function(){console.log("%c(Loading started)","background: #eee; font-weight: bold;"),this.isLoading=!0,meta._loadAllScripts()||this._continueLoad()},_continueLoad:function(){meta._cache.load&&"function"==typeof meta._cache.load&&meta._cache.load();for(var ctrl,numCtrl=this.controllers.length,i=0;numCtrl>i;i++)ctrl=this.controllers[i],ctrl.load(),ctrl.isLoaded=!0;this.isCtrlLoaded=!0,meta.view.isActive=!0,this.isLoading=!1,0===Resource.ctrl.numToLoad&&this.onResourcesLoaded()},update:function(){this.updateFrameID++,this.tNow=Date.now();var tDelta=this.tNow-this.tUpdate;this.pause&&(tDelta=0),tDelta>250&&(tDelta=250);for(var tDeltaF=tDelta/1e3,numCtrl=this.controllers.length,i=0;numCtrl>i;i++)this.controllers[i].update(tDeltaF);if(this.controllersToRemove.length){for(var ctrlToRemove,numCtrls=this.controllers.length,numCtrlsToRemove=this.controllersToRemove.length,n=0;numCtrlsToRemove>n;n++)for(ctrlToRemove=this.controllersToRemove[n],i=0;numCtrls>i;i++)if(this.controllers[i]===ctrlToRemove){this.controllers[i]=this.controllers[numCtrls-1],this.controllers.pop();break}this.controllersToRemove.length=0}meta.update&&meta.update(tDeltaF),this._updateTimers(tDelta),this.tUpdate=this.tNow;var tSample=Date.now(),tSleep=Math.max(0,meta.tUpdate-(tSample-this.tNow));window.setTimeout(this._updateLoop,tSleep)},_updateTimers:function(tDelta){var timer,i;for(i=0;i<this._numTimers;i++)if(timer=this._timers[i],!timer.isPaused)for(timer.tAccumulator+=tDelta;timer.tAccumulator>=timer.tDelta;)if(timer.tAccumulator-=timer.tDelta,0!==timer.numTimes&&timer.func.call(timer.owner,timer),timer.tStart+=timer.tDelta,-1!==timer.numTimes&&(timer.numTimes--,timer.numTimes<=0)){this._timersToRemove.push(timer);break}if(this._timersToRemove.length){var timerToRemove,numTimersToRemove=this._timersToRemove.length;for(i=0;numTimersToRemove>i;i++){timerToRemove=this._timersToRemove[i];for(var n=0;n<this._numTimers;n++)if(timer=this._timers[n],timer.id===timerToRemove.id){timer.onRemove&&timer.onRemove(),this._timers[n]=this._timers[this._numTimers-1],this._timers.pop(),this._numTimers--;break}}}},render:function(){this.frameID++;var tNow=Date.now(),tDelta=tNow-this.tRender;tDelta>250&&(tDelta=250);var tDeltaF=tDelta/1e3;tNow-this.tFPS>=1e3&&(this.tFPS=tNow,this.fps=this._fpsCounter,this._fpsCounter=0),Entity.ctrl.render(tDeltaF),meta.render&&meta.render(tDeltaF),this._fpsCounter++,this.tRender=tNow,requestAnimationFrame(this._renderLoop)},sortAdaptions:function(){var scope=meta,resolutions=scope._cache.resolutions;if(resolutions){var numResolutions=resolutions.length;if(!(1>=numResolutions)){resolutions.sort(function(a,b){var length_a=scope.math.length2(a.width,a.height),length_b=scope.math.length2(b.width,b.height);return length_a-length_b});for(var lowestResolution=resolutions[0],reso,prevReso,i=1;numResolutions>i;i++)prevReso=resolutions[i-1],reso=resolutions[i],reso.unitSize=reso.height/lowestResolution.height,reso.zoomThreshold=prevReso.unitSize+(reso.unitSize-prevReso.unitSize)/100*33.3;meta.maxUnitSize=resolutions[numResolutions-1].unitSize,meta.maxUnitRatio=1/meta.maxUnitSize,scope.camera.bounds(lowestResolution.width,lowestResolution.height)}}},adapt:function(){var scope=meta,resolutions=scope._cache.resolutions;if(!resolutions)return!1;var numResolutions=resolutions.length;if(1>numResolutions)return!1;for(var resolution,newResolution=resolutions[0],zoom=scope.camera.zoom,i=numResolutions-1;i>=0;i--)if(resolution=resolutions[i],zoom>=resolution.zoomThreshold){newResolution=resolution;break}return newResolution===scope._cache.currResolution?!0:(scope._cache.currResolution=newResolution,scope.unitSize=newResolution.unitSize,scope.unitRatio=1/scope.unitSize,this._chnAdapt.emit(newResolution,meta.Event.ADAPT),!0)},onResourcesLoaded:function(){this.isLoaded=!0,console.log("%c(Loading ended)","background: #eee; font-weight: bold;");for(var numCtrl=this.controllers.length,i=0;numCtrl>i;i++)this.controllers[i].ready();this.isReady=!0,meta._cache.ready&&"function"==typeof meta._cache.ready&&meta._cache.ready(),this._start()},onResize:function(){var scope=meta,width,height;scope.element===document.body?(width=window.innerWidth,height=window.innerHeight):(width=scope.element.clientWidth,height=scope.element.clientHeight);var ratio=window.devicePixelRatio;this.width=width*ratio|0,this.height=height*ratio|0,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=width+"px",this.canvas.style.height=height+"px",scope.width=this.width,scope.height=this.height,this.isWebGL&&(this.projection.ortho(0,this.width,this.height,0,0,100),meta.shader.uniformMatrix("projection",this.projection),this.ctx.viewport(0,0,this.width,this.height)),this._updateOffset(),this._chnResize.emit(this,meta.Event.RESIZE)},onFocusChange:function(value){this.isFocus=value,this.enablePauseOnBlur&&(this.pause=!value),this._chnFocus.emit(value,meta.Event.FOCUS)},onVisibilityChange:function(){this.onFocusChange(document[meta.device.hidden]?!1:!0)},onFullScreenChangeCB:function(){var isFullScreen=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;meta.device.isFullScreen=!!isFullScreen},onCtxLost:function(){console.log("(Context lost)")},onCtxRestored:function(){console.log("(Context restored)")},_resolveElement:function(){meta.elementId?(this.element=document.getElementById(meta.elementId),this.element||(console.warn("[meta.engine.create]:","Could not find element with id - "+meta.elementId),this.element=document.body)):this.element=document.body,this.element.style.cssText+=this.elementStyle,meta.element=this.element},_createmeta:function(){if(!meta._cache.ismetaAdded){var contentType=document.createElement("meta");contentType.setAttribute("http-equiv","Content-Type"),contentType.setAttribute("content","text/html; charset=utf-8"),document.head.appendChild(contentType);var encoding=document.createElement("meta");encoding.setAttribute("http-equiv","encoding"),encoding.setAttribute("content","utf-8"),document.head.appendChild(encoding);var content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height",viewport=document.createElement("meta");viewport.setAttribute("name","viewport"),viewport.setAttribute("content",content),document.head.appendChild(viewport);var appleMobileCapable=document.createElement("meta");appleMobileCapable.setAttribute("name","apple-mobile-web-app-capable"),appleMobileCapable.setAttribute("content","yes"),document.head.appendChild(appleMobileCapable);var appleStatusBar=document.createElement("meta");appleStatusBar.setAttribute("name","apple-mobile-web-app-status-bar-style"),appleStatusBar.setAttribute("content","black-translucent"),document.head.appendChild(appleStatusBar),meta._cache.ismetaAdded=!0}},_createCanvas:function(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","meta-canvas"),this.canvas.style.cssText=this.canvasStyle,this.element.appendChild(this.canvas),meta.canvas=this.canvas;var params={};if(meta.enableWebGL&&meta.device.support.webgl){params.stencil=!0,params.preserveDrawingBuffer=!1,this.ctx=this.canvas.getContext("experimental-webgl",params),meta.ctx=this.ctx,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1;var self=this;this._onCtxLostCB=function(event){self.onCtxLost()},this._onCtxRestoredCB=function(event){self.onCtxRestored()},window.addEventListener("webglcontextlost",this._onCtxLostCB),window.addEventListener("webglcontextrestored",this._onCtxRestoredCB),this._initShaders(),this.isWebGL=!0,console.log("%cRenderer: %cWebGL ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")}else this.ctx=this.canvas.getContext("2d",params),meta.ctx=this.ctx,console.log("%cRenderer: %cCanvas ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")},_initShaders:function(){this.projection=new meta.math.Matrix4;var shader=new meta.Shader;return shader.vertexShader="precision mediump float; attribute vec2 vertexPos; attribute vec2 texCoord; uniform vec2 cameraPos; uniform float zoom; uniform vec2 pos; uniform vec2 center; uniform vec2 scale; uniform vec4 frameCoord; uniform float angle; uniform mat4 projection; varying highp vec2 frameTexCoord; void main(void) { float rotX = sin(-angle);float rotY = cos(-angle);vec2 scaled = floor(vertexPos * scale);vec2 origin = vec2(scaled.x + floor(pos.x) - floor(center.x), scaled.y + floor(pos.y) - floor(center.y));vec2 newPos = vec2(origin.x * rotY + origin.y * rotX, origin.y * rotY - origin.x * rotX) + floor(center) + cameraPos;newPos *= zoom;gl_Position = projection * vec4(newPos, 0.0, 1.0);frameTexCoord = vec2(frameCoord.x + (texCoord.x * frameCoord.z), frameCoord.y + (texCoord.y * frameCoord.w)); }",shader.fragmentShader="precision mediump float; uniform sampler2D sampler; uniform float alpha; varying highp vec2 frameTexCoord; void main(void) { vec4 color = texture2D(sampler, frameTexCoord); color.a *= alpha; gl_FragColor = color; }",meta.shaders.default=shader,shader.compile()?(meta.setShader("default"),shader.bindAttrib("vertexPos"),shader.bindAttrib("texCoord"),void 0):(console.error("[meta.Engine._initShaders]:","Could not compile shaders."),void 0)},_updateOffset:function(){this.unsubscribesetLeft=0,this.unsubscribesetTop=0;var element=meta.element;if(element.unsubscribesetParent)do this.unsubscribesetLeft+=element.unsubscribesetLeft,this.unsubscribesetTop+=element.unsubscribesetTop;while(element=element.unsubscribesetParent);var rect=meta.element.getBoundingClientRect();this.unsubscribesetLeft+=rect.left,this.unsubscribesetTop+=rect.top},_addCorePlugins:function(){meta.register("Resource"),meta.register("UI"),meta.register(this.isWebGL?"Entity.WebGLRenderer":"Entity.CanvasRenderer"),meta.register("Input")},_start:function(){var self=this;this._updateLoop=function(){self.update()},this._renderLoop=function(){self.render()},this.tUpdate=Date.now(),this.tRender=this.tUpdate,this.tFPS=this.tUpdate,setTimeout(this._updateLoop),requestAnimationFrame(this._renderLoop)},fullscreen:function(value){var device=meta.device;if(device.isFulScreen!==value)if(value){if(!device.support.fullScreen)return console.warn("[meta.engine.enterFullScreen]:","Device does not support fullscreen."),void 0;document.documentElement[device.fullScreenRequest](Element.ALLOW_KEYBOARD_INPUT)}else document[meta.device.fullScreenExit]()},toggleFullscreen:function(){this.fullscreen(!meta.device.isFullScreen)},set cursor(value){meta.element.style.cursor=value},get cursor(){return meta.element.style.cursor},elementStyle:"padding:0; margin:0;",canvasStyle:"position:absolute; overflow:hidden; translateZ(0); -webkit-backface-visibility:hidden; -webkit-perspective: 1000; -webkit-touch-callout: none; -webkit-user-select: none;"},meta.__defineSetter__("init",function(func){meta._cache.init=func,meta.engine&&meta.engine.isInited&&func()}),meta.__defineSetter__("load",function(func){meta._cache.load=func,meta.engine&&meta.engine.isLoaded&&func()}),meta.__defineSetter__("ready",function(func){meta._cache.ready=func,meta.engine&&meta.engine.isReady&&func()}),meta.__defineGetter__("init",function(){return meta._cache.init}),meta.__defineGetter__("load",function(){return meta._cache.load}),meta.__defineGetter__("ready",function(){return meta._cache.ready}),meta.render=null,meta.update=null,"use strict",meta.Device=function(){this.name="unknown",this.version="0",this.versionBuffer=null,this.vendors=["","webkit","moz","ms","o"],this.support={},this.audioFormats=[],this.isMobile=!1,this.isPortrait=!1,this.isAudioAPI=!1,this.hidden=null,this.visibilityChange=null,this.fullScreenRequest=null,this.fullScreenExit=null,this.fullScreenOnChange=null,this.isFullScreen=!1},meta.Device.prototype={load:function(){this.checkBrowser(),this.isMobile=this.isMobileAgent(),this.support.onloadedmetadata="object"==typeof window.onloadedmetadata,this.support.onkeyup="object"==typeof window.onkeyup,this.support.onkeydown="object"==typeof window.onkeydown,this.support.canvas=this.isCanvasSupport(),this.support.webgl=this.isWebGLSupport(),this.modernize()},checkBrowser:function(){var regexps={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/OPR\/(\S+)/,/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},userAgent=navigator.userAgent,name,currRegexp,match,numElements=2;for(name in regexps)for(;currRegexp=regexps[name].shift();)if(match=userAgent.match(currRegexp)){this.version=match[1].match(new RegExp("[^.]+(?:.[^.]+){0,"+--numElements+"}"))[0],this.name=name,this.versionBuffer=this.version.split(".");for(var versionBufferLength=this.versionBuffer.length,i=0;versionBufferLength>i;i++)this.versionBuffer[i]=parseInt(this.versionBuffer[i]);break}(null===this.versionBuffer||"unknown"===this.name)&&console.warn("[meta.Device.checkBrowser]:","Could not detect browser.")},modernize:function(){this.supportConsole(),this.supportPageVisibility(),this.supportFullScreen(),this.supportRequestAnimFrame(),this.supportPerformanceNow(),this.supportAudioFormats(),this.supportAudioAPI()},isMobileAgent:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isCanvasSupport:function(){return!!window.CanvasRenderingContext2D},isWebGLSupport:function(){var canvas=document.createElement("canvas"),context=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");return!!context},supportConsole:function(){window.console||(window.console={},window.console.log=meta.emptyFuncParam,window.console.warn=meta.emptyFuncParam,window.console.error=meta.emptyFuncParam)},supportPageVisibility:function(){void 0!==document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):void 0!==document.hidden?(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"):void 0!==document.hidden?(this.hidden="mozhidden",this.visibilityChange="mozvisibilitychange"):void 0!==document.hidden&&(this.hidden="mshidden",this.visibilityChange="msvisibilitychange")},supportFullScreen:function(){this._fullScreenRequest(),this._fullScreenExit(),this._fullScreenOnChange(),this.support.fullScreen=document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled},_fullScreenRequest:function(){var element=document.documentElement;void 0!==element.requestFullscreen?this.fullScreenRequest="requestFullscreen":void 0!==element.webkitRequestFullscreen?this.fullScreenRequest="webkitRequestFullscreen":void 0!==element.mozRequestFullScreen?this.fullScreenRequest="mozRequestFullScreen":void 0!==element.msRequestFullscreen&&(this.fullScreenRequest="msRequestFullscreen")},_fullScreenExit:function(){void 0!==document.exitFullscreen?this.fullScreenExit="exitFullscreen":void 0!==document.webkitExitFullscreen?this.fullScreenExit="webkitExitFullscreen":void 0!==document.mozCancelFullScreen?this.fullScreenExit="mozCancelFullScreen":void 0!==document.msExitFullscreen&&(this.fullScreenExit="msExitFullscreen")},_fullScreenOnChange:function(){void 0!==document.onfullscreenchange?this.fullScreenOnChange="fullscreenchange":void 0!==document.onwebkitfullscreenchange?this.fullScreenOnChange="webkitfullscreenchange":void 0!==document.onmozfullscreenchange?this.fullScreenOnChange="mozfullscreenchange":void 0!==document.onmsfullscreenchange&&(this.fullScreenOnChange="msfullscreenchange")},supportRequestAnimFrame:function(){window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}())},supportPerformanceNow:function(){void 0===window.performance&&(window.performance={}),void 0===window.performance.now&&(window.performance.now=Date.now)},supportAudioFormats:function(){var audio=document.createElement("audio");""!=audio.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/i,"")&&this.audioFormats.push("m4a"),audio.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&this.audioFormats.push("ogg"),audio.canPlayType("audio/mpeg;").replace(/no/,"")&&this.audioFormats.push("mp3"),audio.canPlayType('audio/wav; codecs="1"').replace(/no/,"")&&this.audioFormats.push("wav")},supportAudioAPI:function(){window.AudioContext||(window.AudioContext=window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext)}},function(){meta.device=new meta.Device,meta.device.load()}(),"use strict",meta.device.isMobile&&(window.onerror=function(message,file,lineNumber){alert(file+": "+lineNumber+" "+message)}),"use strict",meta.emptyFunc=function(){},meta.emptyFuncParam=function(param){},meta.loadTexture=function(buffer,folderPath,hd_folderPath){meta._loadResource("Texture",buffer,folderPath,hd_folderPath)||console.warn("[meta.loadTexture]:","Unsupported parameter was passed.")},meta.preloadTexture=function(buffer,folderPath,hd_folderPath){meta._preloadResource("Texture",buffer,folderPath,hd_folderPath)||console.warn("[meta.preloadTexture]:","Unsupported parameter was passed.")},meta.loadSound=function(buffer,folderPath){meta._loadResource("Sound",buffer,folderPath)||console.warn("[meta.loadSound]:","Unsupported parameter was passed.")},meta.preloadSound=function(buffer,folderPath){meta._preloadResource("Sound",buffer,folderPath)||console.warn("[meta.preloadSound]:","Unsupported parameter was passed.")},meta.loadSpriteSheet=function(buffer,folderPath){meta._preloadResource("SpriteSheet",buffer,folderPath)||console.warn("[meta.loadSpriteSheet]:","Unsupported parameter was passed.")},meta.loadFont=function(buffer,folderPath){meta._preloadResource("Font",buffer,folderPath)||console.warn("[meta.loadFont]:","Unsupported parameter was passed.")},meta._loadResource=function(strType,buffer,folderPath){if(folderPath){var slashIndex=folderPath.lastIndexOf("/");0>=slashIndex&&(folderPath+="/")}else folderPath="";if(buffer instanceof Array)for(var numResources=buffer.length,i=0;numResources>i;i++)meta._addResource(strType,buffer[i],folderPath);else{if("object"!=typeof buffer&&"string"!=typeof buffer)return!1;meta._addResource(strType,buffer,folderPath)}return!0},meta._preloadResource=function(strType,buffer,folderPath){if(folderPath){var slashIndex=folderPath.lastIndexOf("/");slashIndex!==folderPath.length-1&&(folderPath+="/")}else folderPath="";if(buffer instanceof Array)for(var numResources=buffer.length,i=0;numResources>i;i++)meta._addResource(strType,buffer[i],folderPath).load();else{if("object"!=typeof buffer&&"string"!=typeof buffer)return!1;meta._addResource(strType,buffer,folderPath).load()}return!0},meta._addResource=function(strType,data,folderPath){var resource;return resource="object"==typeof data?new Resource[strType](data,folderPath+data.path):new Resource[strType](folderPath+data),Resource.ctrl.add(resource),resource},meta.getTexture=function(name){return Resource.ctrl.getTexture(name)},meta.getSound=function(name){return Resource.ctrl.getSound(name)},meta.createCtrl=function(ctrlName,view){if(!ctrlName)return console.error("[meta.createCtrl]:","No controller name is defined."),null;var parts=ctrlName.split(".");if(parts.length>2)return console.error("[meta.createCtrl]:",'Name should be in format "MyScope.Controller".'),null;var name=parts[0],ctrlScope=window[name];if(!ctrlScope)return console.error("[meta.createCtrl]:","No such scope defined: "+name),null;var objName;if(objName=1===parts.length?"Controller":parts[1],!ctrlScope[objName])return console.error("[meta.createCtrl]:","No Controller ("+objName+") found in scope: "+name),null;view=view||meta.view;var ctrl=new ctrlScope[objName](view);return ctrl.name=name,ctrl.view=view,ctrl},meta.addCtrl=function(ctrl){if(!ctrl)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var ctrlScope=window[ctrl.name];return ctrlScope.ctrl?(console.error("[meta.addCtrl]:","Controller ("+ctrl.name+") is already added in scope."),void 0):(ctrlScope.ctrl=ctrl,meta.engine.controllers.push(ctrl),meta.engine.isCtrlLoaded&&ctrl.load(),meta.engine.isReady&&ctrl.ready(),void 0)},meta.removeCtrl=function(ctrl){if(!ctrl)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var ctrlScope=window[ctrl.name];return ctrlScope.ctrl?ctrlScope.ctrl!==ctrl?(console.error("[meta.removeCtrl]:","Controller ("+ctrl.name+") is not the same what is already added to the scope."),void 0):(ctrl.unload(),ctrl.release(),meta.engine.controllersToRemove.push(ctrl),void 0):(console.error("[meta.removeCtrl]:","No controller added to the scope."),void 0)},meta.register=function(ctrlName,view){var ctrl=meta.createCtrl(ctrlName,view);if(ctrl){var ctrlScope=window[ctrl.name];if(ctrlScope.ctrl)return console.error("[meta.register]:","Controller ("+ctrl.name+") is already added in scope."),null;ctrlScope.ctrl=ctrl,meta.engine.controllers.push(ctrl),meta.engine.isCtrlLoaded&&ctrl.load(),meta.engine.isReady&&ctrl.ready()}},meta.unregister=function(ctrlName){if(!ctrlName)return console.error("[meta.unregister]:","No controller name is defined."),void 0;var parts=ctrlName.split(".");if(parts.length>2)return console.error("[meta.unregister]:",'Name should be in format "MyScope.Controller".'),void 0;var name=parts[0],ctrlScope=window[name];if(!ctrlScope)return console.error("[meta.unregister]:","No such scope defined: "+name),void 0;if(ctrlScope[name])return console.error("[meta.unregister]:","Controller ("+name+") is already added in scope."),void 0;var objName;if(objName=1===parts.length?"Controller":parts[1],!ctrlScope[objName])return console.error("[meta.unregister]:","No Controller ("+objName+") found in scope: "+name),void 0;var controller=ctrlScope.ctrl;return controller?(controller.unload(),controller.release(),meta.engine.controllersToRemove.push(controller),void 0):(console.error("[meta.unregister]:","No Controller ("+objName+") found in scope: "+name),void 0)},meta.unregisterAll=function(){for(var ctrl,ctrls=meta.engine.controllers,numCtrls=ctrls.length,i=0;numCtrls>i;i++)ctrl=window[ctrls[i].name].ctrl,ctrl.unload(),ctrl.release(),window[ctrls[i].name].ctrl=null;ctrls.length=0},meta.onDomLoad=function(func){if(("interactive"===document.readyState||"complete"===document.readyState)&&!meta.debug)return func(),void 0;var cbFunc=function(event){func(),window.removeEventListener("DOMContentLoaded",cbFunc)};window.addEventListener("DOMContentLoaded",cbFunc)},meta.createEngine=function(){meta.onDomLoad(function(){return meta.engine?(meta.engine.release(),void 0):(meta.engine=new meta.Engine,meta.engine.create(),void 0)})},meta.enumToString=function(buffer,value){if(void 0===buffer)return"unknown";for(var enumKey in buffer)if(buffer[enumKey]===value)return enumKey;return"unknown"},meta.hexToRgb=function(hex){hex.length<6&&(hex+=hex.substr(1,4));var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}},meta.isUrl=function(str){return-1!==str.indexOf("http://")||-1!==str.indexOf("https://")?!0:!1},meta.toUpperFirstChar=function(str){return str.charAt(0).toUpperCase()+str.slice(1)},meta.loadScript=function(src,onLoad){meta.engine&&meta.engine.isLoaded?meta._loadScript({s:src,c:callback}):(meta._cache.scripts||(meta._cache.scripts=[]),meta._cache.scripts.push({s:src,c:onLoad}))},meta._loadScript=function(obj){var script=document.createElement("script"),firstScript=document.scripts[0];"async"in firstScript?(script.async=!1,script.onload=obj.c,script.src=obj.s,document.head.appendChild(script)):firstScript.readyState?(meta._cache.pendingScripts||(meta._cache.pendingScripts=[]),meta._cache.pendingScripts.push(script),script.onreadystatechange=meta._onReadyStateChange,script.src=obj.s):document.write("<script src='"+src+" defer></script>")},meta._onReadyStateChange=function(){for(var pendingScript,pendingScripts=meta._cache.pendingScripts;pendingScripts[0]&&"loaded"===pendingScripts[0].s.readyState;)pendingScript=pendingScripts.shift(),pendingScript.s.onreadystatechange=null,document.scripts[0].parentNode.insertBefore(pendingScript.s,firstScript),pendingScript.c&&pendingScript.c()},meta._loadAllScripts=function(){var scripts=meta._cache.scripts;if(!scripts)return!1;var numScripts=scripts.length;if(0===numScripts)return!1;var callback=function(){var cache=meta._cache;cache.numScriptsToLoad--;var scripts=meta._cache.scripts,numScripts=scripts.length;if(numScripts>0){cache.numScriptsToLoad+=numScripts,cache.scripts=[];for(var script,n=0;numScripts>n;n++)script=scripts[n],script.c=callback,meta._loadScript(script)}0===cache.numScriptsToLoad&&(cache.scripts=null,meta.engine._continueLoad())},script,cache=meta._cache;cache.numScriptsToLoad+=scripts.length,cache.scripts=[];for(var i=0;numScripts>i;i++)script=scripts[i],script.c=callback,meta._loadScript(script);return!0},meta.import=function(path){if(path){var buffer=path.split("/"),name=buffer[0],version;1===buffer.length?(version="latest",path+="/latest"):version=buffer[buffer.length-1];var module=meta.modules[name];if(module)return module.version!==version&&console.error("[meta.loadPackage]:","There is already added module ["+module.name+"] but with different version: "+module.version),void 0;module={name:name,version:version},meta.modules[name]=module,meta.isUrl(path)||(path=meta.importUrl+path+"/module.js"),meta.loadScript(path,null)}},meta.serialize=function(obj){var str=[];for(var key in obj)str.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]));return str.join("&")},meta.addDescription=function(text){var msg=new Entity.Text(text);msg.color="#ffffff",msg.anchor(.5);var texture=new Resource.Texture;texture.fillRect({width:msg.width+10,height:msg.height+10,color:"#000000"});var bg=new Entity.Geometry(texture);bg.z=9999,bg.anchor(.5,0),bg.positionTop(0,10),bg.isPickable=!1,bg.ignoreZoom=!0,bg.disableDebug=!0,meta.view.add(bg),bg.attach(msg)},meta.adaptTo=function(width,height,path){if(meta.engine&&meta.engine.isInited)return console.warn("[meta.adaptTo]:","Only usable before engine is initialized."),void 0;var resolutions=meta._cache.resolutions;resolutions||(resolutions=[],meta._cache.resolutions=resolutions);var lastChar=path.charAt(path.length-1);"/"!==lastChar&&(path+="/");var newRes={width:width,height:height,path:path,unitSize:1,zoomThreshold:1};resolutions.push(newRes)},"use strict",meta.Channel=function(name){this.name=name,this.subs=[],this.numSubs=0,this._isEmiting=!1,this._subsToRemove=null},meta.Channel.prototype={remove:function(){meta.channels[this.name]=null},emit:function(data,event){this._isEmiting=!0;for(var sub,i=0;i<this.numSubs;i++)sub=this.subs[i],sub.func.call(sub.owner,data,event);if(this._isEmiting=!1,this._subsToRemove){for(var numToRemove=this._subsToRemove.length,n=0;numToRemove>n;n++)this.unsubscribe(this._subsToRemove[n]);this._subsToRemove=null}},subscribe:function(owner,func,priority){if(priority=priority||0,!func)return console.warn("[meta.Channel.subscribe]:","No callback function passed."),void 0;for(var i=0;i<this.numSubs;i++)if(this.subs[i].owner===owner)return console.warn("[meta.Channel.subscribe]:","Already subscribed to channel: "+this.name),void 0;
var newSub=new meta.Subscriber(owner,func,priority);this.subs.push(newSub),this.numSubs++,priority?(this._havePriority=!0,this.subs.sort(this._sortFunc)):this._havePriority&&this.subs.sort(this._sortFunc)},unsubscribe:function(owner){if(this._isEmiting)return this._subsToRemove||(this._subsToRemove=[]),this._subsToRemove.push(owner),void 0;for(var sub,i=0;i<this.numSubs;i++)if(sub=this.subs[i],sub.owner===owner){this.subs[i]=this.subs[this.numSubs-1],this.subs.pop(),this.numSubs--;break}this._havePriority&&this.subs.sort(this._sortFunc)},_sortFunc:function(a,b){return a.priority>b.priority?-1:1},_havePriority:!1},meta.Subscriber=function(owner,func,priority){this.owner=owner,this.func=func,this.priority=priority},meta.createChannel=function(name){if(!name)return console.warn("[meta.createChannel]:","No name was specified!"),null;var channel=meta.channels[name];return channel||(channel=new meta.Channel(name),meta.channels[name]=channel),channel},meta.releaseChannel=function(name){return name?(meta.channels[name]&&(meta.channels[name]=null),void 0):(console.warn("[meta.releaseChannel]:","No name was specified!"),void 0)},meta.subscribe=function(owner,channel,func,priority){if("object"!=typeof owner)return console.warn("[meta.subscribe]:","No owner passed."),void 0;if(!func)return console.warn("[meta.subscribe]:","No callback function passed."),void 0;if("string"!=typeof channel){if("[object Array]"===Object.prototype.toString.call(channel)){for(var numChannels=channel.length,i=0;numChannels>i;i++)meta.subscribe(owner,channel[i],func,priority);return}return console.warn("[meta.subscribe]:","Wrong type for channel object: "+typeof channel),void 0}var srcChannel=meta.channels[channel];if(srcChannel)channel=srcChannel;else if(channel=meta.createChannel(channel),!channel)return;channel.subscribe(owner,func,priority)},meta.unsubscribe=function(owner,channel){if("string"!=typeof channel){if("[object Array]"===Object.prototype.toString.call(channel)){for(var numChannels=channel.length,i=0;numChannels>i;i++)meta.unsubscribe(owner,channel[i]);return}return console.warn("[meta.unsubscribe]:","Wrong type for channel object."),void 0}return channel=meta.channels[channel],channel?(channel.unsubscribe(owner),void 0):(console.warn("[meta.unsubscribe]:","No name was specified!"),void 0)},meta.emit=function(channel,data,event){return"string"!=typeof channel||(channel=meta.channels[channel],channel)?(channel.emit(data,event),void 0):(console.warn("[meta.emit]:","No name was specified!"),void 0)},"use strict",meta.View=function(name){this.name=name,this.entities=[],this.views=null,this.parentView=null,this.numEntities=0,this._x=0,this._y=0,this._z=0,this._tween=null,this.bgColor=this._bgColor,this._isActive=!1},meta.View.prototype={release:function(){if(this.parentView&&this.parentView.detach(this),this.views)for(var numViews=this.views.length,i=0;numViews>i;i++)this.views[i].release();this.isActive=!1,this._unregisterFromEngine();for(var entity,numEntities=this.entities.length,n=0;numEntities>n;n++)entity=this.entities[n],entity._view=null,entity.remove();this.entities.length=0,this.numEntities=0},add:function(entity){return entity instanceof Entity.Geometry?entity.isRemoved?(console.warn("[meta.View.add]:","Removed entity can not be added to the view."),void 0):entity._view?(entity._view===this?console.warn("[meta.View.add]:","Entity is already added to this view."):console.warn("[meta.View.add]:","Entity is already added to some other view."),void 0):((0!==this._x||0!==this._y)&&entity.updatePos(),this.entities.push(entity),this.numEntities++,this._attachChildren(entity.children),entity._view=this,entity._viewNodeID=this.numEntities,this._z&&(entity.z=entity._z),entity.texture||(entity.isLoaded=!0),entity._onResize&&entity._onResize(meta.engine,null),this._isActive&&!entity._depthNode.entity&&Entity.ctrl.isLoaded&&this._chnAddedToView.emit(entity,meta.Event.ADDED_TO_VIEW),void 0):(console.warn("[meta.View.add]:","Object should have inherited Entity.Geometry class."),void 0)},_attachChildren:function(children){if(children)for(var child,numChildren=children.length,i=0;numChildren>i;i++)child=children[i],child.isRemoved||(this._attachChildren(child.children),child._view=this)},remove:function(entity){return entity._view?entity._view!==this?(console.warn("[meta.View.remove]:","Entity is part of other view: "+entity.view.name),void 0):entity._parent!==entity._entityCtrl?(console.warn("[meta.View.remove]:","Entity children are not part of view."),void 0):(this._removeFromBuffer(entity),this._isActive?this._chnRemovedFromView.emit(entity,meta.Event.REMOVED_FROM_VIEW):entity.removeFully(),void 0):(console.warn("[meta.View.remove]:","Entity does not have view."),void 0)},_removeFromBuffer:function(entity){var replaceEntity=this.entities[this.numEntities-1];replaceEntity._viewNodeID=entity._viewNodeID,this.entities[entity._viewNodeID]=replaceEntity,this.entities.pop(),this.numEntities--,entity._view=null,this._removeChildren(entity.children)},_removeChildren:function(children){if(children)for(var child,numChildren=children.length,i=0;numChildren>i;i++)child=children[i],this._removeChildren(child),child._view=null},attach:function(view){if(!view)return this.parentView?(console.warn("[meta.View.attach]:","No view was passed."),void 0):(meta.view.attach(this),void 0);if("string"==typeof view){var srcView=meta.views[view];if(!srcView)return console.warn("[meta.View.attach]:","No such view found: "+view),void 0;view=srcView}else if(!(view instanceof meta.View))return console.warn("[meta.View.attach]:","Trying to attach invalid view object."),void 0;return view._isActive?(console.warn("[meta.View.attach]:","Can't attach an active view."),void 0):view.parentView?(console.warn("[meta.View.attach]:","View is already part of other view."),void 0):(this.views||(this.views=[]),this.views.push(view),view.parentView=this,this._isActive&&(view.isActive=!0),void 0)},detach:function(view){if(!view)return this.parentView?(this.parentView.detach(this),void 0):(console.warn("[meta.view.detach]:","No view was passed."),void 0);if("string"==typeof view){var srcView=meta.views[view];if(!srcView)return console.warn("[meta.View.detach]:",'No such view found: "'+view+'"'),void 0;view=srcView}if(!view.parentView)return console.warn("[meta.View.detach]:","View has not parents to detach from."),void 0;if(view.parentView!==this)return console.warn("[meta.View.detach]:","Detaching from wrong parent."),void 0;for(var numViews=this.views.length,i=0;numViews>i;i++)if(this.views[i]===view){this.views[i]=this.views[numViews-1],this.views.pop();break}view.isActive=!1,view.parentView=null},detachAll:function(){if(this.views){for(var view,numChildren=this.views.length,numViews=this.views.length,i=0;numViews>i;i++)view=this.views[i],view.isActive=!1,view.parentView=null;this.views.length=0}},register:function(ctrlName){var ctrl=meta.createCtrl(ctrlName,this);this.controllers?this.controllers.push(ctrl):this.controllers=[ctrl],this._isActive&&(!this.parentView||this.parentView._isActive)&&meta.addCtrl(ctrl)},unregister:function(ctrlName){for(var numControllers=this.controllers.length,i=0;numControllers>i;i++)this.controllers[i].name===ctrlName&&(this._isActive&&meta.unregister(ctrlName),this.controllers[i]=this.controllers[numControllers-1],this.controllers.pop())},_unregisterFromEngine:function(){if(this.controllers)for(var numControllers=this.controllers.length,n=0;numControllers>n;n++)meta.unregister(this.controllers[n])},_addEntities:function(){this.numEntities>0&&this._chnAddedToView.emit(this.entities,meta.Event.ADDED_TO_VIEW)},_removeEntities:function(){this.numEntities>0&&this._chnRemovedFromView.emit(this.entities,meta.Event.REMOVED_FROM_VIEW)},_makeActive:function(){var n;if(this.controllers){var numControllers=this.controllers.length;for(n=0;numControllers>n;n++)meta.addCtrl(this.controllers[n])}if(this._addEntities(),this.views){var numViews=this.views.length;for(n=0;numViews>n;n++)this.views[n].isActive=!0}},_makeInactive:function(){var n;if(this.controllers){var numControllers=this.controllers.length;for(n=0;numControllers>n;n++)meta.removeCtrl(this.controllers[n])}if(this._removeEntities(),this.views){var numViews=this.views.length;for(n=0;numViews>n;n++)this.views[n].isActive=!1}},onResize:function(data,event){for(var i=0;i<this.numEntities;i++)this.entities[i]._onResize(data)},set bgColor(hex){if(meta.engine.isWebGL){3===hex.length&&(hex+=hex.substr(1,3));var color=meta.hexToRgb(hex);color.r>0&&(color.r=color.r/255),color.g>0&&(color.g=color.g/255),color.b>0&&(color.b=color.b/255),meta.ctx.clearColor(color.r,color.g,color.b,1)}else this._bgColor=hex},get bgColor(){return this._bgColor},set isActive(value){if(this._isActive!==value)if(value){if(this.parentView&&!this.parentView._isActive)return;this._isActive=value,meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onResize),this._makeActive()}else this._isActive=value,meta.unsubscribe(this,meta.Event.CAMERA_RESIZE,this.onResize),this._makeInactive()},get isActive(){return this._isActive},set x(value){if(this._x!==value){this._x=value;for(var entity,numEntities=this.entities.length,i=0;numEntities>i;i++)entity=this.entities[i],entity.forcePosition(entity._x,entity._y)}},set y(value){if(this._y!==value){this._y=value;for(var entity,numEntities=this.entities.length,i=0;numEntities>i;i++)entity=this.entities[i],entity.forcePosition(entity._x,entity._y)}},set z(value){this._z=value;for(var numEntities=this.entities.length,i=0;numEntities>i;i++)this.entities[i].z=this.entities[i]._z},get x(){return this._x},get y(){return this._y},get z(){return this._z},get tween(){return this._tween||(this._tween=new meta.Tween(this)),this._tween},controllers:null,_bgColor:"#888888",bgTransparent:!1},meta.createView=function(name,ctrls){if(!name||"string"!=typeof name)return console.error("[meta.createView]:","Invalid name of the view."),void 0;var view=meta.views[name];if(view)return console.error("[meta.createView]:","View with a name - "+name+", already exist!"),void 0;if(view=new meta.View(name),meta.views[name]=view,ctrls)if(ctrls instanceof Array)for(var numCtrls=ctrls.length,i=0;numCtrls>i;i++)view.register(ctrls[i]);else view.register(ctrls)},meta.setView=function(view){return view?("string"==typeof view&&(view=meta.views[view],view||(view=new meta.View(name),meta.views[name]=view)),meta.view.detachAll(),meta.view.attach(view),void 0):(console.error("[meta.setView]:","No view passed."),void 0)},meta.getView=function(name){if(!name)return console.error("[meta.getView]:","No name specified!"),null;var view=meta.views[name];return view||(view=new meta.View(name),meta.views[name]=view),view},meta.attachView=function(view){if(!meta.view)return console.warn("[meta.attachView]:","No current active view."),void 0;if("string"==typeof view){var srcView=meta.views[view];if(!srcView)return console.warn("[meta.attachView]:","No such view found: "+view),void 0;view=srcView}meta.view.attach(view)},meta.detachView=function(view){if(!meta.view)return console.warn("[meta.detachView]:","No current active view."),void 0;if("string"==typeof view){var srcView=meta.views[view];if(!view)return console.warn("[meta.detachView]:","No such view found: "+view),void 0;view=srcView}meta.view.detach(view)},"use strict",meta.Camera=function(){this._x=0,this._y=0,this.volume=new meta.math.AdvAABB(0,0,0,0),this.zoomBounds=null,this._zoom=1,this.prevZoom=1,this.zoomRatio=1,this._draggable=!1,this._isDraggable=!1,this._isAutoZoom=!1,this._enableBorderIgnore=!0,this._enableCentering=!1,this._enableCenteringX=!0,this._enableCenteringY=!0,this._chnMove=null,this._chnResize=null,this._wasMoved=!1,this.init()},meta.Camera.prototype={init:function(){this._chnMove=meta.createChannel(meta.Event.CAMERA_MOVE),this._chnResize=meta.createChannel(meta.Event.CAMERA_RESIZE),meta.subscribe(this,meta.Event.RESIZE,this._onResize),meta.subscribe(this,meta.Event.WORLD_RESIZE,this._onWorldResize),this.zoomBounds={width:-1,height:-1,minWidth:-1,minHeight:-1,maxWidth:-1,maxHeight:-1}},release:function(){this._chnMove.release(),meta.unsubscribe(this,meta.Event.RESIZE),meta.unsubscribe(this,meta.Event.WORLD_RESIZE)},updateView:function(){if(this._isAutoZoom?this.updateAutoZoom():this.updateZoom(),!this._wasMoved){if(this._enableCentering){var world=meta.world;this._x=this._enableCenteringX?Math.floor((this.volume.width-world.width)/2):0,this._y=this._enableCenteringY?Math.floor((this.volume.height-world.height)/2):0}else this._x=0,this._y=0;this.volume.move(this._x,this._y)}this._chnMove.emit(this,meta.Event.CAMERA_MOVE)},updateZoom:function(){this.prevZoom!==this._zoom&&(this.zoomRatio=1/this._zoom,this.volume.scale(this.zoomRatio,this.zoomRatio),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE))},updateAutoZoom:function(){var scope=meta,width=this.zoomBounds.width,height=this.zoomBounds.height,diffX=scope.width/width,diffY=scope.height/height;this.prevZoom=this._zoom,this._zoom=diffX,diffX>diffY&&(this._zoom=diffY),scope.engine.adapt()&&(width=this.zoomBounds.width,height=this.zoomBounds.height,diffX=scope.width/width,diffY=scope.height/height,this._zoom=diffX,diffX>diffY&&(this._zoom=diffY),this.volume.resize(scope.width,scope.height)),this.updateZoom()},bounds:function(width,height){this._isAutoZoom=!0,this.zoomBounds.width=width,this.zoomBounds.height=height,(0!==this.width||0!==this.height)&&this.updateView()},minBounds:function(width,height){this._isAutoZoom=!0,this.zoomBounds.minWidth=width,this.zoomBounds.minHeight=height,this.updateView()},maxBounds:function(width,height){this._isAutoZoom=!0,this.zoomBounds.maxWidth=width,this.zoomBounds.maxHeight=height,this.updateView()},_onInput:function(data,event){var inputEvent=Input.Event;if(event===inputEvent.INPUT_MOVE)this._drag(data);else if(event===inputEvent.INPUT_DOWN){if(0!==data.keyCode)return;this._startDrag(data)}else if(event===inputEvent.INPUT_UP){if(0!==data.keyCode)return;this._endDrag(data)}},_onResize:function(data,event){this.volume.resize(data.width,data.height),this.updateView(),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE)},_onWorldResize:function(data,event){},_startDrag:function(data){this._draggable&&(this._isDraggable=!0)},_endDrag:function(data){this._isDraggable=!1},_drag:function(data){if(this._isDraggable){var scope=meta,diffX=(data.screenX-data.prevScreenX)*this.zoomRatio,diffY=(data.screenY-data.prevScreenY)*this.zoomRatio;this._x+=diffX,this._y+=diffY,this.volume.move(-diffX,-diffY),this._wasMoved=!0,this.enableBorderIgnore||(-this._x<0&&(this._x=0),-this._y<0&&(this._y=0)),this._chnMove.emit(this,scope.Event.CAMERA_MOVE)}},set x(value){this._x!==value&&(this._x=value,this._wasMoved=!0,this.updateView())},set y(value){this._y!==value&&(this._y=value,this._wasMoved=!0,this.updateView())},get x(){return this._x},get y(){return this._y},get width(){return this.volume.width},get height(){return this.volume.height},set zoom(value){this._zoom!==value&&(this.prevZoom=this._zoom,this._zoom=value,this.updateView())},get zoom(){return this._zoom},set enableBorderIgnore(value){this._enableBorderIgnore=value,this.updateView()},get enableBorderIgnore(){return this._enableBorderIgnore},set draggable(value){this._draggable!==value&&(this._draggable=value,value?meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE],this._onInput):(meta.unsubscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE]),this._isDraggable=!1))},get draggable(){return this._draggable},set isAutoZoom(value){this._isAutoZoom!==value&&(this._isAutoZoom=value,this.updateView())},get isAutoZoom(){return this._isAutoZoom},set enableCentering(value){this._enableCentering=value,this.updateView()},set enableCenteringX(value){this._enableCenteringX=value,this.updateView()},set enableCenteringY(value){this._enableCenteringY=value,this.updateView()},get enableCentering(){return this._enableCentering},get enableCenteringX(){return this._enableCenteringX},get enableCenteringY(){return this._enableCenteringY}},"use strict",meta.World=function(width,height){this.chn=null,this.volume=new meta.math.AdvAABB(0,0,0,0),this.minWidth=-1,this.minHeight=-1,this.maxHeight=-1,this.maxHeight=-1,this.centerX=0,this.centerY=0,this.gridX=0,this.gridY=0,this.gridWidth=0,this.gridHeight=0,this.numGridX=0,this.numGridY=0,this.haveGrid=!1,this._discardUnusedSpace=!1,this.lockGrid=!1,this.showBounds=!1,this.init(width,height)},meta.World.prototype={init:function(width,height){this.bounds(width,height),this.chn=meta.createChannel(meta.Event.WORLD_RESIZE),meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onCameraResize)},updateVolume:function(){var scope=meta,width=scope.camera.width+.5|0,height=scope.camera.height+.5|0;this.centerX=width/2,this.centerY=height/2,this.volume.resize(width,height),this.chn&&this.chn.emit(scope.Event.WORLD_RESIZE,this)},bounds:function(width,height){this.volume.resize(width,height),this.updateVolume()},minBounds:function(width,height){this.minWidth=width,this.minHeight=height,this.updateVolume()},maxBounds:function(width,height){this.maxWidth=width,this.maxHeight=height,this.updateVolume()},setGrid:function(obj){obj.x=obj.x||0,obj.y=obj.y||0,obj.width=obj.width||16,obj.height=obj.height||16,obj.sizeX=obj.sizeX||1,obj.sizeY=obj.sizeY||1,this.setGridPosition(obj.x,obj.y),this.setGridResolution(obj.width,obj.height),this.setGridSize(obj.sizeX,obj.sizeY)},setGridResolution:function(width,height){this.gridWidth=width,this.gridHeight=height,this.haveGrid=width||height,this.lockGrid||(this.numGridX=Math.floor(this.width/width),this.numGridY=Math.floor(this.height/height)),this.haveGrid&&this._discardUnusedSpace&&this.setBounds(this.numGridX*this.gridWidth,this.numGridY*this.gridHeight)},setGridSize:function(numGridX,numGridY){if(this.numGridX=numGridX,this.numGridY=numGridY,this.lockGrid=numGridX||numGridY,this.haveGrid){var width=this.numGridX*this.gridWidth,height=this.numGridY*this.gridHeight;this.width>width&&(width=this.width),this.height>height&&(height=this.height),this.setBounds(width,height),this.lockGrid||(this.numGridX=Math.floor(this.width/this.gridWidth),this.numGridY=Math.floor(this.height/this.gridHeight))}},setGridPosition:function(x,y){this.gridX=x,this.gridY=y},getGridPosX:function(x){return this.gridX+this.gridWidth*x},getGridPosY:function(y){return this.gridY+this.gridHeight*y},getGridFromWorldX:function(x){var gridX=Math.floor((x-this.gridX)/this.gridWidth);return-1>gridX?gridX=-1:gridX>=this.numGridX&&(gridX=-1),gridX},getGridFromWorldY:function(y){var gridY=Math.floor((y-this.gridY)/this.gridHeight);return-1>gridY?gridY=-1:gridY>=this.numGridY&&(gridY=-1),gridY},get randX(){return meta.random.number(0,this.volume.width)},get randY(){return meta.random.number(0,this.volume.height)},onCameraResize:function(data,event){this.updateVolume()},set discardUnusedSpace(value){this._discardUnusedSpace=value,value&&this.haveGrid&&this.setBounds(this.gridX+this.numGridX*this.gridWidth,this.gridY+this.numGridY*this.gridHeight)},get discardUnusedSpace(){return this._discardUnusedSpace},get left(){return this.volume.minX},get right(){return this.volume.maxX},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},get width(){return this.volume.width},get height(){return this.volume.height}},"use strict",function(scope){var initializing=!1,fnTest=/\b_super\b/;scope.meta.Class=function(){},scope.meta.Class.extend=function(prop){function Class(a,b,c,d,e,f){initializing||(this._init&&this._init(a,b,c,d,e,f),this.init&&this.init(a,b,c,d,e,f))}var _super=this.prototype;initializing=!0;var proto=new this;initializing=!1;for(var name in prop){var p=Object.getOwnPropertyDescriptor(prop,name);p.get||p.set?Object.defineProperty(proto,name,p):proto[name]="function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])?function(name,fn){return function(a,b,c,d,e,f){var tmp=this._super;this._super=_super[name],this._fn=fn;var ret=this._fn(a,b,c,d,e,f);return this._super=tmp,ret}}(name,prop[name]):prop[name]}return Class.prototype=proto,Class.prototype.constructor=proto.init,Class.extend=this.extend,Class},scope.meta.Class=scope.meta.Class}(void 0!==typeof window?window:global),"use strict",meta.Controller=meta.Class.extend({init:meta.emptyFunc,_init:function(view){this.view=view},release:meta.emptyFunc,load:meta.emptyFunc,unload:meta.emptyFunc,ready:meta.emptyFunc,update:meta.emptyFuncParam,view:null,name:"unknown",isLoaded:!1}),"use strict",meta._cache.timerIndex=0,meta.Timer=function(owner,func,tDelta,numTimes){this.owner=owner,this.id=meta._cache.timerIndex++,this.func=func,this.onRemove=null,this.tDelta=tDelta,this.numTimes=numTimes,void 0===this.numTimes&&(this.numTimes=-1),this.tAccumulator=0,this.tStart=Date.now()},meta.Timer.prototype={remove:function(){this.numTimes=0},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1,this.tStart=Date.now()},onRemove:null,isPaused:!1},meta.addTimer=function(owner,func,tDelta,numTimes){"function"==typeof owner&&(numTimes=tDelta,tDelta=func,func=owner,owner=window);var newTimer=new meta.Timer(owner,func,tDelta,numTimes);return meta.engine._timers.push(newTimer),meta.engine._numTimers++,newTimer},"use strict",meta.shaders={},meta.Shader=function(){this.program=null,this.attrib={},this.uniform={},this._vertexShader=null,this._fragmentShader=null},meta.Shader.prototype={compile:function(){var gl=meta.ctx;return this.program=gl.createProgram(),gl.attachShader(this.program,this._vertexShader),gl.attachShader(this.program,this._fragmentShader),gl.linkProgram(this.program),gl.getProgramParameter(this.program,gl.LINK_STATUS)?!0:(console.error("[meta.Shader.compile]:","Unable to initialize the shader program."),!1)},use:function(){meta.ctx.useProgram(this.program)},bindAttrib:function(name){if(!name)return console.error("[meta.Shader.bindAttrib]:","No name specified!"),void 0;var gl=meta.ctx;this.attrib[name]=gl.getAttribLocation(this.program,name),gl.enableVertexAttribArray(this.attrib[name])},bindBuffer2f:function(name,buffer){var gl=meta.ctx;gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(this.attrib[name],2,gl.FLOAT,!1,0,0)},bindBuffer3f:function(name,buffer){var gl=meta.ctx;gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.vertexAttribPointer(this.attrib[name],3,gl.FLOAT,!1,0,0)},uniformMatrix:function(name,matrix){var gl=meta.ctx,uniform=this.uniform[name];uniform||(uniform=gl.getUniformLocation(this.program,name),this.uniform[name]=uniform),gl.uniformMatrix4fv(uniform,!1,matrix.m)},set vertexShader(value){var gl=meta.ctx;this._vertexShader=gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(this._vertexShader,value),gl.compileShader(this._vertexShader),gl.getShaderParameter(this._vertexShader,gl.COMPILE_STATUS)||console.error("[meta.Shader.vetexShader]:",gl.getShaderInfoLog(this._vertexShader))},get vertexShader(){return this._vertexShader},set fragmentShader(value){var gl=meta.ctx;this._fragmentShader=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(this._fragmentShader,value),gl.compileShader(this._fragmentShader),gl.getShaderParameter(this._fragmentShader,gl.COMPILE_STATUS)||console.error("[meta.Shader.fragmentShader]:","An error occurred compiling the shaders: "+gl.getShaderInfoLog(this._fragmentShader))},get fragmentShader(){return this._fragmentShader}},meta.setShader=function(name){if(!name)return console.error("[meta.setShader]:","No name specified."),null;var shader=meta.shaders[name];return shader?(meta.shader=shader,shader.use(),shader):(console.error("[meta.setShader]:","No shader found with a name: "+name),null)},meta.getShader=function(name){if(!name)return console.error("[meta.getShader]:","No name specified."),null;var shader=meta.shaders[name];return shader?shader:(console.error("[meta.getShader]:","No shader found with a name: "+name),null)},"use strict",meta.Style=function(params){this.states={},this.setStates(params),this.defaultState||this.setState("*",null)},meta.Style.prototype={setState:function(name,params){if(-1!==name.indexOf(","))for(var items=name.split(/[ ,]+/),numItems=items.length,i=0;numItems>i;i++)this.defineState(items[i],params);else this.defineState(name,params)},defineState:function(name,params){var state,stateParams,stateName,key,tmpState;if("string"==typeof params&&(params={texture:params}),"["===name.charAt(0))return name=name.substr(1,name.length-2),this.childStyle||(this.childStyle=new meta.Style),this.childStyle.setState(name,params),void 0;var actionIndex=name.indexOf(":");if(-1!==actionIndex){var actionName=name.substr(actionIndex+1,name.length-actionIndex-1);name=name.substr(0,actionIndex),name||(name="*"),state=this.states[name],state?state.actions||(state.actions={}):(state=new meta.StyleState(name),state.actions={},this.states[name]=state);var tmpAction;if("*"===name){this.defaultState=state;for(stateName in this.states)if(tmpState=this.states[stateName],tmpState.actions&&(tmpAction=tmpState.actions[actionName],tmpAction)){stateParams=tmpAction.params;for(key in params)stateParams[key]||(stateParams[key]=params[key])}}else if(this.defaultState&&this.defaultState.actions&&(tmpAction=this.defaultState.actions[actionName],tmpAction)){stateParams=tmpAction.params;for(key in stateParams)params[key]||(params[key]=stateParams[key])}state.actions[actionName]=new meta.StyleState(actionName,params),this.haveActions=!0}else if(name||(name="*"),state=this.states[name],state){stateParams=state.params;for(key in stateParams)stateParams[key]||(stateParams[key]=params[key]);state._updateTexture()}else{if(this.defaultState){stateParams=this.defaultState.params;for(key in stateParams)params[key]||(params[key]=stateParams[key])}if(state=new meta.StyleState(name,params),"*"===name){this.defaultState=state;for(stateName in this.states){stateParams=this.states[stateName].params;for(key in params)stateParams[key]||(stateParams[key]=params[key])}}this.states[name]=state}return this},setStates:function(params){for(var key in params)this.setState(key,params[key])},setHiddenState:function(name,texture,params){var state=this.setState(name,texture,params);return state&&(state.isHidden=!0),state},removeState:function(name){return this.states[name]?(delete this.states[name],void 0):(console.warn("[meta.Brush.removeState]:","No such state: "+name),void 0)},update:function(entity){if(entity.isNeedStyle=!1,this.states){var styleState=this.states[entity._state];if(!styleState){if(!this.defaultState)return console.warn("[meta.Style.update]:","Could not get state from the style: "+entity._state),void 0;styleState=this.defaultState}if(styleState!==entity._styleState){var key,entityParams=entity._styleParams;for(key in entityParams)entity[key]=entityParams[key];entityParams={},entity._styleParams=entityParams;var params=styleState.params;for(key in params)entityParams[key]=entity[key],entity[key]=params[key];entity._styleState=styleState,entity._inputFlags&&this.updateAction(entity)}}},updateAction:function(entity){var entityParams=entity._styleActionParams;for(var key in entityParams)entity[key]=entityParams[key];entityParams={},entity._styleActionParams=entityParams;var action,state=this.states[entity._state];if(!state){if(!this.defaultState)return;state=this.defaultState}if(state.actions)action=state.actions[entity._action];else{if(!this.defaultState.actions)return;action=this.defaultState.actions[entity._action]}if(action){var params=action.params;for(var key in params)entityParams[key]=entity[key],entity[key]=params[key]}},getRandomState:function(){if(!this.states)return null;var result=null,count=0;for(var key in this.states)this.states[key].isHidden||Math.random()<1/++count&&(result=key);return result},states:null,defaultState:null,haveActions:!1,childStyle:null},meta.StyleState=function(name,params){this.name=name,this.params=params,this.isHidden=!1,this._updateTexture()},meta.StyleState.prototype={_updateTexture:function(){if(this.params&&void 0!==this.params.texture){var texture=this.params.texture;if("string"!=typeof texture)return;var newTexture=meta.getTexture(texture);if(!newTexture)return console.warn("[meta.StyleState]:","Could not get texture from texture name: "+texture),void 0;this.params.texture=newTexture}}},meta.createStyle=function(obj,extend){if(!obj)return extend?extend:null;extend=extend||null;var newStyle=Object.create(extend);if("string"==typeof obj||obj instanceof Resource.Texture)newStyle["*"]?newStyle["*"].texture=obj:newStyle["*"]={texture:obj};else if("object"==typeof obj){var item,itemKey,paramsItem,itemKey,i,key,style,tmpStyle,styleName,styleBuffer,numStyles;for(itemKey in obj)if(item=obj[itemKey],"string"==typeof item&&(item={texture:item}),-1!==itemKey.indexOf(","))for(styleBuffer=itemKey.split(/[ ,]+/),numStyles=styleBuffer.length,i=0;numStyles>i;i++){if(styleName=styleBuffer[i],style=newStyle[styleName],style){tmpStyle={};for(key in style)tmpStyle[key]=style[key];style=tmpStyle}else style={};for(key in item)style[key]=item[key];newStyle[styleName]=style}else{if(style=newStyle[itemKey],style){tmpStyle={};for(key in style)tmpStyle[key]=style[key];style=tmpStyle}else style={};for(key in item)style[key]=item[key];newStyle[itemKey]=style}}return newStyle},"use strict",meta.Event={RESIZE:"resize",WORLD_RESIZE:"worldResize",CAMERA_MOVE:"cameraMove",CAMERA_RESIZE:"cameraResize",FOCUS:"focus",FULLSCREEN:"fullScreen",ADDED_TO_VIEW:"addedToView",REMOVED_FROM_VIEW:"removedFromView",ADAPT:"adapt"},meta.Priority={LOW:0,MEDIUM:5e3,HIGH:1e4},meta.Cursor={ALIAS:"alias",ALL_SCROLL:"all-scroll",CELL:"cell",CONTEXT_MENU:"context-menu",COL_RESIZE:"col-resize",COPY:"copy",CROSSHAIR:"crosshair",DEFAULT:"default",E_RESIZE:"e-resize",EW_RESIZE:"ew-resize",GRAB:"grab",GRABBING:"grabbing",HELP:"help",MOVE:"move",N_RESIZE:"n-resize",NE_RESIZE:"ne-resize",NESW_RESIZE:"nesw-resize",NS_RESIZE:"ns-reisize",NW_RESIZE:"nw-resize",NWSE_RESIZE:"nwse-resize",NO_DROP:"no-drop",NONE:"none",NOT_ALLOWED:"not-allowed",POINTER:"pointer",PROGRESS:"progress",ROW_RESIZE:"row-resize",S_RESIZE:"s-resize",SE_RESIZE:"se-resize",SW_RESIZE:"sw-resize",TEXT:"text",VERTICAL_TEXT:"vertical-text",W_RESIZE:"w-resize",WAIT:"wait",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",INITIAL:"initial"},"use strict",meta.getTexture=function(name){return Resource.ctrl.getTexture(name)},"use strict",meta.utils.LinkedList=function(){this.length=0,this.first=new meta.utils.LinkedListNode(null),this.last=new meta.utils.LinkedListNode(null),this.first.next=this.last,this.last.prev=this.first},meta.utils.LinkedList.prototype={push:function(node){this.last.prev.next=node,this.last.prev=node,node.prev=this.last.prev,node.next=this.last,this.length++},remove:function(node){node.prev.next=node.next,node.next.prev=node.prev,node.prev=null,node.next=null,this.length--}},meta.utils.LinkedListNode=function(data){this.data=data,this.prev=null,this.next=null},"use strict",meta.math={},meta.math={toRadians:function(degree){return degree*Math.PI/180},toDegree:function(rad){return 180*rad/Math.PI},radiansToPoint:function(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.atan(dx/dy)},clamp:function(num,min,max){return min>num?min:num>max?max:num},map:function(v,a,b,x,y){return v==a?x:(v-a)*(y-x)/(b-a)+x},length:function(x1,y1,x2,y2){var x=x2-x1,y=y2-y1;return Math.sqrt(x*x+y*y)},length2:function(x,y){return Math.sqrt(x*x+y*y)},limit:function(value,maxValue){return value>maxValue?maxValue:-maxValue>value?-maxValue:value},lerp:function(value1,value2,amount){return value1+(value2-value1)*amount},lookAt:function(srcX,srcY,targetX,targetY){return Math.atan2(targetX-srcX,srcY-targetY)},lookAtEntity:function(src,target){return meta.math.lookAt(src.x,src.y,target.x,target.y)}},"use strict",meta.math.Vector2=function(x,y){this.x=x,this.y=y},meta.math.Vector2.prototype={reset:function(){this.x=0,this.y=0},set:function(x,y){this.x=x,this.y=y},add:function(value){this.x+=value,this.y+=value},sub:function(value){this.x-=value,this.y-=value},mul:function(value){this.x*=value,this.y*=value},div:function(value){this.x/=value,this.y/=value
},addVec2:function(vec){this.x+=vec.x,this.y+=vec.y},subVec2:function(vec){this.x-=vec.x,this.y-=vec.y},mulVec2:function(vec){this.x*=vec.x,this.y*=vec.y},divVec2:function(vec){this.x/=vec.x,this.y/=vec.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var length=Math.sqrt(this.x*this.x+this.y*this.y);this.x/=length,this.y/=length},dot:function(x,y){return this.x*x+this.y*y},truncate:function(max){var length=Math.sqrt(this.x*this.x+this.y*this.y);length>max&&(this.normalize(),this.x*=max,this.y*=max)},limit:function(max){this.x>max?this.x=max:this.x<-max&&(this.x=-max),this.y>max?this.y=max:this.y<-max&&(this.y=-max)},lengthSq:function(){return this.x*this.x+this.y*this.y},perp:function(){var tmpX=this.x;this.x=-this.y,this.y=tmpX},print:function(str){console.log(str?'[vec "'+str+'"] x: '+this.x+" y: "+this.y:"[vec] x: "+this.x+" y: "+this.y)}},"use strict",meta.math.AABB=function(minX,minY,maxX,maxY){this.minX=minX,this.minY=minY,this.maxX=maxX,this.maxY=maxY},meta.math.AABB.prototype={move:function(x,y){this.minX+=x,this.minY+=y,this.maxX+=x,this.maxY+=y},set:function(x,y){var width=this.maxX-this.minX,height=this.maxY-this.minY;this.minX=x,this.minY=y,this.maxX=x+width,this.maxY=y+height},resize:function(width,height){this.maxX=this.minX+width,this.maxY=this.minY+height},copy:function(src){this.minX=src.minX,this.minY=src.minY,this.maxX=src.maxX,this.maxY=src.maxY},vsAABB:function(src){return this.minX>src.maxX||this.maxX<src.minX||this.minY>src.maxY||this.maxY<src.minY?!1:!0},vsBorderAABB:function(src){return this.minX>=src.maxX||this.maxX<=src.minX||this.minY>=src.maxY||this.maxY<=src.minY?!1:!0},vsAABBIntersection:function(src){return this.minX>src.maxX||this.maxX<src.minX||this.minY>src.maxY||this.maxY<src.minY?0:this.minX>src.minX||this.minY>src.minY?1:this.maxX<src.maxX||this.maxY<src.maxY?1:2},vsPoint:function(x,y){return this.minX>x||this.maxX<x?!1:this.minY>y||this.maxY<y?!1:!0},vsBorderPoint:function(x,y){return this.minX>=x||this.maxX<=x?!1:this.minY>=y||this.maxY<=y?!1:!0},getSqrDistance:function(x,y){var tmp,sqDist=0;return x<this.minX&&(tmp=this.minX-x,sqDist+=tmp*tmp),x>this.maxX&&(tmp=x-this.maxX,sqDist+=tmp*tmp),y<this.minY&&(tmp=this.minY-y,sqDist+=tmp*tmp),y>this.maxY&&(tmp=y-this.maxY,sqDist+=tmp*tmp),sqDist},getDistanceVsAABB:function(aabb){var centerX=this.minX+(this.maxX-this.minX)/2,centerY=this.minY+(this.maxY-this.minY)/2,srcCenterX=aabb.minX+(aabb.maxY-aabb.minY)/2,srcCenterY=aabb.minY+(aabb.maxY-aabb.minY)/2,diffX=srcCenterX-centerX,diffY=srcCenterY-centerY;return Math.sqrt(diffX*diffX+diffY*diffY)},get width(){return this.maxX-this.minX},get height(){return this.maxY-this.minY},isUndefined:function(){return void 0===this.maxY},draw:function(ctx){var unitSize=meta.unitSize,minX,minY,maxX,maxY;1===unitSize?(minX=Math.floor(this.minX),minY=Math.floor(this.minY),maxX=Math.ceil(this.maxX),maxY=Math.ceil(this.maxY)):(minX=Math.floor(this.minX)*unitSize-this.halfWidth*unitSize,minY=Math.floor(this.minY)*unitSize-this.halfHeight*unitSize,maxX=Math.ceil(this.maxX)*unitSize-this.halfWidth*unitSize,maxY=Math.ceil(this.maxY)*unitSize-this.halfHeight*unitSize),ctx.beginPath(),ctx.moveTo(minX,minY),ctx.lineTo(maxX,minY),ctx.lineTo(maxX,maxY),ctx.lineTo(minX,maxY),ctx.lineTo(minX,minY),ctx.stroke()},drawTranslated:function(ctx,obj){var x,y;obj?(x=obj.x,y=obj.y):(x=0,y=0),this.translate(x,y),this.draw(ctx),this.translate(-x,-y)},print:function(str){console.log(str?"(AABB) "+str+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.AdvAABB=function(minX,minY,maxX,maxY){this.minX=minX,this.minY=minY,this.maxX=maxX,this.maxY=maxY,this.initWidth=maxX-minX,this.initHeight=maxY-minY,this.initHalfWidth=.5*this.initWidth,this.initHalfHeight=.5*this.initHeight,this.width=this.initWidth,this.height=this.initHeight,this.halfWidth=this.initHalfWidth,this.halfHeight=this.initHalfHeight,this.x=minX+this.halfWidth|0,this.y=minY+this.halfHeight|0,this.scaleX=1,this.scaleY=1},meta.math.AdvAABB.prototype={move:function(x,y){this.x+=x,this.y+=y,this.minX+=x,this.minY+=y,this.maxX+=x,this.maxY+=y},set:function(x,y){this.x=x,this.y=y,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.x+this.halfWidth,this.maxY=this.y+this.halfHeight},resize:function(width,height){this.initWidth=width,this.initHeight=height,this.initHalfWidth=.5*width,this.initHalfHeight=.5*height,this.width=width*this.scaleX,this.height=height*this.scaleY,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},scale:function(scaleX,scaleY){this.scaleX=scaleX,this.scaleY=scaleY,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},scalePivoted:function(scaleX,scaleY,x,y){this.scaleX=scaleX,this.scaleY=scaleY,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.x=x,this.y=y,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},vsAABB:function(src){return this.minX>src.maxX||this.maxX<src.minX||this.minY>src.maxY||this.maxY<src.minY?!1:!0},vsBorderAABB:function(src){return this.minX>=src.maxX||this.maxX<=src.minX||this.minY>=src.maxY||this.maxY<=src.minY?!1:!0},vsAABBIntersection:function(src){return this.minX>src.maxX||this.maxX<src.minX||this.minY>src.maxY||this.maxY<src.minY?0:this.minX>src.minX||this.minY>src.minY?1:this.maxX<src.maxX||this.maxY<src.maxY?1:2},vsPoint:function(x,y){return this.minX>x||this.maxX<x?!1:this.minY>y||this.maxY<y?!1:!0},vsBorderPoint:function(x,y){return this.minX>=x||this.maxX<=x?!1:this.minY>=y||this.maxY<=y?!1:!0},getSqrDistance:function(x,y){var tmp,sqDist=0;return x<this.minX&&(tmp=this.minX-x,sqDist+=tmp*tmp),x>this.maxX&&(tmp=x-this.maxX,sqDist+=tmp*tmp),y<this.minY&&(tmp=this.minY-y,sqDist+=tmp*tmp),y>this.maxY&&(tmp=y-this.maxY,sqDist+=tmp*tmp),sqDist},getDistanceVsAABB:function(aabb){var centerX=this.minX+.5*(this.maxX-this.minX),centerY=this.minY+.5*(this.maxY-this.minY),srcCenterX=aabb.minX+.5*(aabb.maxY-aabb.minY),srcCenterY=aabb.minY+.5*(aabb.maxY-aabb.minY),diffX=srcCenterX-centerX,diffY=srcCenterY-centerY;return Math.sqrt(diffX*diffX+diffY*diffY)},isUndefined:function(){return void 0===this.maxY},draw:function(ctx){var unitSize=meta.unitSize,minX,minY,maxX,maxY;minX=0|this.minX,minY=0|this.minY,maxX=this.maxX+.5|0,maxY=this.maxY+.5|0,ctx.beginPath(),ctx.moveTo(minX,minY),ctx.lineTo(maxX,minY),ctx.lineTo(maxX,maxY),ctx.lineTo(minX,maxY),ctx.lineTo(minX,minY),ctx.stroke()},drawTranslated:function(ctx){var camera=meta.camera;this.translate(camera._x,camera._y),this.draw(ctx),this.translate(-camera._x,-camera._y)},print:function(str){console.log(str?"(AABB) "+str+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.Matrix4=function(){this.m=new Float32Array(16),this.m[0]=1,this.m[5]=1,this.m[10]=1,this.m[15]=1},meta.math.Matrix4.prototype={reset:function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},scale:function(x,y,z){this.m[0]=x,this.m[5]=y,this.m[10]=z},ortho:function(left,right,bottom,top,zNear,zFar){this.m[0]=2/(right-left),this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=2/(top-bottom),this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=-2/(zFar-zNear),this.m[11]=0,this.m[12]=-(right+left)/(right-left),this.m[13]=-(top+bottom)/(top-bottom),this.m[14]=-(zFar+zNear)/(zFar-zNear),this.m[15]=1}},"use strict",meta.math.Random=function(){this.seed=0,this.a=0,this.m=0,this.q=0,this.r=0,this.oneOverM=0,this.init()},meta.math.Random.prototype={init:function(){this.setSeed(3456789012,!0)},generate:function(){var hi=Math.floor(this.seed/this.q),lo=this.seed%this.q,test=this.a*lo-this.r*hi;return this.seed=test>0?test:test+this.m,this.seed*this.oneOverM},number:function(min,max){var number=this.generate();return Math.round((max-min)*number+min)},numberF:function(min,max){var number=this.generate();return(max-min)*number+min},setSeed:function(seed,useTime){if(void 0!==useTime&&(useTime=!0),useTime===!0){var date=new Date;this.seed=seed+16777215*date.getSeconds()+65535*date.getMinutes()}else this.seed=seed;this.a=48271,this.m=2147483647,this.q=Math.floor(this.m/this.a),this.r=this.m%this.a,this.oneOverM=1/this.m}},meta.random=new meta.math.Random,"use strict",meta.Tween=function(){this.cache=null,this.chain=[]},meta.Tween.prototype={play:function(){if(this.cache){var cache=this.cache;if(!cache.owner)return this;if(cache.owner.isRemoved)return this;cache.isPaused=!1,this.next(),this._play(),this.cache=null}else this.autoPlay=!0;return this},_play:function(){Entity.ctrl._addToUpdating(this.cache)&&this._group&&this._group.activeUsers++},stop:function(callCB){return this.cache?this.autoPlay=!1:(this.linkIndex=0,this._stop(callCB),this.cache=null),this},_stop:function(callCB){Entity.ctrl._removeFromUpdating(this.cache)&&(callCB&&this.currLink._onComplete&&this.currLink._onComplete.call(this.cache.owner),this._group&&(this._group.activeUsers--,0===this._group.activeUsers&&this._group.callback&&this._group.callback()))},paused:function(value){return void 0===value&&(value=!0),this.cache.isPaused=value,this},resume:function(){return this.cache.isPaused=!1,this},clear:function(){return this.stop(),this._tStart=0,this.chain.length=0,this.linkIndex=0,this.currLink=null,this._group&&(this._group.users--,this._group=null),this},reset:function(){var cache=this.cache;if(cache.linkIndex=0,cache.currLink=this.chain[0],!cache.currLink)return this;for(var key in cache.currLink.startValues)cache.owner[key]=cache.currLink.startValues[key];return this.stop(!1),this},next:function(){var isRepeating=!1,cache=this.cache;if(cache.linkIndex===this.chain.length){if(0===this.numRepeat)return this.stop(!0),this;cache.linkIndex=0,-1!==this.numRepeat&&this.numRepeat--,isRepeating=!0,cache.currLink._onComplete&&cache.currLink._onComplete.call(cache.owner)}cache._isLinkDone=!1;var key,link=this.chain[cache.linkIndex++],owner=cache.owner;if(isRepeating)for(key in link.startValues)owner[key]=link.startValues[key];else for(key in link.endValues)link.startValues[key]=owner[key];return link._onStart&&link._onStart.call(this),cache._tStart=meta.engine.tNow,cache.currLink=link,this},repeat:function(numRepeat){return void 0===numRepeat&&(numRepeat=-1),this.cache.numRepeat=numRepeat,this},set reverse(value){return void 0===value&&(value=!0),this.cache.isReverse=value,this},get reverse(){return this.cache.isReverse},update:function(tDelta){var cache=this.cache;if(!cache.currLink)return this.stop(!1),void 0;var tCurr=meta.engine.tNow,tFrameDelta=tCurr-cache._tFrame;if(!(tFrameDelta<cache.currLink.tFrameDelay)){var tElapsed=(tCurr-cache._tStart)/cache.currLink.duration;if(tElapsed>1&&(tElapsed=1),cache._isLinkDone){if(tFrameDelta<cache.currLink.tDelay)return}else cache._tFrame=tCurr,cache.currLink.update(tElapsed),cache.currLink._onTick&&cache.currLink._onTick.call(this);if(1===tElapsed){if(!cache._isLinkDone&&cache.currLink.tDelay>0)return cache._isLinkDone=!0,void 0;this.next()}}},to:function(endValues,duration,onComplete){var link=new meta.Tween.Link(this,endValues,duration,onComplete);return this.chain.push(link),link},wait:function(tDelay){var link=this.to(null,0,null);return link.wait(tDelay),link},group:function(group){return group?this._group?(console.warn("[meta.Tween.group]:","Tween already is part of a group."),this):("object"==typeof group&&(this._group=group),this._group.users++,this):(console.warn("[meta.Tween.group]:","No group name specified."),this)},autoPlay:!1,numRepeat:0,_group:null,_isReversing:!1,_removeFlag:0},meta.Tween.Cache=function(owner){this.owner=owner,this.tween=null,this.linkIndex=0,this.currLink=null,this._updateNodeID=-1,this._isLinkDone=!1,this._tStart=0,this._tFrame=0},meta.Tween.Cache.prototype={update:function(tDelta){this.tween.cache=this,this.tween.update(tDelta),this.tween.cache=null},isPaused:!1,isRemoved:!1,reverse:!1,_flags:0},meta.Tween.Group=function(name,callback){"function"==typeof name&&(callback=name,name=""),this.name=name,this.users=0,this.activeUsers=0,this.callback=callback||null},"use strict",meta.Tween.Easing={linear:function(k){return k},quadIn:function(k){return k*k},quadOut:function(k){return k*(2-k)},quadInOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)},cubicIn:function(k){return k*k*k},cubicOut:function(k){return--k*k*k+1},cubicInOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)},quartIn:function(k){return k*k*k*k},quartOut:function(k){return 1- --k*k*k*k},quartInOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)},quintIn:function(k){return k*k*k*k*k},quintOut:function(k){return--k*k*k*k*k+1},quintIntOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)},sineIn:function(k){return 1-Math.cos(k*Math.PI/2)},sineOut:function(k){return Math.sin(k*Math.PI/2)},sineIntOut:function(k){return.5*(1-Math.cos(Math.PI*k))},expoIn:function(k){return 0===k?0:Math.pow(1024,k-1)},expoOut:function(k){return 1===k?1:1-Math.pow(2,-10*k)},expoInOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(-Math.pow(2,-10*(k-1))+2)},circIn:function(k){return 1-Math.sqrt(1-k*k)},circOut:function(k){return Math.sqrt(1- --k*k)},circInOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)},elasticIn:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||1>a?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),-(a*Math.pow(2,10*(k-=1))*Math.sin(2*(k-s)*Math.PI/p)))},elasticOut:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||1>a?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin(2*(k-s)*Math.PI/p)+1)},elasticInOut:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||1>a?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?-.5*a*Math.pow(2,10*(k-=1))*Math.sin(2*(k-s)*Math.PI/p):a*Math.pow(2,-10*(k-=1))*Math.sin(2*(k-s)*Math.PI/p)*.5+1)},backIn:function(k){var s=1.70158;return k*k*((s+1)*k-s)},backOut:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},backInOut:function(k){var s=2.5949095;return(k*=2)<1?.5*k*k*((s+1)*k-s):.5*((k-=2)*k*((s+1)*k+s)+2)},bounceIn:function(k){return 1-meta.Tween.Easing.bounceOut(1-k)},bounceOut:function(k){return 1/2.75>k?7.5625*k*k:2/2.75>k?7.5625*(k-=1.5/2.75)*k+.75:2.5/2.75>k?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},bounceInOut:function(k){return.5>k?.5*meta.Tween.Easing.bounceIn(2*k):.5*meta.Tween.Easing.bounceOut(2*k-1)+.5}},"use strict",meta.Tween.Link=function(tween,endValues,duration,onComplete){this.tween=tween,this.startValues={},this.endValues=endValues,this.duration=duration,this._onComplete=onComplete},meta.Tween.Link.prototype={play:function(){return this.tween.play(),this},stop:function(){return this.tween.stop(),this},paused:function(value){return this.tween.paused(value),this},resume:function(){return this.tween.resume(),this},clear:function(){return this.tween.clear(),this},reset:function(){return this.tween.reset(),this},update:function(tElapsed){var value=this._easing(tElapsed),startValue,endValue,result,owner=this.tween.cache.owner;for(var key in this.endValues)startValue=this.startValues[key],endValue=this.endValues[key],"string"==typeof startValue&&(endValue=startValue+parseFloat(endValue,4)),result=startValue+(endValue-startValue)*value,this.isRounding&&(result=Math.round(result)),owner[key]=result},next:function(){return this.tween.next(),this},wait:function(tDelay){return this.tDelay=tDelay,this},frameDelay:function(tFrameDelay){return this.tFrameDelay=tFrameDelay,this},round:function(value){return void 0===value&&(value=!0),this.isRounding=value,this},repeat:function(numRepeat){return this.tween.repeat(numRepeat),this},reverse:function(value){return this.tween.reverse(value),this},easing:function(func){return this._easing="function"==typeof func?func:meta.Tween.Easing[func],void 0===this._easing&&(this._easing=meta.Tween.Easing.linear),this},onStart:function(func){return this._onStart=func,this},onComplete:function(func){return this._onComplete=func,this},onTick:function(func){return this._onTick=func,this},to:function(endValues,duration,onComplete){return this.tween.to(endValues,duration,onComplete)},group:function(name){return this.tween.group(name)},_easing:meta.Tween.Easing.linear,_onStart:null,_onComplete:null,_onTick:null,tDelay:0,tFrameDelay:0,isRounding:!1},"use strict",window.Component={},"use strict";var Resource={};Resource.Controller=meta.Controller.extend({init:function(){this.resources={},this.resourcesInUse={},this._chn_added=meta.createChannel(Resource.Event.ADDED),this._chn_allLoaded=meta.createChannel(Resource.Event.ALL_LOADED);var canvas=document.createElement("canvas");Resource.Texture.prototype._tmpImg=canvas,Resource.Texture.prototype._tmpCtx=canvas.getContext("2d"),meta.subscribe(this,meta.Event.ADAPT,this.onAdapt);var proto=Resource.Sound.prototype;meta.device.isAudioAPI?(proto._context=new AudioContext,console.log("%cAudio: %cWebAudio ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")):(proto._loadFromUrl=proto._loadFromUrl_legacy,proto._clear=proto._clear_legacy,proto._createInstance=proto._createInstance_legacy,proto._syncLoading=!0,console.log("%cAudio: %c<audio> ","font-weight: bold; padding: 2px 0 1px 0; width: 500px;","padding: 2px 0 1px 0;"))},add:function(resource){var subBuffer=this.resources[resource.type];subBuffer||(subBuffer={},this.resources[resource.type]=subBuffer);var path=resource.path;if("unknown"===resource.name&&path){var wildcardIndex=path.lastIndexOf("."),slashIndex=path.lastIndexOf("/");resource.name=0>wildcardIndex||path.length-wildcardIndex>5?path.slice(slashIndex+1):path.slice(slashIndex+1,wildcardIndex)}return subBuffer[resource.name]?(console.warn("[Resource.Manager.add]:","There is already a resource("+meta.enumToString(Resource.Type,resource.type)+") added with a name: "+resource.name),null):(subBuffer[resource.name]=resource,this._chn_added.emit(resource,Resource.Event.ADDED),resource)},remove:function(resource){var subBuffer=this.resources[resource.type];return subBuffer&&subBuffer[resource.name]?(subBuffer[resource.name]=null,void 0):(console.warn("[Resource.Manager.remove]:","Resource("+meta.enumToString(Resource.Type,resource.type)+")("+resource.name+") is not added to the manager."),void 0)},addToLoad:function(resource){resource.isLoading=!0,meta.engine.isReady||this.numToLoad++},loadSuccess:function(resource){var subBuffer=this.resourcesInUse[resource.type];subBuffer||(subBuffer=[],this.resourcesInUse[resource.type]=subBuffer),subBuffer.push(resource),resource.isLoading=!1,resource.inUse=!0,meta.engine.isReady||(this.numToLoad--,this.numLoaded++,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn_allLoaded.emit(this,Resource.Event.ALL_LOADED)))},loadFailed:function(resource){resource.isLoading=!1,meta.engine.isReady||(this.numToLoad--,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn_allLoaded.emit(this,Resource.Event.ALL_LOADED)))},getTexture:function(name){if(!name)return console.warn("[Resource.Manager.getTexture]:","No name specified."),null;var subBuffer=this.resources[Resource.Type.TEXTURE];if(!subBuffer)return null;var texture=subBuffer[name];return texture?texture:null},getSound:function(name){if(!name)return console.warn("[Resource.Manager.getSound]:","No name specified."),null;var subBuffer=this.resources[Resource.Type.SOUND];if(!subBuffer)return null;var sound=subBuffer[name];return sound?sound:null},addToQueue:function(resource){this._syncQueue||(this._syncQueue=[]),this._syncQueue.push(resource)},loadNextFromQueue:function(){this.isSyncLoading=!1,this._syncQueue&&this._syncQueue.length&&(this._syncQueue[this._syncQueue.length-1].forceLoad(!0),this._syncQueue.pop())},onAdapt:function(data,event){var unitRatio=meta.unitRatio,texture,textures=this.resources[Resource.Type.TEXTURE];for(var key in textures)texture=textures[key],texture.unitRatio=unitRatio,texture.load()},getUniqueID:function(){return++this._uniqueID},resources:null,resourcesInUse:null,rootPath:"",numLoaded:0,numToLoad:0,_syncQueue:null,isSyncLoading:!1,_chn_added:null,_chn_allLoaded:null,_uniqueID:0}),"use strict",Resource.Event={UNLOADED:"resUnloaded",LOADED:"resLoaded",RESIZE:"resResize",CHANGED:"resChanged",ADDED:"resAdded",ALL_LOADED:"resAllLoaded"},Resource.Type={BASIC:0,TEXTURE:1,SOUND:2,SPRITE_SHEET:3,FONT:4},Resource.TextureType={UNKNOWN:-1,CANVAS:0,WEBGL:1},Resource.AnimType={NONE:0,LINEAR_H:1,LINEAR_V:2,RADIAL:3,RADIAL_TOP_LEFT:4,RADIAL_TOP_RIGHT:5,RADIAL_BOTTOM_LEFT:6,RADIAL_BOTTOM_RIGHT:7},"use strict",Resource.Basic=meta.Class.extend({_init:function(){this.id=Resource.ctrl.getUniqueID()},subscribe:function(owner,func){this.chn||(this.chn=meta.createChannel("__res"+this.id)),this.chn.subscribe(owner,func)},unsubscribe:function(owner){this.chn&&(this.chn.unsubscribe(owner),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(data,event){this.chn&&this.chn.emit(data,event)},set isLoaded(value){value?this._isLoaded?(this._isLoaded=value,this.emit(this,Resource.Event.CHANGED)):(this._isLoaded=value,this.emit(this,Resource.Event.LOADED)):this._isLoaded&&(this._isLoaded=value,this.emit(this,Resource.Event.UNLOADED))},get isLoaded(){return this._isLoaded},id:0,type:Resource.Type.BASIC,name:"unknown",path:"",fullPath:"",chn:null,_isLoaded:!1,isLoading:!1,inUse:!1}),"use strict",Resource.Texture=Resource.Basic.extend({init:function(param,path){if(void 0!==param){var paramType=typeof param;if("object"===paramType)for(var key in param)this[key]=param[key];else"string"===paramType?this.path=param:(this.textureType=param,path&&(this.path=path));if(this.path){var wildCardIndex=this.path.lastIndexOf(".");(-1===wildCardIndex||this.path.length-wildCardIndex>4)&&(this.path+=".png")}}-1===this.textureType&&(this.textureType=meta.engine.isWebGL?Resource.TextureType.WEBGL:Resource.TextureType.CANVAS),this.numFrames>1?(this.numFramesX=this.numFrames,this.isAnimated=!0):(this.numFramesX>1||this.numFramesY>1)&&(this.numFrames=this.numFramesX*this.numFramesY,this.isAnimated=!0),this.generate(this.textureType)},remove:function(){},generate:function(type){if(this.isLoaded=!1,type===Resource.TextureType.WEBGL){var gl=meta.ctx;this.image=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),this._vertices=new Float32Array([0,0,this.trueWidth,0,0,this.trueHeight,this.trueWidth,this.trueHeight]),this.vbo=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo),gl.bufferData(gl.ARRAY_BUFFER,this._vertices,gl.DYNAMIC_DRAW)}else this.image=document.createElement("canvas"),this.ctx=this.image.getContext("2d"),this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight,this.textureType=Resource.TextureType.CANVAS},load:function(path){if(!this.isLoading){if(path)this.path=path;else if(!this.path)return;this.fullPath=meta._cache.currResolution?Resource.ctrl.rootPath+meta._cache.currResolution.path+this.path:Resource.ctrl.rootPath+this.path,Resource.ctrl.addToLoad(this);var self=this,img=new Image;meta.engine.isWebGL&&(img.crossOrigin="anonymous"),img.onload=function(){return img.complete?(self.createFromImg(img),Resource.ctrl.loadSuccess(self),void 0):(console.warn("[Resource.Texture.load]:","Could not load texture from - "+img.src),Resource.ctrl.loadFailed(self),void 0)},img.onerror=function(event){Resource.ctrl.loadFailed(self)},this._isLoaded&&(this._isReloading=!0),img.src=this.fullPath}},createFromImg:function(img){if(this._isLoaded&&this.clear(),this.resize(img.width,img.height),this.textureType!==Resource.TextureType.WEBGL)this.ctx.drawImage(img,0,0);else{var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img)}this.unitRatio=meta.unitRatio,this._isReloading=!1,this.isLoaded=!0},_createCachedImg:function(){this._cachedImg||(this._cachedImg=document.createElement("canvas"),this._cachedImg.width=this.trueFullWidth,this._cachedImg.height=this.trueFullHeight,this._cachedCtx=this._cachedImg.getContext("2d"))},resize:function(width,height){if(this.trueFullWidth!==width||this.trueFullHeight!==height){this.trueFullWidth=width,this.trueFullHeight=height,this.isAnimated?(this.trueWidth=width/this.numFramesX,this.trueHeight=height/this.numFramesY):(this.trueWidth=width,this.trueHeight=height);var unitRatio=meta.unitRatio;if(this.width=this.trueWidth*unitRatio+.5|0,this.height=this.trueHeight*unitRatio+.5|0,this.fullWidth=this.trueFullWidth*unitRatio+.5|0,this.fullHeight=this.trueFullHeight*unitRatio+.5|0,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this.textureType){var gl=meta.ctx;this._vertices[2]=this.trueWidth,this._vertices[5]=this.trueHeight,this._vertices[6]=this.trueWidth,this._vertices[7]=this.trueHeight,this._xRatio=1/this.numFramesX,this._yRatio=1/this.numFramesY,this.fromAtlas?(this._widthRatio=1/(this.ptr.trueFullWidth/this.trueWidth/this.numFramesX),this._heightRatio=1/(this.ptr.trueFullHeight/this.trueHeight/this.numFramesY)):(this._widthRatio=1/this.numFramesX,this._heightRatio=1/this.numFramesY),gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo),gl.bufferData(gl.ARRAY_BUFFER,this._vertices,gl.DYNAMIC_DRAW),this._isLoaded&&this._cachedImg&&(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this._cachedImg,0,0),this._cachedImg.width=this.trueFullWidth,this._cachedImg.height=this.trueFullHeight,this._cachedCtx.drawImage(this._cachedImg,0,0),gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg))}else this._isLoaded&&this.image.width>0&&this.image.height>0?(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this.image,0,0),this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight,this.ctx.drawImage(this._tmpImg,0,0)):(this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight);this._isLoaded&&!this._isReloading&&this.emit(this,Resource.Event.RESIZE)}},upResize:function(width,height){width<this.trueFullWidth&&(width=this.trueFullWidth),height<this.trueFullHeight&&(height=this.trueFullHeight),this.resize(width,height)},update:function(){this.textureType&&this.resize(this.trueWidth,this.trueHeight)},draw:function(ctx,x,y){this._bgTexture&&this._bgTexture.draw(ctx,x,y),this.fromAtlas?ctx.drawImage(this.ptr.image,this._x,this._y,this.trueWidth,this.trueHeight,x,y,this.trueWidth,this.trueHeight):ctx.drawImage(this.image,x,y)},drawFrame:function(ctx,x,y,frame,isEmulateReverse){if(this._bgTexture&&ctx.drawImage(this._bgTexture.image,x,y),this._anim){var theta,cos;if(1===this._anim.type){var width=this._anim.fill*frame;0===width?width=.01:width>this.trueFullWidth&&(width=this.trueFullWidth),isEmulateReverse?ctx.drawImage(this.image,this.trueFullWidth-width,0,width,this.trueFullHeight,x+this.trueFullWidth-width,y,width,this.trueFullHeight):ctx.drawImage(this.image,0,0,width,this.trueFullHeight,x,y,width,this.trueFullHeight)}else if(2===this._anim.type){var height=this._anim.fill*frame;0===height?height=.01:height>this.trueHeight&&(width=this.trueHeight),isEmulateReverse?ctx.drawImage(this.image,0,this.trueFullHeight-height,this.trueFullWidth,height,x,y+this.trueFullHeight-height,this.trueFullWidth,height):ctx.drawImage(this.image,0,0,this.trueFullWidth,height,x,y,this.trueFullWidth,height)}else 3===this._anim.type||(4===this._anim.type?(isEmulateReverse?(theta=this._anim.fill*(-this.numFrames+frame+1)+Math.PI/2,cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x,y),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length),ctx.lineTo(cos+this.trueFullWidth,y),ctx.closePath(),ctx.clip()):(theta=this._anim.fill*-frame+Math.PI/2,cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x,y),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length),ctx.lineTo(cos,y+this.trueFullHeight),ctx.lineTo(x,y+this.trueFullHeight),ctx.closePath(),ctx.clip()),ctx.drawImage(this.image,x,y),ctx.restore()):5===this._anim.type?(isEmulateReverse?(theta=this._anim.fill*(this.numFrames-frame-1)+Math.PI/2,cos=x+Math.cos(theta)*this._anim.length+this.trueFullWidth,ctx.save(),ctx.beginPath(),ctx.moveTo(x+this.trueFullWidth,y),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length),ctx.lineTo(x,y+this.trueFullHeight),ctx.lineTo(x,y),ctx.closePath(),ctx.clip()):(theta=this._anim.fill*frame+Math.PI/2,cos=x+Math.cos(theta)*this._anim.length+this.trueFullWidth,ctx.save(),ctx.beginPath(),ctx.moveTo(x+this.trueFullWidth,y),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length),ctx.lineTo(cos,y+this.trueFullHeight),ctx.lineTo(x+this.trueFullWidth,y+this.trueFullHeight),ctx.closePath(),ctx.clip()),ctx.drawImage(this.image,x,y),ctx.restore()):6===this._anim.type?(isEmulateReverse?(theta=this._anim.fill*(-this.numFrames+frame+1),cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x,y+this.trueFullHeight),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length+this.trueFullHeight),ctx.lineTo(x+this.trueFullWidth,y),ctx.lineTo(x,y),ctx.closePath(),ctx.clip()):(theta=this._anim.fill*-frame,cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x,y+this.trueFullHeight),ctx.lineTo(cos,y+Math.sin(theta)*this._anim.length+this.trueFullHeight),ctx.lineTo(x+this.trueFullWidth,y),ctx.lineTo(x+this.trueFullWidth,y+this.trueFullHeight),ctx.closePath(),ctx.clip()),ctx.drawImage(this.image,x,y),ctx.restore()):7===this._anim.type&&(isEmulateReverse?(theta=this._anim.fill*(this.numFrames-1-frame)+Math.PI,cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x+64,y+this.trueFullHeight),ctx.lineTo(cos+64,y+Math.sin(theta)*this._anim.length+64),ctx.lineTo(x,y),ctx.lineTo(x+64,y),ctx.closePath(),ctx.clip()):(theta=this._anim.fill*frame+Math.PI,cos=x+Math.cos(theta)*this._anim.length,ctx.save(),ctx.beginPath(),ctx.moveTo(x+64,y+this.trueFullHeight),ctx.lineTo(cos+64,y+Math.sin(theta)*this._anim.length+64),ctx.lineTo(x,y),ctx.lineTo(x,y+64),ctx.closePath(),ctx.clip()),ctx.drawImage(this.image,x,y),ctx.restore()))}else ctx.drawImage(this.image,this.trueWidth*(frame%this.numFramesX),this.trueHeight*Math.floor(frame/this.numFramesX),this.trueWidth,this.trueHeight,x,y,this.trueWidth,this.trueHeight)},clear:function(){if(this.textureType===Resource.TextureType.WEBGL){if(!this._cachedCtx)return;this._cachedCtx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);this._isReloading||(this.isLoaded=!0)},clearSilent:function(){if(this.textureType===Resource.TextureType.WEBGL){this._tmpCtx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight)},drawOver:function(texture,x,y){if(!texture)return console.warn("[Resource.Texture.drawOver]:","No texture specified."),void 0;
if(x=x||0,y=y||0,console.log("here"),"string"==typeof texture){var obj=meta.getTexture(texture);if(!obj)return console.warn("[Resource.Texture.drawOver]:","No such texture with name - "+texture),void 0;texture=obj}if(texture.textureType===Resource.TextureType.WEBGL){if(!texture._canvasCache)return texture._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,texture.path),texture._canvasCache.load(),texture=texture._canvasCache,this._loadCache={name:"drawOver",texture:texture,x:x,y:y},this.isLoaded=!1,texture.subscribe(this,this.onTextureCacheEvent),void 0;texture=texture._canvasCache}var ctx=this.ctx;if(this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.drawImage(texture.image,x,y),this.textureType){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},fillRect:function(params,height,color){if(!params)return console.warn("[Resource.Texture.fillRect]:","No parameters specified."),void 0;if("number"==typeof params)return this.fillRect({width:params,height:height,color:color}),void 0;var scope=meta,ctx=this.ctx;params.x=params.x||0,params.y=params.y||0;var width=(params.width||this.trueFullWidth||1)+params.x,height=(params.height||this.trueFullHeight||1)+params.y;if(this.upResize(width,height),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.fillStyle=params.color||"#000000",ctx.fillRect(params.x,params.y,width,height),this.textureType){var gl=scope.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},tile:function(params,height,texture){if("number"==typeof params)return this.tile({width:params,height:height,texture:texture}),void 0;if(!params)return console.warn("[Resource.Texture.tile]:","No parameters specified."),void 0;if("string"==typeof params.texture&&(params.texture=Resource.ctrl.getTexture(params.texture)),!params.texture)return console.warn("[Resource.Texture.tile]:","Undefined texture."),void 0;var texture=params.texture;if(texture.textureType===Resource.TextureType.WEBGL){if(!texture._canvasCache)return texture._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,texture.path),texture._canvasCache.load(),texture=texture._canvasCache,this._loadCache={name:"tile",data:params},this.isLoaded=!1,texture.subscribe(this,this.onTextureCacheEvent),void 0;texture=texture._canvasCache}if(!texture._isLoaded)return texture._isLoading||texture.load(),this._loadCache={name:"tile",data:params},this.isLoaded=!1,texture.subscribe(this,this.onTextureCacheEvent),void 0;var scope=meta;params.x=params.x||0,params.y=params.y||0,params.width=params.width||texture.fullWidth,params.height=params.height||texture.fullHeight,params.width*=scope.unitSize,params.height*=scope.unitSize,this.resize(params.width,params.height),params.center&&(params.x+=(this.trueFullWidth&texture.trueFullWidth-1)/2,params.y+=(this.trueFullHeight&texture.trueFullHeight-1)/2);var ctx=this.ctx;this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx);var posX=params.x,posY=params.y,numX=Math.ceil(this.trueFullWidth/texture.trueFullWidth)||1,numY=Math.ceil(this.trueFullHeight/texture.trueFullHeight)||1;posX>0&&(numX+=Math.ceil(posX/texture.trueFullWidth),posX-=texture.trueFullWidth),posY>0&&(numY+=Math.ceil(posY/texture.trueFullHeight),posY-=texture.trueFullHeight);for(var origY=posY,x=0;numX>x;x++){for(var y=0;numY>y;y++)console.log(posX,posY),ctx.drawImage(texture.image,posX,posY),posY+=texture.trueHeight;posX+=texture.trueWidth,posY=origY}if(this.textureType){var gl=scope.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},stroke:function(params){if(!params)return console.warn("[Resource.Texture.stroke]:","No parameters specified."),void 0;if(!params.buffer)return console.warn("[Resource.Texture.stroke]:","No buffer defined."),void 0;var minX=Number.POSITIVE_INFINITY,minY=minX,maxX=Number.NEGATIVE_INFINITY,maxY=maxX,item,i,x,y,buffer=params.buffer,numItems=buffer.length;for(i=0;numItems>i;i+=2)x=buffer[i],y=buffer[i+1],minX>x&&(minX=x),minY>y&&(minY=y),x>maxX&&(maxX=x),y>maxY&&(maxY=y);minX>0&&(minX=0),minY>0&&(minY=0);var ctx=this.ctx;params.addWidth=params.addWidth||0,params.addHeight=params.addHeight||0,params.lineWidth=params.lineWidth||1,params.color||params.borderColor||(params.borderColor="#000000");var halfLineWidth=params.lineWidth/2,offsetX=-minX+halfLineWidth+params.addWidth/2;for(this.resize(maxX-minX+params.lineWidth+params.addWidth,maxY-minY),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.lineWidth=params.lineWidth,params.lineCap&&(ctx.lineCap=params.lineCap),params.lineDash&&ctx.setLineDash(params.lineDash),ctx.beginPath(),ctx.moveTo(buffer[0]+offsetX,buffer[1]),i=2;numItems>i;i+=2)ctx.lineTo(buffer[i]+offsetX,buffer[i+1]);if(params.color&&(ctx.fillStyle=params.color,ctx.closePath(),ctx.fill()),params.borderColor&&(ctx.strokeStyle=params.borderColor,ctx.stroke()),this.textureType===Resource.TextureType.WEBGL){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},border:function(params){if(!params)return console.warn("[Resource.Texture.strokeBorder]:","No parameters specified."),void 0;params.width=params.width||this.trueFullWidth,params.height=params.height||this.trueFullHeight;var lineWidth=1;params.borderWidth&&(lineWidth=params.borderWidth),params.buffer=[0,0,params.width-lineWidth,0,params.width-lineWidth,params.height-lineWidth,0,params.height-lineWidth,0,0],this.stroke(params)},arc:function(params){if(!params)return console.warn("[Resource.Texture.arc]:","No parameters specified."),void 0;var ctx=this.ctx;params.x=params.x||0,params.y=params.y||0,params.radius=params.radius||5,params.startAngle=params.startAngle||0,params.endAngle=params.endAngle||2*Math.PI,params.borderWidth=params.borderWidth||1,params.color||params.borderColor||(params.borderColor=params.borderColor||"#000000");var size=2*params.radius+params.borderWidth;if(params.drawOver||this.resize(params.x+size,params.y+size),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.lineWidth=params.borderWidth,ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight),ctx.beginPath(),ctx.arc(params.x+params.radius+params.borderWidth/2,params.y+params.radius+params.borderWidth/2,params.radius,params.startAngle,params.endAngle,!1),ctx.closePath(),params.color&&(ctx.fillStyle=params.color,ctx.fill()),params.borderColor&&(ctx.strokeStyle=params.borderColor,ctx.stroke()),this.textureType===Resource.TextureType.WEBGL){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},rect:function(params,height,color,borderWidth){if("object"!=typeof params)return this.rect({width:params,height:height,color:color,borderWidth:borderWidth}),void 0;if(!params)return console.warn("[Resource.Texture.rect]:","No parameters specified."),void 0;var ctx=this.ctx,width=params.width||1,height=params.height||1;params.color=params.color||"#0000000";var borderWidth=params.borderWidth||1;params.drawOver||this.resize(width,height),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.strokeStyle=params.color,ctx.lineWidth=borderWidth;var halfWidth=Math.ceil(borderWidth/2);if(borderWidth%2===1?(ctx.save(),ctx.translate(.5,.5),ctx.beginPath(),ctx.moveTo(halfWidth,halfWidth),ctx.lineTo(width-halfWidth-1,halfWidth),ctx.lineTo(width-halfWidth-1,height-halfWidth-1),ctx.lineTo(halfWidth,height-halfWidth-1),ctx.closePath(),ctx.stroke(),ctx.restore()):(ctx.beginPath(),ctx.moveTo(halfWidth,halfWidth),ctx.lineTo(width-halfWidth,halfWidth),ctx.lineTo(width-halfWidth,height-halfWidth),ctx.lineTo(halfWidth,height-halfWidth),ctx.closePath(),ctx.stroke()),params.fillColor&&(ctx.fillStyle=params.fillColor,ctx.fill()),this.textureType===Resource.TextureType.WEBGL){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},roundRect:function(params,height,radius,color,borderWidth){if("object"!=typeof params)return this.roundRect({width:params,height:height,radius:radius,color:color,borderWidth:borderWidth}),void 0;if(!params)return console.warn("[Resource.Texture.rect]:","No parameters specified."),void 0;var ctx=this.ctx,width=params.width||1,height=params.height||1;params.color=params.color||"#0000000";var radius=params.radius||1,borderWidth=params.borderWidth||3;params.drawOver||this.resize(width,height),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.strokeStyle=params.color,ctx.lineWidth=borderWidth;var halfWidth=Math.ceil(borderWidth/2);if(borderWidth%2===1?(ctx.save(),ctx.translate(.5,.5),ctx.beginPath(),ctx.moveTo(halfWidth+radius,halfWidth),ctx.lineTo(width-halfWidth-radius,halfWidth),ctx.quadraticCurveTo(width-halfWidth,halfWidth,width-halfWidth,halfWidth+radius),ctx.lineTo(width-halfWidth,height-halfWidth-radius),ctx.quadraticCurveTo(width-halfWidth,height-halfWidth,width-halfWidth-radius,height-halfWidth),ctx.lineTo(halfWidth+radius,height-halfWidth),ctx.quadraticCurveTo(halfWidth,height-halfWidth,halfWidth,height-halfWidth-radius),ctx.lineTo(halfWidth,radius+halfWidth),ctx.quadraticCurveTo(halfWidth,halfWidth,halfWidth+radius,halfWidth),ctx.closePath(),ctx.stroke(),ctx.restore()):(ctx.beginPath(),ctx.moveTo(halfWidth+radius,halfWidth),ctx.lineTo(width-halfWidth-radius,halfWidth),ctx.quadraticCurveTo(width-halfWidth,halfWidth,width-halfWidth,halfWidth+radius),ctx.lineTo(width-halfWidth,height-halfWidth-radius),ctx.quadraticCurveTo(width-halfWidth,height-halfWidth,width-halfWidth-radius,height-halfWidth),ctx.lineTo(halfWidth+radius,height-halfWidth),ctx.quadraticCurveTo(halfWidth,height-halfWidth,halfWidth,height-halfWidth-radius),ctx.lineTo(halfWidth,radius+halfWidth),ctx.quadraticCurveTo(halfWidth,halfWidth,halfWidth+radius,halfWidth),ctx.closePath(),ctx.stroke()),params.fillColor&&(ctx.fillStyle=params.fillColor,ctx.fill()),this.textureType===Resource.TextureType.WEBGL){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},bazier:function(color,path,params){this.isLoaded=!0},emulateAnim:function(type,frames){if(!this._isLoaded)return console.warn("[Resource.Texture.emulateAnim]:","Texture is not loaded yet."),void 0;var animType=Resource.AnimType;type===animType.NONE?this._anim=null:(this._anim={type:type},this.isAnimated=!0,this.numFrames=frames,type===animType.LINEAR_H?this._anim.fill=this.trueWidth/(frames-1):type===animType.LINEAR_V?this._anim.fill=this.trueHeight/(frames-1):type===animType.RADIAL?(console.log("[Resource.Texture.emulateAnim]:","RADIAL is currently unsupported type."),this._anim.halfWidth=this.trueFullWidth/2,this._anim.halfHeight=this.trueFullHeight/2,this._anim.fill=2*Math.PI/(frames-1),this._anim.length=Math.sqrt(this._anim.halfWidth*this._anim.halfWidth+this._anim.halfHeight*this._anim.halfHeight)+1|0):(type===animType.RADIAL_TOP_LEFT||type===animType.RADIAL_TOP_RIGHT||type===animType.RADIAL_BOTTOM_LEFT||type===animType.RADIAL_BOTTOM_RIGHT)&&(this._anim.fill=2*Math.PI/(4*(frames-1)),this._anim.length=Math.sqrt(this.trueFullWidth*this.trueFullWidth+this.trueFullHeight*this.trueFullHeight)+1|0)),this.isLoaded=!0},gradient:function(data){if(!data)return console.warn("[Resource.Texture.gradient]:","No data specified."),void 0;if(!data.colors||!data.colors.length)return console.warn("[Resource.Texture.gradient]:","No data.colors specified."),void 0;var ctx=this.ctx;data.dirX=data.dirX||0,data.dirY=data.dirY||0,data.width=data.width||this.trueFullWidth||1,data.height=data.height||this.trueFullHeight||1,data.drawOver||this.resize(data.width,data.height),this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx);var colors=data.colors,numColors=colors.length,x1,x2,y1,y2;data.dirX<0?(x1=this.trueFullWidth,x2=0):(x1=0,x2=this.trueFullWidth*data.dirX),data.dirY<0?(y1=this.trueFullHeight,y2=0):(y1=0,y2=this.trueFullHeight*data.dirY);for(var gradient=ctx.createLinearGradient(x1,y1,x2,y2),i=0;numColors>i;i++)gradient.addColorStop(colors[i][0],colors[i][1]);if(ctx.fillStyle=gradient,ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight),ctx.fillRect(0,0,this.trueFullWidth,this.trueFullHeight),this.textureType){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},grid:function(params,cellHeight,numCellsX,numCellsY){if("number"==typeof params)return this.grid({cellWidth:params,cellHeight:cellHeight,numCellsX:numCellsX,numCellsY:numCellsY}),void 0;if(!params)return console.warn("[Resource.Texture.grid]:","No params specified."),void 0;var cellWidth=params.cellWidth||1,cellHeight=params.cellHeight||1,numCellsX=params.numCellsX||1,numCellsY=params.numCellsY||1;params.x=params.x||0,params.y=params.y||0,params.color=params.color||"#000000",params.borderWidth=params.borderWidth||1,params.drawOver=params.drawOver||!1;var width=params.x+params.cellWidth*params.numCellsX+1,height=params.y+params.cellHeight*params.numCellsY+1;params.drawOver||this.resize(width,height);var ctx=this.ctx;this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.strokeStyle=params.color,ctx.lineWidth=params.borderWidth,ctx.save(),ctx.translate(.5,.5);for(var x=0;numCellsX+1>x;x++)ctx.moveTo(x*cellHeight,0),ctx.lineTo(x*cellHeight,height);for(var y=0;numCellsY+1>y;y++)ctx.moveTo(0,y*cellHeight),ctx.lineTo(width,y*cellHeight);if(ctx.stroke(),ctx.restore(),this.textureType){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},onTextureEvent:function(event,data){event===Resource.Event.LOADED&&(this.tile(data),data.unsubscribe(this))},construct:function(data){if(!data)return console.warn("[Resource.Texture.buildMatrix]:","No parameters specified."),void 0;this._constructTex(data,"center"),this._constructTex(data,"left"),this._constructTex(data,"right"),data.width=data.width||this.trueFullWidth,data.height=data.height||this.trueFullHeight,this.resize(data.width,data.height),console.log(this.trueWidth,this.trueHeight);var left=data.width/2-data.center.width/2|0,top=data.height/2-data.center.height/2|0;console.log(left);var ctx=this.ctx;if(ctx.drawImage(data.center,left,top),this.textureType){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},_constructTex:function(data,texture){if(data[texture]&&"string"==typeof data[texture]){if(data[texture]=Resource.ctrl.getTexture(data[texture]),!data[texture])return console.warn("[Resource.Texture.buildMatrix]:","Undefined texture for: "+texture),void 0;data[texture]=data[texture].image}},generateAlphaMask:function(){if(!this._isLoaded)return console.warn("[Resource.Texture.generateMask]:","Texture is not loaded yet."),void 0;if(0!==this.textureType)return console.warn("[Resource.Texture.generateMask]:","Only canvas textures are supported currently."),void 0;var alphaMask=new Resource.Texture(Resource.TextureType.CANVAS);alphaMask.resize(this.trueFullWidth,this.trueFullHeight);for(var imgData=this.ctx.getImageData(0,0,this.trueFullWidth,this.trueFullHeight),data=imgData.data,numBytes=data.length,i=0;numBytes>i;i+=4)data[i]=255,data[i+1]=255,data[i+2]=255;return alphaMask.ctx.putImageData(imgData,0,0),alphaMask.isLoaded=!0,alphaMask},onTextureCacheEvent:function(data,event){event===Resource.Event.LOADED&&(data.unsubscribe(this),"drawOver"===this._loadCache.name?this.drawOver(this._loadCache.texture,this._loadCache.x,this._loadCache.y):this[this._loadCache.name](this._loadCache.data),this._loadCache=null)},set x(value){return this.ptr?(this.textureType?(this._xRatio=1/this.ptr.trueFullWidth,this._x=this._xRatio*value):this._x=value,void 0):(this._x=0,void 0)},set y(value){return this.ptr?(this.textureType?(this._yRatio=1/this.ptr.trueFullHeight,this._y=this._yRatio*value):this._y=value,void 0):(this._y=0,void 0)},get x(){return this._x},get y(){return this._y},set offsetX(x){this._offsetX=x,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},set offsetY(y){this._offsetY=y,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},set bgTexture(texture){if("string"==typeof texture){var obj=Resource.ctrl.getTexture(texture);if(!obj)return console.warn("[Resource.Texture.bgTexture]:","No such texture found: "+texture),void 0;texture=obj}this._bgTexture=texture,this.isLoaded=!0},get bgTexture(){return this._bgTexture},type:Resource.Type.TEXTURE,textureType:Resource.TextureType.UNKNOWN,image:null,ctx:null,_bgTexture:null,vbo:null,_vertices:null,_x:0,_y:0,_xRatio:0,_yRatio:0,_width:0,_height:0,fullWidth:0,fullHeight:0,_widthRatio:0,_heightRatio:0,_offsetX:0,_offsetY:0,unitRatio:1,fps:0,numFrames:1,numFramesX:1,numFramesY:1,isAnimated:!1,isLoop:!1,autoPlay:!0,isAnimReverse:!1,isEmulateReverse:!1,fromAtlas:!1,isReloading:!1,_tmpImg:null,_tmpCtx:null,_cachedImg:null,_cachedCtx:null,_anim:null,_frames:null,_loadCache:null,_canvasCache:null,_maxResCanvasCache:null,_maxResCtxCache:null}),"use strict",Resource.Sound=Resource.Basic.extend({init:function(param,path){if("string"==typeof param&&(path=param,param=void 0),path){var wildCardIndex=path.lastIndexOf(".");-1!==wildCardIndex&&path.length-wildCardIndex<=5&&(this.format=path.substr(wildCardIndex+1,path.length-wildCardIndex-1),path=path.substr(0,wildCardIndex)),this.path=Resource.ctrl.rootPath+path}this._instances=[];var self=this;meta.device.isAudioAPI?(this._request=new XMLHttpRequest,this._request.responseType="arraybuffer",this._request.onreadystatechange=function(){self._onStateChange()}):(this._context=this._getInstance(),this._context.audio.addEventListener("error",function(){self.format?self._onLoadFailed():self._loadNextExtension()}),this._numInstancesUsed=0)},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,Resource.ctrl.addToLoad(this);var resourceCtrl=Resource.ctrl;resourceCtrl.isSyncLoading?resourceCtrl.addToQueue(this):(this.syncLoading||(resourceCtrl.isSyncLoading=!0),this._loadNextExtension())}},forceLoad:function(){this._loadNextExtension()},_loadNextExtension:function(){var url;if(this.format)url=this.path;else{var audioFormats=meta.device.audioFormats;if(this._requestFormat++,this._requestFormat>audioFormats.length)return this._onLoadFailed(),void 0;url=this.path+"."+meta.device.audioFormats[this._requestFormat-1]}this._loadFromUrl(url)},_loadFromUrl:function(url){this._request.open("GET",url,!0),this._request.send()},_loadFromUrl_legacy:function(url){this._context.audio.src=url,this._context.audio.load()},_clear:function(){this._request.onreadystatechange=null,this._request=null},_clear_legacy:function(){},_onStateChange:function(){if(4===this._request.readyState)if(200===this._request.status){var self=this;this._context.decodeAudioData(this._request.response,function(buffer){self._onDecodeSuccess(buffer)},function(){self._onDecodeError()}),this._request=null}else this.format?this._onLoadFailed():this._loadNextExtension()},_onDecodeSuccess:function(buffer){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),this._buffer=buffer,this._isLoading=!1,this._clear(),this.isLoaded=!0,Resource.ctrl.loadSuccess(this);for(var numInstances=this._instances.length,i=0;numInstances>i;i++)this._createSource(this._instances[i])},_onDecodeError:function(){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),console.warn("[Resource.Sound.load]:","Error decoding file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},_onLoadFailed:function(){if(!this.format){var format=meta.device.audioFormats[this._requestFormat-1];format&&(this.path+="."+format)}console.warn("[Resource.Sound.load]:","Error loading file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},play:function(isLoop,time){var instance=this._getInstance();instance.isLoop=isLoop||!1,instance.play(time)},stop:function(){for(var i=0;i<this._numInstancesUsed;i++)this._instances[i]._stop();this._numInstancesUsed=0},pause:function(){for(var i=0;i<this._numInstancesUsed;i++)this._instances[i].pause()},resume:function(){for(var i=0;i<this._numInstancesUsed;i++)this._instances[i].resume()},_createSource:function(instance){var gainNode=this._context.createGain();gainNode.connect(this._context.destination);var source=this._context.createBufferSource();source.buffer=this._buffer,source.loop=instance._isLoop,source.connect(gainNode),source.start||(source.start=source.noteOn),source.stop||(source.stop=source.noteOff);var self=this;return source.onended=function(){self._clearInstance(instance)},instance.source=source,instance.gainNode=gainNode,source},_createInstance:function(){return new Resource.AudioInstance},_createInstance_legacy:function(){return new Resource.AudioInstance_legacy(this)},_getInstance:function(){this._instances.length===this._numInstancesUsed&&(this._instances.length+=1,this._instances[this._numInstancesUsed]=this._createInstance());var instance=this._instances[this._numInstancesUsed];return instance.id=this._numInstancesUsed,this._numInstancesUsed++,instance},_clearInstance:function(instance){this._numInstancesUsed--;var lastInstance=this._instances[this._numInstancesUsed];lastInstance.id=instance.id,this._instances[instance.id]=lastInstance},set volume(value){if(this._volume!==value){this._volume=value;for(var numInstances=this._instances.length,i=0;numInstances>i;i++)this._instances[i].volume=value}},get volume(){return this._volume},get isPlaying(){return this._numInstancesUsed>0?!0:!1},type:Resource.Type.SOUND,format:"",_instances:null,_numInstancesUsed:0,_autoIsLoop:!1,_autoTime:0,_context:null,_buffer:null,_request:null,_requestFormat:0,_volume:1,_isInQueue:!1,_syncLoading:!1}),Resource.AudioInstance=function(){this.id=-1,this.source=null,this.gainNode=null,this.auto,this._volume=1,this._mixedVolume=1},Resource.AudioInstance.prototype={set volume(value){this._mixedVolume=this._volume*value,this.gainNode.gain.value=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume}},Resource.AudioInstance_legacy=function(parent){this.id=-1,this.parent=parent,this.isPlaying=!1,this.isLoop=!1,this._canPlay=!1,this._metaLoaded=!1,this._isLoaded=!1,this._volume=1,this._mixedVolume=1,this.audio=new Audio,this.audio.preload="auto",this._addEvents(parent)},Resource.AudioInstance_legacy.prototype={play:function(time){this.isPlaying=!0,this._isLoaded?(this.audio.currentTime=time||0,this.audio.play()):this._autoPlay=!0},stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause(),this.parent._clearInstance(this)},_stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause()},pause:function(){this.isPlaying=!1,this.audio.pause()},resume:function(){this.isPlaying=!0,this.audio.play()},_addEvents:function(){var self=this,canPlayFunc=function(){self.audio.removeEventListener("canplaythrough",canPlayFunc),self._canPlay=!0,meta.device.support.onloadedmetadata&&self._metaLoaded&&self._onLoaded()};if(this.audio.addEventListener("canplaythrough",canPlayFunc,!1),meta.device.support.onloadedmetadata){var metaFunc=function(){self.audio.removeEventListener("loadedmetadata",metaFunc),self._metaLoaded=!0,self._canPlay&&self._onLoaded()};this.audio.addEventListener("loadedmetadata",metaFunc,!1)}this.audio.addEventListener("ended",function(){self._onEnd()},!1),this.parent._isLoaded&&(this.audio.src=this.parent.path,this.audio.load())},_onLoaded:function(){if(!this.parent._isLoaded){this.parent.format||(this.parent.path+="."+meta.device.audioFormats[this.parent._requestFormat-1]),this.parent._isLoading=!1,this.parent.isLoaded=!0;for(var instance,instances=this.parent._instances,numInstances=this.parent._instances.length,i=1;numInstances>i;i++)instance=instances[i],instance.audio.src=this.parent.path,instance.audio.load();Resource.ctrl.loadSuccess(parent),Resource.ctrl.loadNextFromQueue()}this._isLoaded=!0,this._autoPlay&&this.audio.play()},_onEnd:function(){this.isLoop?(this.audio.play(),this.audio.currentTime=0):this.isPlaying&&(this.isPlaying=!1,this.parent._clearInstance(this))},set currentTime(time){this.isPlaying?this.audio.currentTime=time||0:(this.audio.play(),this.audio.currentTime=time||0,this.audio.pause())},get currentTime(){return this.audio.currentTime},set volume(value){value>1?value=1:0>value&&(value=0),this._mixedVolume=this._volume*value,this.audio.volume=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume},_autoPlay:!1},"use strict",Resource.SpriteSheet=Resource.Basic.extend({init:function(param,path){if("string"==typeof param)path=param,param=void 0;else for(var key in param)this[key]=param[key];if(path){var wildCardIndex=path.lastIndexOf(".");-1!==wildCardIndex&&path.length-wildCardIndex<=5&&(this.format=path.substr(wildCardIndex+1,path.length-wildCardIndex-1),path=path.substr(0,wildCardIndex)),this.path=Resource.ctrl.rootPath+path,this.format||(this.format="xml")}},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,this._isAtlasLoaded=!1,this.texture?"string"==typeof this.texture&&(this.texture=new Resource.Texture(this.texture)):this.texture=new Resource.Texture(this.path),this.texture._isLoaded||(this.texture.subscribe(this,this._onTextureEvent),this.texture._isLoading||this.texture.load());var self=this,atlasPath=this.path+"."+this.format;this._request=new XMLHttpRequest,this._request.open("GET",atlasPath,!1),this._request.onreadystatechange=function(){self._onStateChange()},this._request.send(),Resource.ctrl.addToLoad(this)}},loadData:function(data,format){if(format=format||this.format,format||(format="xml"),this.format=format,this.isLoaded=!0,"xml"===format){var parser=new DOMParser,xml=parser.parseFromString(data,"text/xml");return this.loadXML(xml)}if("json"===format){var json=JSON.parse(data);return this.loadJSON(json)}if("plist"===format){var parser=new DOMParser,plist=parser.parseFromString(data,"text/xml");return this.loadPlist(plist)}return console.warn("[Resource.SpriteSheet.loadData]:","Trying to load an unsupported format - "+this.format),!1},loadXML:function(xml){if(!xml)return console.warn("[Resource.SpriteSheet.loadXML]:","Invalid XML file."),!1;for(var childNodes=xml.documentElement.childNodes,numNodes=childNodes.length,node,i=0;numNodes>i;i++)if(node=childNodes[i],"SubTexture"===node.nodeName)this._loadXML_Starling(node);else if("sprite"===node.nodeName)this._loadXML_genericXML(node);else if("dict"===node.nodeName)return this.loadPlist(xml);return!0},_loadXML_Starling:function(node){var texture=new Resource.Texture;texture.ptr=this.texture,texture.name=node.getAttribute("name"),texture.x=node.getAttribute("x"),texture.y=node.getAttribute("y"),texture._width=node.getAttribute("width"),texture._height=node.getAttribute("height"),texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture)},_loadXML_genericXML:function(node){var texture=new Resource.Texture;texture.ptr=this.texture,texture.name=node.getAttribute("n"),texture.x=node.getAttribute("x"),texture.y=node.getAttribute("y"),texture._width=node.getAttribute("w"),texture._height=node.getAttribute("h"),texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture)},loadPlist:function(plist){if(!plist)return console.warn("[Resource.SpriteSheet.loadPlist]:","Invalid Plist file."),!1;for(var childNodes=plist.documentElement.childNodes,numNodes=childNodes.length,node,i=0;numNodes>i;i++)if(node=childNodes[i],"dict"===node.nodeName)return this._loadPlist_dict(node)},_loadPlist_dict:function(node){for(var nodes=node.childNodes,numNodes=nodes.length,command="",i=0;numNodes>i;i++)if(node=nodes[i],"key"===node.nodeName)command=node.textContent;else if("dict"===node.nodeName){if(!command)continue;"frames"===command&&this._loadPlist_frames(node)}},_loadPlist_frames:function(node){for(var nodes=node.childNodes,numNodes=nodes.length,name="",i=0;numNodes>i;i++)node=nodes[i],"key"===node.nodeName?name=node.textContent:"dict"===node.nodeName&&this._loadPlist_frame(node,name)},_loadPlist_frame:function(node,name){var texture=new Resource.Texture;texture.ptr=this.texture,texture.name=name;for(var nodes=node.childNodes,numNodes=nodes.length,command="",data,i=0;numNodes>i;i++)if(node=nodes[i],"key"===node.nodeName)command=node.textContent;else if("string"===node.nodeName&&"frame"===command)return data=node.textContent.match(/[0-9]+/g),texture.x=parseInt(data[0]),texture.y=parseInt(data[1]),texture._width=parseInt(data[2]),texture._height=parseInt(data[3]),texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture),void 0},loadJSON:function(json){return json?(json.frames instanceof Array?this._loadJSON_array(json):this._loadJSON_hash(json),!0):(console.warn("[Resource.SpriteSheet.loadFromJSON]:","Invalid JSON file."),!1)},_loadJSON_array:function(json){for(var frame,texture,frames=json.frames,numFrames=frames.length,i=0;numFrames>i;i++)frame=frames[i],texture=new Resource.Texture,texture.ptr=this.texture,texture.name=frame.filename,frame=frame.frame,texture.x=frame.x,texture.y=frame.y,texture._width=frame.w,texture._height=frame.h,texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture)},_loadJSON_hash:function(json){var frame,texture,frames=json.frames;for(var key in frames)texture=new Resource.Texture,texture.ptr=this.texture,texture.name=key,frame=frames[key].frame,texture.x=frame.x,texture.y=frame.y,texture._width=frame.w,texture._height=frame.h,texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture)},loadAtlas:function(){if("object"!=typeof this.atlas)return console.warn("[Resource.SpriteSheet.loadFromAtlas]:","Incorrect atlas object, expected to be an Array."),!1;for(var frames=[],item,texture,name,numItems=this.atlas.length,i=0;numItems>i;i++)item=this.atlas[i],name=item.name||this.params,name?(item.x=item.x||this.params.x||0,item.y=item.y||this.params.y||0,item.width=item.width||this.params.width||1,item.height=item.height||this.params.height||1,frames.push(item),texture=new Resource.Texture,texture.ptr=this.texture,texture.name=name,texture.x=item.x,texture.y=item.y,texture._width=item.width,texture._height=item.height,texture.numFrames=item.numFrames||this.params.numFrames||1,texture.fromAtlas=!0,texture.isLoaded=!0,texture.update(),Resource.ctrl.add(texture)):console.warn("[Resource.SpriteSheet.loadFromAtlas]:","No name defined for atlas item in "+this.name+" spritesheet.");return this.texture._frames=frames,this.atlas=null,this.isLoaded=!0,!0},_onTextureEvent:function(data,event){event===Resource.Event.LOADED&&(this.texture.unsubscribe(this),this._isAtlasLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null))},_onStateChange:function(){4===this._request.readyState&&(200===this._request.status?(this._isAtlasLoaded=!0,this._response=this._request.response,this._request=null,this.texture._isLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null)):(this._isLoading=!1,this._request.onreadystatechange=null,this._request=null,Resource.ctrl.loadFailed(this)))},type:Resource.Type.SPRITE_SHEET,format:"",atlas:null,params:null,texture:null,_request:null,_response:null,_isAtlasLoaded:!1}),"use strict",Resource.Font=Resource.Basic.extend({init:function(param,path){if("string"==typeof param)path=param,param=void 0;else for(var key in param)this[key]=param[key];if(path){var wildCardIndex=path.lastIndexOf(".");
-1!==wildCardIndex&&path.length-wildCardIndex<=5&&(this.format=path.substr(wildCardIndex+1,path.length-wildCardIndex-1),path=path.substr(0,wildCardIndex)),this.path=Resource.ctrl.rootPath+path,this.format||(this.format="fnt")}},load:function(){console.log("load")},type:Resource.Type.FONT,format:""}),"use strict",window.Entity={},Entity.Controller=meta.Controller.extend({init:function(){var entityProto=Entity.Geometry.prototype;entityProto._entityCtrl=this,entityProto._parent=this,this.InputFlag=entityProto.InputFlag,this.entities=new Entity.DepthList,this.entitiesToAdd=[],this.entitiesToUpdate=[],this.entitiesToRemove=[],this.entitiesRemoveUpdate=[],this.detachBuffer=[],this._depthNode=new Entity.DepthList.Node,this._centerTex=new Resource.Texture,this._centerTex.fillRect({color:"#ff0000",width:6,height:6});var scope=meta;this._chnOnDown=scope.createChannel(Entity.Event.INPUT_DOWN),this._chnOnUp=scope.createChannel(Entity.Event.INPUT_UP),this._chnOnClick=scope.createChannel(Entity.Event.CLICK),this._chnOnDrag=scope.createChannel(Entity.Event.DRAG),this._chnOnDragStart=scope.createChannel(Entity.Event.DRAG_START),this._chnOnDragEnd=scope.createChannel(Entity.Event.DRAG_END),this._chnOnHover=scope.createChannel(Entity.Event.HOVER),this._chnOnHoverEnter=scope.createChannel(Entity.Event.HOVER_ENTER),this._chnOnHoverExit=scope.createChannel(Entity.Event.HOVER_EXIT),scope.subscribe(this,scope.Event.RESIZE,this.onResize),scope.subscribe(this,scope.Event.CAMERA_MOVE,this.onMove),scope.subscribe(this,scope.Event.ADAPT,this.onAdapt),scope.subscribe(this,scope.Event.ADDED_TO_VIEW,this.onAddToView),scope.subscribe(this,scope.Event.REMOVED_FROM_VIEW,this.onRemoveFromView),this.volume=scope.camera.volume,this.onMove(scope.camera,null)},release:function(){Entity.Geometry.prototype._entityCtrl=null,this.cells=null,this.entities=null,this.entitiesToAdd=null,this.entitiesToUpdate=null,this.entitiesToRemove=null,this.entitiesRemoveUpdate=null,this.detachBuffer=null,this.dynamicEntities=null,this._chnOnDown.remove(),this._chnOnUp.remove(),this._chnOnClick.remove(),this._chnOnDrag.remove(),this._chnOnDragStart.remove(),this._chnOnDragEnd.remove(),this._chnOnHover.remove(),this._chnOnHoverEnter.remove(),this._chnOnHoverExit.remove(),meta.unsubscribe(this,meta.Event.RESIZE),meta.unsubscribe(this,meta.Event.CAMERA_MOVE),meta.unsubscribe(this,meta.Event.ADDED_TO_VIEW,this.onAddToView),meta.unsubscribe(this,meta.Event.REMOVED_FROM_VIEW,this.onRemoveFromView),meta.unsubscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP],this.onInput),meta.unsubscribe(this,Input.Event.INPUT_MOVE)},load:function(){this.cells={};var volume=meta.camera.volume;if(this.startCellX=Math.floor(volume.minX/this._cellSizeX),this.startCellY=Math.floor(volume.minY/this._cellSizeY),this.endCellX=Math.floor(volume.maxX/this._cellSizeX),this.endCellY=Math.floor(volume.maxY/this._cellSizeY),this.entities.length>0){for(var dummyParent=Entity.Geometry.prototype._dummyParent,currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)currNode.entity._parent=dummyParent;this.entities.clear()}this.dynamicEntities=new Array(64);for(var entity,entities=meta.view.entities,numEntities=entities.length,i=0;numEntities>i;i++)entity=entities[i],entity._showBounds&&this.numShowBounds++,entity._parent===dummyParent&&(entity._parent=this);meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP],this.onInput,meta.Priority.HIGH),meta.subscribe(this,Input.Event.INPUT_MOVE,this.onInputMove,meta.Priority.HIGH)},unload:function(){for(var entity,numEntities=this.entities.length,i=0;numEntities>i;i++)entity=this.entities[i],entity._parent===this&&(entity._parent=null);this.numShowBounds=0,this.numEntitiesToUpdate=0},update:function(tDelta){this._isUpdateTick=!0;var i,n,entity,children,numChildren;for(this._flags&this.Flag.UPDATE_HOVER&&(this._checkHover(Input.ctrl.getEvent()),this._flags&=~this.Flag.UPDATE_HOVER),i=0;i<this.numEntitiesToUpdate;i++)entity=this.entitiesToUpdate[i],entity.isPaused||entity.isRemoved||(entity.update&&entity.update(tDelta),entity.components&&entity._updateComponents(tDelta));if(this.numDetachItems){for(i=0;i<this.numDetachItems;i++)if(entity=this.detachBuffer[i],children=entity._parent.children,numChildren=children.length,0!==numChildren)for(n=0;numChildren>n;n++)if(children[n]===entity){children[n]=children[numChildren-1],children.pop();break}this.detachBuffer.length=0,this.numDetachItems=0}if(this.numEntitiesToRemove){for(i=0;i<this.numEntitiesToRemove;i++)entity=this.entitiesToRemove[i],this.entities.remove(entity._depthNode),entity.removeFully();this.entitiesToRemove.length=0,this.numEntitiesToRemove=0,this.isNeedRender=!0}if(this.numEntitiesToAdd){for(i=0;i<this.numEntitiesToAdd;i++)this._addEntity(this.entitiesToAdd[i]);this.entitiesToAdd.length=0,this.numEntitiesToAdd=0}if(this.numEntitiesRemoveUpdate){var tmpEntity;for(i=0;i<this.numEntitiesRemoveUpdate;i++)entity=this.entitiesRemoveUpdate[i],this.entitiesRemoveUpdate[i]=null,4===(4&entity._removeFlag)&&(this.numEntitiesToUpdate--,tmpEntity=this.entitiesToUpdate[this.numEntitiesToUpdate],tmpEntity._updateNodeID=entity._updateNodeID,this.entitiesToUpdate[entity._updateNodeID]=tmpEntity,this.entitiesToUpdate[this.numEntitiesToUpdate]=null,entity._removeFlag&=-5,entity._updateNodeID=-1);this.numEntitiesRemoveUpdate=0}this._isUpdateTick=!1},_addToDrawBounds:function(){this.numShowBounds++,this.isNeedRender=!0},_removeToDrawBounds:function(){this.numShowBounds--,this.isNeedRender=!0},onAddToView:function(entities,event){var i,numEntities;if(this._isUpdateTick)if(entities instanceof Entity.Geometry)this.entitiesToAdd.push(entities),this.numEntitiesToAdd++;else{var numToAdd=entities.length;for(i=0;numToAdd>i;i++)this.entitiesToAdd.push(entities[i]);this.numEntitiesToAdd+=numToAdd}else if(entities instanceof Entity.Geometry)this._addEntity(entities);else for(numEntities=entities.length,i=0;numEntities>i;i++)this._addEntity(entities[i]);this._flags|=this.Flag.UPDATE_HOVER},onRemoveFromView:function(entities,event){if(entities instanceof Entity.Geometry)this._removeEntity(entities);else for(var numEntities=entities.length,i=0;numEntities>i;i++)this._removeEntity(entities[i])},_addEntity:function(entity){if(!entity.isRemoved&&!entity._depthNode.entity){entity.cellX=Math.floor(entity._x/this._cellSizeX),entity.cellY=Math.floor(entity._y/this._cellSizeY),entity._cellIndex=entity.cellX|entity.cellY<<16;var cell=this.cells[entity._cellIndex];if(cell||(cell=new Entity.CellArray,this.cells[entity._cellIndex]=cell),cell.push(entity),entity._depthNode.entity=entity,this.entities.push(entity._depthNode),entity.texture||(entity.isLoaded=!0),entity.children)for(var numChildren=entity.children.length,i=0;numChildren>i;i++)this._addEntity(entity.children[i]);entity.update&&(entity.isUpdating=!0),entity.isNeedStyle&&entity._style.update(entity),entity._isLoaded&&entity._texture&&this.cacheEntity(entity)}},_removeEntity:function(entity){if(entity._depthNode.entity&&(this.entitiesToRemove.push(entity),this.numEntitiesToRemove++,entity.children))for(var numChildren=entity.children.length,i=0;numChildren>i;i++)this._removeEntity(entity.children[i])},_addToUpdating:function(entity){return entity?4===(4&entity._removeFlag)?(entity._removeFlag&=-5,!0):-1!==entity._updateNodeID?!1:(entity._updateNodeID=this.numEntitiesToUpdate,this.entitiesToUpdate.length===this.numEntitiesToUpdate&&(this.entitiesToUpdate.length+=8),this.entitiesToUpdate[this.numEntitiesToUpdate]=entity,this.numEntitiesToUpdate++,!0):(console.warn("[Entity.Controller._addToUpdating]:","Invalid or object is null."),void 0)},_removeFromUpdating:function(entity){return entity?-1===entity._updateNodeID||4===(4&entity._removeFlag)?!1:(this.entitiesRemoveUpdate.length===this.numEntitiesRemoveUpdate&&(this.entitiesRemoveUpdate.length+=4),entity._removeFlag|=4,this.entitiesRemoveUpdate[this.numEntitiesRemoveUpdate]=entity,this.numEntitiesRemoveUpdate++,!0):(console.warn("[Entity.Controller._addToUpdating]:","Invalid or object is null."),void 0)},getFromVolume:function(volume){for(var entity,currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)if(entity=currNode.entity,entity.volume!==volume&&entity.volume.vsAABB(volume))return entity;return null},getFromPoint:function(x,y,exclude){for(var entity,currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)if(entity=currNode.entity,entity!==exclude&&entity.volume.vsPoint(x,y))return entity;return null},getFromEntity:function(entity){return this.getFromVolume(entity.volume)},cacheEntity:meta.emptyFuncParam,uncacheEntity:meta.emptyFuncParam,onResize:function(data,event){var volume=meta.camera.volume;this.prevStartCellX=this.startCellX,this.prevStartCellY=this.startCellY,this.prevEndCellX=this.endCellX,this.prevEndCellY=this.endCellY,this.startCellX=Math.floor(volume.minX/this._cellSizeX),this.startCellY=Math.floor(volume.minY/this._cellSizeY),this.endCellX=Math.floor(volume.maxX/this._cellSizeX),this.endCellY=Math.floor(volume.maxY/this._cellSizeY),this.isNeedRender=!0},onMove:function(data,event){var volume=data.volume;this.prevStartCellX=this.startCellX,this.prevStartCellY=this.startCellY,this.prevEndCellX=this.endCellX,this.prevEndCellY=this.endCellY,this.startCellX=Math.floor(volume.minX/this._cellSizeX),this.startCellY=Math.floor(volume.minY/this._cellSizeY),this.endCellX=Math.floor(volume.maxX/this._cellSizeX),this.endCellY=Math.floor(volume.maxY/this._cellSizeY);for(var loopStartX=Math.min(this.prevStartCellX,this.startCellX),loopStartY=Math.min(this.prevStartCellY,this.startCellY),loopEndX=Math.max(this.prevEndCellX,this.endCellX),loopEndY=Math.max(this.prevEndCellY,this.endCellY),index,cell,y=loopStartY;loopEndY>y;y++)for(var x=loopStartX;loopEndX>x;x++)index=x|y<<16;this.x=0|data._x,this.y=0|data._y,this.isNeedRender=!0},onAdapt:function(data,event){for(var entities=this.entities.buffer,numEntities=this.entities.length,i=0;numEntities>i;i++)entities[i].adapt()},onInput:function(data,event){if(this.enablePicking){this._checkHover(data);var inputEvent=Input.Event;if(inputEvent.INPUT_DOWN===event){if(!this.hoverEntity||!this.hoverEntity.clickable)return;data.entity=this.hoverEntity,this.pressedEntity=this.hoverEntity,this.pressedEntity._inputFlags|=this.InputFlag.PRESSED,this.pressedEntity._style&&this.pressedEntity._onDown.call(this.pressedEntity,data),this.pressedEntity.onDown.call(this.pressedEntity,data),this._chnOnDown.emit(data,Entity.Event.INPUT_DOWN)}else inputEvent.INPUT_UP===event&&this.pressedEntity&&this.pressedEntity.clickable&&(data.entity=this.hoverEntity,this.pressedEntity._inputFlags&=~this.InputFlag.PRESSED,this.pressedEntity._style&&this.pressedEntity._onUp.call(this.pressedEntity,event),this.pressedEntity.onUp.call(this.pressedEntity,event),this._chnOnUp.emit(this.pressedEntity,Entity.Event.INPUT_UP),this.pressedEntity===this.hoverEntity&&(this.pressedEntity._onClick.call(this.pressedEntity,data),this.pressedEntity.onClick.call(this.pressedEntity,data),this._chnOnClick.emit(data,Entity.Event.CLICK)),this.pressedEntity._inputFlags&this.InputFlag.DRAGGED&&(data.entity=this.pressedEntity,this.pressedEntity._inputFlags&=~this.InputFlag.DRAGGED,this.pressedEntity._style&&this.pressedEntity._onDragEnd.call(this.pressedEntity,data),this.pressedEntity.onDragEnd.call(this.pressedEntity,data),this._chnOnDragEnd.emit(data,Entity.Event.DRAG_END),data.entity=this.hoverEntity),this.pressedEntity=null)}},_checkHover:function(data){for(var entity,currNode=this.entities.last.prev,lastNode=this.entities.first;currNode!==lastNode;currNode=currNode.prev)if(entity=currNode.entity,entity.pickable&&entity.isInside(data.x,data.y))return this.hoverEntity!==entity?(this.hoverEntity&&(data.entity=this.hoverEntity,this.hoverEntity._inputFlags&=~this.InputFlag.HOVER,this.hoverEntity._style&&this.hoverEntity._onHoverExit.call(this.hoverEntity,data),this.hoverEntity.onHoverExit.call(this.hoverEntity,data),this._chnOnHoverExit.emit(data,Entity.Event.HOVER_EXIT)),data.entity=entity,entity._inputFlags|=this.InputFlag.HOVER,entity._style&&entity._onHoverEnter.call(entity,data),entity.onHoverEnter.call(entity,data),this._chnOnHoverEnter.emit(data,Entity.Event.HOVER_ENTER),this.hoverEntity=entity):(data.entity=entity,entity.onHover.call(entity,data),this._chnOnHover.emit(data,Entity.Event.HOVER)),data.entity=null,void 0;this.hoverEntity&&(data.entity=this.hoverEntity,this.hoverEntity._inputFlags&=~this.InputFlag.HOVER,this.hoverEntity._style&&this.hoverEntity._onHoverExit.call(this.hoverEntity,data),this.hoverEntity.onHoverExit.call(this.hoverEntity,data),this._chnOnHoverExit.emit(data,Entity.Event.HOVER_EXIT)),this.hoverEntity=null},_checkDrag:function(data){return this.pressedEntity&&this.pressedEntity.clickable?(data.entity=this.pressedEntity,this.pressedEntity._inputFlags&this.InputFlag.DRAGGED?(this.pressedEntity.onDrag.call(this.pressedEntity,data),this._chnOnDrag.emit(data,Entity.Event.DRAG),!1):(this.pressedEntity._inputFlags|=this.InputFlag.DRAGGED,this.pressedEntity._style&&this.pressedEntity._onDragStart.call(this.pressedEntity,data),this.pressedEntity.onDragStart.call(this.pressedEntity,data),this._chnOnDragStart.emit(data,Entity.Event.DRAG_START),!1)):!0},onInputMove:function(data,event){return this.enablePicking?(this._checkHover(data),this._checkDrag(data)?(data.entity=this.hoverEntity,void 0):(data.entity=this.hoverEntity,void 0)):void 0},getByID:function(id){for(var buffer=this.entities.buffer,num=this.entities.length,n=0;num>n;n++)if(id===buffer[n].id)return buffer[n]},getByName:function(name){for(var buffer=this.entities.buffer,num=this.entities.length,n=0;num>n;n++)if(name===buffer[n].name)return buffer[n]},getUniqueID:function(){return++this._uniqueID},set cellMagnitue(value){this._cellMagnitue!==value&&(this._cellMagnitue=value,this._cellSizeX=128*value,this._cellSizeY=128*value,this.isNeedRender=!0)},get cellMagnitue(){return this._cellMagnitue},Flag:{UPDATE_HOVER:128},InputFlag:null,_x:0,_y:0,_depthNode:null,totalAngleRad:0,totalAlpha:1,totalScaleX:1,totalScaleY:1,volume:null,pivotX:0,pivotY:0,_flags:0,cells:null,_cellSizeX:128,_cellSizeY:128,_cellMagnitue:1,startCellX:0,startCellY:0,endCellX:0,endCellY:0,prevStartCellX:0,prevStartCellY:0,prevEndCellX:0,prevEndCellY:0,_numCellX:0,_numCellY:0,entities:null,entitiesToCheck:null,entitiesToAdd:null,entitiesToRemove:null,entitiesToUpdate:null,entitiesRemoveUpdate:null,detachBuffer:null,dynamicEntities:null,numEntitiesToCheck:0,numEntitiesToAdd:0,numEntitiesToRemove:0,numEntitiesToUpdate:0,numEntitiesRemoveUpdate:0,numShowBounds:0,numDetachItems:0,_parent:null,childOffsetX:0,childOffsetY:0,hoverEntity:null,pressedEntity:null,isNeedRender:!0,_isUpdateTick:!1,enablePicking:!0,showBounds:!1,showCells:!1,_uniqueID:0,_centerTex:null,_chnOnDown:null,_chnOnUp:null,_chnOnClick:null,_chnOnDrag:null,_chnOnDragStart:null,_chnOnDragEnd:null,_chnOnHover:null,_chnOnHoverEnter:null,_chnOnHoverExit:null}),"use strict",Entity.Event={INPUT_UP:"entityUp",INPUT_DOWN:"entityDown",CLICK:"entityClick",DRAG:"drag",DRAG_START:"dragStart",DRAG_END:"dragEnd",HOVER:"hover",HOVER_ENTER:"hoverEnter",HOVER_EXIT:"hoverExit",STATE_CHANGE:"stateChange"},Entity.PositionType={CENTER:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_LEFT:3,BOTTOM_RIGHT:4,TOP:5,BOTTOM:6,LEFT:7,RIGHT:8},"use strict",Entity.WebGLRenderer=Entity.Controller.extend({init:function(){this._super();var gl=meta.ctx;this._worldTex=new Resource.Texture,this._worldTex.fillRect({color:"#7AA3CC",width:1,height:1}),this._highlightTex=new Resource.Texture,this._highlightTex.fillRect({color:"#339933",width:6,height:6}),this._position=new Float32Array([0,0]),this._center=new Float32Array([0,0]),this._scale=new Float32Array([0,0]),this.cameraPos=new Float32Array([0,0]);var texCoord=[0,0,1,0,0,1,1,1];this.texCoord=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.texCoord),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(texCoord),gl.STATIC_DRAW);var lineIndices=[0,1,3,2,0];this._lineIndices=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._lineIndices),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(lineIndices),gl.STATIC_DRAW),this._frameCoord=new Float32Array(4),gl.clearDepth(1),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.activeTexture(gl.TEXTURE0),gl.enable(gl.BLEND);var shader=meta.shader;this.locCameraPos=gl.getUniformLocation(shader.program,"cameraPos"),this.locZoom=gl.getUniformLocation(shader.program,"zoom"),this.locSampler=gl.getUniformLocation(shader.program,"sampler"),this.locAlpha=gl.getUniformLocation(shader.program,"alpha"),this.locPos=gl.getUniformLocation(shader.program,"pos"),this.locCenter=gl.getUniformLocation(shader.program,"center"),this.locScale=gl.getUniformLocation(shader.program,"scale"),this.locFrameCoord=gl.getUniformLocation(shader.program,"frameCoord"),this.locAngle=gl.getUniformLocation(shader.program,"angle")},ready:function(){meta.shader.bindBuffer2f("texCoord",this.texCoord)},render:function(tDelta){for(var entity,currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)entity=currNode.entity,entity.isNeedStyle&&entity._style.update(entity),entity._texture&&entity.isAnimating&&entity._updateAnim(tDelta);if(this.isNeedRender){var scope=meta,gl=scope.ctx,shader=scope.shader,camera=scope.camera,unitSize=scope.unitSize,texture,clipMinX,clipMinY,clipMaxX,clipMaxY;for(this.clearScreen(),this.cameraPos[0]=camera._x*meta.unitSize|0,this.cameraPos[1]=camera._y*meta.unitSize|0,gl.uniform2fv(this.locCameraPos,this.cameraPos),gl.uniform1f(this.locZoom,meta.camera._zoom*meta.unitRatio),gl.uniform1i(this.locSampler,0),currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)entity=currNode.entity,entity.isVisible&&entity.isLoaded&&entity.texture&&(texture=entity._texture,shader.bindBuffer2f("vertexPos",texture.vbo),this._clipVolume!==entity.clipVolume&&(entity.clipVolume?(this._clipVolume||gl.enable(gl.SCISSOR_TEST),this._clipVolume=entity.clipVolume,clipMinX=(this._clipVolume.minX+camera._x)*camera._zoom,clipMaxX=(this._clipVolume.maxX+camera._x)*camera._zoom,clipMinY=(camera.volume.height-(this._clipVolume.maxY+camera._y))*camera._zoom,clipMaxY=(camera.volume.height-(this._clipVolume.minY+camera._y))*camera._zoom,gl.scissor(0|clipMinX,0|clipMinY,Math.ceil(clipMaxX-clipMinX),Math.ceil(clipMaxY-clipMinY))):(gl.disable(gl.SCISSOR_TEST),this._clipVolume=null)),this._position[0]=1===entity._flipX?entity.volume.minX*unitSize|0:(entity.volume.minX+entity.volume.width)*unitSize|0,this._position[1]=1===entity._flipY?entity.volume.minY*unitSize|0:(entity.volume.minY+entity.volume.height)*unitSize|0,entity.isChild?(this._center[0]=(entity._parent.volume.x-entity._parent.pivotX+entity.volume.x)*unitSize,this._center[1]=(entity._parent.volume.y-entity._parent.pivotY+entity.volume.y)*unitSize):(this._center[0]=(entity.volume.x-entity.pivotX)*unitSize,this._center[1]=(entity.volume.y-entity.pivotY)*unitSize),this._scale[0]=entity.totalScaleX*entity._flipX,this._scale[1]=entity.totalScaleY*entity._flipY,this._frameCoord[0]=texture._x+entity.currFrame%entity._texture.numFramesX*texture._xRatio,this._frameCoord[1]=texture._y+Math.floor(entity.currFrame/entity._texture.numFramesX)*texture._yRatio,this._frameCoord[2]=texture._widthRatio,this._frameCoord[3]=texture._heightRatio,gl.uniform1f(this.locAlpha,entity.totalAlpha),gl.uniform2fv(this.locPos,this._position),gl.uniform2fv(this.locCenter,this._center),gl.uniform2fv(this.locScale,this._scale),gl.uniform4fv(this.locFrameCoord,this._frameCoord),gl.uniform1f(this.locAngle,entity.totalAngleRad),texture.fromAtlas?gl.bindTexture(gl.TEXTURE_2D,texture.ptr.image):gl.bindTexture(gl.TEXTURE_2D,texture.image),entity.ignoreZoom?(gl.uniform1f(this.locZoom,1),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),gl.uniform1f(this.locZoom,meta.camera._zoom)):gl.drawArrays(gl.TRIANGLE_STRIP,0,4),entity._isNeedDraw=!1);if(this._clipVolume&&gl.disable(gl.SCISSOR_TEST),this.numShowBounds>0||this.showBounds){for(gl.disable(gl.BLEND),gl.uniform1f(this.locAlpha,1),gl.lineWidth(2),currNode=this.entities.first.next;currNode!==lastNode;currNode=currNode.next)entity=currNode.entity,(entity.showBounds||this.showBounds)&&!entity.disableDebug&&entity.isVisible&&entity.isLoaded&&(this._position[0]=1===entity._flipX?entity.volume.minX*unitSize|0:(entity.volume.minX+entity.volume.width)*unitSize|0,this._position[1]=1===entity._flipY?entity.volume.minY*unitSize|0:(entity.volume.minY+entity.volume.height)*unitSize|0,entity.isChild?(this._center[0]=(entity._parent.volume.x-entity._parent.pivotX+entity.volume.x)*unitSize,this._center[1]=(entity._parent.volume.y-entity._parent.pivotY+entity.volume.y)*unitSize):(this._center[0]=(entity.volume.x-entity.pivotX)*unitSize,this._center[1]=(entity.volume.y-entity.pivotY)*unitSize),this._scale[0]=entity.totalScaleX*entity._flipX,this._scale[1]=entity.totalScaleY*entity._flipY,entity.isHighlight?gl.bindTexture(gl.TEXTURE_2D,this._highlightTex.image):gl.bindTexture(gl.TEXTURE_2D,this._centerTex.image),gl.uniform2fv(this.locPos,this._position),gl.uniform2fv(this.locCenter,this._center),gl.uniform2fv(this.locScale,this._scale),gl.uniform1f(this.locAngle,entity.totalAngleRad),shader.bindBuffer2f("vertexPos",entity.texture.vbo),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._lineIndices),gl.drawElements(gl.LINE_STRIP,5,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),shader.bindBuffer2f("vertexPos",this._centerTex.vbo),entity.isHighlight?gl.bindTexture(gl.TEXTURE_2D,this._highlightTex.image):gl.bindTexture(gl.TEXTURE_2D,this._centerTex.image),gl.lineWidth(2),this._position[0]=(entity.volume.x-entity.pivotX-3)*unitSize,this._position[1]=(entity.volume.y-entity.pivotY-3)*unitSize,this._scale[0]=unitSize,this._scale[1]=unitSize,gl.uniform2fv(this.locPos,this._position),gl.uniform2fv(this.locScale,this._scale),entity.ignoreZoom?(gl.uniform1f(this.locZoom,1),gl.drawArrays(gl.TRIANGLE_STRIP,0,4),gl.uniform1f(this.locZoom,meta.camera._zoom)):gl.drawArrays(gl.TRIANGLE_STRIP,0,4));gl.enable(gl.BLEND)}var world=meta.world;if(world.showBounds){if(shader.bindBuffer2f("vertexPos",this._worldTex.vbo),gl.bindTexture(gl.TEXTURE_2D,this._worldTex.image),this._scale[0]=world.width,this._scale[1]=world.height,gl.uniform2fv(this.locScale,this._scale),this._position[0]=0,this._position[1]=0,gl.uniform2fv(this.locPos,this._position),this._center[0]=0,this._center[1]=0,gl.uniform2fv(this.locCenter,this._center),gl.uniform1f(this.locAngle,0),gl.uniform1f(this.locAlpha,1),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._lineIndices),gl.lineWidth(2),gl.drawElements(gl.LINE_STRIP,5,gl.UNSIGNED_SHORT,0),world.haveGrid){var numX=world.numGridX,numY=world.numGridY;this._scale[0]=world.gridWidth,this._scale[1]=world.gridHeight,gl.uniform2fv(this.locScale,this._scale);for(var y=0;numY>y;y++)for(var x=0;numX>x;x++)this._position[0]=x*world.gridWidth+world.gridX,this._position[1]=y*world.gridHeight+world.gridY,gl.uniform2fv(this.locPos,this._position),gl.drawElements(gl.LINE_STRIP,5,gl.UNSIGNED_SHORT,0)}gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)}this.isNeedRender=!1}},clearScreen:function(){var gl=meta.ctx;gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)},_worldTex:null,_highlightTex:null,_position:null,_center:null,_scale:null,_frameCoord:null,_clipVolume:null,locCameraPos:null,locZoom:null,locSampler:null,locAlpha:null,locPos:null,locCenter:null,locScale:null,locFrameCoord:null,locAngle:null}),"use strict",Entity.CanvasRenderer=Entity.Controller.extend({init:function(){meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onCameraResize),this._super(),this._tStaticCheck=Date.now()},release:function(){this._super(),meta.unsubscribe(this,meta.Event.CAMERA_RESIZE)},render:function(tDelta){var currNode=this.entities.first.next;if(this.isNeedRender)this._renderAll(currNode,tDelta);else for(var entity,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)if(entity=currNode.entity,entity.isNeedStyle&&entity._style.update(entity),entity._texture&&entity.isAnimating&&entity._updateAnim(tDelta),entity._isLoaded&&entity.isNeedDraw){this._reRender(currNode.next,tDelta);break}},_reRender:function(untilNode,tDelta){this.clearScreen();var scope=meta,ctx=scope.ctx,camera=scope.camera,unitRatio=scope.unitRatio,unitSize=scope.unitSize;ctx.save(),ctx.translate(this.x*camera._zoom|0,this.y*camera._zoom|0),ctx.scale(camera._zoom*unitRatio,camera._zoom*unitRatio);for(var entity,currNode=this.entities.first.next;currNode!==untilNode;currNode=currNode.next)if(entity=currNode.entity,!entity._isCached&&entity.isVisible&&entity._isLoaded){if(this._clipVolume!==entity.clipVolume){if(null===entity.clipVolume)ctx.restore();else{ctx.save();var clip=entity.clipVolume;ctx.beginPath(),ctx.rect(clip.minX*unitSize|0,clip.minY*unitSize|0,clip.width*unitSize,clip.height*unitSize),ctx.closePath(),ctx.clip()}this._clipVolume=entity.clipVolume}entity.ignoreZoom?(ctx.restore(),ctx.save(),entity.draw(ctx),ctx.scale(camera._zoom*unitRatio,camera._zoom*unitRatio)):entity.draw(ctx),entity._isNeedDraw=!1}for(var lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)if(entity=currNode.entity,entity.isNeedStyle&&entity._style.update(entity),entity._texture&&entity.isAnimating&&entity._updateAnim(tDelta),!entity._isCached&&entity.isVisible&&entity._isLoaded){if(this._clipVolume!==entity.clipVolume){if(null===entity.clipVolume)ctx.restore();else{ctx.save();var clip=entity.clipVolume;ctx.beginPath(),ctx.rect(clip.minX*unitSize|0,clip.minY*unitSize|0,clip.width*unitSize,clip.height*unitSize),ctx.closePath(),ctx.clip()}this._clipVolume=entity.clipVolume}entity.ignoreZoom?(ctx.restore(),ctx.save(),entity.draw(ctx),ctx.scale(camera._zoom*unitRatio,camera._zoom*unitRatio)):entity.draw(ctx),entity._isNeedDraw=!1}null!==this._clipVolume&&(this._clipVolume=null,ctx.restore()),ctx.restore(),ctx.save(),ctx.scale(camera._zoom,camera._zoom),ctx.translate(0|this.x,0|this.y),this._drawBounds(),this.showCells&&this._drawCells(),ctx.restore(),this.isNeedRender=!1},_renderAll:function(currNode,tDelta){this.clearScreen();var scope=meta,ctx=scope.ctx,camera=scope.camera,unitRatio=scope.unitRatio,unitSize=scope.unitSize;ctx.save(),ctx.translate(this.x*camera._zoom|0,this.y*camera._zoom|0),ctx.scale(camera._zoom*unitRatio,camera._zoom*unitRatio);for(var entity,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)if(entity=currNode.entity,entity.isNeedStyle&&entity._style.update(entity),entity._texture&&entity.isAnimating&&entity._updateAnim(tDelta),!entity._isCached&&entity.isVisible&&entity._isLoaded){if(this._clipVolume!==entity.clipVolume){if(null===entity.clipVolume)ctx.restore();else{ctx.save();var clip=entity.clipVolume;ctx.beginPath(),ctx.rect(clip.minX*unitSize|0,clip.minY*unitSize|0,clip.width*unitSize,clip.height*unitSize),ctx.closePath(),ctx.clip()}this._clipVolume=entity.clipVolume}entity.ignoreZoom?(ctx.restore(),ctx.save(),entity.draw(ctx),ctx.scale(camera._zoom*unitRatio,camera._zoom*unitRatio)):entity.draw(ctx),entity._isNeedDraw=!1}null!==this._clipVolume&&(this._clipVolume=null,ctx.restore()),ctx.restore(),ctx.save(),ctx.scale(camera._zoom,camera._zoom),ctx.translate(0|this.x,0|this.y),this._drawBounds(),this.showCells&&this._drawCells(),ctx.restore(),this.isNeedRender=!1},clearScreen:function(){var scope=meta;scope.view.bgTransparent?scope.ctx.clearRect(0,0,scope.width,scope.height):(scope.ctx.fillStyle=scope.view.bgColor,scope.ctx.fillRect(0,0,scope.width,scope.height))},_drawBounds:function(){if(this.numShowBounds>0||this.showBounds){var isCached=!1,unitSize=meta.unitSize,unitRatio=meta.unitRatio,camera=meta.camera,ctx=meta.ctx;ctx.strokeStyle="#ff0000",ctx.lineWidth=2;for(var entity,pivotOffsetX,pivotOffsetY,parentOffsetX,parentOffsetY,currNode=this.entities.first.next,lastNode=this.entities.last;currNode!==lastNode;currNode=currNode.next)entity=currNode.entity,(entity.showBounds||this.showBounds)&&!entity.disableDebug&&entity.isVisible&&entity.isLoaded&&(isCached!==entity._isCached&&(ctx.strokeStyle=entity.isCached||entity.isHighlight?"#339933":"#ff0000",isCached=!isCached),ctx.save(),pivotOffsetX=entity.volume.x-entity.pivotX,pivotOffsetY=entity.volume.y-entity.pivotY,entity.isChild?(parentOffsetX=entity._parent.volume.x-entity._parent.pivotX,parentOffsetY=entity._parent.volume.y-entity._parent.pivotY,ctx.translate(parentOffsetX,parentOffsetY),ctx.rotate(entity._parent.totalAngleRad),ctx.translate(-parentOffsetX,-parentOffsetY),ctx.translate(pivotOffsetX,pivotOffsetY),ctx.rotate(entity._angleRad),ctx.translate(-pivotOffsetX,-pivotOffsetY)):(ctx.translate(pivotOffsetX,pivotOffsetY),ctx.rotate(entity._angleRad),ctx.translate(-pivotOffsetX,-pivotOffsetY)),entity.volume.draw(ctx),this._centerTex.draw(ctx,pivotOffsetX-3,pivotOffsetY-3),ctx.restore())}},_drawWorldBounds:function(){var world=meta.world;if(world.showBounds){var ctx=meta.ctx;if(ctx.translate(this.x,this.y),ctx.strokeStyle="#7AA3CC",ctx.lineWidth=2,world.volume.draw(ctx),world.haveGrid){var numX=world.numGridX,numY=world.numGridY,width=numX*world.gridWidth,height=numY*world.gridHeight;ctx.translate(world.gridX,world.gridY);for(var x=0;numX>=x;x++)ctx.moveTo(x*world.gridWidth,0),ctx.lineTo(x*world.gridHeight,height);for(var y=0;numY>=y;y++)ctx.moveTo(0,y*world.gridHeight),ctx.lineTo(width,y*world.gridHeight);ctx.stroke()}}},_drawCells:function(){var unitSize=meta.unitSize,ctx=meta.ctx;ctx.strokeStyle="orange",ctx.lineWidth=2,ctx.beginPath();for(var offsetX=this.x%this._cellSizeX,offsetY=this.y%this._cellSizeY,numCellX=this.endCellX-this.startCellX,numCellY=this.endCellY-this.startCellY,x=0;numCellX>=x;x++)ctx.moveTo(offsetX+x*this._cellSizeX,0),ctx.lineTo(offsetX+x*this._cellSizeX,meta.camera.height);for(var y=0;numCellY>=y;y++)ctx.moveTo(0,offsetY+y*this._cellSizeY),ctx.lineTo(meta.camera.width,offsetY+y*this._cellSizeY);ctx.stroke()},cacheEntity:function(entity){},uncacheEntity:function(entity){},onCameraResize:function(event,data){},_cachedCanvas:null,_cachedCtx:null,_cacheOffsetX:0,_cacheOffsetY:0,_tStaticCheck:0,tStaticCheckDelay:500,_clipVolume:null,x:0,y:0}),"use strict",Entity.Geometry=meta.Class.extend({_init:function(params){this.id=this._entityCtrl.getUniqueID(),this.name="entity"+this.id,this.volume=new meta.math.AdvAABB(0,0,0,0),this._parent=this._entityCtrl,this._depthNode=new Entity.DepthList.Node,this._initParams(params)},_initParams:function(params){if(params)if("object"==typeof params)if(params instanceof Resource.Texture)this.texture=params;else for(var key in params)this[key]=params[key];else"string"==typeof params&&(this.texture=params)},get parent(){return this._parent},remove:function(){this.isRemoved||(this.isRemoved=!0,this._view?(this._parent===this._entityCtrl?this._view.remove(this):this._view._isActive?(this._entityCtrl.entitiesToRemove.push(this),this._entityCtrl.numEntitiesToRemove++):this._view=null,this._tween&&(this._tween.clear(),this._tween.owner=null),this.children&&this.removeChilds()):this.components&&this.removeComponents(),this.chn=null,this._onResize&&(this.onResize=null))},removeFully:function(){this.isUpdating=!1,this._depthNode.entity=null,this.components&&this.removeComponents()},removeChilds:function(){for(var numChildren=this.children.length,i=0;numChildren>i;i++)this.children[i].remove()},clone:function(){var clone=new Entity.Geometry;for(var key in this)clone[key]!==this[key]&&(clone[key]=this[key]);return clone.id=this._entityCtrl.getUniqueID(),clone},draw:function(ctx){this._draw(ctx)},_draw:function(ctx){this._drawDefault(ctx)},_drawDefault:function(ctx){if(this._texture){var unitSize=this.meta.unitSize;this._texture.isAnimated?this._texture.drawFrame(ctx,(0|this.drawX)*unitSize,(0|this.drawY)*unitSize,this._currFrame,this.isEmulateReverse):this._texture.draw(ctx,(0|this.drawX)*unitSize,(0|this.drawY)*unitSize)
}},_drawTransform:function(ctx){if(this._texture){ctx.save(),ctx.globalAlpha=this.totalAlpha;var unitSize=this.meta.unitSize,posX=(this.volume.x-this.pivotX)*unitSize,posY=(this.volume.y-this.pivotY)*unitSize;if(this.isChild){var parentOffsetX=(this._parent.volume.x-this._parent.pivotX)*unitSize,parentOffsetY=(this._parent.volume.y-this._parent.pivotY)*unitSize;ctx.translate(parentOffsetX,parentOffsetY),ctx.rotate(this._parent.totalAngleRad),ctx.translate(-parentOffsetX,-parentOffsetY),ctx.translate(posX,posY),ctx.rotate(this._angleRad),ctx.scale(this.totalScaleX,this.totalScaleY),ctx.translate(-posX,-posY)}else ctx.translate(posX,posY),ctx.rotate(this._angleRad),ctx.scale(this.totalScaleX,this.totalScaleY),ctx.translate(-posX,-posY);this.texture.isAnimated?this._texture.drawFrame(ctx,(0|this.drawX)*unitSize,(0|this.drawY)*unitSize,this._currFrame,this.isEmulateReverse):this._texture.draw(ctx,(0|this.drawX)*unitSize,(0|this.drawY)*unitSize),ctx.restore()}},update:null,_updateComponents:function(tDelta){for(var comp,n=0;n<this.numComponents;n++)comp=this.componentBuffer[n],comp.update&&comp.update(tDelta)},_updateAnim:function(tDelta){if(!(this.animSpeed<=0||this._texture.numFrames<2)){var delay=1/(this.fps*this.animSpeed);if(this._tAnim+=tDelta,!(this._tAnim<delay)){this.isNeedDraw=!0;var numFrames=this._tAnim/delay|0;this._tAnim-=delay*numFrames,this._isAnimReverse?(this._currFrame-=numFrames,this._currFrame<0&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=0):this.isLoop||this._texture.isLoop?this._currFrame=(this._texture.numFrames+this._currFrame)%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1),this.onAnimEnd&&this.onAnimEnd())):(this._currFrame+=numFrames,this._currFrame>=this._texture.numFrames&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1):this.isLoop||this._texture.isLoop?this._currFrame=this._currFrame%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=0),this.onAnimEnd&&this.onAnimEnd()))}}},play:function(isLoop,fps){this.texture&&this.texture.isAnimated&&(this.isLoop=isLoop?!0:!1,this.fps=fps||this.texture.fps,this.currFrame=0,this.isAnimating=!0,this.pauseAtEnd=!1,this._isAnimReverse=!1)},playAndPause:function(fps){this.play(!1,fps),this.pauseAtEnd=!0},playReverse:function(isLoop,fps){this.texture&&(this.play(isLoop,fps),this.currFrame=this.texture.numFrames-1,this._isAnimReverse=!0)},playReverseAndPause:function(fps){this.playReverse(!1,fps),this.pauseAtEnd=!0},stop:function(){this._texture?(this.isLoop=this._texture.isLoop,this.currFrame=this._isAnimReverse?this._texture.numFrames-1:0):(this.isLoop=!1,this.currFrame=0),this.isAnimating=!1},pause:function(){this.isAnimating=!1},resume:function(){this.isAnimating=!0},forcePosition:function(x,y){this._x=x,this._y=y,this.updatePos()},updatePos:function(){if(this._tmpX=this._x+this.textureOffsetX+this.offsetX+this._anchorPosX+this._parent.childOffsetX,this._tmpY=this._y+this.textureOffsetY+this.offsetY+this._anchorPosY+this._parent.childOffsetY,this._view&&(this._tmpX+=this._view._x,this._tmpY+=this._view._y),this.volume.set(this._tmpX+this.pivotX,this._tmpY+this.pivotY),this.drawX=this._tmpX-this.volume.initHalfWidth+this.pivotSrcX,this.drawY=this._tmpY-this.volume.initHalfHeight+this.pivotSrcY,this.children){this.childOffsetX=this._tmpX+this.childPivotX,this.childOffsetY=this._tmpY+this.childPivotY;for(var numChildren=this.children.length,i=0;numChildren>i;i++)this.children[i].updatePos()}this.isNeedDraw=!0},updatePosType:function(){0!==this.positionType&&(1===this.positionType?(this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0):2===this.positionType?(this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0):3===this.positionType?(this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0):4===this.positionType?(this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0):5===this.positionType?this._y=this.typeY+this.volume.halfHeight|0:6===this.positionType?this._y=this.typeY-this.volume.halfHeight|0:7===this.positionType?this._x=this.typeX+this.volume.halfWidth|0:8===this.positionType&&(this._x=this.typeX-this.volume.halfWidth|0))},updateFromTexture:function(){var unitRatio=this.meta.unitRatio;if(this.volume.resize(this._texture.trueWidth*unitRatio,this._texture.trueHeight*unitRatio),this.updatePivot(),this.updatePosType(),this.updatePos(),this.children)for(var numChildren=this.children.length,i=0;numChildren>i;i++){var child=this.children[i];child.positionType&&child.updatePosType(),child.updateAnchor()}},adapt:function(){this._texture||(this.volume.unitSize=meta.unitSize,this.updatePosType(),this.updatePos())},position:function(x,y){this.positionType=0,(this._x!==x||this._y!==y)&&(this._x=x,this._y=y,this.updatePos())},move:function(deltaX,deltaY){var newX=this._x+deltaX,newY=this._y+deltaY;(this._x!==newX||this._y!==newY)&&this.forcePosition(newX,newY)},moveForward:function(delta){var newX=this._x+delta*Math.cos(this._angleRad-1.57079),newY=this._y+delta*Math.sin(this._angleRad-1.57079);(this._x!==newX||this._y!==newY)&&this.forcePosition(newX,newY)},moveDirected:function(delta,angleOffset){var newX=this._x+-delta*Math.cos(this._angleRad-1.57079+angleOffset),newY=this._y+-delta*Math.sin(this._angleRad-1.57079+angleOffset);(this._x!==newX||this._y!==newY)&&this.forcePosition(newX,newY)},strafe:function(delta){var newX=this._x+-delta*Math.cos(this._angleRad+Math.PI),newY=this._y+-delta*Math.sin(this._angleRad+Math.PI);(this._x!==newX||this._y!==newY)&&this.forcePosition(newX,newY)},positionTopLeft:function(x,y){(this._x!==x||this._y!==y||1!==this.positionType)&&(this.positionType=1,this.typeX=x,this.typeY=y,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionTopRight:function(x,y){(this._x!==x||this._y!==y||2!==this.positionType)&&(this.positionType=2,this.typeX=x,this.typeY=y,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionBottomLeft:function(x,y){(this._x!==x||this._y!==y||3!==this.positionType)&&(this.positionType=3,this.typeX=x,this.typeY=y,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionBottomRight:function(x,y){(this._x!==x||this._y!==y||4!==this.positionType)&&(this.positionType=4,this.typeX=x,this.typeY=y,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionTop:function(x,y){(this._x!==x||this._y!==y||5!==this.positionType)&&(this.positionType=5,this.typeX=x,this.typeY=y,this._x=x,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionBottom:function(x,y){(this._x!==x||this._y!==y||6!==this.positionType)&&(this.positionType=6,this.typeX=x,this.typeY=y,this._x=x,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionLeft:function(x,y){(this._x!==x||this._y!==y||7!==this.positionType)&&(this.positionType=7,this.typeX=x,this.typeY=y,this._x=this.typeX+this.volume.halfWidth|0,this._y=y,this.updatePos())},positionRight:function(x,y){(this._x!==x||this._y!==y||8!==this.positionType)&&(this.positionType=8,this.typeX=x,this.typeY=y,this._x=this.typeX-this.volume.halfWidth|0,this._y=y,this.updatePos())},topLeft:function(x,y){(this._x!==x||this._y!==y||1!==this.positionType)&&(this.positionType=1,this.typeX=x,this.typeY=y,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},topRight:function(x,y){(this._x!==x||this._y!==y||2!==this.positionType)&&(this.positionType=2,this.typeX=x,this.typeY=y,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},bottomLeft:function(x,y){(this._x!==x||this._y!==y||3!==this.positionType)&&(this.positionType=3,this.typeX=x,this.typeY=y,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},bottomRight:function(x,y){(this._x!==x||this._y!==y||4!==this.positionType)&&(this.positionType=4,this.typeX=x,this.typeY=y,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},set top(y){this.positionTop(this._x,y)},set bottom(y){this.positionBottom(this._x,y)},set left(x){this.positionLeft(x,this._y)},set right(x){this.positionRight(x,this._y)},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},get left(){return this.volume.minX},get right(){return this.volume.maxX},pivot:function(x,y){void 0===y&&(y=x),this.pivotRatioX=x,this.pivotRatioY=y,this.updatePivot(),this.updatePos()},updatePivot:function(){this.pivotSrcX=-this.pivotRatioX*this.volume.initHalfWidth,this.pivotSrcY=-this.pivotRatioY*this.volume.initHalfHeight,this.pivotX=this.pivotSrcX*this._scaleX,this.pivotY=this.pivotSrcY*this._scaleY,this.children&&(this.childPivotX=(-this.pivotRatioX-1)*this.volume.initHalfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.initHalfHeight,this.childOffsetX=this._x+this.childPivotX+this._anchorPosX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY)},pivotPx:function(x,y){void 0===y&&(y=x),this.pivotX=x,this.pivotY=y,this.children&&(this.childOffsetX=this._x+pivotX+this._anchorPosX,this.childOffsetY=this._y+pivotY+this._anchorPosY),this.updatePos()},pivotCenter:function(x,y){return 0!==this.pivotRatioX&&0!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(0,0),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotTopLeft:function(x,y){return-1!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(-1,-1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotTopRight:function(x,y){return 1!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(1,-1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotBottomLeft:function(x,y){return-1!==this.pivotRatioX&&1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(-1,1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotBottomRight:function(x,y){return 1!==this.pivotRatioX&&1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(1,1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotTop:function(x,y){return 0!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(0,-1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotBottom:function(x,y){return 0!==this.pivotRatioX||1!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(0,1),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotLeft:function(x,y){return-1!==this.pivotRatioX||0!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(-1,0),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},pivotRight:function(x,y){return 1!==this.pivotRatioX||0!==this.pivotRatioY?(this._x=x,this._y=y,this.pivot(1,0),void 0):((this._x!==x||this._y!==y)&&this.forcePosition(x,y),void 0)},anchor:function(x,y){void 0===y&&(y=x),(this._anchorX!==x||this._anchorY!==y)&&(this._anchorX=x,this._anchorY=y,this._flags|=this.Flag.ANCHOR,this.updateAnchor())},updateAnchor:function(){this._flags&this.Flag.IGNORE_ZOOM?(this._anchorPosX=this._parent.volume.width*(1/this._parent.volume.scaleX)*this._anchorX+.5|0,this._anchorPosY=this._parent.volume.height*(1/this._parent.volume.scaleY)*this._anchorY+.5|0):(this._anchorPosX=this._parent.volume.width*this._anchorX+.5|0,this._anchorPosY=this._parent.volume.height*this._anchorY+.5|0),this.updatePos()},dragStart:function(x,y){this._dragOffsetX=this._x+this._anchorPosX-x,this._dragOffsetY=this._y+this._anchorPosY-y},dragEnd:function(){this._dragOffsetX=0,this._dragOffsetY=0},dragTo:function(x,y){x-=this._anchorPosX-this._dragOffsetX,y-=this._anchorPosY-this._dragOffsetY,(this._x!==x||this._y!==y)&&this.forcePosition(x,y)},isInside:function(x,y){return this.volume.vsBorderPoint(x-this.offsetX,y-this.offsetY)},_isInsideDefault:function(x,y){return this.volume.vsBorderPoint(x-this.offsetX,y-this.offsetY)},_isInsideTransform:function(x,y){var centerX=this._anchorPosX+this._parent.childOffsetX-this.offsetX,centerY=this._anchorPosY+this._parent.childOffsetY-this.offsetY;this.isChild||(centerX+=this._x,centerY+=this._y);var offsetX=x-centerX,offsetY=y-centerY,sin=Math.sin(-this._angleRad),cos=Math.cos(-this._angleRad),newX=offsetX*cos-offsetY*sin+centerX,newY=offsetY*cos+offsetX*sin+centerY;return this.volume.vsBorderPoint(newX,newY)},vsEntity:function(entity){return this.volume.vsAABB(entity.volume)},resize:function(width,height){void 0===height&&(height=this.volume.height),this.volume.resize(width,height)},_onTextureEvent:function(data,event){var resEvent=Resource.Event;event===resEvent.LOADED?(this.updateFromTexture(),this.isLoaded=!0):event===resEvent.UNLOADED?this.isLoaded=!1:event===resEvent.RESIZE?this.updateFromTexture():event===resEvent.CHANGED&&this.updateFromTexture(),this.isNeedDraw=!0},_onResAllLoaded:function(data,event){if("string"==typeof this._texture){var texture=meta.getTexture(this._texture);texture?this.texture=texture:(console.warn("[Entity.Geometry._onResAllLoaded]:","Could not find texture with a name: "+this._texture),this._texture=null),meta.unsubscribe(this,Resource.Event.ALL_LOADED)}},attach:function(entity,isRelative){if(!entity)return console.error("[Entity.Geometry.attach]:","Invalid child object passed."),void 0;if(entity.isChild)return console.error("[Entity.Geometry.attach]:","Entity is already a child of someone else."),void 0;if(entity.isRemoved)return console.error("[Entity.Geometry.attach]:","Entity is marked as removed ro to be removed."),void 0;if(!entity._view||entity._view===this._view&&entity.isChild||entity._view._removeFromBuffer(entity),isRelative&&entity.move(-this._x-this._anchorPosX-this.pivotX+this.volume.halfWidth,-this._y-this._anchorPosY-this.pivotY+this.volume.halfHeight),entity._parent=this,entity.isChild=!0,entity.ignoreZoom=this.ignoreZoom,entity.disableDebug=this.disableDebug,entity._view=this._view,this.clipVolume&&!entity.clipVolume&&entity.clip(this.clipVolume),this.pickable||(entity.pickable=!1),this.clickable||(entity.clickable=!1),entity.updateAngle(),entity.updateAlpha(),(1!==this.totalScaleX||1!==this.totalScaleY)&&entity.updateScale(),0!==this._depthNode.depth&&(entity.z=entity._z),this.children)this.children.push(entity);else{this.children=[entity],this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight,this.childOffsetX=this._x+this.childPivotX+this._anchorPosX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY;for(var parent=this._parent;parent;)this.childOffsetX+=parent.childOffsetX,this.childOffsetY+=parent.childOffsetY,parent=parent._parent}entity._flags&this.Flag.ANCHOR&&entity.updateAnchor(),this._flags&this.Flag.IGNORE_ZOOM&&(entity.ignoreZoom=this.ignoreZoom),entity.updatePos(),this._view&&this._view._isActive&&this._entityCtrl.onAddToView(entity,null),this.onChildAdded(entity),entity.onParentAdded(this)},detach:function(entity){if(entity){if(!this.children)return;for(var child,numChildren=this.children.length,i=0;numChildren>i;i++)if(child=this.children[i],!child.isRemoved&&child===entity)return child._parent=this._entityCtrl,child._view=null,child.isChild=!1,this._view.add(child),child.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight),this.onChildRemoved(child),child.onParentRemoved(this),void 0}else{if(!this.isChild)return;this._parent.detach(this)}},detachChildren:function(){if(this.children){var i,child,numChildren=this.children.length;for(i=0;numChildren>i;i++)child=this.children[i],child.isRemoved||(child._parent=this._entityCtrl,child._view=null,child.isChild=!1,this._view.add(child),child.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight),this.onChildRemoved(child),child.onParentRemoved(this));this.children.length=0}},detachExact:function(){for(var child,numChildren=this.children.length,i=0;numChildren>i;i++)child=this.children[i],child.isRemoved||(child._x+=this.childOffsetX,child._y+=this.childOffsetY,child._parent=this._entityCtrl,child._view=null,child.isChild=!1,this._view.add(child),child.forcePosition(child._x,child._y),this.onChildRemoved(child),child.onParentRemoved(this));this.children.length=0},clip:function(minX,minY,maxX,maxY){if(this.clipVolume="object"==typeof minX?minX instanceof meta.math.AdvAABB||minX instanceof meta.math.AABB?minX:minX.volume:new meta.math.AdvAABB(minX,minY,maxX,maxY),this.children)for(var numChildren=this.children.length,i=0;numChildren>i;i++)this.children[i].clip(this.clipVolume);return this.isNeedDraw=!0,this.clipVolume},_onClick:meta.emptyFuncParam,_onDown:function(param){this._action="pressed",this._style.updateAction(this)},_onUp:function(param){this._inputFlags>0?this._inputFlags&this.InputFlag.DRAGGED?this._action="drag":this._inputFlags&this.InputFlag.HOVER?this._action="hover":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},_onDragStart:function(){this._action="drag",this._style.updateAction(this)},_onDragEnd:function(){this._inputFlags>0?this._inputFlags&this.InputFlag.PRESSED?this._action="pressed":this._inputFlags&this.InputFlag.HOVER?this._action="hover":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},_onHoverEnter:function(){this._action="hover",this._style.updateAction(this)},_onHoverExit:function(){this._inputFlags>0?this._inputFlags&this.InputFlag.DRAGGED?this._action="drag":this._inputFlags&this.InputFlag.PRESSED?this._action="pressed":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},onDown:meta.emptyFuncParam,onUp:meta.emptyFuncParam,onClick:meta.emptyFuncParam,onDrag:meta.emptyFuncParam,onDragStart:meta.emptyFuncParam,onDragEnd:meta.emptyFuncParam,onHover:meta.emptyFuncParam,onHoverEnter:meta.emptyFuncParam,onHoverExit:meta.emptyFuncParam,onAnimEnd:null,onChildAdded:meta.emptyFuncParam,onChildRemoved:meta.emptyFuncParam,onParentAdded:meta.emptyFuncParam,onParentRemoved:meta.emptyFuncParam,_onChange:meta.emptyFunc,onChange:meta.emptyFunc,addComponent:function(comp,params){if(!comp)return console.warn("[Entity.Geometry.addComponent]:","No component specified."),null;var scope=window.Component,newComp=null,key;if("string"==typeof comp){for(key in scope)if(key===comp){newComp=new scope[key];break}}else for(key in scope)if(scope[key]===comp){newComp=new comp;break}if(!newComp)return console.warn("[Entity.Geometry.addComponent]:","Invalid component - "+comp),null;if(this.numComponents++,this.components||(this.components={},this.componentBuffer=[]),this.numComponents>this.componentBuffer.length&&(this.componentBuffer.length=this.numComponents),this.components[key]=newComp,newComp.owner=this,newComp.__id=this.numComponents-1,this.componentBuffer[newComp.__id]=newComp,params)for(key in params)newComp[key]=params[key];return this._isLoaded&&newComp.load&&newComp.load(),newComp.update&&!this._isUpdating&&(this.isUpdating=!0),newComp},removeComponent:function(comp){if(!comp)return console.warn("[Entity.Geometry.removeComponent]:","No component specified."),void 0;if(this.components){var component,compName;if("string"==typeof comp){if(component=this.components[comp],compName=comp,!component)return console.warn("[Entity.Geometry.removeComponent]:","No such component found - "+comp),void 0}else{for(var key in this.components)if(this.components[key]===comp){component=comp,compName=key;break}if(!component)return console.warn("[Entity.Geometry.removeComponent]:","No such component found - "+comp),void 0}component.unload&&component.unload(),this.numComponents--,this.numComponents<=0?(this.components=null,this.componentBuffer=null,this.numComponents=0):(this.componentBuffer[component.__id]=this.componentBuffer[this.numComponents],this.componentBuffer[component.__id].__id=component.__id,this.componentBuffer[this.numComponents]=null,delete this.components[compName])}},removeComponents:function(){for(var component,n=0;n<this.numComponents;n++)component=this.componentBuffer[n],component.unload&&component.unload();this.components=null,this.componentBuffer=null,this.numComponents=0},lookAt:function(x,y){this.angleRad=-Math.atan2(x-(this._x+this._anchorPosX+this._parent.childOffsetX),y-(this._y+this._anchorPosY+this._parent.childOffsetY))+Math.PI},lookAtEntity:function(entity){this.lookAt(entity._x+entity._parent.childOffsetX,entity._y+entity._parent.childOffsetY)},getLookAt:function(x,y){this.angleRad=-Math.atan2(x-(this.x+this._anchorPosX+this._parent.childOffsetX),y-(this.y+this._anchorPosY+this._parent.childOffsetY))+Math.PI},subscribe:function(owner,func){this.chn||(this.chn=meta.createChannel("__ent"+this.id)),this.chn.subscribe(owner,func)},unsubscribe:function(owner){this.chn&&(this.chn.unsubscribe(owner),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(data,event){this.chn&&this.chn.emit(data,event)},print:function(str){str=str||"",console.log("[Entity",this.name+":"+this.id+"]",str)},get view(){return this._view},set x(value){this.position(value,this._y)},set y(value){this.position(this._x,value)},get x(){return this._x},get y(){return this._y},get absoluteX(){return this.volume.x},get absoluteY(){return this.volume.y},get width(){return this.volume.width},get height(){return this.volume.height},set anchorX(x){this.anchor(x,this._anchorY)},set anchorY(y){this.anchor(this._anchorX,y)},get anchorX(){return this._anchorX},get anchorY(){return this._anchorY},set offsetX(value){this._offsetX!==value&&(this._offsetX=value,this.updatePos())},set offsetY(value){this._offsetY!==value&&(this._offsetY=value,this.updatePos())},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},set isAnchor(value){(this._flags&this.Flag.ANCHOR)!==value&&(value?this._flags|=this.Flag.ANCHOR:(this._anchorX=0,this._anchorY=0,this._anchorPosX=0,this._anchorPosY=0,this._flags^=this.Flag.ANCHOR),this.isNeedDraw=!0)},get isAnchor(){return this._flags&this.Flag.ANCHOR},get centerX(){return this._x+this._parent.childOffsetX+this.textureOffsetX},get centerY(){return this._y+this._parent.childOffsetY+this.textureOffsetY},set z(value){var newZ=this._parent._depthNode.depth+value+1;if(this._view&&(newZ+=this._view._z),this._depthNode.depth!==newZ&&(this._z=value,this._depthNode.depth=newZ,this._depthNode.entity&&(this._entityCtrl.entities.update(this._depthNode),this.isNeedDraw=!0),this.children))for(var numChildren=this.children.length,i=0;numChildren>i;i++)this.children[i].z=value},set depthIndex(value){this.z=value},get z(){return this._z},get depthIndex(){return this._z},set texture(texture){if("string"==typeof texture){if(this._texture&&this._texture.name===texture)return;var textureName=texture;if(texture=meta.getTexture(textureName),!texture)return this._texture=textureName,meta.subscribe(this,Resource.Event.ALL_LOADED,this._onResAllLoaded),void 0}else if(this._texture===texture)return;return this._texture&&this._texture.unsubscribe(this),texture?texture instanceof Resource.Texture?(this._texture=texture,this._texture.subscribe(this,this._onTextureEvent),this.textureOffsetX=this._texture._offsetX,this.textureOffsetY=this._texture._offsetY,this._texture._isLoaded?(this.isLoaded=!0,this.updateFromTexture()):(this.isLoaded=!1,this._texture.isLoading||this._texture.load()),texture.isAnimated&&(this.isAnimating||(this.isAnimating=texture.autoPlay),texture.isEmulateReverse&&(this.isEmulateReverse=!0),this.isAnimReverse=texture.isAnimReverse),texture):(console.warn("[Entity.Geometry.texture]:","Texture should extend Resource.Texture class."),null):(this._texture=null,this.isLoaded=!1,void 0)},get texture(){return this._texture},set isNeedDraw(value){this._isLoaded&&(this._isNeedDraw=value,this._tChange=Date.now(),this._isCached&&this._entityCtrl.uncacheEntity(this),value&&(this._entityCtrl.isNeedRender=!0))},get isNeedDraw(){return this._isNeedDraw},updateStyle:function(){this._style&&this._style.update(this)},setState:function(name,texture,params){texture&&(params||(params={texture:texture})),this._style||(name="*",this._style=new meta.Style,this._styleParams={}),this._style.setState(name,texture)},set style(style){if(this._style)for(var key in this._styleParams)this[key]=this._styleParams[key];this._style=style instanceof meta.Style?style:new meta.Style(style),this.isNeedStyle=style?!0:!1},get style(){return this._style},set state(value){value||(value="*"),this._state!==value&&(this._state=value,this._onChange(),this.onChange(),this.chn&&this.chn.emit(Entity.Event.STATE_CHANGE,this),this._style&&(null===value?(this._styleState=null,this._styleAction=null,this.isNeedStyle=!1,this.texture=null):this.isNeedStyle=!0))},set action(value){this._action!==value&&(this._action=value,this._style&&this._style.updateAction(this))},get state(){return this._state},get action(){return this._action},updateAlpha:function(){var alpha;if(alpha=this._flags&this.Flag.IGNORE_PARENT_ALPHA?this._alpha:this._alpha*this._parent.totalAlpha,this.totalAlpha!==alpha){if(this.totalAlpha=alpha,this.children)for(var numChildren=this.children.length,i=0;numChildren>i;i++){var child=this.children[i];if(child._flag&this.Flag.IGNORE_PARENT_ALPHA)return;child.updateAlpha()}this._draw=this._drawTransform,this.isNeedDraw=!0}},set alpha(value){this._alpha!==value&&(this._alpha=value,this.updateAlpha())},get alpha(){return this._alpha},set ignoreParentAlpha(value){this._flags|=this.Flag.IGNORE_PARENT_ALPHA},get ignoreParentAlpha(){return this._flags&this.Flag.IGNORE_PARENT_ALPHA},updateAngle:function(){var angleRad;if(angleRad=this._flags&this.Flag.IGNORE_PARENT_ANGLE?this._angleRad:this._angleRad+this._parent.totalAngleRad,angleRad!==this.totalAngleRad){if(this.totalAngleRad=angleRad,this.children)for(var numChildren=this.children.length,i=0;numChildren>i;i++){var child=this.children[i];child._flags&this.Flag.IGNORE_PARENT_ANGLE||child.updateAngle()}this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0}},set angle(value){value=meta.math.toRadians(value),this._angleRad!==value&&(this._angleRad=value,this.updateAngle())},get angle(){return meta.math.toDegree(this._angleRad)},set angleRad(value){this._angleRad!==value&&(this._angleRad=value,this.updateAngle())},get angleRad(){return this._angleRad},set ignoreParentAngle(value){this._flags|=this.Flag.IGNORE_PARENT_ANGLE},get ignoreParentAngle(){return this._flags&this.Flag.IGNORE_PARENT_ANGLE},updateScale:function(){var scaleX,scaleY;this._flags&this.Flag.IGNORE_PARENT_SCALE?(scaleX=this._scaleX,scaleY=this._scaleY):(scaleX=this._scaleX*this._parent.totalScaleX,scaleY=this._scaleY*this._parent.totalScaleY);var totalScaleX=scaleX*this._flipX,totalScaleY=scaleY*this._flipY;if(totalScaleX!==this.totalScaleX||totalScaleY!==this.totalScaleY){if(this.totalScaleX=totalScaleX,this.totalScaleY=totalScaleY,this.pivotX=this.pivotSrcX*scaleX,this.pivotY=this.pivotSrcY*scaleY,this.volume.scalePivoted(this.totalScaleX,this.totalScaleY,this.drawSrcX+this.pivotX,this.drawSrcY+this.pivotY),this.children)for(var child,numChildren=this.children.length,i=0;numChildren>i;i++)child=this.children[i],child._flag&this.Flag.IGNORE_PARENT_SCALE||child.updateScale();this._parent===this._entityCtrl&&(this.updatePos(),this.isNeedDraw=!0),this._draw=this._drawTransform,this.isInside=this._isInsideTransform}},scale:function(x,y){y=y||x,this._scaleX=x,this._scaleY=y,this.updateScale()},set scaleX(value){this._scaleX=value,this.updateScale()},set scaleY(value){this._scaleY=value,this.updateScale()},get scaleX(){return this._scaleX},get scaleY(){return this._scaleY},set ignoreParentScale(value){this._flags|=this.Flag.IGNORE_PARENT_SCALE},get ignoreParentScale(){return this._flags&this.Flag.IGNORE_PARENT_SCALE},flip:function(x,y){void 0===x&&void 0===y?(x=-this._flipX,y=this._flipY):(x=void 0!==x?x:1,y=void 0!==y?y:1),x=0|x,y=0|y,x>1?x=1:-1>x?x=-1:0===x&&(x=1),y>1?y=1:-1>y?y=-1:0===y&&(y=1),(x!==this._flipX||y!==this._flipY)&&(this._flipX=x,this._flipY=y,this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0)},set flipX(x){this.flip(x,this._flipY)},set flipY(y){this.flip(this._flipX,y)},get flipX(){return this._flipX},get flipY(){return this._flipY},set visible(value){if(this.isVisible!==value&&(this.isVisible=value,this._entityCtrl.isNeedRender=!0,this.children))for(var numChildren=this.children.length,i=0;numChildren>i;i++)this.children[i].visible=value},get visible(){return this.isVisible},set isLoaded(value){if(this._isLoaded!==value)if(this._isLoaded=value,value){if(this.load&&this.load(),this.components){var comp;for(var key in this.components)comp=this.components[key],comp.load&&comp.load()}this._entityCtrl.cacheEntity(this)}else this._entityCtrl.uncacheEntity(this)},get isLoaded(){return this._isLoaded},set isUpdating(value){this._isUpdating!==value&&(this._isUpdating=value,value?this._entityCtrl._addToUpdating(this):this._entityCtrl._removeFromUpdating(this))},get isUpdating(){return this._isUpdating},set currFrame(index){if(this._texture){var frame=index%this._texture.numFrames;if(frame===this._currFrame)return;this._currFrame=frame,this.isNeedDraw=!0}else this._currFrame=index},get currFrame(){return this._currFrame},set isAnimReverse(value){this._isAnimReverse=value,this.currFrame=value&&this._texture?this._texture.numFrames-1:0},get isAnimReverse(){return this._isAnimReverse},set tween(obj){if(this._tweenCache||(this._tweenCache=new meta.Tween.Cache(this)),obj instanceof meta.Tween.Link)this._tweenCache.tween=obj.tween;else{if(!(obj instanceof meta.Tween))return console.warn("[Entity.Geometry.set::tween]:","Ivalid object! Should be meta.Tween or meta.Tween.Link object."),void 0;this._tweenCache.tween=obj}var tween=this._tweenCache.tween;tween.autoPlay&&(tween.cache=this._tweenCache,tween.play())},get tween(){return this._tweenCache||(this._tweenCache=new meta.Tween.Cache(this),this._tweenCache.tween=new meta.Tween),this._tweenCache.tween.cache=this._tweenCache,this._tweenCache.tween},_onResize:function(data){this.onResize&&this.onResize(data),this._flags&this.Flag.ANCHOR&&this._onResize_anchor(data)},onResize:null,_onResize_anchor:function(){this.updateAnchor()},set isCached(value){this._isCached===value},get isCached(){return this._isCached},click:function(){var inputEvent=Input.ctrl.getEvent();this._onClick(inputEvent),this.onClick(inputEvent)},set hover(value){var inputEvent=Input.ctrl.getEvent();value?0===(this._inputFlags&this.InputFlag.HOVER)?(this._inputFlags|=this.InputFlag.HOVER,this._onHoverEnter(inputEvent),this.onHoverEnter(inputEvent)):(this._onHover(inputEvent),this.onHover(inputEvent)):(this._inputFlags&=~this.InputFlag.HOVER,this._onHoverExit(inputEvent),this.onHoverExit(inputEvent))},set pressed(value){if(!!(this._inputFlags&this.InputFlag.PRESSED)!==value){var inputEvent=Input.ctrl.getEvent();value?(this._inputFlags|=this.InputFlag.PRESSED,this._onDown(inputEvent),this.onDown(inputEvent)):(this._inputFlags&=~this.InputFlag.PRESSED,this._onUp(inputEvent),this.onUp(inputEvent))}},set dragged(value){var inputEvent=Input.ctrl.getEvent();value?0===(this._inputFlags&this.InputFlag.DRAGGED)?(this._inputFlags|=this.InputFlag.DRAGGED,this._onDragStart(inputEvent),this.onDragStart(inputEvent)):(this._onDrag(inputEvent),this.onDrag(inputEvent)):(this._inputFlags&=~this.InputFlag.DRAGGED,this._onDragEnd(inputEvent),this.onDragEnd(inputEvent))},get hover(){return!!(this._inputFlags&this.InputFlag.HOVER)},get pressed(){return!!(this._inputFlags&this.InputFlag.PRESSED)
},get dragged(){return!!(this._inputFlags&this.InputFlag.DRAGGED)},set ignoreZoom(value){!!(this._flags&this.Flag.IGNORE_ZOOM)!==value&&(this._flags&this.Flag.ANCHOR&&this.updateAnchor(),value?this._flags|=this.Flag.IGNORE_ZOOM:this._flags&=~this.Flag.IGNORE_ZOOM,this.isNeedDraw=!0)},get ignoreZoom(){return!!(this._flags&this.Flag.IGNORE_ZOOM)},set showBounds(value){!!(this._flags&this.Flag.SHOW_BOUNDS)!==value&&(value?(this._flags|=this.Flag.SHOW_BOUNDS,this._entityCtrl._addToDrawBounds()):(this._flags&=~this.Flag.SHOW_BOUNDS,this._entityCtrl._removeToDrawBounds()))},get showBounds(){return!!(this._flags&this.Flag.SHOW_BOUNDS)},set disableDebug(value){!!(this._flags&this.Flag.DISABLE_DEBUG)!==value&&(value?this._flags|=this.Flag.DISABLE_DEBUG:this._flags&=~this.Flag.DISABLE_DEBUG,this.isNeedDraw=!0)},get disableDebug(){return!!(this._flags&this.Flag.DISABLE_DEBUG)},set cursor(value){meta.engine.cursor=value},get cursor(){return meta.engine.cursor},Flag:{REMOVED:4,ANCHOR:128,IGNORE_ZOOM:256,IGNORE_PARENT_ANGLE:512,IGNORE_PARENT_SCALE:1024,IGNORE_PARENT_ALPHA:2048,SHOW_BOUNDS:4096,DISABLE_DEBUG:16384},InputFlag:{HOVER:1,PRESSED:2,DRAGGED:4},meta:meta,_entityCtrl:null,_tmpX:0,_tmpY:0,id:-1,type:0,name:"unknown",_parent:null,_view:null,_depthNode:null,_checkID:-1,_viewNodeID:-1,_updateNodeID:-1,_updateAnimNodeID:-1,_removeFlag:0,_flags:0,_inputFlags:0,chn:null,_x:0,_y:0,_z:0,typeX:0,typeY:0,_anchorX:0,_anchorY:0,_anchorPosX:0,_anchorPosY:0,_dragOffsetX:0,_dragOffsetY:0,drawX:0,drawY:0,drawSrcX:0,drawSrcY:0,_offsetX:0,_offsetY:0,textureOffsetX:0,textureOffsetY:0,pivotX:0,pivotY:0,pivotRatioX:0,pivotRatioY:0,pivotSrcX:0,pivotSrcY:0,childOffsetX:0,childOffsetY:0,childPivotX:0,childPivotY:0,cellX:0,cellY:0,_cellIndex:0,_style:null,_styleState:null,_styleAction:null,_styleParams:null,_styleActionParams:null,_state:"*",_action:"",_tweenCache:null,volume:null,clipVolume:null,positionType:0,_angleRad:0,_scaleX:1,_scaleY:1,_flipX:1,_flipY:1,_alpha:1,totalAngleRad:0,totalScaleX:1,totalScaleY:1,totalAlpha:1,_texture:null,vbo:null,vertices:null,components:null,componentBuffer:null,numComponents:0,children:null,pickable:!0,clickable:!0,fps:0,animSpeed:1,_currFrame:0,isAnimating:!1,isLoop:!1,_isAnimReverse:!1,isEmulateReverse:!1,_tAnim:0,pauseAtEnd:!1,_tChange:0,isAdded:!1,_isLoaded:!1,isVisible:!0,isPaused:!1,isChild:!1,isRemoved:!1,_isUpdating:!1,_isNeedDraw:!1,isNeedStyle:!1,_isNeedOffset:!1,_cacheIndex:-1,_isHighlight:!1}),"use strict",Entity.Text=Entity.Geometry.extend({init:function(params){this.texture=new Resource.Texture,this._texture.resize(this._fontSize,this._fontSize);var type=typeof params;this.setText("string"===type||"number"===type?params:"")},_initParams:function(params){},setText:function(text){this._text=text;var ctx;ctx=this._texture.textureType===Resource.TextureType.WEBGL?this._texture._tmpCtx:this._texture.ctx,ctx.font=this._style+" "+this._fontSizePx+" "+this._font;var metrics=ctx.measureText(this._text),width=metrics.width+2*this.outlineWidth;if(this.resize(width,1.2*this._fontSize),this._texture.textureType===Resource.TextureType.WEBGL&&(this._texture._tmpImg.width=width,this._texture._tmpImg.height=1.2*this._fontSize),ctx.clearRect(0,0,this.volume.width,this.volume.height),ctx.font=this._style+" "+this._fontSizePx+" "+this._font,ctx.fillStyle=this._color,ctx.textBaseline="top",ctx.fillText(text,this.outlineWidth,0),this.isOutline&&(ctx.lineWidth=this._outlineWidth,ctx.strokeStyle=this._outlineColor,ctx.strokeText(text,this.outlineWidth,0)),this._texture.textureType===Resource.TextureType.WEBGL){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this._texture.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._texture._tmpImg)}this._texture._isLoaded||(this._texture.isLoaded=!0),this.isNeedDraw=!0},resize:function(width,height){width=width||1,height=height||this.volume.height,this._texture.resize(width,height)},setFont:function(font){this._font=font,this.setText(this._text)},setSize:function(size){this._fontSize=size,this._fontSizePx=size+"px",this.setText(this._text)},setColor:function(color){this._color=color,this.setText(this._text)},setOutlineColor:function(color){this._outlineColor=color,this.isOutline=!0},setOutlineWidth:function(width){this._outlineWidth=width,this._isOutline&&this.setText(this._text)},setStyle:function(style){this._style=style,this.setText(this._text)},set text(text){this.setText(text)},get text(){return this._text},set font(font){this.setFont(font)},get font(){return this._font},set size(size){this.setSize(size)},get size(){return this._fontSize},set color(color){this.setColor(color)},get color(){return this._color},set outlineColor(color){this.setOutlineColor(color)},get outlineColor(){return this._outlineColor},set outlineWidth(width){this.setOutlineWidth(width)},get outlineWidth(){return this._outlineWidth},set style(style){this.setStyle(style)},get style(){return this._style},set isOutline(value){this._isOutline!==value&&(this._isOutline=value,this.setText(this._text))},get isOutline(){return this._isOutline},_text:"",_font:"Arial",_fontSize:14,_fontSizePx:"14px",_color:"#000000",_outlineColor:"#ffffff",_outlineWidth:1,_style:"",_isOutline:!1}),"use strict",Entity.Grid=Entity.Geometry.extend({create:function(width,height,numCellsX,numCellsY){this.resize(width,height),this.numCellsX=numCellsX,this.numCellsY=numCellsY},addCell:function(entity,x,y){},tile:function(texture,numCellsX,numCellsY){if("string"==typeof texture){var textureRef=meta.getTexture(texture);if(!textureRef)return console.warn("[Entity.Grid.tile]:","Could not find texture with a name - ",texture),void 0;texture=textureRef}if(!texture._isLoaded)return console.warn("[Entity.Grid.tile]:","Texture is not loaded - ",texture.name),void 0;var width=numCellsX*texture.width,height=numCellsY*texture.height;this.resize(width,height);for(var entity,posX=0,posY=0,x=0;numCellsX>x;x++){for(var y=0;numCellsY>y;y++)entity=new Entity.Geometry(texture),entity.positionTopLeft(posX,posY),this.attach(entity),posY+=texture.height;posY=0,posX+=texture.width}},numCellsX:0,numCellsY:0}),"use strict",Entity.DepthList=function(){this.length=0,this.first=new Entity.DepthList.Node(null),this.last=new Entity.DepthList.Node(null),this.bufferLength=64,this.buffer=new Array(this.bufferLength),this.first.depth=-2147483648,this.first.next=this.last,this.last.depth=2147483648,this.last.prev=this.first},Entity.DepthList.prototype={push:function(node){var currNode=this.last.prev;do{if(node.depth>=currNode.depth)return node.prev=currNode,node.next=currNode.next,currNode.next.prev=node,currNode.next=node,this.length>=this.bufferLength&&(this.bufferLength+=64,this.buffer.length=this.bufferLength),this.buffer[this.length]=node.entity,this.length++,void 0;currNode=currNode.prev}while(currNode);console.error("[Entity.DepthList.push]:","Node is out of the bounds!")},remove:function(node){node.next&&(node.next.prev=node.prev),node.prev&&(node.prev.next=node.next),node.next=null,node.prev=null,this.length--,this.buffer[node.index]=this.buffer[this.length],this.buffer[this.length]=null,node.index=0},clear:function(){this.length=0,this.buffer=new Array(this.bufferLength)},update:function(node){var currNode=node.prev;if(currNode!==this.first&&currNode.depth>node.depth){node.next.prev=node.prev,node.prev.next=node.next;do{if(currNode.depth<=node.depth)return node.prev=currNode,node.next=currNode.next,node.next.prev=node,currNode.next=node,void 0;currNode=currNode.prev}while(currNode)}if(currNode=node.next,currNode!==this.last&&currNode.depth<node.depth){node.next.prev=node.prev,node.prev.next=node.next;do{if(currNode.depth>node.depth)return node.next=currNode,node.prev=currNode.prev,node.prev.next=node,currNode.prev=node,void 0;currNode=currNode.next}while(currNode)}},print:function(){if(0===this.length)return console.log("Empty"),void 0;var currNode=this.first.next;do console.log(currNode.entity.name,currNode.depth),currNode=currNode.next;while(currNode!==this.last)}},Entity.DepthList.Node=function(){this.entity=null,this.depth=0,this.prev=null,this.next=null,this.index=-1},"use strict",Entity.CellArray=function(){this.buffer=new Array(8),this.size=8,this.length=0,this.isVisible=!1},Entity.CellArray.prototype={push:function(entity){this.size===this.length&&(this.size+=8,this.buffer.length=this.size),this.buffer[this.length]=entity,entity._cellIndex=this.length,this.length++},remove:function(entity){this.length--,this.buffer[entity._cellIndex]=this.buffer[this.length],this.length+8===this.size&&(this.size-=8,this.buffer.length=this.size)}},"use strict",window.Input={},Input.Controller=meta.Controller.extend({init:function(){this.keys=new Array(this.numKeys),this.inputs=new Array(this.numInputs),this.touches=[],this._event={event:null,x:0,y:0,prevScreenX:0,prevScreenY:0,screenX:0,screenY:0,keyCode:0,entity:null},this.addEventListeners(),this._loadIgnoreKeys(),meta.subscribe(this,meta.Event.FOCUS,this.onFocus)},release:function(){this.removeEventListeners(),meta.unsubscribe(this,meta.Event.FOCUS,this.onFocus)},onKeyDown:function(event){if(window.top&&this._iFrameKeys[event.keyCode]&&event.preventDefault(),void 0!==this._cmdKeys[event.keyCode]&&this._numCmdKeys++,void 0!==this._ignoreKeys[event.keyCode]&&this._numCmdKeys<=0&&event.preventDefault(),!(this.blockInput||this.isStickyKeys&&this.keys[event.keyCode]||(this.keys[event.keyCode]=!0,this._event.event=event,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.screenX=0,this._event.screenY=0,this._event.x=0,this._event.y=0,this._event.keyCode=event.keyCode,this._chnKeyDown.emit(this._event,Input.Event.KEY_DOWN),!this.keyRepeat))){if(!this._inputTimer){var self=this;this._inputTimer=meta.addTimer(this,function(){self._event.keyCode=self._repeatKey,self._chnKeyDown.emit(self._event,Input.Event.KEY_DOWN)},this.keyRepeat)}this._repeatKey=event.keyCode,this._inputTimer.resume(),this._inputTimer.tAccumulator=0}},onKeyUp:function(event){window.top&&this._iFrameKeys[event.keyCode]&&event.preventDefault(),void 0!==this._cmdKeys[event.keyCode]&&this.keys[event.keyCode]&&this._numCmdKeys--,void 0===this._ignoreKeys[event.keyCode]&&this._numCmdKeys<=0&&event.preventDefault(),this.blockInput||(this.keys[event.keyCode]=!1,this._event.event=event,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=event.keyCode,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP),this.keyRepeat&&this._inputTimer&&this._inputTimer.pause())},onMouseDown:function(event){if(!this.blockInput){this.inputs[event.button]=!0;var scope=meta,camera=scope.camera,screenX=(event.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(event.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0;this._event.event=event,this._event.prevScreenX=screenX,this._event.prevScreenY=screenY,this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=event.button,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN),this._event.entity=null}},onMouseUp:function(event){if(!this.blockInput){this.inputs[event.button]=!1;var scope=meta,camera=scope.camera,screenX=(event.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(event.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0;this._event.event=event,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=event.button,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP),this._event.entity=null}},onMouseMove:function(event){if(event.preventDefault(),!this.blockInput){var scope=meta,camera=scope.camera,screenX=(event.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(event.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0;this._event.event=event,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=-1,this.inputX=x,this.inputY=y,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE),this._event.entity=null}},onTouchDown:function(event){event.preventDefault();for(var scope=meta,camera=scope.camera,touch,screenX,screenY,x,y,changedTouches=event.changedTouches,numTouches=changedTouches.length,i=0;numTouches>i;i++)touch=event.changedTouches[i],this.touches.push(touch.identifier),this.numTouches++,screenX=(touch.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(touch.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0,this._event.event=event,this._event.prevScreenX=screenX,this._event.prevScreenY=screenY,this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=this.numTouches-1,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN),this._event.entity=null},onTouchUp:function(event){event.preventDefault();for(var scope=meta,camera=scope.camera,touch,id,screenX,screenY,x,y,changedTouches=event.changedTouches,numTouches=changedTouches.length,i=0;numTouches>i;i++)touch=event.changedTouches[i],id=this._getTouchID(touch.identifier),-1!==id&&(this.touches.splice(id,1),this.numTouches--,screenX=(touch.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(touch.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0,this._event.event=event,0===id?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY):(this._event.prevScreenX=screenX,this._event.prevScreenY=screenY),this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=id,this._chnInputDown.emit(this._event,Input.Event.INPUT_UP),this._event.entity=null)},onTouchMove:function(event){event.preventDefault();for(var scope=meta,camera=scope.camera,touch,id,screenX,screenY,x,y,changedTouches=event.changedTouches,numTouches=changedTouches.length,i=0;numTouches>i;i++)touch=event.changedTouches[i],id=this._getTouchID(touch.identifier),-1!==id&&(screenX=(touch.pageX-scope.engine.unsubscribesetLeft)*window.devicePixelRatio,screenY=(touch.pageY-scope.engine.unsubscribesetTop)*window.devicePixelRatio,x=screenX*camera.zoomRatio-camera._x|0,y=screenY*camera.zoomRatio-camera._y|0,this._event.event=event,0===id?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this.inputX=x,this.inputY=y):(this._event.prevScreenX=screenX,this._event.prevScreenY=screenY),this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=id,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE),this._event.entity=null)},onFocus:function(event,data){data===!1&&this.resetInput()},isDown:function(keyCode){return this.keys[keyCode]},isInputDown:function(keyCode){return this.inputs[keyCode]},addEventListeners:function(){var self=this;this._chnKeyDown=meta.createChannel(Input.Event.KEY_DOWN),this._chnKeyUp=meta.createChannel(Input.Event.KEY_UP),this._chnInputDown=meta.createChannel(Input.Event.INPUT_DOWN),this._chnInputUp=meta.createChannel(Input.Event.INPUT_UP),this._chnInputMove=meta.createChannel(Input.Event.INPUT_MOVE),this._onKeyDown=function(event){self.onKeyDown(event)},this._onKeyUp=function(event){self.onKeyUp(event)},this._onMouseDown=function(event){self.onMouseDown(event)},this._onMouseUp=function(event){self.onMouseUp(event)},this._onMouseMove=function(event){self.onMouseMove(event)},this._onTouchDown=function(event){self.onTouchDown(event)},this._onTouchUp=function(event){self.onTouchUp(event)},this._onTouchMove=function(event){self.onTouchMove(event)},this._onTouchCancel=function(event){self.onTouchCancel(event)},window.addEventListener("mousedown",this._onMouseDown),window.addEventListener("mouseup",this._onMouseUp),window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("touchstart",this._onTouchDown),window.addEventListener("touchend",this._onTouchUp),window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchcancel",this._onTouchUp),window.addEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.addEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.addEventListener("keyup",this._onKeyUp)},removeEventListeners:function(){window.removeEventListener("mousedown",this._onMouseDown),window.removeEventListener("mouseup",this._onMouseUp),window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("touchstart",this._onTouchDown),window.removeEventListener("touchend",this._onTouchUp),window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchcancel",this._onTouchUp),window.removeEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.removeEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.removeEventListener("keyup",this._onKeyUp)},resetInput:function(){var i;for(this._event.event=null,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=0,i=0;i<this.numKeys;i++)this.keys[i]&&(this.keys[i]=!1,this._event.keyCode=i,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP));for(i=0;i<this.numInputs;i++)this.inputs[i]&&(this.inputs[i]=!1,this._event.keyCode=i,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP));if(this._numCmdKeys=0,this.numTouches){for(i=0;i<this.numTouches;i++)this._event.keyCode=i,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP);this.touches.length=0,this.numTouches=0}},getEvent:function(){return this._event.event=null,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.inputX,this._event.y=this.inputY,this._event.keyCode=-1,this._event},_loadIgnoreKeys:function(){this._ignoreKeys=[],this._ignoreKeys[8]=1,this._ignoreKeys[9]=1,this._ignoreKeys[13]=1,this._ignoreKeys[17]=1,this._ignoreKeys[91]=1,this._ignoreKeys[38]=1,this._ignoreKeys[39]=1,this._ignoreKeys[40]=1,this._ignoreKeys[37]=1,this._ignoreKeys[112]=1,this._ignoreKeys[113]=1,this._ignoreKeys[114]=1,this._ignoreKeys[115]=1,this._ignoreKeys[116]=1,this._ignoreKeys[117]=1,this._ignoreKeys[118]=1,this._ignoreKeys[119]=1,this._ignoreKeys[120]=1,this._ignoreKeys[121]=1,this._ignoreKeys[122]=1,this._ignoreKeys[123]=1,this._ignoreKeys[124]=1,this._ignoreKeys[125]=1,this._ignoreKeys[126]=1,this._cmdKeys=[],this._cmdKeys[91]=1,this._cmdKeys[17]=1,this._iFrameKeys=[],this._iFrameKeys[37]=1,this._iFrameKeys[38]=1,this._iFrameKeys[39]=1,this._iFrameKeys[40]=1},_getTouchID:function(eventTouchID){for(var i=0;i<this.numTouches;i++)if(this.touches[i]===eventTouchID)return i;return-1},keys:null,inputs:null,touches:null,blockInput:!1,isStickyKeys:!0,keyRepeat:0,_inputTimer:null,_repeatKey:0,numKeys:256,numInputs:10,numTouches:0,inputX:0,inputY:0,_event:null,_onKeyDown:null,_onKeyUp:null,_onMouseDown:null,_onMouseUp:null,_onMouseMove:null,_onTouchDown:null,_onTouchUp:null,_onTouchMove:null,_onTouchCancel:null,_chnKeyDown:null,_chnKeyUp:null,_chnInputDown:null,_chnInputUp:null,_chnInputMove:null,_ignoreKeys:null,_cmdKeys:null,_iFrameKeys:null,_numCmdKeys:0}),"use strict",Input.Event={KEY_DOWN:"keyDown",KEY_UP:"keyUp",INPUT_DOWN:"inputDown",INPUT_UP:"inputUp",INPUT_MOVE:"inputMove",INPUT_CLICK:"click"},Input.Key={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,ESC:27,SPACE:32,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,DELETE:127,PLUS:187,MINUS:189,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,BUTTON_LEFT:0,BUTTON_MIDDLE:1,BUTTON_RIGHT:2},"use strict";var UI={};UI.Controller=meta.Controller.extend({init:function(){var buttonTex=new Resource.Texture;buttonTex.fillRect({color:"#111",width:120,height:30});var buttonOnHoverTex=new Resource.Texture;buttonOnHoverTex.fillRect({color:"#ff0000",width:120,height:30}),this.coreStyle={button:{"*:hover":{cursor:"pointer"},"*:pressed":{cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*:hover":{cursor:"pointer"},"*:pressed":{cursor:"pointer",offsetX:1,offsetY:1}}},this.style={button:{"*":{texture:buttonTex},"*:hover":{texture:buttonOnHoverTex,cursor:"pointer"},"*:pressed":{texture:buttonOnHoverTex,cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*":{texture:buttonTex},"*:hover":{texture:buttonOnHoverTex,cursor:"pointer"},"*:pressed":{texture:buttonOnHoverTex,cursor:"pointer",offsetX:1,offsetY:1},"[off]":{texture:buttonTex},"[on]":{texture:buttonOnHoverTex}}}},coreStyle:null,style:null}),"use strict",UI.Button=Entity.Geometry.extend({_initParams:function(params){this.style=params?meta.createStyle(params,UI.ctrl.coreStyle.button):UI.ctrl.style.button},set text(str){this._text?this._text.setText(str):(this._text=new Entity.Text(str),this._text.size=20,this._text.color="#ffffff",this.attach(this._text),this._text.anchor(.5),this._text.pickable=!1)},get text(){return this._text?this._text._text:""},_text:null}),UI.Checkbox=Entity.Geometry.extend({_initParams:function(params){this.style=params?meta.createStyle(params,UI.ctrl.coreStyle.checkbox):UI.ctrl.style.checkbox;var self=this,entity=new Entity.Geometry;entity.style=this._style.childStyle,entity.anchor(.5),entity.pickable=!1,entity.onChange=function(){self._onChildChange(this)},this.attach(entity),this.state="off",this._onClick=this.toggle},toggle:function(){var child=this.children[0];child.state=this.group?"on":"on"===child.state?"off":"on"},_onChange:function(){this.children[0].state=this._state,this.group&&"on"===this._state&&this.group._onStateChange(this)},_onChildChange:function(child){this.state=this.children[0]._state},set checked(value){this.state=value?"on":"off"},get checked(){return"on"===this._state},set text(str){this._text?this._text.setText(str):(this._text=new Entity.Text(str),this._text.size=12,this._text.color="#ffffff",this.attach(this._text),this._text.anchor(.5),this._text.pickable=!1)},get text(){return this._text?this._text._text:""},_text:null,group:null,value:""}),"use strict",UI.ProgressBar=Entity.Geometry.extend({init:function(){this.texture=new Resource.Texture,this.volume.resize(300,30),this.buildElement()},buildElement:function(){this.texture.fillRect({width:this.width,height:this.height,color:"white"})},updateElement:function(){},set min(value){this._min!==value&&(this._min=value,this.updateElement())},set max(value){this._max!==value&&(this._max=value,this.updateElement())},set value(value){this._value!==value&&(this._value=value,this.updateElement())},get min(){return this._min},get max(){return this._max},get value(){return this._value},_min:0,_max:100,_value:0}),"use strict",UI.Group=Entity.Geometry.extend({add:function(entity){entity.group&&entity.detach(),this.children||(entity.state="on",this._value=entity.value),this.attach(entity),entity.group=this},_onStateChange:function(entity){this.prevValue=this._value,this._value=entity.value;for(var child,numChildren=this.children.length,i=0;numChildren>i;i++)child=this.children[i],child!==entity&&(this.children[i].state="off");this.onChange(this)},set value(_value){if(this.children)for(var numChildren=this.children.length,n=0;numChildren>n;n++)if(this.children[n].value===_value){this.children[n].state="on";break}},get value(){return this._value},prevValue:"",_value:""}),"use strict",function(){meta.enableDefault&&meta.createEngine()}();