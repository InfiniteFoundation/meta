"use strict";var meta={};meta.engine=null,meta.device=null,meta.element=null,meta.elementId="",meta.canvas=null,meta.ctx=null,meta.width=0,meta.height=0,meta.channels=null,meta.shaders=null,meta.view=null,meta.world=null,meta.camera=null,meta.shader=null,meta.version="1.1",meta.enableDefault=!0,meta.enablemeta=!0,meta.enableWebGL=!0,meta.tUpdate=1e3/60,meta.utils={},meta.modules={},meta.importUrl="http://infinite-games.com/store/modules/",meta._cache={ismetaAdded:!1,init:null,load:null,ready:null,scripts:null,pendingScripts:null,numScriptsToLoad:0},meta.Engine=function(){this.controllers=[],this.controllersToRemove=[],this._timers=[],this._timersToRemove=[],this._numTimers=0,this.unsubscribesetLeft=0,this.unsubscribesetTop=0,this._onResizeCB=null,this._onVisibilityChangeCB=null,this._onFullScreenChangeCB=null,this._onFocusCB=null,this._onBlurCB=null,this._onCtxLostCB=null,this._onCtxRestoredCB=null,this._chnResize=null,this._chnFocus=null,this._chnFullScreen=null,this.isCreated=!1,this.isFocus=!1,this.isWebGL=!1,this.isInited=!1,this.isLoaded=!1,this.isLoading=!1,this.isCtrlLoaded=!1,this.isReady=!1,this.pause=!1,this.projection=null,this._updateLoop=null,this._renderLoop=null,this.tUpdate=0,this.tRender=0,this.tFPS=0,this.fps=0,this._fpsCounter=0,this.enablePauseOnBlur=!0},meta.Engine.prototype={create:function(){if(this.isCreated)return console.error("[meta.Engine.create]:","Engine instance is already created."),void 0;console.log("%c META v"+meta.version+" ","background: #000; color: white; font-size: 12px; padding: 2px 0 1px 0;"),console.log("%cBrowser: %c"+meta.device.name+" "+meta.device.version+"	","font-weight: bold; padding: 2px 0 1px 0;","padding: 2px 0 1px 0;"),meta.enablemeta&&this._createmeta(),meta.channels={},meta.shaders={},meta.views={},this._chnResize=meta.createChannel(meta.Event.RESIZE),this._chnFocus=meta.createChannel(meta.Event.FOCUS),this._chnFullScreen=meta.createChannel(meta.Event.FULLSCREEN),meta.View.prototype._chnAddedToView=meta.createChannel(meta.Event.ADDED_TO_VIEW),meta.View.prototype._chnRemovedFromView=meta.createChannel(meta.Event.REMOVED_FROM_VIEW),this._resolveElement(),this._createCanvas(),this.onResize(),meta.camera=new meta.Camera,meta.world=new meta.World(this.width,this.height);var t=this;this._onResizeCB=function(e){t.onResize()},this._onFocusCB=function(e){t.onFocusChange(!0)},this._onBlurCB=function(e){t.onFocusChange(!1)},window.addEventListener("resize",this._onResizeCB,!1),window.addEventListener("orientationchange",this._onResizeCB,!1),meta.device.hidden?(this._onVisibilityChangeCB=function(){t.onVisibilityChange()},document.addEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB)):(window.addEventListener("focus",this._onFocusCB),window.addEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&(this._onFullScreenChangeCB=function(){t.onFullScreenChangeCB()},document.addEventListener(meta.device.fullScreenOnChange,this._onFullScreenChangeCB)),this.start(),this.isCreated=!0},release:function(){return this.isCreated?(this._chnFocus.remove(),this._chnResize.remove(),this._chnFullScreen.remove(),window.removeEventListener("resize",this._onResizeCB),window.removeEventListener("orientationchange",this._onResizeCB),meta.device.hidden?document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB):(window.removeEventListener("focus",this._onFocusCB),window.removeEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB),this.isWebGL&&(window.removeEventListener("webglcontextlost",this._onCtxLostCB),window.removeEventListener("webglcontextrestored",this._onCtxRestoredCB)),meta.removeAllControllers(),meta.channels=null,meta.shaders=null,meta.views=null,meta.view=null,meta.world=null,meta.shader=null,this.isCreated=!1,void 0):(console.error("[meta.Engine.release]:","Can't release uninitialized engine instance."),void 0)},start:function(){meta.setView("game"),meta._cache.init&&"function"==typeof meta._cache.init&&meta._cache.init(),this._addCorePlugins(),this.isInited=!0,console.log(" "),this._load()},_load:function(){console.log("%c(Loading started)","background: #eee; font-weight: bold;"),this.isLoading=!0,meta._loadAllScripts()||this._continueLoad()},_continueLoad:function(){meta._cache.load&&"function"==typeof meta._cache.load&&meta._cache.load();for(var t,e=this.controllers.length,i=0;e>i;i++)t=this.controllers[i],t.load(),t.isLoaded=!0;this.isCtrlLoaded=!0,meta.view.isActive=!0,this.isLoading=!1,0===Resource.ctrl.numToLoad&&this.onResourcesLoaded()},update:function(){var t=Date.now(),e=t-this.tUpdate;this.pause&&(e=0),e>250&&(e=250);for(var i=e/1e3,s=this.controllers.length,n=0;s>n;n++)this.controllers[n].update(i);if(this.controllersToRemove.length){for(var o,h=this.controllers.length,r=this.controllersToRemove.length,a=0;r>a;a++)for(o=this.controllersToRemove[a],n=0;h>n;n++)if(this.controllers[n]===o){this.controllers[n]=this.controllers[h-1],this.controllers.pop();break}this.controllersToRemove.length=0}meta.update&&meta.update(i),this._updateTimers(e),this.tUpdate=t;var u=Date.now(),c=Math.max(0,meta.tUpdate-(u-t));window.setTimeout(this._updateLoop,c)},_updateTimers:function(t){var e,i;for(i=0;i<this._numTimers;i++)if(e=this._timers[i],!e.isPaused)for(e.tAccumulator+=t;e.tAccumulator>=e.tDelta;)if(e.tAccumulator-=e.tDelta,0!==e.numTimes&&e.func.call(e.owner,e),e.tStart+=e.tDelta,-1!==e.numTimes&&(e.numTimes--,e.numTimes<=0)){this._timersToRemove.push(e);break}if(this._timersToRemove.length){var s,n=this._timersToRemove.length;for(i=0;n>i;i++){s=this._timersToRemove[i];for(var o=0;o<this._numTimers;o++)if(e=this._timers[o],e.id===s.id){e.onRemove&&e.onRemove(),this._timers[o]=this._timers[this._numTimers-1],this._timers.pop(),this._numTimers--;break}}}},render:function(){var t=Date.now(),e=t-this.tRender;e>250&&(e=250);var i=e/1e3;t-this.tFPS>=1e3&&(this.tFPS=t,this.fps=this._fpsCounter,this._fpsCounter=0),Entity.ctrl.render(i),meta.render&&meta.render(i),this._fpsCounter++,this.tRender=t,requestAnimationFrame(this._renderLoop)},onResourcesLoaded:function(){this.isLoaded=!0,console.log("%c(Loading ended)","background: #eee; font-weight: bold;");for(var t=this.controllers.length,e=0;t>e;e++)this.controllers[e].ready();this.isReady=!0,meta._cache.ready&&"function"==typeof meta._cache.ready&&meta._cache.ready(),this._start()},onResize:function(){var t,e;meta.element===document.body?(t=window.innerWidth,e=window.innerHeight):(t=meta.element.clientWidth,e=meta.element.clientHeight);var i=window.devicePixelRatio;this.width=t*i|0,this.height=e*i|0,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",meta.width=this.width,meta.height=this.height,this.isWebGL&&(this.projection.ortho(0,this.width,this.height,0,0,100),meta.shader.uniformMatrix("projection",this.projection),this.ctx.viewport(0,0,this.width,this.height)),this._updateOffset(),this._chnResize.emit(this,meta.Event.RESIZE)},onFocusChange:function(t){this.isFocus=t,this.enablePauseOnBlur&&(this.pause=!t),this._chnFocus.emit(t,meta.Event.FOCUS)},onVisibilityChange:function(){this.onFocusChange(document[meta.device.hidden]?!1:!0)},onFullScreenChangeCB:function(){var t=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;meta.device.isFullScreen=!!t},onCtxLost:function(){console.log("(Context lost)")},onCtxRestored:function(){console.log("(Context restored)")},_resolveElement:function(){meta.elementId?(this.element=document.getElementById(meta.elementId),this.element||(console.warn("[meta.engine.create]:","Could not find element with id - "+meta.elementId),this.element=document.body)):this.element=document.body,this.element.style.cssText+=this.elementStyle,meta.element=this.element},_createmeta:function(){if(!meta._cache.ismetaAdded){var t=document.createElement("meta");t.setAttribute("http-equiv","Content-Type"),t.setAttribute("content","text/html; charset=utf-8"),document.head.appendChild(t);var e=document.createElement("meta");e.setAttribute("http-equiv","encoding"),e.setAttribute("content","utf-8"),document.head.appendChild(e);var i="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height",s=document.createElement("meta");s.setAttribute("name","viewport"),s.setAttribute("content",i),document.head.appendChild(s);var n=document.createElement("meta");n.setAttribute("name","apple-mobile-web-app-capable"),n.setAttribute("content","yes"),document.head.appendChild(n);var o=document.createElement("meta");o.setAttribute("name","apple-mobile-web-app-status-bar-style"),o.setAttribute("content","black-translucent"),document.head.appendChild(o),meta._cache.ismetaAdded=!0}},_createCanvas:function(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","meta-canvas"),this.canvas.style.cssText=this.canvasStyle,this.element.appendChild(this.canvas),meta.canvas=this.canvas;var t={};if(meta.enableWebGL&&meta.device.support.webgl){t.antialias=!0,t.stencil=!0,this.ctx=this.canvas.getContext("experimental-webgl",{stencil:!0}),meta.ctx=this.ctx,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1;var e=this;this._onCtxLostCB=function(t){e.onCtxLost()},this._onCtxRestoredCB=function(t){e.onCtxRestored()},window.addEventListener("webglcontextlost",this._onCtxLostCB),window.addEventListener("webglcontextrestored",this._onCtxRestoredCB),this._initShaders(),this.isWebGL=!0,console.log("%cRenderer: %cWebGL ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")}else this.ctx=this.canvas.getContext("2d",t),meta.ctx=this.ctx,console.log("%cRenderer: %cCanvas ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")},_initShaders:function(){this.projection=new meta.math.Matrix4;var t=new meta.Shader;return t.vertexShader="precision mediump float; attribute vec2 vertexPos; attribute vec2 texCoord; uniform vec2 cameraPos; uniform float zoom; uniform vec2 pos; uniform vec2 center; uniform vec2 scale; uniform vec4 frameCoord; uniform float angle; uniform mat4 projection; varying highp vec2 frameTexCoord; void main(void) { float rotX = sin(-angle);float rotY = cos(-angle);vec2 scaled = floor(vertexPos * scale);vec2 origin = vec2(scaled.x + floor(pos.x) - floor(center.x), scaled.y + floor(pos.y) - floor(center.y));vec2 newPos = vec2(origin.x * rotY + origin.y * rotX, origin.y * rotY - origin.x * rotX) + floor(center) + cameraPos;newPos *= zoom;gl_Position = projection * vec4(newPos, 0.0, 1.0);frameTexCoord = vec2(frameCoord.x + (texCoord.x * frameCoord.z), frameCoord.y + (texCoord.y * frameCoord.w)); }",t.fragmentShader="precision mediump float; uniform sampler2D sampler; uniform float alpha; varying highp vec2 frameTexCoord; void main(void) { vec4 color = texture2D(sampler, frameTexCoord); color.a *= alpha; gl_FragColor = color; }",meta.shaders.default=t,t.compile()?(meta.setShader("default"),t.bindAttrib("vertexPos"),t.bindAttrib("texCoord"),void 0):(console.error("[meta.Engine._initShaders]:","Could not compile shaders."),void 0)},_updateOffset:function(){this.unsubscribesetLeft=0,this.unsubscribesetTop=0;var t=meta.element;if(t.unsubscribesetParent)do this.unsubscribesetLeft+=t.unsubscribesetLeft,this.unsubscribesetTop+=t.unsubscribesetTop;while(t=t.unsubscribesetParent);var e=meta.element.getBoundingClientRect();this.unsubscribesetLeft+=e.left,this.unsubscribesetTop+=e.top},_addCorePlugins:function(){meta.register("Resource"),meta.register("UI"),meta.register(this.isWebGL?"Entity.WebGLRenderer":"Entity.CanvasRenderer"),meta.register("Input")},_start:function(){var t=this;this._updateLoop=function(){t.update()},this._renderLoop=function(){t.render()},this.tUpdate=Date.now(),this.tRender=this.tUpdate,this.tFPS=this.tUpdate,setTimeout(this._updateLoop),requestAnimationFrame(this._renderLoop)},enterFullScreen:function(){var t=meta.device;if(!t.isFullScreen)return t.support.fullScreen?(document.documentElement[t.fullScreenRequest](Element.ALLOW_KEYBOARD_INPUT),void 0):(console.warn("[meta.engine.enterFullScreen]:","Device does not support fullscreen."),void 0)},exitFullScreen:function(){meta.device.isFullScreen&&document[meta.device.fullScreenExit]()},elementStyle:"padding:0; margin:0;",canvasStyle:"position:absolute; overflow:hidden; translateZ(0); -webkit-backface-visibility:hidden; -webkit-perspective: 1000; -webkit-touch-callout: none; -webkit-user-select: none;"},meta.__defineSetter__("init",function(t){meta._cache.init=t,meta.engine&&meta.engine.isInited&&t()}),meta.__defineSetter__("load",function(t){meta._cache.load=t,meta.engine&&meta.engine.isLoaded&&t()}),meta.__defineSetter__("ready",function(t){meta._cache.ready=t,meta.engine&&meta.engine.isReady&&t()}),meta.__defineGetter__("init",function(){return meta._cache.init}),meta.__defineGetter__("load",function(){return meta._cache.load}),meta.__defineGetter__("ready",function(){return meta._cache.ready}),meta.render=null,meta.update=null,"use strict",meta.Device=function(){this.name="unknown",this.version="0",this.versionBuffer=null,this.vendors=["","webkit","moz","ms","o"],this.support={},this.audioFormats=[],this.isMobile=!1,this.isPortrait=!1,this.isAudioAPI=!1,this.hidden=null,this.visibilityChange=null,this.fullScreenRequest=null,this.fullScreenExit=null,this.fullScreenOnChange=null,this.isFullScreen=!1},meta.Device.prototype={load:function(){this.checkBrowser(),this.isMobile=this.isMobileAgent(),this.support.onloadedmetadata="object"==typeof window.onloadedmetadata,this.support.onkeyup="object"==typeof window.onkeyup,this.support.onkeydown="object"==typeof window.onkeydown,this.support.canvas=this.isCanvasSupport(),this.support.webgl=this.isWebGLSupport(),this.modernize()},checkBrowser:function(){var t={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/Chrome\/(\S+)/,/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},e=navigator.userAgent,i,s,n,o=2;for(i in t)for(;s=t[i].shift();)if(n=e.match(s)){this.version=n[1].match(new RegExp("[^.]+(?:.[^.]+){0,"+--o+"}"))[0],this.name=i,this.versionBuffer=this.version.split(".");for(var h=this.versionBuffer.length,r=0;h>r;r++)this.versionBuffer[r]=parseInt(this.versionBuffer[r]);break}(null===this.versionBuffer||"unknown"===this.name)&&console.warn("[meta.Device.checkBrowser]:","Could not detect browser.")},modernize:function(){this.supportConsole(),this.supportPageVisibility(),this.supportFullScreen(),this.supportRequestAnimFrame(),this.supportPerformanceNow(),this.supportAudioFormats(),this.supportAudioAPI()},isMobileAgent:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isCanvasSupport:function(){return!!window.CanvasRenderingContext2D},isWebGLSupport:function(){var t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return!!e},supportConsole:function(){window.console||(window.console={},window.console.log=meta.emptyFuncParam,window.console.warn=meta.emptyFuncParam,window.console.error=meta.emptyFuncParam)},supportPageVisibility:function(){void 0!==document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):void 0!==document.hidden?(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"):void 0!==document.hidden?(this.hidden="mozhidden",this.visibilityChange="mozvisibilitychange"):void 0!==document.hidden&&(this.hidden="mshidden",this.visibilityChange="msvisibilitychange")},supportFullScreen:function(){this._fullScreenRequest(),this._fullScreenExit(),this._fullScreenOnChange(),this.support.fullScreen=document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled},_fullScreenRequest:function(){var t=document.documentElement;void 0!==t.requestFullscreen?this.fullScreenRequest="requestFullscreen":void 0!==t.webkitRequestFullscreen?this.fullScreenRequest="webkitRequestFullscreen":void 0!==t.mozRequestFullScreen?this.fullScreenRequest="mozRequestFullScreen":void 0!==t.msRequestFullscreen&&(this.fullScreenRequest="msRequestFullscreen")},_fullScreenExit:function(){void 0!==document.exitFullscreen?this.fullScreenExit="exitFullscreen":void 0!==document.webkitExitFullscreen?this.fullScreenExit="webkitExitFullscreen":void 0!==document.mozCancelFullScreen?this.fullScreenExit="mozCancelFullScreen":void 0!==document.msExitFullscreen&&(this.fullScreenExit="msExitFullscreen")},_fullScreenOnChange:function(){void 0!==document.onfullscreenchange?this.fullScreenOnChange="fullscreenchange":void 0!==document.onwebkitfullscreenchange?this.fullScreenOnChange="webkitfullscreenchange":void 0!==document.onmozfullscreenchange?this.fullScreenOnChange="mozfullscreenchange":void 0!==document.onmsfullscreenchange&&(this.fullScreenOnChange="msfullscreenchange")},supportRequestAnimFrame:function(){window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)}}())},supportPerformanceNow:function(){void 0===window.performance&&(window.performance={}),void 0===window.performance.now&&(window.performance.now=Date.now)},supportAudioFormats:function(){var t=document.createElement("audio");""!=t.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/i,"")&&this.audioFormats.push("m4a"),t.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&this.audioFormats.push("ogg"),t.canPlayType("audio/mpeg;").replace(/no/,"")&&this.audioFormats.push("mp3"),t.canPlayType('audio/wav; codecs="1"').replace(/no/,"")&&this.audioFormats.push("wav")},supportAudioAPI:function(){window.AudioContext||(window.AudioContext=window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext)}},function(){meta.device=new meta.Device,meta.device.load()}(),"use strict",meta.device.isMobile&&(window.onerror=function(t,e,i){alert(e+": "+i+" "+t)}),"use strict",meta.emptyFunc=function(){},meta.emptyFuncParam=function(t){},meta.loadTextures=function(t,e){meta._loadResource("Texture",t,e)||console.warn("[meta.loadTextures]:","Unsupported parameter was passed.")},meta.preloadTextures=function(t,e){meta._preloadResource("Texture",t,e)||console.warn("[meta.preloadTextures]:","Unsupported parameter was passed.")},meta.loadSounds=function(t,e){meta._loadResource("Sound",t,e)||console.warn("[meta.loadSounds]:","Unsupported parameter was passed.")},meta.preloadSounds=function(t,e){meta._preloadResource("Sound",t,e)||console.warn("[meta.preloadSound]:","Unsupported parameter was passed.")},meta.loadSpriteSheet=function(t,e){meta._preloadResource("SpriteSheet",t,e)||console.warn("[meta.loadSpriteSheet]:","Unsupported parameter was passed.")},meta._loadResource=function(t,e,i){if(i){var s=i.lastIndexOf("/");0>=s&&(i+="/")}else i="";if(e instanceof Array)for(var n=e.length,o=0;n>o;o++)meta._addResource(t,e[o],i);else{if("object"!=typeof e&&"string"!=typeof e)return!1;meta._addResource(t,e,i)}return!0},meta._preloadResource=function(t,e,i){if(i){var s=i.lastIndexOf("/");s!==i.length-1&&(i+="/")}else i="";if(e instanceof Array)for(var n=e.length,o=0;n>o;o++)meta._addResource(t,e[o],i).load();else{if("object"!=typeof e&&"string"!=typeof e)return!1;meta._addResource(t,e,i).load()}return!0},meta._addResource=function(t,e,i){var s;return s="object"==typeof e?new Resource[t](e,i+e.path):new Resource[t](i+e),Resource.ctrl.add(s),s},meta.getTexture=function(t){return Resource.ctrl.getTexture(t)},meta.getSound=function(t){return Resource.ctrl.getSound(t)},meta.createCtrl=function(t,e){if(!t)return console.error("[meta.createCtrl]:","No controller name is defined."),null;var i=t.split(".");if(i.length>2)return console.error("[meta.createCtrl]:",'Name should be in format "MyScope.Controller".'),null;var s=i[0],n=window[s];if(!n)return console.error("[meta.createCtrl]:","No such scope defined: "+s),null;var o;if(o=1===i.length?"Controller":i[1],!n[o])return console.error("[meta.createCtrl]:","No Controller ("+o+") found in scope: "+s),null;e=e||meta.view;var h=new n[o](e);return h.name=s,h.view=e,h},meta.addCtrl=function(t){if(!t)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var e=window[t.name];return e.ctrl?(console.error("[meta.addCtrl]:","Controller ("+t.name+") is already added in scope."),void 0):(e.ctrl=t,meta.engine.controllers.push(t),meta.engine.isCtrlLoaded&&t.load(),meta.engine.isReady&&t.ready(),void 0)},meta.removeCtrl=function(t){if(!t)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var e=window[t.name];return e.ctrl?e.ctrl!==t?(console.error("[meta.removeCtrl]:","Controller ("+t.name+") is not the same what is already added to the scope."),void 0):(t.unload(),t.release(),meta.engine.controllersToRemove.push(t),void 0):(console.error("[meta.removeCtrl]:","No controller added to the scope."),void 0)},meta.register=function(t,e){var i=meta.createCtrl(t,e);if(i){var s=window[i.name];if(s.ctrl)return console.error("[meta.register]:","Controller ("+i.name+") is already added in scope."),null;s.ctrl=i,meta.engine.controllers.push(i),meta.engine.isCtrlLoaded&&i.load(),meta.engine.isReady&&i.ready()}},meta.unregister=function(t){if(!t)return console.error("[meta.unregister]:","No controller name is defined."),void 0;var e=t.split(".");if(e.length>2)return console.error("[meta.unregister]:",'Name should be in format "MyScope.Controller".'),void 0;var i=e[0],s=window[i];if(!s)return console.error("[meta.unregister]:","No such scope defined: "+i),void 0;if(s[i])return console.error("[meta.unregister]:","Controller ("+i+") is already added in scope."),void 0;var n;if(n=1===e.length?"Controller":e[1],!s[n])return console.error("[meta.unregister]:","No Controller ("+n+") found in scope: "+i),void 0;var o=s.ctrl;return o?(o.unload(),o.release(),meta.engine.controllersToRemove.push(o),void 0):(console.error("[meta.unregister]:","No Controller ("+n+") found in scope: "+i),void 0)},meta.unregisterAll=function(){for(var t,e=meta.engine.controllers,i=e.length,s=0;i>s;s++)t=window[e[s].name].ctrl,t.unload(),t.release(),window[e[s].name].ctrl=null;e.length=0},meta.onDomLoad=function(t){if(("interactive"===document.readyState||"complete"===document.readyState)&&!meta.debug)return t(),void 0;var e=function(i){t(),window.removeEventListener("DOMContentLoaded",e)};window.addEventListener("DOMContentLoaded",e)},meta.createEngine=function(){meta.onDomLoad(function(){return meta.engine?(meta.engine.release(),void 0):(meta.engine=new meta.Engine,meta.engine.create(),void 0)})},meta.enumToString=function(t,e){if(void 0===t)return"unknown";for(var i in t)if(t[i]===e)return i;return"unknown"},meta.hexToRgb=function(t){t.length<6&&(t+=t.substr(1,4));var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}},meta.isUrl=function(t){return-1!==t.indexOf("http://")||-1!==t.indexOf("https://")?!0:!1},meta.toUpperFirstChar=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},meta.loadScript=function(t,e){meta.engine&&meta.engine.isLoaded?meta._loadScript({s:t,c:callback}):(meta._cache.scripts||(meta._cache.scripts=[]),meta._cache.scripts.push({s:t,c:e}))},meta._loadScript=function(t){var e=document.createElement("script"),i=document.scripts[0];"async"in i?(e.async=!1,e.onload=t.c,e.src=t.s,document.head.appendChild(e)):i.readyState?(meta._cache.pendingScripts||(meta._cache.pendingScripts=[]),meta._cache.pendingScripts.push(e),e.onreadystatechange=meta._onReadyStateChange,e.src=t.s):document.write("<script src='"+src+" defer></script>")},meta._onReadyStateChange=function(){for(var t,e=meta._cache.pendingScripts;e[0]&&"loaded"===e[0].s.readyState;)t=e.shift(),t.s.onreadystatechange=null,document.scripts[0].parentNode.insertBefore(t.s,firstScript),t.c&&t.c()},meta._loadAllScripts=function(){var t=meta._cache.scripts;if(!t)return!1;var e=t.length;if(0===e)return!1;var i=function(){var t=meta._cache;t.numScriptsToLoad--;var e=meta._cache.scripts,s=e.length;if(s>0){t.numScriptsToLoad+=s,t.scripts=[];for(var n,o=0;s>o;o++)n=e[o],n.c=i,meta._loadScript(n)}0===t.numScriptsToLoad&&(t.scripts=null,meta.engine._continueLoad())},s,n=meta._cache;n.numScriptsToLoad+=t.length,n.scripts=[];for(var o=0;e>o;o++)s=t[o],s.c=i,meta._loadScript(s);return!0},meta.import=function(t){if(t){var e=t.split("/"),i=e[0],s;1===e.length?(s="latest",t+="/latest"):s=e[e.length-1];var n=meta.modules[i];if(n)return n.version!==s&&console.error("[meta.loadPackage]:","There is already added module ["+n.name+"] but with different version: "+n.version),void 0;n={name:i,version:s},meta.modules[i]=n,meta.isUrl(t)||(t=meta.importUrl+t+"/module.js"),meta.loadScript(t,null)}},meta.serialize=function(t){var e=[];for(var i in t)e.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return e.join("&")},meta.addDescription=function(t){var e=new Entity.Text;e.color="#ffffff",e.size=14,e.text=t,e.isPickable=!1,e.ignoreZoom=!0,e.enableDebug=!1;var i=new Resource.Texture;i.fillRect({width:e.width+10,height:e.height+10,color:"#000000"});var s=new Entity.Geometry(i);s.z=9999,s.anchor(.5,0),s.positionTop(0,10),s.isPickable=!1,s.ignoreZoom=!0,s.enableDebug=!1,meta.view.add(s),s.attach(e),e.anchor(.5)},"use strict",meta.Channel=function(t){this.name=t,this.subs=[],this.numSubs=0,this._isEmiting=!1,this._subsToRemove=null},meta.Channel.prototype={remove:function(){meta.channels[this.name]=null},emit:function(t,e){this._isEmiting=!0;for(var i,s=0;s<this.numSubs;s++)i=this.subs[s],i.func.call(i.owner,t,e);if(this._isEmiting=!1,this._subsToRemove){for(var n=this._subsToRemove.length,o=0;n>o;o++)this.unsubscribe(this._subsToRemove[o]);this._subsToRemove=null}},subscribe:function(t,e){for(var i=0;i<this.numSubs;i++)if(this.subs[i].owner===t)return console.warn("[meta.Channel.subscribe]:","Already subscribed to channel: "+this.name),void 0;var s=new meta.Subscriber(t,e);this.subs.push(s),this.numSubs++},unsubscribe:function(t){if(this._isEmiting)return this._subsToRemove||(this._subsToRemove=[]),this._subsToRemove.push(t),void 0;for(var e,i=0;i<this.numSubs;i++)if(e=this.subs[i],e.owner===t){this.subs[i]=this.subs[this.numSubs-1],this.subs.pop(),this.numSubs--;break}}},meta.Subscriber=function(t,e){this.owner=t,this.func=e},meta.createChannel=function(t){if(!t)return console.warn("[meta.createChannel]:","No name was specified!"),null;var e=meta.channels[t];return e||(e=new meta.Channel(t),meta.channels[t]=e),e},meta.releaseChannel=function(t){return t?(meta.channels[t]&&(meta.channels[t]=null),void 0):(console.warn("[meta.releaseChannel]:","No name was specified!"),void 0)},meta.subscribe=function(t,e,i){if("object"!=typeof t)return console.warn("[meta.subscribe]:","No owner passed."),void 0;if("string"!=typeof e){if("[object Array]"===Object.prototype.toString.call(e)){for(var s=e.length,n=0;s>n;n++)meta.subscribe(t,e[n],i);return}return console.warn("[meta.subscribe]:","Wrong type for channel object: "+typeof e),void 0}var o=meta.channels[e];if(o)e=o;else if(e=meta.createChannel(e),!e)return;e.subscribe(t,i)},meta.unsubscribe=function(t,e){if("string"!=typeof e){if("[object Array]"===Object.prototype.toString.call(e)){for(var i=e.length,s=0;i>s;s++)meta.unsubscribe(t,e[s]);return}return console.warn("[meta.unsubscribe]:","Wrong type for channel object."),void 0}return e=meta.channels[e],e?(e.unsubscribe(t),void 0):(console.warn("[meta.unsubscribe]:","No name was specified!"),void 0)},meta.emit=function(t,e,i){return"string"!=typeof t||(t=meta.channels[t],t)?(t.emit(i,e),void 0):(console.warn("[meta.emit]:","No name was specified!"),void 0)},"use strict",meta.View=function(t){this.name=t,this.entities=[],this.views=null,this.parentView=null,this.numEntities=0,this._x=0,this._y=0,this._z=0,this._tween=null,this.bgColor=this._bgColor,this._isActive=!1},meta.View.prototype={release:function(){if(this.parentView&&this.parentView.detach(this),this.views)for(var t=this.views.length,e=0;t>e;e++)this.views[e].release();this.isActive=!1,this._unregisterFromEngine();for(var i,s=this.entities.length,n=0;s>n;n++)i=this.entities[n],i._view=null,i.remove();this.entities.length=0,this.numEntities=0},add:function(t){return t instanceof Entity.Geometry?t.isRemoved?(console.warn("[meta.View.add]:","Removed entity can not be added to the view."),void 0):t._view?(t._view===this?console.warn("[meta.View.add]:","Entity is already added to this view."):console.warn("[meta.View.add]:","Entity is already added to some other view."),void 0):(t.updatePos(),this.entities.push(t),this.numEntities++,this._attachren(t.children),t._view=this,t._viewNodeID=this.numEntities,this._z&&(t.z=t._z),t.texture||(t.isLoaded=!0),t._onResize&&t._onResize(meta.engine,null),this._isActive&&!t._depthNode.entity&&Entity.ctrl.isLoaded&&this._chnAddedToView.emit(t,meta.Event.ADDED_TO_VIEW),void 0):(console.warn("[meta.View.add]:","Object should have inherited Entity.Geometry class."),void 0)},_attachren:function(t){if(t)for(var e,i=t.length,s=0;i>s;s++)e=t[s],e.isRemoved||(this._attachren(e.children),e._view=this)},remove:function(t){return t._view?t._view!==this?(console.warn("[meta.View.remove]:","Entity is part of other view: "+t.view.name),void 0):t._parent!==t._entityCtrl?(console.warn("[meta.View.remove]:","Entity children are not part of view."),void 0):(this._removeFromBuffer(t),this._isActive?this._chnRemovedFromView.emit(t,meta.Event.REMOVED_FROM_VIEW):t.removeFully(),void 0):(console.warn("[meta.View.remove]:","Entity does not have view."),void 0)},_removeFromBuffer:function(t){var e=this.entities[this.numEntities-1];e._viewNodeID=t._viewNodeID,this.entities[t._viewNodeID]=e,this.entities.pop(),this.numEntities--,t._view=null,this._removeChildren(t.children)},_removeChildren:function(t){if(t)for(var e,i=t.length,s=0;i>s;s++)e=t[s],this._removeChildren(e),e._view=null},attach:function(t){if("string"==typeof t){var e=meta.views[t];if(!e)return console.warn("[meta.View.attach]:","No such view found: "+t),void 0;t=e}return t._isActive?(console.warn("[meta.View.attach]:","Can't attach an active view."),void 0):t.parentView?(console.warn("[meta.View.attach]:","View is already part of other view."),void 0):(this.views||(this.views=[]),this.views.push(t),t.parentView=this,this._isActive&&(t.isActive=!0),void 0)},detach:function(t){if("string"==typeof t){var e=meta.views[t];if(!e)return console.warn("[meta.View.attach]:",'No such view found: "'+t+'"'),void 0;t=e}if(!t.parentView)return console.warn("[meta.View.detach]:","View has not parents to detach from."),void 0;if(t.parentView!==this)return console.warn("[meta.View.detach]:","Detaching from wrong parent."),void 0;for(var i=this.views.length,s=0;i>s;s++)if(this.views[s]===t){this.views[s]=this.views[i-1],this.views.pop();break}t.isActive=!1,t.parentView=null},register:function(t){var e=meta.createCtrl(t,this);this.controllers?this.controllers.push(e):this.controllers=[e],this._isActive&&(!this.parentView||this.parentView._isActive)&&meta.addCtrl(e)},unregister:function(t){for(var e=this.controllers.length,i=0;e>i;i++)this.controllers[i].name===t&&(this._isActive&&meta.unregister(t),this.controllers[i]=this.controllers[e-1],this.controllers.pop())},_unregisterFromEngine:function(){if(this.controllers)for(var t=this.controllers.length,e=0;t>e;e++)meta.unregister(this.controllers[e])},_addEntities:function(){this.numEntities>0&&this._chnAddedToView.emit(this.entities,meta.Event.ADDED_TO_VIEW)},_removeEntities:function(){this.numEntities>0&&this._chnRemovedFromView.emit(this.entities,meta.Event.REMOVED_FROM_VIEW)},_makeActive:function(){var t;if(this.controllers){var e=this.controllers.length;for(t=0;e>t;t++)meta.addCtrl(this.controllers[t])}if(this._addEntities(),this.views){var i=this.views.length;
for(t=0;i>t;t++)this.views[t].isActive=!0}},_makeInactive:function(){var t;if(this.controllers){var e=this.controllers.length;for(t=0;e>t;t++)meta.removeCtrl(this.controllers[t])}if(this._removeEntities(),this.views){var i=this.views.length;for(t=0;i>t;t++)this.views[t].isActive=!1}},set bgColor(t){if(meta.engine.isWebGL){3===t.length&&(t+=t.substr(1,3));var e=meta.hexToRgb(t);e.r>0&&(e.r=e.r/255),e.g>0&&(e.g=e.g/255),e.b>0&&(e.b=e.b/255),meta.ctx.clearColor(e.r,e.g,e.b,1)}else this._bgColor=t},get bgColor(){return this._bgColor},set isActive(t){if(this._isActive!==t)if(t){if(this.parentView&&!this.parentView._isActive)return;this._isActive=t,this._makeActive()}else this._isActive=t,this._makeInactive()},get isActive(){return this._isActive},set x(t){if(this._x!==t){this._x=t;for(var e,i=this.entities.length,s=0;i>s;s++)e=this.entities[s],e.forcePosition(e._x,e._y)}},set y(t){if(this._y!==t){this._y=t;for(var e,i=this.entities.length,s=0;i>s;s++)e=this.entities[s],e.forcePosition(e._x,e._y)}},set z(t){this._z=t;for(var e=this.entities.length,i=0;e>i;i++)this.entities[i].z=this.entities[i]._z},get x(){return this._x},get y(){return this._y},get z(){return this._z},get tween(){return this._tween||(this._tween=new meta.Tween(this)),this._tween},controllers:null,_bgColor:"#888888",bgTransparent:!1},meta.setView=function(t){if(!t)return console.error("[meta.getView]:","No name specified!"),void 0;if(!meta.view||t!==meta.view.name){var e=meta.views[t];e||(e=new meta.View(t),meta.views[t]=e),meta.view=e,meta.engine.isInited&&meta.engine.onViewChange(e)}},meta.getView=function(t){if(!t)return console.error("[meta.getView]:","No name specified!"),null;var e=meta.views[t];return e||(e=new meta.View(t),meta.views[t]=e),e},meta.attachView=function(t){if(!meta.view)return console.warn("[meta.attachView]:","No current active view."),void 0;if("string"==typeof t){var e=meta.views[t];if(!e)return console.warn("[meta.attachView]:","No such view found: "+t),void 0;t=e}meta.view.attach(t)},meta.detachView=function(t){if(!meta.view)return console.warn("[meta.detachView]:","No current active view."),void 0;if("string"==typeof t){var e=meta.views[t];if(!t)return console.warn("[meta.detachView]:","No such view found: "+t),void 0;t=e}meta.view.detach(t)},"use strict",meta.Camera=function(){this._x=0,this._y=0,this.volume=new meta.math.AdvAABB(0,0,0,0),this.zoomBounds=null,this._zoom=1,this.prevZoom=1,this.zoomRatio=1,this._draggable=!1,this._isDraggable=!1,this._isAutoZoom=!1,this._enableBorderIgnore=!0,this._enableCentering=!1,this._enableCenteringX=!0,this._enableCenteringY=!0,this._chnMove=null,this._chnResize=null,this._wasMoved=!1,this.init()},meta.Camera.prototype={init:function(){this._chnMove=meta.createChannel(meta.Event.CAMERA_MOVE),this._chnResize=meta.createChannel(meta.Event.CAMERA_RESIZE),this.volume.resize(meta.width,meta.height),meta.subscribe(this,meta.Event.RESIZE,this._onResize),meta.subscribe(this,meta.Event.WORLD_RESIZE,this._onWorldResize),this.zoomBounds={width:-1,height:-1,minWidth:-1,minHeight:-1,maxWidth:-1,maxHeight:-1}},release:function(){this._chnMove.release(),meta.unsubscribe(this,meta.Event.RESIZE),meta.unsubscribe(this,meta.Event.WORLD_RESIZE),this.enableDrag=!1},updateView:function(){var t=meta.world;if(this._isAutoZoom){var e=this.zoomBounds.width,i=this.zoomBounds.height,s=meta.width/e,n=meta.height/i;this.prevZoom=this._zoom,this._zoom=s,s>n&&(this._zoom=n)}this.prevZoom!==this._zoom&&(this.zoomRatio=1/this._zoom,this.volume.scale(this.zoomRatio,this.zoomRatio),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE)),this._wasMoved||(this._enableCentering?(this._x=this._enableCenteringX?Math.floor((this.volume.width-t.width)/2):0,this._y=this._enableCenteringY?Math.floor((this.volume.height-t.height)/2):0):(this._x=0,this._y=0),this.volume.move(this._x,this._y)),this._chnMove.emit(this,meta.Event.CAMERA_MOVE)},bounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.width=t,this.zoomBounds.height=e,this.updateView()},minBounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.minWidth=t,this.zoomBounds.minHeight=e,this.updateView()},maxBounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.maxWidth=t,this.zoomBounds.maxHeight=e,this.updateView()},_onInput:function(t,e){var i=Input.Event;if(e===i.INPUT_MOVE)this._drag(t);else if(e===i.INPUT_DOWN){if(0!==t.keyCode)return;this._startDrag(t)}else if(e===i.INPUT_UP){if(0!==t.keyCode)return;this._endDrag(t)}},_onResize:function(t,e){this.volume.resize(t.width,t.height),meta.world.onCameraResize(this,meta.Event.CAMERA_RESIZE),this.updateView(),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE)},_onWorldResize:function(t,e){this.updateView()},_startDrag:function(t){this._draggable&&(this._isDraggable=!0)},_endDrag:function(t){this._isDraggable=!1},_drag:function(t){if(this._isDraggable){var e=(t.screenX-t.prevScreenX)*this.zoomRatio,i=(t.screenY-t.prevScreenY)*this.zoomRatio;this._x+=e,this._y+=i,this.volume.move(-e,-i),this._wasMoved=!0,this.enableBorderIgnore||(-this._x<0&&(this._x=0),-this._y<0&&(this._y=0)),this._chnMove.emit(this,meta.Event.CAMERA_MOVE)}},set x(t){this._x!==t&&(this._x=t,this._wasMoved=!0,this.updateView())},set y(t){this._y!==t&&(this._y=t,this._wasMoved=!0,this.updateView())},get x(){return this._x},get y(){return this._y},get width(){return this.volume.width},get height(){return this.volume.height},set zoom(t){this._zoom!==t&&(this.prevZoom=this._zoom,this._zoom=t,this.updateView())},get zoom(){return this._zoom},set enableBorderIgnore(t){this._enableBorderIgnore=t,this.updateView()},get enableBorderIgnore(){return this._enableBorderIgnore},set draggable(t){this._draggable!==t&&(this._draggable=t,t?meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE],this._onInput):(meta.unsubscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE]),this._isDraggable=!1))},get draggable(){return this._draggable},set isAutoZoom(t){this._isAutoZoom!==t&&(this._isAutoZoom=t,this.updateView())},get isAutoZoom(){return this._isAutoZoom},set enableCentering(t){this._enableCentering=t,this.updateView()},set enableCenteringX(t){this._enableCenteringX=t,this.updateView()},set enableCenteringY(t){this._enableCenteringY=t,this.updateView()},get enableCentering(){return this._enableCentering},get enableCenteringX(){return this._enableCenteringX},get enableCenteringY(){return this._enableCenteringY}},"use strict",meta.World=function(t,e){this.chn=null,this.volume=new meta.math.AdvAABB(0,0,0,0),this.minWidth=-1,this.minHeight=-1,this.maxHeight=-1,this.maxHeight=-1,this.centerX=0,this.centerY=0,this.gridX=0,this.gridY=0,this.gridWidth=0,this.gridHeight=0,this.numGridX=0,this.numGridY=0,this.haveGrid=!1,this._discardUnusedSpace=!1,this.lockGrid=!1,this.showBounds=!1,this.init(t,e)},meta.World.prototype={init:function(t,e){this.chn=meta.createChannel(meta.Event.WORLD_RESIZE),this.bounds(t,e)},updateVolume:function(){var t=this.volume.width,e=this.volume.height;this.minWidth>-1&&t<this.minWidth?t=this.minWidth:this.maxWidth>-1&&t>this.maxWidth&&(t=this.maxWidth),this.minHeight>-1&&e<this.minHeight?e=this.minHeight:this.maxHeight>-1&&e>this.maxHeight&&(e=this.maxHeight),this.centerX=t/2,this.centerY=e/2,this.volume.resize(t,e),this.chn.emit(meta.Event.WORLD_RESIZE,this)},bounds:function(t,e){this.volume.resize(t,e),this.updateVolume()},minBounds:function(t,e){this.minWidth=t,this.minHeight=e,this.updateVolume()},maxBounds:function(t,e){this.maxWidth=t,this.maxHeight=e,this.updateVolume()},setGrid:function(t){t.x=t.x||0,t.y=t.y||0,t.width=t.width||16,t.height=t.height||16,t.sizeX=t.sizeX||1,t.sizeY=t.sizeY||1,this.setGridPosition(t.x,t.y),this.setGridResolution(t.width,t.height),this.setGridSize(t.sizeX,t.sizeY)},setGridResolution:function(t,e){this.gridWidth=t,this.gridHeight=e,this.haveGrid=t||e,this.lockGrid||(this.numGridX=Math.floor(this.width/t),this.numGridY=Math.floor(this.height/e)),this.haveGrid&&this._discardUnusedSpace&&this.setBounds(this.numGridX*this.gridWidth,this.numGridY*this.gridHeight)},setGridSize:function(t,e){if(this.numGridX=t,this.numGridY=e,this.lockGrid=t||e,this.haveGrid){var i=this.numGridX*this.gridWidth,s=this.numGridY*this.gridHeight;this.width>i&&(i=this.width),this.height>s&&(s=this.height),this.setBounds(i,s),this.lockGrid||(this.numGridX=Math.floor(this.width/this.gridWidth),this.numGridY=Math.floor(this.height/this.gridHeight))}},setGridPosition:function(t,e){this.gridX=t,this.gridY=e},getGridPosX:function(t){return this.gridX+this.gridWidth*t},getGridPosY:function(t){return this.gridY+this.gridHeight*t},getGridFromWorldX:function(t){var e=Math.floor((t-this.gridX)/this.gridWidth);return-1>e?e=-1:e>=this.numGridX&&(e=-1),e},getGridFromWorldY:function(t){var e=Math.floor((t-this.gridY)/this.gridHeight);return-1>e?e=-1:e>=this.numGridY&&(e=-1),e},get randX(){return meta.random.number(0,this.volume.width)},get randY(){return meta.random.number(0,this.volume.height)},onCameraResize:function(t,e){this.updateVolume()},set discardUnusedSpace(t){this._discardUnusedSpace=t,t&&this.haveGrid&&this.setBounds(this.gridX+this.numGridX*this.gridWidth,this.gridY+this.numGridY*this.gridHeight)},get discardUnusedSpace(){return this._discardUnusedSpace},get left(){return this.volume.minX},get right(){return this.volume.maxX},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},get width(){return this.volume.width},get height(){return this.volume.height}},"use strict",function(t){var e=!1,i=/\b_super\b/;t.meta.Class=function(){},t.meta.Class.extend=function(t){function s(t,i,s,n,o,h){e||(this._init&&this._init(t,i,s,n,o,h),this.init&&this.init(t,i,s,n,o,h))}var n=this.prototype;e=!0;var o=new this;e=!1;for(var h in t){var r=Object.getOwnPropertyDescriptor(t,h);r.get||r.set?Object.defineProperty(o,h,r):o[h]="function"==typeof t[h]&&"function"==typeof n[h]&&i.test(t[h])?function(t,e){return function(i,s,o,h,r,a){var u=this._super;this._super=n[t],this._fn=e;var c=this._fn(i,s,o,h,r,a);return this._super=u,c}}(h,t[h]):t[h]}return s.prototype=o,s.prototype.constructor=o.init,s.extend=this.extend,s},t.meta.Class=t.meta.Class,t.meta.Class=t.meta.Class}("undefined"!=typeof window?window:global),"use strict",meta.Controller=meta.Class.extend({init:meta.emptyFunc,_init:function(t){this.view=t},release:meta.emptyFunc,load:meta.emptyFunc,unload:meta.emptyFunc,ready:meta.emptyFunc,update:meta.emptyFuncParam,view:null,name:"unknown",isLoaded:!1}),"use strict",meta._cache.timerIndex=0,meta.Timer=function(t,e,i,s){this.owner=t,this.id=meta._cache.timerIndex++,this.func=e,this.onRemove=null,this.tDelta=i,this.numTimes=s,void 0===this.numTimes&&(this.numTimes=-1),this.tAccumulator=0,this.tStart=Date.now()},meta.Timer.prototype={remove:function(){this.numTimes=0},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1,this.tStart=Date.now()},onRemove:null,isPaused:!1},meta.addTimer=function(t,e,i,s){"function"==typeof t&&(s=i,i=e,e=t,t=window);var n=new meta.Timer(t,e,i,s);return meta.engine._timers.push(n),meta.engine._numTimers++,n},"use strict",meta.shaders={},meta.Shader=function(){this.program=null,this.attrib={},this.uniform={},this._vertexShader=null,this._fragmentShader=null},meta.Shader.prototype={compile:function(){var t=meta.ctx;return this.program=t.createProgram(),t.attachShader(this.program,this._vertexShader),t.attachShader(this.program,this._fragmentShader),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?!0:(console.error("[meta.Shader.compile]:","Unable to initialize the shader program."),!1)},use:function(){meta.ctx.useProgram(this.program)},bindAttrib:function(t){if(!t)return console.error("[meta.Shader.bindAttrib]:","No name specified!"),void 0;var e=meta.ctx;this.attrib[t]=e.getAttribLocation(this.program,t),e.enableVertexAttribArray(this.attrib[t])},bindBuffer2f:function(t,e){var i=meta.ctx;i.bindBuffer(i.ARRAY_BUFFER,e),i.vertexAttribPointer(this.attrib[t],2,i.FLOAT,!1,0,0)},bindBuffer3f:function(t,e){var i=meta.ctx;i.bindBuffer(i.ARRAY_BUFFER,e),i.vertexAttribPointer(this.attrib[t],3,i.FLOAT,!1,0,0)},uniformMatrix:function(t,e){var i=meta.ctx,s=this.uniform[t];s||(s=i.getUniformLocation(this.program,t),this.uniform[t]=s),i.uniformMatrix4fv(s,!1,e.m)},set vertexShader(t){var e=meta.ctx;this._vertexShader=e.createShader(e.VERTEX_SHADER),e.shaderSource(this._vertexShader,t),e.compileShader(this._vertexShader),e.getShaderParameter(this._vertexShader,e.COMPILE_STATUS)||console.error("[meta.Shader.vetexShader]:",e.getShaderInfoLog(this._vertexShader))},get vertexShader(){return this._vertexShader},set fragmentShader(t){var e=meta.ctx;this._fragmentShader=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(this._fragmentShader,t),e.compileShader(this._fragmentShader),e.getShaderParameter(this._fragmentShader,e.COMPILE_STATUS)||console.error("[meta.Shader.fragmentShader]:","An error occurred compiling the shaders: "+e.getShaderInfoLog(this._fragmentShader))},get fragmentShader(){return this._fragmentShader}},meta.setShader=function(t){if(!t)return console.error("[meta.setShader]:","No name specified."),null;var e=meta.shaders[t];return e?(meta.shader=e,e.use(),e):(console.error("[meta.setShader]:","No shader found with a name: "+t),null)},meta.getShader=function(t){if(!t)return console.error("[meta.getShader]:","No name specified."),null;var e=meta.shaders[t];return e?e:(console.error("[meta.getShader]:","No shader found with a name: "+t),null)},"use strict",meta.Brush=meta.Class.extend({_init:function(){this.states={}},setState:function(t,e,i){if("string"==typeof e){var s=meta.getTexture(e);if(!s)return console.warn("[meta.Brush.setState]:","Could not get texture from texture name: "+e),null;e=s}void 0===typeof i&&(i=null);var n=new meta.BrushState(t,e,i);return this.states[t]=n,this.defaultState||(this.defaultState=n),n},setHiddenState:function(t,e,i){var s=this.setState(t,e,i);return s&&(s.isHidden=!0),s},removeState:function(t){return this.states[t]?(delete this.states[t],void 0):(console.warn("[meta.Brush.removeState]:","No such state: "+t),void 0)},getState:function(t){return this.states?this.states[t._state]:null},getRandomState:function(){if(!this.states)return null;var t=null,e=0;for(var i in this.states)this.states[i].isHidden||Math.random()<1/++e&&(t=i);return t},states:null,defaultState:null}),meta.BrushState=function(t,e,i){this.name=t,this.texture=e,this.params=i,this.isHidden=!1},meta.BrushState.prototype={applyState:function(t){if(this.params)for(var e in this.params)t._brushParams[e]=t[e],t[e]=this.params[e]},discardState:function(t){var e=t._brushParams;for(var i in e)t[i]=e[i]}},"use strict",meta.Event={RESIZE:"resize",WORLD_RESIZE:"worldResize",CAMERA_MOVE:"cameraMove",CAMERA_RESIZE:"cameraResize",FOCUS:"focus",FULLSCREEN:"fullScreen",ADDED_TO_VIEW:"addedToView",REMOVED_FROM_VIEW:"removedFromView"},"use strict",meta.getTexture=function(t){return Resource.ctrl.getTexture(t)},"use strict",meta.utils.LinkedList=function(){this.length=0,this.first=new meta.utils.LinkedListNode(null),this.last=new meta.utils.LinkedListNode(null),this.first.next=this.last,this.last.prev=this.first},meta.utils.LinkedList.prototype={push:function(t){this.last.prev.next=t,this.last.prev=t,t.prev=this.last.prev,t.next=this.last,this.length++},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev,t.prev=null,t.next=null,this.length--}},meta.utils.LinkedListNode=function(t){this.data=t,this.prev=null,this.next=null},"use strict",meta.math={toRadians:function(t){return t*Math.PI/180},toDegree:function(t){return 180*t/Math.PI},radiansToPoint:function(t,e,i,s){var n=i-t,o=s-e;return Math.atan(n/o)},clamp:function(t,e,i){return e>t?e:t>i?i:t},map:function(t,e,i,s,n){return t==e?s:(t-e)*(n-s)/(i-e)+s},length2:function(t,e){return Math.sqrt(t*t+e*e)},limit:function(t,e){return t>e?e:-e>t?-e:t},lerp:function(t,e,i){return t+(e-t)*i},lookAt:function(t,e,i,s){return Math.atan2(i-t,e-s)},lookAtEntity:function(t,e){return meta.math.lookAt(t.x,t.y,e.x,e.y)}},"use strict",meta.math.Vector2=function(t,e){this.x=t,this.y=e},meta.math.Vector2.prototype={reset:function(){this.x=0,this.y=0},set:function(t,e){this.x=t,this.y=e},add:function(t){this.x+=t,this.y+=t},sub:function(t){this.x-=t,this.y-=t},mul:function(t){this.x*=t,this.y*=t},div:function(t){this.x/=t,this.y/=t},addVec2:function(t){this.x+=t.x,this.y+=t.y},subVec2:function(t){this.x-=t.x,this.y-=t.y},mulVec2:function(t){this.x*=t.x,this.y*=t.y},divVec2:function(t){this.x/=t.x,this.y/=t.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);this.x/=t,this.y/=t},dot:function(t,e){return this.x*t+this.y*e},truncate:function(t){var e=Math.sqrt(this.x*this.x+this.y*this.y);e>t&&(this.normalize(),this.x*=t,this.y*=t)},limit:function(t){this.x>t?this.x=t:this.x<-t&&(this.x=-t),this.y>t?this.y=t:this.y<-t&&(this.y=-t)},lengthSq:function(){return this.x*this.x+this.y*this.y},perp:function(){var t=this.x;this.x=-this.y,this.y=t},print:function(t){console.log(t?'[vec "'+t+'"] x: '+this.x+" y: "+this.y:"[vec] x: "+this.x+" y: "+this.y)}},"use strict",meta.math={},meta.math.AABB=function(t,e,i,s){this.minX=t,this.minY=e,this.maxX=i,this.maxY=s},meta.math.AABB.prototype={move:function(t,e){this.minX+=t,this.minY+=e,this.maxX+=t,this.maxY+=e},set:function(t,e){var i=this.maxX-this.minX,s=this.maxY-this.minY;this.minX=t,this.minY=e,this.maxX=t+i,this.maxY=e+s},resize:function(t,e){this.maxX=this.minX+t,this.maxY=this.minY+e},copy:function(t){this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY},vsAABB:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?!1:!0},vsBorderAABB:function(t){return this.minX>=t.maxX||this.maxX<=t.minX||this.minY>=t.maxY||this.maxY<=t.minY?!1:!0},vsAABBIntersection:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?0:this.minX>t.minX||this.minY>t.minY?1:this.maxX<t.maxX||this.maxY<t.maxY?1:2},vsPoint:function(t,e){return this.minX>t||this.maxX<t?!1:this.minY>e||this.maxY<e?!1:!0},vsBorderPoint:function(t,e){return this.minX>=t||this.maxX<=t?!1:this.minY>=e||this.maxY<=e?!1:!0},getSqrDistance:function(t,e){var i,s=0;return t<this.minX&&(i=this.minX-t,s+=i*i),t>this.maxX&&(i=t-this.maxX,s+=i*i),e<this.minY&&(i=this.minY-e,s+=i*i),e>this.maxY&&(i=e-this.maxY,s+=i*i),s},getDistanceVsAABB:function(t){var e=this.minX+(this.maxX-this.minX)/2,i=this.minY+(this.maxY-this.minY)/2,s=t.minX+(t.maxY-t.minY)/2,n=t.minY+(t.maxY-t.minY)/2,o=s-e,h=n-i;return Math.sqrt(o*o+h*h)},get width(){return this.maxX-this.minX},get height(){return this.maxY-this.minY},isUndefined:function(){return void 0===this.maxY},draw:function(t){var e=Math.floor(this.minX),i=Math.floor(this.minY),s=Math.floor(this.maxX),n=Math.floor(this.maxY);t.beginPath(),t.moveTo(e-.5,i-.5),t.lineTo(s+.5,i-.5),t.lineTo(s+.5,n+.5),t.lineTo(e-.5,n+.5),t.lineTo(e-.5,i-.5),t.stroke()},drawTranslated:function(t,e){var i,s;e?(i=e.x,s=e.y):(i=0,s=0),this.translate(i,s),this.draw(t),this.translate(-i,-s)},print:function(t){console.log(t?"(AABB) "+t+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.AdvAABB=function(t,e,i,s){this.minX=t,this.minY=e,this.maxX=i,this.maxY=s,this.initWidth=i-t,this.initHeight=s-e,this.initHalfWidth=this.initWidth/2,this.initHalfHeight=this.initHeight/2,this.width=this.initWidth,this.height=this.initHeight,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.x=Math.floor(t+this.halfWidth),this.y=Math.floor(e+this.halfHeight),this.scaleX=1,this.scaleY=1},meta.math.AdvAABB.prototype={move:function(t,e){this.x+=t,this.y+=e,this.minX+=t,this.minY+=e,this.maxX+=t,this.maxY+=e},set:function(t,e){this.x=Math.floor(t),this.y=Math.floor(e),this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.x+this.halfWidth,this.maxY=this.y+this.halfHeight},resize:function(t,e){this.initWidth=t,this.initHeight=e,this.initHalfWidth=t/2,this.initHalfHeight=e/2,this.width=t*this.scaleX,this.height=e*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},moveToAndResize:function(t,e,i,s){this.x=Math.floor(t),this.y=Math.floor(e),this.initWidth=i,this.initHeight=s,this.initHalfWidth=i/2,this.initHalfHeight=s/2,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},scale:function(t,e){this.scaleX=t,this.scaleY=e,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},vsAABB:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?!1:!0},vsBorderAABB:function(t){return this.minX>=t.maxX||this.maxX<=t.minX||this.minY>=t.maxY||this.maxY<=t.minY?!1:!0},vsAABBIntersection:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?0:this.minX>t.minX||this.minY>t.minY?1:this.maxX<t.maxX||this.maxY<t.maxY?1:2},vsPoint:function(t,e){return this.minX>t||this.maxX<t?!1:this.minY>e||this.maxY<e?!1:!0},vsBorderPoint:function(t,e){return this.minX>=t||this.maxX<=t?!1:this.minY>=e||this.maxY<=e?!1:!0},getSqrDistance:function(t,e){var i,s=0;return t<this.minX&&(i=this.minX-t,s+=i*i),t>this.maxX&&(i=t-this.maxX,s+=i*i),e<this.minY&&(i=this.minY-e,s+=i*i),e>this.maxY&&(i=e-this.maxY,s+=i*i),s},getDistanceVsAABB:function(t){var e=this.minX+(this.maxX-this.minX)/2,i=this.minY+(this.maxY-this.minY)/2,s=t.minX+(t.maxY-t.minY)/2,n=t.minY+(t.maxY-t.minY)/2,o=s-e,h=n-i;return Math.sqrt(o*o+h*h)},isUndefined:function(){return void 0===this.maxY},draw:function(t){var e=Math.floor(this.minX),i=Math.floor(this.minY),s=Math.floor(this.maxX),n=Math.floor(this.maxY);t.beginPath(),t.moveTo(e,i),t.lineTo(s,i),t.lineTo(s,n),t.lineTo(e,n),t.lineTo(e,i),t.stroke()},drawTranslated:function(t){var e=meta.camera;this.translate(e._x,e._y),this.draw(t),this.translate(-e._x,-e._y)},print:function(t){console.log(t?"(AABB) "+t+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.Matrix4=function(){this.m=new Float32Array(16),this.m[0]=1,this.m[5]=1,this.m[10]=1,this.m[15]=1},meta.math.Matrix4.prototype={reset:function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},ortho:function(t,e,i,s,n,o){this.m[0]=2/(e-t),this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=2/(s-i),this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=-2/(o-n),this.m[11]=0,this.m[12]=-(e+t)/(e-t),this.m[13]=-(s+i)/(s-i),this.m[14]=-(o+n)/(o-n),this.m[15]=1}},"use strict",meta.math.Random=function(){this.seed=0,this.a=0,this.m=0,this.q=0,this.r=0,this.oneOverM=0,this.init()},meta.math.Random.prototype={init:function(){this.setSeed(3456789012,!0)},generate:function(){var t=Math.floor(this.seed/this.q),e=this.seed%this.q,i=this.a*e-this.r*t;return this.seed=i>0?i:i+this.m,this.seed*this.oneOverM},number:function(t,e){var i=this.generate();return Math.round((e-t)*i+t)},numberF:function(t,e){var i=this.generate();return(e-t)*i+t},setSeed:function(t,e){if(void 0!==e&&(e=!0),e===!0){var i=new Date;this.seed=t+16777215*i.getSeconds()+65535*i.getMinutes()}else this.seed=t;this.a=48271,this.m=2147483647,this.q=Math.floor(this.m/this.a),this.r=this.m%this.a,this.oneOverM=1/this.m}},meta.random=new meta.math.Random,"use strict",meta.Tween=function(t){this.owner=t,this.chain=[],this.linkIndex=0,this.currLink=null,this._updateNodeID=-1,this._tStart=0,this._tFrame=0},meta.Tween.prototype={play:function(){return this.owner.isRemoved?this:(this.isPaused=!1,this.next(),this._play(),this)},_play:function(){this._parent||-1!==this._updateNodeID||Entity.ctrl._addToUpdating(this)},stop:function(){return this.linkIndex=0,this._stop(),this},_stop:function(){this._parent||-1===this._updateNodeID||Entity.ctrl._removeFromUpdating(this)},paused:function(t){return void 0===t&&(t=!0),this.isPaused=t,this},resume:function(){return this.isPaused=!1,this},clear:function(){return this.stop(),this._tStart=0,this.chain.length=0,this.linkIndex=0,this.currLink=null,this},reset:function(){if(this.linkIndex=0,this.currLink=this.chain[0],!this.currLink)return this;for(var t in this.currLink.startValues)this.owner[t]=this.currLink.startValues[t];return this.stop(),this},next:function(){var t=!1;if(this.linkIndex===this.chain.length){if(0===this.numRepeat)return this.stop(),this;this.linkIndex=0,-1!==this.numRepeat&&this.numRepeat--,t=!0}this._isLinkDone=!1;var e,i=this.chain[this.linkIndex++];if(t)for(e in i.startValues)this.owner[e]=i.startValues[e];else for(e in i.endValues)i.startValues[e]=this.owner[e];return i._onStart&&i._onStart.call(this),this._tStart=window.performance.now(),this.currLink=i,this},repeat:function(t){return void 0===t&&(t=-1),this.numRepeat=t,this},reverse:function(t){return void 0===t&&(t=!0),this.doReverse=t,this},update:function(t){if(!this.currLink)return this.stop(),void 0;var e=window.performance.now();if(!(e-this._tFrame<this.currLink.tFrameDelay)){var i=(e-this._tStart)/this.currLink.duration;if(i>1&&(i=1),this._isLinkDone){if(e-this._tFrame<this.currLink.tDelay)return}else this._tFrame=e,this.currLink.update(i),this.currLink._onTick&&this.currLink._onTick.call(this);if(1===i){if(!this._isLinkDone&&this.currLink.tDelay>0)return this._isLinkDone=!0,void 0;this.currLink._onComplete&&this.currLink._onComplete.call(this),this.next()}}},to:function(t,e,i){var s=new meta.Tween.Link(this,t,e,i);return this.chain.push(s),s},wait:function(t){var e=this.to(null,0,null);return e.wait(t),e},numRepeat:0,isPaused:!1,doReverse:!1,_isLinkDone:!1,_isReversing:!1},"use strict",meta.Tween.Easing={linear:function(t){return t},quadIn:function(t){return t*t},quadOut:function(t){return t*(2-t)},quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:function(t){return t*t*t},cubicOut:function(t){return--t*t*t+1},cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quartIn:function(t){return t*t*t*t},quartOut:function(t){return 1- --t*t*t*t},quartInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quintIn:function(t){return t*t*t*t*t},quintOut:function(t){return--t*t*t*t*t+1},quintIntOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sineIn:function(t){return 1-Math.cos(t*Math.PI/2)},sineOut:function(t){return Math.sin(t*Math.PI/2)},sineIntOut:function(t){return.5*(1-Math.cos(Math.PI*t))},expoIn:function(t){return 0===t?0:Math.pow(1024,t-1)},expoOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},expoInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)},circIn:function(t){return 1-Math.sqrt(1-t*t)},circOut:function(t){return Math.sqrt(1- --t*t)},circInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s)))},elasticOut:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/s)+1)},elasticInOut:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?-.5*i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s):i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s)*.5+1)},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},backInOut:function(t){var e=2.5949095;return(t*=2)<1?.5*t*t*((e+1)*t-e):.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:function(t){return 1-meta.Easing.bounceOut(1-t)},bounceOut:function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},bounceInOut:function(t){return.5>t?.5*meta.Easing.bounceIn(2*t):.5*meta.Easing.bounceOut(2*t-1)+.5}},"use strict",meta.Tween.Link=function(t,e,i,s){this.tween=t,this.startValues={},this.endValues=e,this.duration=i,this._onComplete=s},meta.Tween.Link.prototype={play:function(){return this.tween.play(),this},stop:function(){return this.tween.stop(),this},paused:function(t){return this.tween.paused(t),this},resume:function(){return this.tween.resume(),this},clear:function(){return this.tween.clear(),this},reset:function(){return this.tween.reset(),this},update:function(t){var e=this._easing(t),i,s,n;for(var o in this.endValues)i=this.startValues[o],s=this.endValues[o],"string"==typeof i&&(s=i+parseFloat(s,4)),n=i+(s-i)*e,this.isRounding&&(n=Math.round(n)),this.tween.owner[o]=n},next:function(){return this.tween.next(),this},wait:function(t){return this.tDelay=t,this},frameDelay:function(t){return this.tFrameDelay=t,this},round:function(t){return void 0===t&&(t=!0),this.isRounding=t,this},repeat:function(t){return this.tween.repeat(t),this},reverse:function(t){return this.tween.reverse(t),this},easing:function(t){return this._easing=t,this},onStart:function(t){return this._onStart=t,this},onComplete:function(t){return this._onComplete=t,this},onTick:function(t){return this._onTick=t,this},to:function(t,e,i){return this.tween.to(t,e,i)},_easing:meta.Tween.Easing.linear,_onStart:null,_onComplete:null,_onTick:null,tDelay:0,tFrameDelay:0,isRounding:!1},"use strict",window.Component={},"use strict";var Resource={};Resource.Controller=meta.Controller.extend({init:function(){this.resources={},this.resourcesInUse={},this._chn=meta.createChannel("Resource");var t=document.createElement("canvas");Resource.Texture.prototype._tmpImg=t,Resource.Texture.prototype._tmpCtx=t.getContext("2d");var e=Resource.Sound.prototype;meta.device.isAudioAPI?(e._context=new AudioContext,console.log("%cAudio: %cWebAudio ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")):(e._loadFromUrl=e._loadFromUrl_legacy,e._clear=e._clear_legacy,e._createInstance=e._createInstance_legacy,e._syncLoading=!0,console.log("%cAudio: %c<audio> ","font-weight: bold; padding: 2px 0 1px 0; width: 500px;","padding: 2px 0 1px 0;"))},add:function(t){var e=this.resources[t.type];e||(e={},this.resources[t.type]=e);var i=t.path;if("unknown"===t.name&&i){var s=i.lastIndexOf("."),n=i.lastIndexOf("/");t.name=0>s||i.length-s>5?i.slice(n+1):i.slice(n+1,s)}return e[t.name]?(console.warn("[Resource.Manager.add]:","There is already a resource("+meta.enumToString(Resource.Type,t.type)+") added with a name: "+t.name),null):(e[t.name]=t,this._chn.emit(t,Resource.Event.ADDED),t)},remove:function(t){var e=this.resources[t.type];return e&&e[t.name]?(e[t.name]=null,void 0):(console.warn("[Resource.Manager.remove]:","Resource("+meta.enumToString(Resource.Type,t.type)+")("+t.name+") is not added to the manager."),void 0)},addToLoad:function(t){t.isLoading=!0,meta.engine.isReady||this.numToLoad++},loadSuccess:function(t){var e=this.resourcesInUse[t.type];e||(e=[],this.resourcesInUse[t.type]=e),e.push(t),t.isLoading=!1,t.inUse=!0,meta.engine.isReady||(this.numToLoad--,this.numLoaded++,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn.emit(this,Resource.Event.ALL_LOADED)))},loadFailed:function(t){t.isLoading=!1,meta.engine.isReady||(this.numToLoad--,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn.emit(this,Resource.Event.ALL_LOADED)))
},getTexture:function(t){if(!t)return console.warn("[Resource.Manager.getTexture]:","No name specified."),null;var e=this.resources[Resource.Type.TEXTURE];if(!e)return null;var i=e[t];return i?i:null},getSound:function(t){if(!t)return console.warn("[Resource.Manager.getSound]:","No name specified."),null;var e=this.resources[Resource.Type.SOUND];if(!e)return null;var i=e[t];return i?i:null},addToQueue:function(t){this._syncQueue||(this._syncQueue=[]),this._syncQueue.push(t)},loadNextFromQueue:function(){this.isSyncLoading=!1,this._syncQueue&&this._syncQueue.length&&(this._syncQueue[this._syncQueue.length-1].forceLoad(!0),this._syncQueue.pop())},getUniqueID:function(){return++this._uniqueID},resources:null,resourcesInUse:null,rootPath:"",numLoaded:0,numToLoad:0,_syncQueue:null,isSyncLoading:!1,_chn:null,_uniqueID:0}),"use strict",Resource.Event={UNLOADED:0,LOADED:1,RESIZE:2,CHANGED:3,ADDED:4,ALL_LOADED:5},Resource.Type={BASIC:0,TEXTURE:1,SOUND:2,SPRITE_SHEET:3},Resource.TextureType={UNKNOWN:-1,CANVAS:0,WEBGL:1},Resource.AnimType={NONE:0,LINEAR_H:1,LINEAR_V:2,RADIAL:3,RADIAL_TOP_LEFT:4,RADIAL_TOP_RIGHT:5,RADIAL_BOTTOM_LEFT:6,RADIAL_BOTTOM_RIGHT:7},"use strict",Resource.Basic=meta.Class.extend({_init:function(){this.id=Resource.ctrl.getUniqueID()},subscribe:function(t,e){this.chn||(this.chn=meta.createChannel("__res"+this.id)),this.chn.subscribe(t,e)},unsubscribe:function(t){this.chn&&(this.chn.unsubscribe(t),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(t,e){this.chn&&this.chn.emit(t,e)},set isLoaded(t){t?this._isLoaded?(this._isLoaded=t,this.emit(this,Resource.Event.CHANGED)):(this._isLoaded=t,this.emit(this,Resource.Event.LOADED)):this._isLoaded&&(this._isLoaded=t,this.emit(this,Resource.Event.UNLOADED))},get isLoaded(){return this._isLoaded},id:0,type:Resource.Type.BASIC,name:"unknown",path:"",chn:null,_isLoaded:!1,isLoading:!1,inUse:!1}),"use strict",Resource.Texture=Resource.Basic.extend({init:function(t,e){if(void 0!==t){var i=typeof t;if("object"===i)for(var s in t)this[s]=t[s];else"string"===i?this.path=t:(this.textureType=t,e&&(this.path=e));if(this.path){var n=this.path.lastIndexOf(".");(-1===n||this.path.length-n>4)&&(this.path+=".png"),this.path=Resource.ctrl.rootPath+this.path}}-1===this.textureType&&(this.textureType=meta.engine.isWebGL?Resource.TextureType.WEBGL:Resource.TextureType.CANVAS),this.generate(this.textureType),this.path||(this._isLoaded=!0)},generate:function(t){if(this.isLoaded=!1,t===Resource.TextureType.WEBGL){var e=meta.ctx;this.image=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),this._vertices=new Float32Array([0,0,this._width,0,0,this._height,this._width,this._height]),this.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vbo),e.bufferData(e.ARRAY_BUFFER,this._vertices,e.DYNAMIC_DRAW)}else this.image=document.createElement("canvas"),this.ctx=this.image.getContext("2d"),this.image.width=this.fullWidth,this.image.height=this.fullHeight,this.textureType=Resource.TextureType.CANVAS;this.numFrames>1?(this.numFramesX=this.numFrames,this.isAnimated=!0):(this.numFramesX>1||this.numFramesY>1)&&(this.isAnimated=!0)},load:function(t){if(!this.isLoading){if(t)this.path=Resource.ctrl.rootPath+t;else if(!this.path)return;this.isLoaded=!1,Resource.ctrl.addToLoad(this);var e=this,i=new Image;meta.engine.isWebGL&&(i.crossOrigin="anonymous"),i.onload=function(){return i.complete?(e.createFromImg(i),Resource.ctrl.loadSuccess(e),void 0):(console.warn("[Resource.Texture.load]:","Could not load texture from - "+i.src),Resource.ctrl.loadFailed(e),void 0)},i.onerror=function(t){Resource.ctrl.loadFailed(e)},i.src=this.path}},createFromImg:function(t){if(this._width&&this._height){var e=this._width||t.width,i=this._height||t.height;this.numFramesX=t.width/e|0,this.numFramesY=t.height/i|0,this.isAnimated=!0}if(this.numFrames=this.numFramesX*this.numFramesY,this.resize(t.width,t.height),this.textureType!==Resource.TextureType.WEBGL)this.ctx.drawImage(t,0,0);else{var s=meta.ctx;s.bindTexture(s.TEXTURE_2D,this.image),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t)}this.isLoaded=!0},_createCachedImg:function(){this._cachedImg||(this._cachedImg=document.createElement("canvas"),this._cachedImg.width=this.fullWidth,this._cachedImg.height=this.fullHeight,this._cachedCtx=this._cachedImg.getContext("2d"))},resize:function(t,e){if(this.fullWidth!==t||this.fullHeight!==e){if(this.fullWidth=t,this.fullHeight=e,this.isAnimated?(this._width=t/this.numFramesX,this._height=e/this.numFramesY):(this._width=t,this._height=e),this.textureType){var i=meta.ctx;this._vertices[2]=this._width,this._vertices[5]=this._height,this._vertices[6]=this._width,this._vertices[7]=this._height,this._xRatio=1/this.numFramesX,this._yRatio=1/this.numFramesY,this.fromAtlas?(this._widthRatio=1/(this.ptr.fullWidth/this._width/this.numFramesX),this._heightRatio=1/(this.ptr.fullHeight/this._height/this.numFramesY)):(this._widthRatio=1/this.numFramesX,this._heightRatio=1/this.numFramesY),i.bindBuffer(i.ARRAY_BUFFER,this.vbo),i.bufferData(i.ARRAY_BUFFER,this._vertices,i.DYNAMIC_DRAW),this._isLoaded&&this._cachedImg&&(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this._cachedImg,0,0),this._cachedImg.width=this.fullWidth,this._cachedImg.height=this.fullHeight,this._cachedCtx.drawImage(this._cachedImg,0,0),i.bindTexture(i.TEXTURE_2D,this.image),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._cachedImg))}else this._isLoaded&&this.image.width>0&&this.image.height>0?(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this.image,0,0),this.image.width=this.fullWidth,this.image.height=this.fullHeight,this.ctx.drawImage(this._tmpImg,0,0)):(this.image.width=this.fullWidth,this.image.height=this.fullHeight);this._isLoaded&&this.emit(this,Resource.Event.RESIZE)}},upResize:function(t,e){t>this.fullWidth&&(e>this.fullHeight?this.resize(t,e):this.resize(t,this.fullHeight))},update:function(){this.textureType&&this.resize(this._width,this._height)},draw:function(t,e,i){this._bgTexture&&this._bgTexture.draw(t,e,i),this.fromAtlas?t.drawImage(this.ptr.image,this._x,this._y,this._width,this._height,e,i,this._width,this._height):t.drawImage(this.image,e,i)},drawFrame:function(t,e,i,s,n){if(this._bgTexture&&t.drawImage(this._bgTexture.image,e,i),this._anim){var o,h;if(1===this._anim.type){var r=this._anim.fill*s;0===r?r=.01:r>this.fullWidth&&(r=this.fullWidth),n?t.drawImage(this.image,this.fullWidth-r,0,r,this.fullHeight,e+this.fullWidth-r,i,r,this.fullHeight):t.drawImage(this.image,0,0,r,this.fullHeight,e,i,r,this.fullHeight)}else if(2===this._anim.type){var a=this._anim.fill*s;0===a?a=.01:a>this._height&&(r=this._height),n?t.drawImage(this.image,0,this.fullHeight-a,this.fullWidth,a,e,i+this.fullHeight-a,this.fullWidth,a):t.drawImage(this.image,0,0,this.fullWidth,a,e,i,this.fullWidth,a)}else 3===this._anim.type||(4===this._anim.type?(n?(o=this._anim.fill*(-this.numFrames+s+1)+Math.PI/2,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h+this.fullWidth,i),t.closePath(),t.clip()):(o=this._anim.fill*-s+Math.PI/2,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h,i+this.fullHeight),t.lineTo(e,i+this.fullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):5===this._anim.type?(n?(o=this._anim.fill*(this.numFrames-s-1)+Math.PI/2,h=e+Math.cos(o)*this._anim.length+this.fullWidth,t.save(),t.beginPath(),t.moveTo(e+this.fullWidth,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(e,i+this.fullHeight),t.lineTo(e,i),t.closePath(),t.clip()):(o=this._anim.fill*s+Math.PI/2,h=e+Math.cos(o)*this._anim.length+this.fullWidth,t.save(),t.beginPath(),t.moveTo(e+this.fullWidth,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h,i+this.fullHeight),t.lineTo(e+this.fullWidth,i+this.fullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):6===this._anim.type?(n?(o=this._anim.fill*(-this.numFrames+s+1),h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i+this.fullHeight),t.lineTo(h,i+Math.sin(o)*this._anim.length+this.fullHeight),t.lineTo(e+this.fullWidth,i),t.lineTo(e,i),t.closePath(),t.clip()):(o=this._anim.fill*-s,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i+this.fullHeight),t.lineTo(h,i+Math.sin(o)*this._anim.length+this.fullHeight),t.lineTo(e+this.fullWidth,i),t.lineTo(e+this.fullWidth,i+this.fullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):7===this._anim.type&&(n?(o=this._anim.fill*(this.numFrames-1-s)+Math.PI,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e+64,i+this.fullHeight),t.lineTo(h+64,i+Math.sin(o)*this._anim.length+64),t.lineTo(e,i),t.lineTo(e+64,i),t.closePath(),t.clip()):(o=this._anim.fill*s+Math.PI,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e+64,i+this.fullHeight),t.lineTo(h+64,i+Math.sin(o)*this._anim.length+64),t.lineTo(e,i),t.lineTo(e,i+64),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()))}else t.drawImage(this.image,this._width*(s%this.numFramesX),this._height*Math.floor(s/this.numFramesX),this._width,this._height,e,i,this._width,this._height)},clear:function(){if(this.textureType===Resource.TextureType.WEBGL){if(!this._cachedCtx)return;this._cachedCtx.clearRect(0,0,this.fullWidth,this.fullHeight);var t=meta.ctx;t.bindTexture(t.TEXTURE_2D,this.image),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.fullWidth,this.fullHeight);this.isLoaded=!0},clearSilent:function(){if(this.textureType===Resource.TextureType.WEBGL){this._tmpCtx.clearRect(0,0,this.fullWidth,this.fullHeight);var t=meta.ctx;t.bindTexture(t.TEXTURE_2D,this.image),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.fullWidth,this.fullHeight)},drawOver:function(t,e,i){if(!t)return console.warn("[Resource.Texture.drawOver]:","No texture specified."),void 0;if(e=e||0,i=i||0,console.log("here"),"string"==typeof t){var s=meta.getTexture(t);if(!s)return console.warn("[Resource.Texture.drawOver]:","No such texture with name - "+t),void 0;t=s}if(t.textureType===Resource.TextureType.WEBGL){if(!t._canvasCache)return t._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,t.path),t._canvasCache.load(),t=t._canvasCache,this._loadCache={name:"drawOver",texture:t,x:e,y:i},this.isLoaded=!1,t.subscribe(this,this.onTextureCacheEvent),void 0;t=t._canvasCache}var n=this.ctx;if(this.textureType&&(this._createCachedImg(),n=this._cachedCtx),n.drawImage(t.image,e,i),this.textureType){var o=meta.ctx;o.bindTexture(o.TEXTURE_2D,this.image),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},fillRect:function(t,e,i){if("number"!=typeof t){if(!t)return console.warn("[Resource.Texture.fillRect]:","No parameters specified."),void 0;var s=this.ctx;t.x=t.x||0,t.y=t.y||0,t.color=t.color||"#000000",t.width=t.width||this.fullWidth||1,t.height=t.height||this.fullHeight||1,t.drawOver||this.resize(t.width+t.x,t.height+t.y),this.textureType&&(this._createCachedImg(),s=this._cachedCtx),s.fillStyle=t.color,s.fillRect(t.x,t.y,t.width,t.height)}else{var n=t,i=i||"#000000";this.resize(n,e),this.textureType&&(this._createCachedImg(),s=this._cachedCtx),s.fillStyle=i,s.fillRect(0,0,n,e)}if(this.textureType){var o=meta.ctx;o.bindTexture(o.TEXTURE_2D,this.image),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},tile:function(t,e,i){if("number"==typeof t)return this.tile({width:t,height:e,texture:i}),void 0;if(!t)return console.warn("[Resource.Texture.tile]:","No parameters specified."),void 0;if("string"==typeof t.texture&&(t.texture=Resource.ctrl.getTexture(t.texture)),!t.texture)return console.warn("[Resource.Texture.tile]:","Undefined texture."),void 0;var i=t.texture;if(i.textureType===Resource.TextureType.WEBGL){if(!i._canvasCache)return i._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,i.path),i._canvasCache.load(),i=i._canvasCache,this._loadCache={name:"tile",data:t},this.isLoaded=!1,i.subscribe(this,this.onTextureCacheEvent),void 0;i=i._canvasCache}if(!i._isLoaded)return i._isLoading||i.load(),this._loadCache={name:"tile",data:t},this.isLoaded=!1,i.subscribe(this,this.onTextureCacheEvent),void 0;t.x=t.x||0,t.y=t.y||0,t.width=t.width||this.fullWidth,t.height=t.height||this.fullHeight,t.drawOver||this.resize(t.width,t.height),t.center&&(t.x+=(this.fullWidth&i.fullWidth-1)/2,t.y+=(this.fullHeight&i.fullHeight-1)/2);var s=this.ctx;this.textureType&&(this._createCachedImg(),s=this._cachedCtx);var n=t.x,o=t.y,h=Math.ceil(this.fullWidth/i.fullWidth),r=Math.ceil(this.fullHeight/i.fullHeight);n>0&&(h+=Math.ceil(n/i.fullWidth),n-=i.fullWidth),o>0&&(r+=Math.ceil(o/i.fullHeight),o-=i.fullHeight);for(var a=o,u=0;h>u;u++){for(var c=0;r>c;c++)s.drawImage(i.image,n,o),o+=i.height;n+=i.width,o=a}if(this.textureType){var l=meta.ctx;l.bindTexture(l.TEXTURE_2D,this.image),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},stroke:function(t){if(!t)return console.warn("[Resource.Texture.stroke]:","No parameters specified."),void 0;if(!t.buffer)return console.warn("[Resource.Texture.stroke]:","No buffer defined."),void 0;var e=Number.POSITIVE_INFINITY,i=e,s=Number.NEGATIVE_INFINITY,n=s,o,h,r,a,u=t.buffer,c=u.length;for(h=0;c>h;h+=2)r=u[h],a=u[h+1],e>r&&(e=r),i>a&&(i=a),r>s&&(s=r),a>n&&(n=a);e>0&&(e=0),i>0&&(i=0);var l=this.ctx;t.addWidth=t.addWidth||0,t.addHeight=t.addHeight||0,t.borderWidth=t.borderWidth||1,t.color||t.borderColor||(t.borderColor="#000000");var d=t.borderWidth/2,m=-e+d+t.addWidth/2,_=-i+d+t.addHeight/2;for(t.drawOver||this.resize(s-e+t.borderWidth+t.addWidth,n-i+t.borderWidth+t.addHeight),this.textureType&&(this._createCachedImg(),l=this._cachedCtx),l.lineWidth=t.borderWidth,t.lineCap&&(l.lineCap=t.lineCap),t.lineDash&&l.setLineDash(t.lineDash),l.beginPath(),l.moveTo(u[0]+m,u[1]+_),h=2;c>h;h+=2)l.lineTo(u[h]+m,u[h+1]+_);if(t.color&&(l.fillStyle=t.color,l.closePath(),l.fill()),t.borderColor&&(l.strokeStyle=t.borderColor,l.stroke()),this.textureType===Resource.TextureType.WEBGL){var f=meta.ctx;f.bindTexture(f.TEXTURE_2D,this.image),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},border:function(t){if(!t)return console.warn("[Resource.Texture.strokeBorder]:","No parameters specified."),void 0;t.width=t.width||this.fullWidth,t.height=t.height||this.fullHeight;var e=1;t.borderWidth&&(e=t.borderWidth),t.buffer=[0,0,t.width-e,0,t.width-e,t.height-e,0,t.height-e,0,0],this.stroke(t)},arc:function(t){if(!t)return console.warn("[Resource.Texture.arc]:","No parameters specified."),void 0;var e=this.ctx;t.x=t.x||0,t.y=t.y||0,t.radius=t.radius||5,t.startAngle=t.startAngle||0,t.endAngle=t.endAngle||2*Math.PI,t.borderWidth=t.borderWidth||1,t.color||t.borderColor||(t.borderColor=t.borderColor||"#000000");var i=2*t.radius+t.borderWidth;if(t.drawOver||this.resize(t.x+i,t.y+i),this.textureType&&(this._createCachedImg(),e=this._cachedCtx),e.lineWidth=t.borderWidth,e.clearRect(0,0,this.fullWidth,this.fullHeight),e.beginPath(),e.arc(t.x+t.radius+t.borderWidth/2,t.y+t.radius+t.borderWidth/2,t.radius,t.startAngle,t.endAngle,!1),e.closePath(),t.color&&(e.fillStyle=t.color,e.fill()),t.borderColor&&(e.strokeStyle=t.borderColor,e.stroke()),this.textureType===Resource.TextureType.WEBGL){var s=meta.ctx;s.bindTexture(s.TEXTURE_2D,this.image),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},roundRect:function(t,e,i,s,n){n||(n={}),s=s||5,n.borderWidth=n.borderWidth||1;var o=n.borderWidth/2,h=n.borderWidth/2;this.upResize(e+n.borderWidth,i+n.borderWidth);var r=null;if(this.textureType===Resource.TextureType.WEBGL?(this._tmpCanvas.width=this._width,this._tmpCanvas.height=this._height,r=this._tmpCtx):r=this.ctx,r.strokeStyle=t,r.lineWidth=n.borderWidth,r.beginPath(),r.moveTo(o+s,h),r.lineTo(o+e-s,h),r.quadraticCurveTo(o+e,h,o+e,h+s),r.lineTo(o+e,h+i-s),r.quadraticCurveTo(o+e,h+i,o+e-s,h+i),r.lineTo(o+s,h+i),r.quadraticCurveTo(o,h+i,o,h+i-s),r.lineTo(o,h+s),r.quadraticCurveTo(o,h,o+s,h),r.closePath(),r.stroke(),n.fill&&(r.fillStyle=n.fill,r.fill()),this.textureType===Resource.TextureType.WEBGL){var a=meta.ctx;a.bindTexture(a.TEXTURE_2D,this.image),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this._tmpCanvas)}this.isLoaded=!0},bazier:function(t,e,i){this.isLoaded=!0},emulateAnim:function(t,e){if(!this._isLoaded)return console.warn("[Resource.Texture.emulateAnim]:","Texture is not loaded yet."),void 0;var i=Resource.AnimType;t===i.NONE?this._anim=null:(this._anim={type:t},this.isAnimated=!0,this.numFrames=e,t===i.LINEAR_H?this._anim.fill=this._width/(e-1):t===i.LINEAR_V?this._anim.fill=this._height/(e-1):t===i.RADIAL?(console.log("[Resource.Texture.emulateAnim]:","RADIAL is currently unsupported type."),this._anim.halfWidth=this.fullWidth/2,this._anim.halfHeight=this.fullHeight/2,this._anim.fill=2*Math.PI/(e-1),this._anim.length=Math.sqrt(this._anim.halfWidth*this._anim.halfWidth+this._anim.halfHeight*this._anim.halfHeight)+1|0):(t===i.RADIAL_TOP_LEFT||t===i.RADIAL_TOP_RIGHT||t===i.RADIAL_BOTTOM_LEFT||t===i.RADIAL_BOTTOM_RIGHT)&&(this._anim.fill=2*Math.PI/(4*(e-1)),this._anim.length=Math.sqrt(this.fullWidth*this.fullWidth+this.fullHeight*this.fullHeight)+1|0)),this.isLoaded=!0},gradient:function(t){if(!t)return console.warn("[Resource.Texture.gradient]:","No data specified."),void 0;if(!t.colors||!t.colors.length)return console.warn("[Resource.Texture.gradient]:","No data.colors specified."),void 0;var e=this.ctx;t.dirX=t.dirX||0,t.dirY=t.dirY||0,t.width=t.width||this.fullWidth||1,t.height=t.height||this.fullHeight||1,t.drawOver||this.resize(t.width,t.height),this.textureType&&(this._createCachedImg(),e=this._cachedCtx);var i=t.colors,s=i.length,n,o,h,r;t.dirX<0?(n=this.fullWidth,o=0):(n=0,o=this.fullWidth*t.dirX),t.dirY<0?(h=this.fullHeight,r=0):(h=0,r=this.fullHeight*t.dirY);for(var a=e.createLinearGradient(n,h,o,r),u=0;s>u;u++)a.addColorStop(i[u][0],i[u][1]);if(e.fillStyle=a,e.clearRect(0,0,this.fullWidth,this.fullHeight),e.fillRect(0,0,this.fullWidth,this.fullHeight),this.textureType){var c=meta.ctx;c.bindTexture(c.TEXTURE_2D,this.image),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},grid:function(t,e,i,s){if("number"==typeof t)return this.grid({cellWidth:t,cellHeight:e,numCellsX:i,numCellsY:s}),void 0;if(!t)return console.warn("[Resource.Texture.grid]:","No params specified."),void 0;var n=t.cellWidth||1,e=t.cellHeight||1,i=t.numCellsX||1,s=t.numCellsY||1;t.x=t.x||0,t.y=t.y||0,t.color=t.color||"#000000",t.borderWidth=t.borderWidth||1,t.drawOver=t.drawOver||!1;var o=t.x+t.cellWidth*t.numCellsX+1,h=t.y+t.cellHeight*t.numCellsY+1;t.drawOver||this.resize(o,h);var r=this.ctx;this.textureType&&(this._createCachedImg(),r=this._cachedCtx),r.strokeStyle=t.color,r.lineWidth=t.borderWidth,r.save(),r.translate(.5,.5);for(var a=0;i+1>a;a++)r.moveTo(a*e,0),r.lineTo(a*e,h);for(var u=0;s+1>u;u++)r.moveTo(0,u*e),r.lineTo(o,u*e);if(r.stroke(),r.restore(),this.textureType){var c=meta.ctx;c.bindTexture(c.TEXTURE_2D,this.image),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},onTextureEvent:function(t,e){t===Resource.Event.LOADED&&(this.tile(e),e.unsubscribe(this))},construct:function(t){if(!t)return console.warn("[Resource.Texture.buildMatrix]:","No parameters specified."),void 0;this._constructTex(t,"center"),this._constructTex(t,"left"),this._constructTex(t,"right"),t.width=t.width||this.fullWidth,t.height=t.height||this.fullHeight,this.resize(t.width,t.height),console.log(this._width,this._height);var e=t.width/2-t.center.width/2|0,i=t.height/2-t.center.height/2|0;console.log(e);var s=this.ctx;if(s.drawImage(t.center,e,i),this.textureType){var n=meta.ctx;n.bindTexture(n.TEXTURE_2D,this.image),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},_constructTex:function(t,e){if(t[e]&&"string"==typeof t[e]){if(t[e]=Resource.ctrl.getTexture(t[e]),!t[e])return console.warn("[Resource.Texture.buildMatrix]:","Undefined texture for: "+e),void 0;t[e]=t[e].image}},generateAlphaMask:function(){if(!this._isLoaded)return console.warn("[Resource.Texture.generateMask]:","Texture is not loaded yet."),void 0;if(0!==this.textureType)return console.warn("[Resource.Texture.generateMask]:","Only canvas textures are supported currently."),void 0;var t=new Resource.Texture(Resource.TextureType.CANVAS);t.resize(this.fullWidth,this.fullHeight);for(var e=this.ctx.getImageData(0,0,this.fullWidth,this.fullHeight),i=e.data,s=i.length,n=0;s>n;n+=4)i[n]=255,i[n+1]=255,i[n+2]=255;return t.ctx.putImageData(e,0,0),t.isLoaded=!0,t},onTextureCacheEvent:function(t,e){e===Resource.Event.LOADED&&(t.unsubscribe(this),"drawOver"===this._loadCache.name?this.drawOver(this._loadCache.texture,this._loadCache.x,this._loadCache.y):this[this._loadCache.name](this._loadCache.data),this._loadCache=null)},set x(t){return this.ptr?(this.textureType?(this._xRatio=1/this.ptr.fullWidth,this._x=this._xRatio*t):this._x=t,void 0):(this._x=0,void 0)},set y(t){return this.ptr?(this.textureType?(this._yRatio=1/this.ptr.fullHeight,this._y=this._yRatio*t):this._y=t,void 0):(this._y=0,void 0)},get x(){return this._x},get y(){return this._y},set width(t){this._width=t,this.update()},set height(t){this._height=t,this.update()},get width(){return this._width},get height(){return this._height},set offsetX(t){this._offsetX=t,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},set offsetY(t){this._offsetY=t,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},set bgTexture(t){if("string"==typeof t){var e=Resource.ctrl.getTexture(t);if(!e)return console.warn("[Resource.Texture.bgTexture]:","No such texture found: "+t),void 0;t=e}this._bgTexture=t,this.isLoaded=!0},get bgTexture(){return this._bgTexture},type:Resource.Type.TEXTURE,textureType:Resource.TextureType.UNKNOWN,image:null,ctx:null,_bgTexture:null,vbo:null,_vertices:null,_x:0,_y:0,_xRatio:0,_yRatio:0,_width:0,_height:0,fullWidth:0,fullHeight:0,_widthRatio:0,_heightRatio:0,_offsetX:0,_offsetY:0,fps:0,numFrames:1,numFramesX:1,numFramesY:1,isAnimated:!1,isLoop:!1,autoPlay:!0,isAnimReverse:!1,isEmulateReverse:!1,fromAtlas:!1,_tmpImg:null,_tmpCtx:null,_cachedImg:null,_cachedCtx:null,_anim:null,_frames:null,_loadCache:null,_canvasCache:null}),"use strict",Resource.Sound=Resource.Basic.extend({init:function(t,e){if("string"==typeof t&&(e=t,t=void 0),e){var i=e.lastIndexOf(".");-1!==i&&e.length-i<=5&&(this.format=e.substr(i+1,e.length-i-1),e=e.substr(0,i)),this.path=Resource.ctrl.rootPath+e}this._instances=[];var s=this;meta.device.isAudioAPI?(this._request=new XMLHttpRequest,this._request.responseType="arraybuffer",this._request.onreadystatechange=function(){s._onStateChange()}):(this._context=this._getInstance(),this._context.audio.addEventListener("error",function(){s.format?s._onLoadFailed():s._loadNextExtension()}),this._numInstancesUsed=0)},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,Resource.ctrl.addToLoad(this);var t=Resource.ctrl;t.isSyncLoading?t.addToQueue(this):(this.syncLoading||(t.isSyncLoading=!0),this._loadNextExtension())}},forceLoad:function(){this._loadNextExtension()},_loadNextExtension:function(){var t;if(this.format)t=this.path;else{var e=meta.device.audioFormats;if(this._requestFormat++,this._requestFormat>e.length)return this._onLoadFailed(),void 0;t=this.path+"."+meta.device.audioFormats[this._requestFormat-1]}this._loadFromUrl(t)},_loadFromUrl:function(t){this._request.open("GET",t,!0),this._request.send()},_loadFromUrl_legacy:function(t){this._context.audio.src=t,this._context.audio.load()},_clear:function(){this._request.onreadystatechange=null,this._request=null},_clear_legacy:function(){},_onStateChange:function(){if(4===this._request.readyState)if(200===this._request.status){var t=this;this._context.decodeAudioData(this._request.response,function(e){t._onDecodeSuccess(e)},function(){t._onDecodeError()}),this._request=null}else this.format?this._onLoadFailed():this._loadNextExtension()},_onDecodeSuccess:function(t){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),this._buffer=t,this._isLoading=!1,this._clear(),this.isLoaded=!0,Resource.ctrl.loadSuccess(this);for(var e=this._instances.length,i=0;e>i;i++)this._createSource(this._instances[i])},_onDecodeError:function(){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),console.warn("[Resource.Sound.load]:","Error decoding file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},_onLoadFailed:function(){if(!this.format){var t=meta.device.audioFormats[this._requestFormat-1];t&&(this.path+="."+t)}console.warn("[Resource.Sound.load]:","Error loading file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},play:function(t,e){var i=this._getInstance();i.isLoop=t||!1,i.play(e)},stop:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t]._stop();this._numInstancesUsed=0},pause:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t].pause()},resume:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t].resume()},_createSource:function(t){var e=this._context.createGain();e.connect(this._context.destination);var i=this._context.createBufferSource();i.buffer=this._buffer,i.loop=t._isLoop,i.connect(e),i.start||(i.start=i.noteOn),i.stop||(i.stop=i.noteOff);var s=this;return i.onended=function(){s._clearInstance(t)},t.source=i,t.gainNode=e,i},_createInstance:function(){return new Resource.AudioInstance},_createInstance_legacy:function(){return new Resource.AudioInstance_legacy(this)},_getInstance:function(){this._instances.length===this._numInstancesUsed&&(this._instances.length+=1,this._instances[this._numInstancesUsed]=this._createInstance());var t=this._instances[this._numInstancesUsed];return t.id=this._numInstancesUsed,this._numInstancesUsed++,t},_clearInstance:function(t){this._numInstancesUsed--;var e=this._instances[this._numInstancesUsed];e.id=t.id,this._instances[t.id]=e},set volume(t){if(this._volume!==t){this._volume=t;for(var e=this._instances.length,i=0;e>i;i++)this._instances[i].volume=t}},get volume(){return this._volume},get isPlaying(){return this._numInstancesUsed>0?!0:!1},type:Resource.Type.SOUND,format:"",_instances:null,_numInstancesUsed:0,_autoIsLoop:!1,_autoTime:0,_context:null,_buffer:null,_request:null,_requestFormat:0,_volume:1,_isInQueue:!1,_syncLoading:!1}),Resource.AudioInstance=function(){this.id=-1,this.source=null,this.gainNode=null,this.auto,this._volume=1,this._mixedVolume=1},Resource.AudioInstance.prototype={set volume(t){this._mixedVolume=this._volume*t,this.gainNode.gain.value=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume}},Resource.AudioInstance_legacy=function(t){this.id=-1,this.parent=t,this.isPlaying=!1,this.isLoop=!1,this._canPlay=!1,this._metaLoaded=!1,this._isLoaded=!1,this._volume=1,this._mixedVolume=1,this.audio=new Audio,this.audio.preload="auto",this._addEvents(t)},Resource.AudioInstance_legacy.prototype={play:function(t){this.isPlaying=!0,this._isLoaded?(this.audio.currentTime=t||0,this.audio.play()):this._autoPlay=!0},stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause(),this.parent._clearInstance(this)},_stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause()},pause:function(){this.isPlaying=!1,this.audio.pause()},resume:function(){this.isPlaying=!0,this.audio.play()},_addEvents:function(){var t=this,e=function(){t.audio.removeEventListener("canplaythrough",e),t._canPlay=!0,meta.device.support.onloadedmetadata&&t._metaLoaded&&t._onLoaded()};if(this.audio.addEventListener("canplaythrough",e,!1),meta.device.support.onloadedmetadata){var i=function(){t.audio.removeEventListener("loadedmetadata",i),t._metaLoaded=!0,t._canPlay&&t._onLoaded()};this.audio.addEventListener("loadedmetadata",i,!1)}this.audio.addEventListener("ended",function(){t._onEnd()},!1),this.parent._isLoaded&&(this.audio.src=this.parent.path,this.audio.load())},_onLoaded:function(){if(!this.parent._isLoaded){this.parent.format||(this.parent.path+="."+meta.device.audioFormats[this.parent._requestFormat-1]),this.parent._isLoading=!1,this.parent.isLoaded=!0;for(var t,e=this.parent._instances,i=this.parent._instances.length,s=1;i>s;s++)t=e[s],t.audio.src=this.parent.path,t.audio.load();Resource.ctrl.loadSuccess(parent),Resource.ctrl.loadNextFromQueue()}this._isLoaded=!0,this._autoPlay&&this.audio.play()},_onEnd:function(){this.isLoop?(this.audio.play(),this.audio.currentTime=0):this.isPlaying&&(this.isPlaying=!1,this.parent._clearInstance(this))},set currentTime(t){this.isPlaying?this.audio.currentTime=t||0:(this.audio.play(),this.audio.currentTime=t||0,this.audio.pause())},get currentTime(){return this.audio.currentTime},set volume(t){t>1?t=1:0>t&&(t=0),this._mixedVolume=this._volume*t,this.audio.volume=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume},_autoPlay:!1},"use strict",Resource.SpriteSheet=Resource.Basic.extend({init:function(t,e){if("string"==typeof t)e=t,t=void 0;else for(var i in t)this[i]=t[i];if(e){var s=e.lastIndexOf(".");-1!==s&&e.length-s<=5&&(this.format=e.substr(s+1,e.length-s-1),e=e.substr(0,s)),this.path=Resource.ctrl.rootPath+e,this.format||(this.format="xml")}},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,this._isAtlasLoaded=!1,this.texture?"string"==typeof this.texture&&(this.texture=new Resource.Texture(this.texture)):this.texture=new Resource.Texture(this.path),this.texture._isLoaded||(this.texture.subscribe(this,this._onTextureEvent),this.texture._isLoading||this.texture.load());var t=this,e=this.path+"."+this.format;this._request=new XMLHttpRequest,this._request.open("GET",e,!1),this._request.onreadystatechange=function(){t._onStateChange()},this._request.send(),Resource.ctrl.addToLoad(this)}},loadData:function(t,e){if(e=e||this.format,e||(e="xml"),this.format=e,this.isLoaded=!0,"xml"===e){var i=new DOMParser,s=i.parseFromString(t,"text/xml");return this.loadXML(s)}if("json"===e){var n=JSON.parse(t);return this.loadJSON(n)}if("plist"===e){var i=new DOMParser,o=i.parseFromString(t,"text/xml");return this.loadPlist(o)}return console.warn("[Resource.SpriteSheet.loadData]:","Trying to load an unsupported format - "+this.format),!1},loadXML:function(t){if(!t)return console.warn("[Resource.SpriteSheet.loadXML]:","Invalid XML file."),!1;for(var e=t.documentElement.childNodes,i=e.length,s,n=0;i>n;n++)if(s=e[n],"SubTexture"===s.nodeName)this._loadXML_Starling(s);else if("sprite"===s.nodeName)this._loadXML_genericXML(s);else if("dict"===s.nodeName)return this.loadPlist(t);return!0},_loadXML_Starling:function(t){var e=new Resource.Texture;e.ptr=this.texture,e.name=t.getAttribute("name"),e.x=t.getAttribute("x"),e.y=t.getAttribute("y"),e._width=t.getAttribute("width"),e._height=t.getAttribute("height"),e.fromAtlas=!0,e.update(),Resource.ctrl.add(e)},_loadXML_genericXML:function(t){var e=new Resource.Texture;e.ptr=this.texture,e.name=t.getAttribute("n"),e.x=t.getAttribute("x"),e.y=t.getAttribute("y"),e._width=t.getAttribute("w"),e._height=t.getAttribute("h"),e.fromAtlas=!0,e.update(),Resource.ctrl.add(e)},loadPlist:function(t){if(!t)return console.warn("[Resource.SpriteSheet.loadPlist]:","Invalid Plist file."),!1;
for(var e=t.documentElement.childNodes,i=e.length,s,n=0;i>n;n++)if(s=e[n],"dict"===s.nodeName)return this._loadPlist_dict(s)},_loadPlist_dict:function(t){for(var e=t.childNodes,i=e.length,s="",n=0;i>n;n++)if(t=e[n],"key"===t.nodeName)s=t.textContent;else if("dict"===t.nodeName){if(!s)continue;"frames"===s&&this._loadPlist_frames(t)}},_loadPlist_frames:function(t){for(var e=t.childNodes,i=e.length,s="",n=0;i>n;n++)t=e[n],"key"===t.nodeName?s=t.textContent:"dict"===t.nodeName&&this._loadPlist_frame(t,s)},_loadPlist_frame:function(t,e){var i=new Resource.Texture;i.ptr=this.texture,i.name=e;for(var s=t.childNodes,n=s.length,o="",h,r=0;n>r;r++)if(t=s[r],"key"===t.nodeName)o=t.textContent;else if("string"===t.nodeName&&"frame"===o)return h=t.textContent.match(/[0-9]+/g),i.x=parseInt(h[0]),i.y=parseInt(h[1]),i._width=parseInt(h[2]),i._height=parseInt(h[3]),i.fromAtlas=!0,i.update(),Resource.ctrl.add(i),void 0},loadJSON:function(t){return t?(t.frames instanceof Array?this._loadFromJSON_array(t):this._loadFromJSON_hash(t),!0):(console.warn("[Resource.SpriteSheet.loadFromJSON]:","Invalid JSON file."),!1)},_loadFromJSON_array:function(t){for(var e,i,s=t.frames,n=s.length,o=0;n>o;o++)e=s[o],i=new Resource.Texture,i.ptr=this.texture,i.name=e.filename,e=e.frame,i.x=e.x,i.y=e.y,i._width=e.w,i._height=e.h,i.fromAtlas=!0,i.update(),Resource.ctrl.add(i)},_loadJSON_hash:function(t){var e,i,s=t.frames;for(var n in s)i=new Resource.Texture,i.ptr=this.texture,i.name=n,e=s[n].frame,i.x=e.x,i.y=e.y,i._width=e.w,i._height=e.h,i.fromAtlas=!0,i.update(),Resource.ctrl.add(i)},loadAtlas:function(){if("object"!=typeof this.atlas)return console.warn("[Resource.SpriteSheet.loadFromAtlas]:","Incorrect atlas object, expected to be an Array."),!1;for(var t=[],e,i,s,n=this.atlas.length,o=0;n>o;o++)e=this.atlas[o],s=e.name||this.params,s?(e.x=e.x||this.params.x||0,e.y=e.y||this.params.y||0,e.width=e.width||this.params.width||1,e.height=e.height||this.params.height||1,t.push(e),i=new Resource.Texture,i.ptr=this.texture,i.name=s,i.x=e.x,i.y=e.y,i._width=e.width,i._height=e.height,i.numFrames=e.numFrames||this.params.numFrames||1,i.fromAtlas=!0,Resource.ctrl.add(i)):console.warn("[Resource.SpriteSheet.loadFromAtlas]:","No name defined for atlas item in "+this.name+" spritesheet.");return this.texture._frames=t,this.atlas=null,this.isLoaded=!0,!0},_onTextureEvent:function(t,e){e===Resource.Event.LOADED&&(this.texture.unsubscribe(this),this._isAtlasLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null))},_onStateChange:function(){4===this._request.readyState&&(200===this._request.status?(this._isAtlasLoaded=!0,this._response=this._request.response,this._request=null,this.texture._isLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null)):(this._isLoading=!1,this._request.onreadystatechange=null,this._request=null,Resource.ctrl.loadFailed(this)))},type:Resource.Type.SPRITE_SHEET,format:"",atlas:null,params:null,texture:null,_request:null,_response:null,_isAtlasLoaded:!1}),"use strict",window.Entity={},Entity.Controller=meta.Controller.extend({init:function(){Entity.Geometry.prototype._entityCtrl=this,Entity.Geometry.prototype.parent=this,this.entities=new Entity.DepthList,this.entitiesToAdd=[],this.entitiesToUpdate=[],this.entitiesToRemove=[],this.detachBuffer=[],this._centerTex=new Resource.Texture,this._centerTex.fillRect({color:"#ff0000",width:6,height:6}),this._chnOnDown=meta.createChannel(Entity.Event.DOWN),this._chnOnUp=meta.createChannel(Entity.Event.UP),this._chnOnClick=meta.createChannel(Entity.Event.CLICK),this._chnOnDrag=meta.createChannel(Entity.Event.DRAG),this._chnOnDragStart=meta.createChannel(Entity.Event.DRAG_START),this._chnOnDragEnd=meta.createChannel(Entity.Event.DRAG_END),this._chnOnHover=meta.createChannel(Entity.Event.HOVER),this._chnOnHoverEnter=meta.createChannel(Entity.Event.HOVER_ENTER),this._chnOnHoverExit=meta.createChannel(Entity.Event.HOVER_EXIT),meta.subscribe(this,meta.Event.RESIZE,this.onResize),meta.subscribe(this,meta.Event.CAMERA_MOVE,this.onMove),meta.subscribe(this,meta.Event.ADDED_TO_VIEW,this.onAddToView),meta.subscribe(this,meta.Event.REMOVED_FROM_VIEW,this.onRemoveFromView),this.volume=meta.camera.volume,this.onMove(meta.camera,null)},release:function(){Entity.Geometry.prototype._entityCtrl=null,this.cells=null,this.entities=null,this.entitiesToAdd=null,this.entitiesToUpdate=null,this.entitiesToRemove=null,this.detachBuffer=null,this.dynamicEntities=null,this._chnOnDown.remove(),this._chnOnUp.remove(),this._chnOnClick.remove(),this._chnOnDrag.remove(),this._chnOnDragStart.remove(),this._chnOnDragEnd.remove(),this._chnOnHover.remove(),this._chnOnHoverEnter.remove(),this._chnOnHoverExit.remove(),meta.unsubscribe(this,meta.Event.RESIZE),meta.unsubscribe(this,meta.Event.CAMERA_MOVE),meta.unsubscribe(this,meta.Event.ADDED_TO_VIEW,this.onAddToView),meta.unsubscribe(this,meta.Event.REMOVED_FROM_VIEW,this.onRemoveFromView),meta.unsubscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP],this.onInput),meta.unsubscribe(this,Input.Event.INPUT_MOVE)},load:function(){this.cells={};var t=meta.camera.volume;if(this.startCellX=Math.floor(t.minX/this._cellSizeX),this.startCellY=Math.floor(t.minY/this._cellSizeY),this.endCellX=Math.floor(t.maxX/this._cellSizeX),this.endCellY=Math.floor(t.maxY/this._cellSizeY),this.entities.length>0){for(var e=Entity.Geometry.prototype._dummyParent,i=this.entities.first.next,s=this.entities.last;i!==s;i=i.next)i.entity._parent=e;this.entities.clear()}this.dynamicEntities=new Array(64);for(var n,o=meta.view.entities,h=o.length,r=0;h>r;r++)n=o[r],n._showBounds&&this.numShowBounds++,n._parent===e&&(n._parent=this);meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP],this.onInput),meta.subscribe(this,Input.Event.INPUT_MOVE,this.onInputMove)},unload:function(){for(var t,e=this.entities.length,i=0;e>i;i++)t=this.entities[i],t._parent===this&&(t._parent=null);this.numShowBounds=0,this.numEntitiesToUpdate=0},update:function(t){this._isUpdateTick=!0;var e,i,s,n,o;for(e=0;e<this.numEntitiesToUpdate;e++)s=this.entitiesToUpdate[e],s.isPaused||s.isRemoved||(s.update&&s.update(t),s.components&&s._updateComponents(t));if(this.numDetachItems){for(e=0;e<this.numDetachItems;e++)if(s=this.detachBuffer[e],n=s._parent.children,o=n.length,0!==o)for(i=0;o>i;i++)if(n[i]===s){n[i]=n[o-1],n.pop();break}this.detachBuffer.length=0,this.numDetachItems=0}if(this.numEntitiesToRemove){var s;for(e=0;e<this.numEntitiesToRemove;e++)s=this.entitiesToRemove[e],this.entities.remove(s._depthNode),s.removeFully();this.entitiesToRemove.length=0,this.numEntitiesToRemove=0,this.isNeedRender=!0}if(this.numEntitiesToAdd){for(e=0;e<this.numEntitiesToAdd;e++)this._addEntity(this.entitiesToAdd[e]);this.entitiesToAdd.length=0,this.numEntitiesToAdd=0}this._isUpdateTick=!1},_addToDrawBounds:function(){this.numShowBounds++,this.isNeedRender=!0},_removeToDrawBounds:function(){this.numShowBounds--,this.isNeedRender=!0},onAddToView:function(t,e){var i,s;if(this._isUpdateTick)if(t instanceof Entity.Geometry)this.entitiesToAdd.push(t),this.numEntitiesToAdd++;else{var n=t.length;for(i=0;n>i;i++)this.entitiesToAdd.push(t[i]);this.numEntitiesToAdd+=n}else if(t instanceof Entity.Geometry)this._addEntity(t);else for(s=t.length,i=0;s>i;i++)this._addEntity(t[i])},onRemoveFromView:function(t,e){if(t instanceof Entity.Geometry)this._removeEntity(t);else for(var i=t.length,s=0;i>s;s++)this._removeEntity(t[s])},_addEntity:function(t){if(!t.isRemoved&&!t._depthNode.entity){t.cellX=Math.floor(t._x/this._cellSizeX),t.cellY=Math.floor(t._y/this._cellSizeY),t._cellIndex=t.cellX|t.cellY<<16;var e=this.cells[t._cellIndex];if(e||(e=new Entity.CellArray,this.cells[t._cellIndex]=e),e.push(t),t._depthNode.entity=t,this.entities.push(t._depthNode),t.children)for(var i=t.children.length,s=0;i>s;s++)this._addEntity(t.children[s]);t.update&&(t.isUpdating=!0),t.isNeedState&&t.updateState(),t._isLoaded&&t._texture&&this.cacheEntity(t)}},_removeEntity:function(t){if(t._depthNode.entity&&(this.entitiesToRemove.push(t),this.numEntitiesToRemove++,t.children))for(var e=t.children.length,i=0;e>i;i++)this._removeEntity(t.children[i])},_addToUpdating:function(t){t._updateNodeID=this.numEntitiesToUpdate,this.entitiesToUpdate.push(t),this.numEntitiesToUpdate++},_removeFromUpdating:function(t){var e=this.entitiesToUpdate[this.numEntitiesToUpdate-1];this.entitiesToUpdate[t._updateNodeID]=e,this.entitiesToUpdate.pop(),this.numEntitiesToUpdate--,e._updateNodeID=t._updateNodeID,t._updateNodeID=-1},getFromVolume:function(t){for(var e,i=this.entities.first.next,s=this.entities.last;i!==s;i=i.next)if(e=i.entity,e.volume!==t&&e.volume.vsAABB(t))return e;return null},getFromPoint:function(t,e,i){for(var s,n=this.entities.first.next,o=this.entities.last;n!==o;n=n.next)if(s=n.entity,s!==i&&s.volume.vsPoint(t,e))return s;return null},getFromEntity:function(t){return this.getFromVolume(t.volume)},cacheEntity:meta.emptyFuncParam,uncacheEntity:meta.emptyFuncParam,onResize:function(t,e){var i=meta.camera.volume;this.prevStartCellX=this.startCellX,this.prevStartCellY=this.startCellY,this.prevEndCellX=this.endCellX,this.prevEndCellY=this.endCellY,this.startCellX=Math.floor(i.minX/this._cellSizeX),this.startCellY=Math.floor(i.minY/this._cellSizeY),this.endCellX=Math.floor(i.maxX/this._cellSizeX),this.endCellY=Math.floor(i.maxY/this._cellSizeY),this.isNeedRender=!0},onMove:function(t,e){var i=t.volume;this.prevStartCellX=this.startCellX,this.prevStartCellY=this.startCellY,this.prevEndCellX=this.endCellX,this.prevEndCellY=this.endCellY,this.startCellX=Math.floor(i.minX/this._cellSizeX),this.startCellY=Math.floor(i.minY/this._cellSizeY),this.endCellX=Math.floor(i.maxX/this._cellSizeX),this.endCellY=Math.floor(i.maxY/this._cellSizeY);for(var s=Math.min(this.prevStartCellX,this.startCellX),n=Math.min(this.prevStartCellY,this.startCellY),o=Math.max(this.prevEndCellX,this.endCellX),h=Math.max(this.prevEndCellY,this.endCellY),r,a,u=n;h>u;u++)for(var c=s;o>c;c++)r=c|u<<16;this.x=0|t._x,this.y=0|t._y,this.isNeedRender=!0},onInput:function(t,e){if(this.enablePicking){this._checkHover(t);var i=Input.Event;if(i.INPUT_DOWN===e){if(!this.hoverEntity)return;t.entity=this.hoverEntity,this.pressedEntity=this.hoverEntity,this.pressedEntity.isPressed=!0,this.pressedEntity._onDown.call(this.pressedEntity,t),this.pressedEntity.onDown.call(this.pressedEntity,t),this._chnOnDown.emit(t,Entity.Event.DOWN)}else if(i.INPUT_UP===e){if(this.pressedEntity&&this.pressedEntity.isDragged&&(this.pressedEntity.isDragged=!1,this.pressedEntity._onDragEnd.call(this.pressedEntity,t),this.pressedEntity.onDragEnd.call(this.pressedEntity,t),this._chnOnDragEnd.emit(t,Entity.Event.DRAG_END)),!this.hoverEntity||this.hoverEntity!==this.pressedEntity)return this.pressedEntity&&(this.pressedEntity.isPressed=!1,this.pressedEntity._onUp.call(this.pressedEntity,e),this.pressedEntity.onUp.call(this.pressedEntity,e),this._chnOnUp.emit(this.pressedEntity,Entity.Event.UP),this.pressedEntity=null),void 0;t.entity=this.pressedEntity,this.pressedEntity.isPressed=!1,this.pressedEntity=null,t.entity._onClick.call(t.entity,t),t.entity.onClick.call(t.entity,t),this._chnOnClick.emit(t,Entity.Event.CLICK),t.entity=null}}},_checkHover:function(t){for(var e,i=this.entities.last.prev,s=this.entities.first;i!==s;i=i.prev)if(e=i.entity,e.isPickable&&e.isInside(t.x,t.y))return this.hoverEntity!==e?(this.hoverEntity&&(t.entity=this.hoverEntity,this.hoverEntity.isHover=!1,this.hoverEntity._onHoverExit.call(this.hoverEntity,t),this.hoverEntity.onHoverExit.call(this.hoverEntity,t),this._chnOnHoverExit.emit(t,Entity.Event.HOVER_EXIT)),t.entity=e,e.isHover=!0,e._onHoverEnter.call(e,t),e.onHoverEnter.call(e,t),this._chnOnHoverEnter.emit(t,Entity.Event.HOVER_ENTER),this.hoverEntity=e):(t.entity=e,e._onHover.call(e,t),e.onHover.call(e,t),this._chnOnHover.emit(t,Entity.Event.HOVER)),t.entity=null,void 0;this.hoverEntity&&(t.entity=this.hoverEntity,this.hoverEntity.isHover=!1,this.hoverEntity._onHoverExit.call(this.hoverEntity,t),this.hoverEntity.onHoverExit.call(this.hoverEntity,t),this._chnOnHoverExit.emit(t,Entity.Event.HOVER_EXIT)),this.hoverEntity=null},_checkDrag:function(t){return this.pressedEntity?(t.entity=this.pressedEntity,this.pressedEntity.isDragged?(this.pressedEntity._onDrag.call(this.pressedEntity,t),this.pressedEntity.onDrag.call(this.pressedEntity,t),this._chnOnDrag.emit(t,Entity.Event.DRAG),!1):(this.pressedEntity.isDragged=!0,this.pressedEntity._onDragStart.call(this.pressedEntity,t),this.pressedEntity.onDragStart.call(this.pressedEntity,t),this._chnOnDragStart.emit(t,Entity.Event.DRAG_START),!1)):!0},onInputMove:function(t,e){this.enablePicking&&this._checkDrag(t)&&this._checkHover(t)},getUniqueID:function(){return++this._uniqueID},set cellMagnitue(t){this._cellMagnitue!==t&&(this._cellMagnitue=t,this._cellSizeX=128*t,this._cellSizeY=128*t,this.isNeedRender=!0)},get cellMagnitue(){return this._cellMagnitue},_x:0,_y:0,_z:0,_alpha:1,volume:null,cells:null,_cellSizeX:128,_cellSizeY:128,_cellMagnitue:1,startCellX:0,startCellY:0,endCellX:0,endCellY:0,prevStartCellX:0,prevStartCellY:0,prevEndCellX:0,prevEndCellY:0,_numCellX:0,_numCellY:0,entities:null,entitiesToAdd:null,entitiesToRemove:null,entitiesToUpdate:null,detachBuffer:null,dynamicEntities:null,numEntitiesToAdd:0,numEntitiesToRemove:0,numEntitiesToUpdate:0,numShowBounds:0,numDetachItems:0,_parent:null,childOffsetX:0,childOffsetY:0,hoverEntity:null,pressedEntity:null,isNeedRender:!0,_isUpdateTick:!1,enablePicking:!0,showBounds:!1,showCells:!1,_uniqueID:0,_centerTex:null,_chnOnDown:null,_chnOnUp:null,_chnOnClick:null,_chnOnDrag:null,_chnOnDragStart:null,_chnOnDragEnd:null,_chnOnHover:null,_chnOnHoverEnter:null,_chnOnHoverExit:null}),"use strict",Entity.Event={UP:"up",DOWN:"down",CLICK:"click",DRAG:"drag",DRAG_START:"dragStart",DRAG_END:"dragEnd",HOVER:"hover",HOVER_ENTER:"hoverEnter",HOVER_EXIT:"hoverExit"},Entity.PositionType={CENTER:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_LEFT:3,BOTTOM_RIGHT:4,TOP:5,BOTTOM:6,LEFT:7,RIGHT:8},"use strict",Entity.WebGLRenderer=Entity.Controller.extend({init:function(){this._super();var t=meta.ctx;this._worldTex=new Resource.Texture,this._worldTex.fillRect({color:"#7AA3CC",width:1,height:1}),this._highlightTex=new Resource.Texture,this._highlightTex.fillRect({color:"#339933",width:6,height:6}),this._position=new Float32Array([0,0]),this._center=new Float32Array([0,0]),this._scale=new Float32Array([0,0]),this.cameraPos=new Float32Array([0,0]);var e=[0,0,1,0,0,1,1,1];this.texCoord=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texCoord),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);var i=[0,1,3,2,0];this._lineIndices=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._lineIndices),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),t.STATIC_DRAW),this._frameCoord=new Float32Array(4),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.activeTexture(t.TEXTURE0),t.enable(t.BLEND);var s=meta.shader;this.locCameraPos=t.getUniformLocation(s.program,"cameraPos"),this.locZoom=t.getUniformLocation(s.program,"zoom"),this.locSampler=t.getUniformLocation(s.program,"sampler"),this.locAlpha=t.getUniformLocation(s.program,"alpha"),this.locPos=t.getUniformLocation(s.program,"pos"),this.locCenter=t.getUniformLocation(s.program,"center"),this.locScale=t.getUniformLocation(s.program,"scale"),this.locFrameCoord=t.getUniformLocation(s.program,"frameCoord"),this.locAngle=t.getUniformLocation(s.program,"angle")},ready:function(){meta.shader.bindBuffer2f("texCoord",this.texCoord)},render:function(t){for(var e,i=this.entities.first.next,s=this.entities.last;i!==s;i=i.next)e=i.entity,e.isNeedState&&e.updateState(),e._texture&&e.isAnimating&&e._updateAnim(t);if(this.isNeedRender){var n=meta,o=n.ctx,h=n.shader,r=n.camera,a;for(this.clearScreen(),this.cameraPos[0]=0|r._x,this.cameraPos[1]=0|r._y,o.uniform2fv(this.locCameraPos,this.cameraPos),o.uniform1f(this.locZoom,meta.camera._zoom),o.uniform1i(this.locSampler,0),i=this.entities.first.next,s=this.entities.last;i!==s;i=i.next)e=i.entity,e.isVisible&&e.isLoaded&&e.texture&&(a=e._texture,h.bindBuffer2f("vertexPos",a.vbo),this._position[0]=1===e._flipX?0|e.volume.minX:e.volume.minX+e.volume.width|0,this._position[1]=1===e._flipY?0|e.volume.minY:e.volume.minY+e.volume.height|0,e.isChild?(this._center[0]=e._parent.childOffsetX,this._center[1]=e._parent.childOffsetY):(this._center[0]=e.volume.x+e.pivotX,this._center[1]=e.volume.y+e.pivotY),this._scale[0]=e._scaleX*e._flipX,this._scale[1]=e._scaleY*e._flipY,this._frameCoord[0]=a._x+e.currFrame%e._texture.numFramesX*a._xRatio,this._frameCoord[1]=a._y+Math.floor(e.currFrame/e._texture.numFramesX)*a._yRatio,this._frameCoord[2]=a._widthRatio,this._frameCoord[3]=a._heightRatio,o.uniform1f(this.locAlpha,e._alpha),o.uniform2fv(this.locPos,this._position),o.uniform2fv(this.locCenter,this._center),o.uniform2fv(this.locScale,this._scale),o.uniform4fv(this.locFrameCoord,this._frameCoord),o.uniform1f(this.locAngle,e._angleRad),a.fromAtlas?o.bindTexture(o.TEXTURE_2D,a.ptr.image):o.bindTexture(o.TEXTURE_2D,a.image),e.ignoreZoom?(o.uniform1f(this.locZoom,1),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.uniform1f(this.locZoom,meta.camera._zoom)):o.drawArrays(o.TRIANGLE_STRIP,0,4),e._isNeedDraw=!1);if(this.numShowBounds>0||this.showBounds){for(o.disable(o.BLEND),o.uniform1f(this.locAlpha,1),i=this.entities.first.next;i!==s;i=i.next)e=i.entity,(e._showBounds||this.showBounds)&&e.enableDebug&&e.isVisible&&e.isLoaded&&(this._position[0]=1===e._flipX?0|e.volume.minX:e.volume.minX+e.volume.width|0,this._position[1]=1===e._flipY?0|e.volume.minY:e.volume.minY+e.volume.height|0,e.isChild?(this._center[0]=e._parent.childOffsetX,this._center[1]=e._parent.childOffsetY):(this._center[0]=e.volume.x+e.pivotX,this._center[1]=e.volume.y+e.pivotY),this._scale[0]=e._scaleX*e._flipX,this._scale[1]=e._scaleY*e._flipY,e.isHighlight?o.bindTexture(o.TEXTURE_2D,this._highlightTex.image):o.bindTexture(o.TEXTURE_2D,this._centerTex.image),o.uniform2fv(this.locPos,this._position),o.uniform2fv(this.locCenter,this._center),o.uniform2fv(this.locScale,this._scale),o.uniform1f(this.locAngle,e._angleRad),h.bindBuffer2f("vertexPos",e.texture.vbo),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._lineIndices),o.lineWidth(2),o.drawElements(o.LINE_STRIP,5,o.UNSIGNED_SHORT,0),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),h.bindBuffer2f("vertexPos",this._centerTex.vbo),e.isHighlight?o.bindTexture(o.TEXTURE_2D,this._highlightTex.image):o.bindTexture(o.TEXTURE_2D,this._centerTex.image),this._position[0]=e.volume.x+e.pivotX-3,this._position[1]=e.volume.y+e.pivotY-3,this._scale[0]=1,this._scale[1]=1,o.uniform2fv(this.locPos,this._position),o.uniform2fv(this.locScale,this._scale),e.ignoreZoom?(o.uniform1f(this.locZoom,1),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.uniform1f(this.locZoom,meta.camera._zoom)):o.drawArrays(o.TRIANGLE_STRIP,0,4));o.enable(o.BLEND)}var u=meta.world;if(u.showBounds){if(h.bindBuffer2f("vertexPos",this._worldTex.vbo),o.bindTexture(o.TEXTURE_2D,this._worldTex.image),this._scale[0]=u.width,this._scale[1]=u.height,o.uniform2fv(this.locScale,this._scale),this._position[0]=0,this._position[1]=0,o.uniform2fv(this.locPos,this._position),this._center[0]=0,this._center[1]=0,o.uniform2fv(this.locCenter,this._center),o.uniform1f(this.locAngle,0),o.uniform1f(this.locAlpha,1),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this._lineIndices),o.lineWidth(2),o.drawElements(o.LINE_STRIP,5,o.UNSIGNED_SHORT,0),u.haveGrid){var c=u.numGridX,l=u.numGridY;this._scale[0]=u.gridWidth,this._scale[1]=u.gridHeight,o.uniform2fv(this.locScale,this._scale);for(var d=0;l>d;d++)for(var m=0;c>m;m++)this._position[0]=m*u.gridWidth+u.gridX,this._position[1]=d*u.gridHeight+u.gridY,o.uniform2fv(this.locPos,this._position),o.drawElements(o.LINE_STRIP,5,o.UNSIGNED_SHORT,0)}o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null)}this.isNeedRender=!1}},clearScreen:function(){var t=meta.ctx;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)},_worldTex:null,_highlightTex:null,_position:null,_center:null,_scale:null,_frameCoord:null,locCameraPos:null,locZoom:null,locSampler:null,locAlpha:null,locPos:null,locCenter:null,locScale:null,locFrameCoord:null,locAngle:null}),"use strict",Entity.CanvasRenderer=Entity.Controller.extend({init:function(){meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onCameraResize),this._super(),this._tStaticCheck=Date.now()},release:function(){this._super(),meta.unsubscribe(this,meta.Event.CAMERA_RESIZE)},render:function(t){var e=this.entities.first.next;if(this.isNeedRender)this._renderAll(e,t);else for(var i,s=this.entities.last;e!==s;e=e.next)if(i=e.entity,i.isNeedState&&i.updateState(),i._texture&&i.isAnimating&&i._updateAnim(t),i._isLoaded&&i.isNeedDraw){this._reRender(e.next,t);break}},_reRender:function(t,e){this.clearScreen();var i=meta,s=i.ctx,n=meta.camera;s.save(),s.scale(n._zoom,n._zoom);for(var o,h=this.entities.first.next;h!==t;h=h.next)o=h.entity,!o._isCached&&o.isVisible&&o._isLoaded&&(o.draw(s),o._isNeedDraw=!1);for(var r=this.entities.last;h!==r;h=h.next)if(o=h.entity,o.isNeedState&&o.updateState(),o._texture&&o.isAnimating&&o._updateAnim(e),!o._isCached&&o.isVisible&&o._isLoaded){if(this._clipVolume!==o.clipVolume){if(null===o.clipVolume)s.restore();else{s.save();var a=o.clipVolume;s.beginPath(),s.rect(a.minX,a.minY,a.width,a.height),s.closePath(),s.clip()}this._clipVolume=o.clipVolume}o.ignoreZoom?(s.restore(),s.save(),o.draw(s),s.scale(n._zoom,n._zoom)):o.draw(s),o._isNeedDraw=!1}this._drawBounds(),s.restore(),this.isNeedRender=!1},_renderAll:function(t,e){this.clearScreen();var i=meta,s=i.ctx,n=i.camera;s.save(),s.scale(n._zoom,n._zoom);for(var o,h=this.entities.last;t!==h;t=t.next)if(o=t.entity,o.isNeedState&&o.updateState(),o._texture&&o.isAnimating&&o._updateAnim(e),!o._isCached&&o.isVisible&&o._isLoaded){if(this._clipVolume!==o.clipVolume){if(null===o.clipVolume)s.restore();else{s.save();var r=o.clipVolume;s.beginPath(),s.rect(r.minX,r.minY,r.width,r.height),s.closePath(),s.clip()}this._clipVolume=o.clipVolume}o.ignoreZoom?(s.restore(),s.save(),o.draw(s),s.scale(n._zoom,n._zoom)):o.draw(s),o._isNeedDraw=!1}this._drawBounds(),this.showCells&&this._drawCells(),s.restore(),this.isNeedRender=!1},clearScreen:function(){var t=meta;t.view.bgTransparent?t.ctx.clearRect(0,0,t.width,t.height):(t.ctx.fillStyle=t.view.bgColor,t.ctx.fillRect(0,0,t.width,t.height))},_drawBounds:function(){if(this.numShowBounds>0||this.showBounds){var t=!1,e=meta.ctx;e.strokeStyle="#ff0000",e.lineWidth=2;for(var i,s,n,o=this.entities.first.next,h=this.entities.last;o!==h;o=o.next)i=o.entity,(i._showBounds||this.showBounds)&&i.enableDebug&&i.isVisible&&i.isLoaded&&(t!==i._isCached&&(e.strokeStyle=i.isCached||i.isHighlight?"#339933":"#ff0000",t=!t),e.save(),e.translate(this.x,this.y),s=i.volume.x+i.pivotX,n=i.volume.y+i.pivotY,i.isChild?(e.translate(i._parent.childOffsetX,i._parent.childOffsetY),e.rotate(i._angleRad),e.translate(-i._parent.childOffsetX,-i._parent.childOffsetY)):(e.translate(s,n),e.rotate(i._angleRad),e.translate(-s,-n)),i.volume.draw(e),this._centerTex.draw(e,s-3,n-3),e.restore())}},_drawWorldBounds:function(){var t=meta.world;if(t.showBounds){var e=meta.ctx;if(e.translate(this.x,this.y),e.strokeStyle="#7AA3CC",e.lineWidth=2,t.volume.draw(e),t.haveGrid){var i=t.numGridX,s=t.numGridY,n=i*t.gridWidth,o=s*t.gridHeight;e.translate(t.gridX,t.gridY);for(var h=0;i>=h;h++)e.moveTo(h*t.gridWidth,0),e.lineTo(h*t.gridHeight,o);for(var r=0;s>=r;r++)e.moveTo(0,r*t.gridHeight),e.lineTo(n,r*t.gridHeight);e.stroke()}}},_drawCells:function(){var t=meta.ctx;t.strokeStyle="orange",t.lineWidth=2,t.beginPath();for(var e=this.x%this._cellSizeX,i=this.y%this._cellSizeY,s=this.endCellX-this.startCellX,n=this.endCellY-this.startCellY,o=0;s>=o;o++)t.moveTo(e+o*this._cellSizeX,0),t.lineTo(e+o*this._cellSizeX,meta.camera.height);for(var h=0;n>=h;h++)t.moveTo(0,i+h*this._cellSizeY),t.lineTo(meta.camera.width,i+h*this._cellSizeY);t.stroke()},cacheEntity:function(t){},uncacheEntity:function(t){},onCameraResize:function(t,e){},_cachedCanvas:null,_cachedCtx:null,_cacheOffsetX:0,_cacheOffsetY:0,_tStaticCheck:0,tStaticCheckDelay:500,_clipVolume:null,x:0,y:0}),"use strict",Entity.Geometry=meta.Class.extend({_init:function(t){if(this.id=this._entityCtrl.getUniqueID(),this.name="entity"+this.id,this.volume=new meta.math.AdvAABB(0,0,0,0),this._parent=this._entityCtrl,this._depthNode=new Entity.DepthList.Node,t)if("object"==typeof t)if(t instanceof Resource.Texture)this.texture=t;else for(var e in t)this[e]=t[e];else"string"==typeof t&&(this.texture=t)},remove:function(){this.isRemoved||(this.isRemoved=!0,this._view?(this._parent===this._entityCtrl?this._view.remove(this):this._view._isActive?(this._entityCtrl.entitiesToRemove.push(this),this._entityCtrl.numEntitiesToRemove++):this._view=null,this._tween&&(this._tween.clear(),this._tween.owner=null),this.children&&this.removeChilds()):this.components&&this.removeComponents(),this._onResize&&(this.onResize=null))},removeFully:function(){this.isUpdating=!1,this._depthNode.entity=null,this.components&&this.removeComponents()},removeChilds:function(){for(var t=this.children.length,e=0;t>e;e++)this.children[e].remove()},clone:function(){var t=new Entity.Geometry;for(var e in this)t[e]!==this[e]&&(t[e]=this[e]);return t.id=this._entityCtrl.getUniqueID(),t},draw:function(t){this._draw(t)},_draw:function(t){this._drawDefault(t)},_drawDefault:function(t){this._texture&&(this._texture.isAnimated?this._texture.drawFrame(t,this._entityCtrl.x+this.drawX|0,this._entityCtrl.y+this.drawY|0,this._currFrame,this.isEmulateReverse):this._texture.draw(t,this._entityCtrl.x+this.drawX|0,this._entityCtrl.y+this.drawY|0))},_drawTransform:function(t){this._texture&&(t.save(),t.globalAlpha=this.totalAlpha,this.isChild?(t.translate(this._parent.childOffsetX,this._parent.childOffsetY),t.rotate(this._angleRad),t.translate(this.volume.x+this._entityCtrl.x-this._parent.childOffsetX,this.volume.y+this._entityCtrl.y-this._parent.childOffsetY),t.scale(this._scaleX*this._flipX,this._scaleY*this._flipY),t.translate(-this.volume.x,-this.volume.y)):(t.translate(this.volume.x+this._entityCtrl.x+this.pivotX,this.volume.y+this._entityCtrl.y+this.pivotY),t.rotate(this._angleRad),t.scale(this._scaleX*this._flipX,this._scaleY*this._flipY),t.translate(-this.volume.x-this.pivotX,-this.volume.y-this.pivotY)),this.texture.isAnimated?this._texture.drawFrame(t,0|this.drawX,0|this.drawY,this._currFrame,this.isEmulateReverse):this._texture.draw(t,0|this.drawX,0|this.drawY),t.restore())},update:null,_updateComponents:function(t){for(var e,i=0;i<this.numComponents;i++)e=this.componentBuffer[i],e.update&&e.update(t)},_updateAnim:function(t){if(!(this.animSpeed<=0||this._texture.numFrames<2)){var e=1/(this.fps*this.animSpeed);if(this._tAnim+=t,!(this._tAnim<e)){this.isNeedDraw=!0;var i=this._tAnim/e|0;this._tAnim-=e*i,this._isAnimReverse?(this._currFrame-=i,this._currFrame<0&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=0):this.isLoop||this._texture.isLoop?this._currFrame=(this._texture.numFrames+this._currFrame)%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1),this.onAnimEnd&&this.onAnimEnd())):(this._currFrame+=i,this._currFrame>=this._texture.numFrames&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1):this.isLoop||this._texture.isLoop?this._currFrame=this._currFrame%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=0),this.onAnimEnd&&this.onAnimEnd()))}}},play:function(t,e){this.texture&&this.texture.isAnimated&&(this.isLoop=t?!0:!1,this.fps=e||this.texture.fps,this.currFrame=0,this.isAnimating=!0,this.pauseAtEnd=!1,this._isAnimReverse=!1)},playAndPause:function(t){this.play(!1,t),this.pauseAtEnd=!0},playReverse:function(t,e){this.texture&&(this.play(t,e),this.currFrame=this.texture.numFrames-1,this._isAnimReverse=!0)},playReverseAndPause:function(t){this.playReverse(!1,t),this.pauseAtEnd=!0},stop:function(){this._texture?(this.isLoop=this._texture.isLoop,this.currFrame=this._isAnimReverse?this._texture.numFrames-1:0):(this.isLoop=!1,this.currFrame=0),this.isAnimating=!1},pause:function(){this.isAnimating=!1},resume:function(){this.isAnimating=!0},forcePosition:function(t,e){if(this._x=t,this._y=e,this.drawX=this._x+this._parent.childOffsetX+this.textureOffsetX-this.pivotX+this._anchorPosX,this.drawY=this._y+this._parent.childOffsetY+this.textureOffsetY-this.pivotY+this._anchorPosY,this._view&&(this.drawX+=this._view._x,this.drawY+=this._view._y),this.volume.set(this.drawX,this.drawY),this.drawX-=this.volume.initHalfWidth,this.drawY-=this.volume.initHalfHeight,this.children){this.childOffsetX=this._x+this.childPivotX+this._anchorPosX+this._parent.childOffsetX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY+this._parent.childOffsetY,this._view&&(this.childOffsetX+=this._view._x,this.childOffsetY+=this._view._y);for(var i=this.children.length,s=0;i>s;s++)this.children[s].updatePos()}this.isNeedDraw=!0},updatePos:function(){if(this.drawX=this._x+this._parent.childOffsetX+this.textureOffsetX-this.pivotX+this._anchorPosX,this.drawY=this._y+this._parent.childOffsetY+this.textureOffsetY-this.pivotY+this._anchorPosY,this._view&&(this.drawX+=this._view._x,this.drawY+=this._view._y),this.volume.set(this.drawX,this.drawY),this.drawX-=this.volume.initHalfWidth,this.drawY-=this.volume.initHalfHeight,this.children){this.childOffsetX=this._x+this.childPivotX+this._anchorPosX+this._parent.childOffsetX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY+this._parent.childOffsetY,this._view&&(this.childOffsetX+=this._view._x,this.childOffsetY+=this._view._y);for(var t=this.children.length,e=0;t>e;e++)this.children[e].updatePos()}this.isNeedDraw=!0},updatePosType:function(){0!==this.positionType&&(1===this.positionType?(this._x+=this.volume.halfWidth,this._y+=this.volume.halfHeight):2===this.positionType?(this._x-=this.volume.halfWidth,this._y+=this.volume.halfHeight):3===this.positionType?(this._x+=this.volume.halfWidth,this._y-=this.volume.halfHeight):4===this.positionType?(this._x-=this.volume.halfWidth,this._y-=this.volume.halfHeight):5===this.positionType?this._y+=this.volume.halfHeight:6===this.positionType?this._y-=this.volume.halfHeight:7===this.positionType?this._x+=this.volume.halfWidth:8===this.positionType&&(this._x-=this.volume.halfWidth))},updateFromTexture:function(){if(this.volume.moveToAndResize(0,0,this._texture._width,this._texture._height),this.pivotX=this.pivotRatioX*this.volume.halfWidth,this.pivotY=this.pivotRatioY*this.volume.halfHeight,this.children&&(this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight),this.updatePosType(),this.updatePos(),this.children)for(var t=this.children.length,e=0;t>e;e++){var i=this.children[e];i.updateAnchor(null,null)}},position:function(t,e){this.positionType=0,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},move:function(t,e){var i=this._x+t,s=this._y+e;(this._x!==i||this._y!==s)&&this.forcePosition(i,s)},positionTopLeft:function(t,e){t+=this.volume.halfWidth,e+=this.volume.halfHeight,this.positionType=1,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionTopRight:function(t,e){t+=this.volume.halfWidth,e-=this.volume.halfHeight,this.positionType=2,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionBottomLeft:function(t,e){t-=this.volume.halfWidth,e+=this.volume.halfHeight,this.positionType=3,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionBottomRight:function(t,e){t+=this.volume.halfWidth,e+=this.volume.halfHeight,this.positionType=4,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionTop:function(t,e){e-=this.volume.halfHeight,this.positionType=5,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)
},positionBottom:function(t,e){e+=this.volume.halfHeight,this.positionType=6,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionLeft:function(t,e){t-=this.volume.halfWidth,this.positionType=7,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},positionRight:function(t,e){t+=this.volume.halfWidth,this.positionType=8,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},pivot:function(t,e){void 0===e&&(e=t),this.pivotRatioX=t,this.pivotRatioY=e,this.pivotX=this.pivotRatioX*this.volume.halfWidth,this.pivotY=this.pivotRatioY*this.volume.halfHeight,this.children&&(this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight,this.childOffsetX=this._x+this.childPivotX+this._anchorPosX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY),this.updatePos()},pivotPx:function(t,e){void 0===e&&(e=t),this.pivotX=t,this.pivotY=e,this.children&&(this.childOffsetX=this._x+pivotX+this._anchorPosX,this.childOffsetY=this._y+pivotY+this._anchorPosY),this.updatePos()},pivotCenter:function(t,e){return 0!==this.pivotRatioX&&0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotTopLeft:function(t,e){return-1!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotTopRight:function(t,e){return 1!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotBottomLeft:function(t,e){return-1!==this.pivotRatioX&&1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotBottomRight:function(t,e){return 1!==this.pivotRatioX&&1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotPositionTop:function(t,e){return 0!==this.pivotRatioX&&-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotPositionBottom:function(t,e){return 0!==this.pivotRatioX&&1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotPositionLeft:function(t,e){return-1!==this.pivotRatioX&&0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotPositionRight:function(t,e){return 1!==this.pivotRatioX&&0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},anchor:function(t,e){void 0===e&&(e=t),this._anchorX=t,this._anchorY=e,this._anchorPosX=this.parent.volume.width*this._anchorX,this._anchorPosY=this.parent.volume.height*this._anchorY,this.isAnchor=!0,this.updatePos()},dragStart:function(t,e){this._dragOffsetX=this._x+this._anchorPosX-t,this._dragOffsetY=this._y+this._anchorPosY-e},dragEnd:function(){this._dragOffsetX=0,this._dragOffsetY=0},dragTo:function(t,e){t-=this._anchorPosX-this._dragOffsetX,e-=this._anchorPosY-this._dragOffsetY,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},isInside:function(t,e){return this.volume.vsBorderPoint(t,e)},_isInsideDefault:function(t,e){return this.volume.vsBorderPoint(t,e)},_isInsideTransform:function(t,e){var i=this._anchorPosX+this._parent.childOffsetX,s=this._anchorPosY+this._parent.childOffsetY;this.isChild||(i+=this._x,s+=this._y);var n=t-i,o=e-s,h=Math.sin(-this._angleRad),r=Math.cos(-this._angleRad),a=n*r-o*h+i,u=o*r+n*h+s;return this.volume.vsBorderPoint(a,u)},vsEntity:function(t){return this.volume.vsAABB(t.volume)},resize:function(t,e){void 0===e&&(e=this.volume.height),this.volume.resize(t,e)},setTexture:function(t){if("string"==typeof t){var e=t;if(t=meta.getTexture(e),!t)return this._texture=e,meta.subscribe(this,"Resource",this._onResourceEvent),void 0}return this._texture&&this._texture.unsubscribe(this),t?t instanceof Resource.Texture?(this._texture=t,this._texture.subscribe(this,this._onTextureEvent),this.textureOffsetX=this._texture._offsetX,this.textureOffsetY=this._texture._offsetY,this._texture._isLoaded?(this.updateFromTexture(),this.isLoaded=!0):(this.isLoaded=!1,this._texture.isLoading||this._texture.load()),t.isAnimated&&(this.isAnimating||(this.isAnimating=t.autoPlay),t.isEmulateReverse&&(this.isEmulateReverse=!0),this.isAnimReverse=t.isAnimReverse),t):(console.warn("[Entity.Geometry.setTexture]:","Texture should extend Resource.Texture class."),null):(this._texture=null,this.isLoaded=!1,null)},_onTextureEvent:function(t,e){var i=Resource.Event;e===i.LOADED?(this.updateFromTexture(),this.isLoaded=!0):e===i.UNLOADED?this.isLoaded=!1:e===i.RESIZE&&this.updateFromTexture(),this.isNeedDraw=!0},_onResourceEvent:function(t,e){e===Resource.Event.ADDED?t.name===this._texture&&(this._texture=null,this.setTexture(t),meta.unsubscribe(this,"Resource")):e===Resource.Event.ALL_LOADED&&"string"==typeof this._texture&&(console.warn("[Entity.Geometry.setTexture]:","Could not find texture with a name: "+this._texture),meta.unsubscribe(this,"Resource"))},attach:function(t,e){if(!t)return console.error("[Entity.Geometry.attach]:","Invalid child object passed."),void 0;if(t.isChild)return console.error("[Entity.Geometry.attach]:","Entity is already a child of someone else."),void 0;if(t.isRemoved)return console.error("[Entity.Geometry.attach]:","Entity is marked as removed ro to be removed."),void 0;if(!t._view||t._view===this._view&&t.isChild||t._view._removeFromBuffer(t),e&&t.move(-this._x-this._anchorPosX-this.pivotX+this.volume.halfWidth,-this._y-this._anchorPosY-this.pivotY+this.volume.halfHeight),t.parent=this,t.isChild=!0,t._view=this._view,0===this._angleRad||t.ignoreParentAngle||(t.angleRad=this._angleRad),1===this._alpha||t.ignoreParentAlpha||(t.alpha=t._alpha),(1!==this._scaleX||1!==this._scaleY)&&t.scale(this._scaleX,this._scaleY),0!==this._z&&(t.z=t._z),this.children)this.children.push(t);else{this.children=[t],this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight,this.childOffsetX=this._x+this.childPivotX+this._anchorPosX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY;for(var i=this._parent;i;)this.childOffsetX+=i.childOffsetX,this.childOffsetY+=i.childOffsetY,i=i._parent}t.isAnchor&&t.anchor(t._anchorX,t._anchorY),t.ignoreZoom!==this.ignoreZoom&&(t.ignoreZoom=this.ignoreZoom),t.updatePos(),this._view&&this._view._isActive&&this._entityCtrl.onAddToView(t,null)},detach:function(t){if(t){if(!this.children)return;for(var e,i=this.children.length,s=0;i>s;s++)if(e=this.children[s],!e.isRemoved&&e===t)return e._parent=this._entityCtrl,e._view=null,e.isChild=!1,this._view.add(e),e.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight),void 0}else{if(!this.isChild)return;this.parent.detach(this)}},detachChildren:function(){if(this.children){var t,e,i=this.children.length;for(t=0;i>t;t++)e=this.children[t],e.isRemoved||(e._parent=this._entityCtrl,e._view=null,e.isChild=!1,this._view.add(e),e.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight));this.children.length=0}},detachExact:function(){for(var t,e=this.children.length,i=0;e>i;i++)t=this.children[i],t.isRemoved||(t._x+=this.childOffsetX,t._y+=this.childOffsetY,t._parent=this._entityCtrl,t._view=null,t.isChild=!1,this._view.add(t),t.forcePosition(t._x,t._y));this.children.length=0},clip:function(t,e,i,s){return this.clipVolume="object"==typeof t&&t instanceof meta.math.AdvAABB?t:new meta.math.AdvAABB(t,e,i,s),this.isNeedDraw=!0,this.clipVolume},_onDown:meta.emptyFuncParam,_onUp:meta.emptyFuncParam,_onClick:meta.emptyFuncParam,_onDrag:meta.emptyFuncParam,_onDragStart:meta.emptyFuncParam,_onDragEnd:meta.emptyFuncParam,_onHover:meta.emptyFuncParam,_onHoverEnter:meta.emptyFuncParam,_onHoverExit:meta.emptyFuncParam,onDown:meta.emptyFuncParam,onUp:meta.emptyFuncParam,onClick:meta.emptyFuncParam,onDrag:meta.emptyFuncParam,onDragStart:meta.emptyFuncParam,onDragEnd:meta.emptyFuncParam,onHover:meta.emptyFuncParam,onHoverEnter:meta.emptyFuncParam,onHoverExit:meta.emptyFuncParam,onAnimEnd:null,addComponent:function(t,e){if(!t)return console.warn("[Entity.Geometry.addComponent]:","No component specified."),null;var i=window.Component,s=null,n;if("string"==typeof t){for(n in i)if(n===t){s=new i[n];break}}else for(n in i)if(i[n]===t){s=new t;break}if(!s)return console.warn("[Entity.Geometry.addComponent]:","Invalid component - "+t),null;if(this.numComponents++,this.components||(this.components={},this.componentBuffer=[]),this.numComponents>this.componentBuffer.length&&(this.componentBuffer.length=this.numComponents),this.components[n]=s,s.owner=this,s.__id=this.numComponents-1,this.componentBuffer[s.__id]=s,e)for(n in e)s[n]=e[n];return this._isLoaded&&s.load&&s.load(),s},removeComponent:function(t){if(!t)return console.warn("[Entity.Geometry.removeComponent]:","No component specified."),void 0;if(this.components){var e,i;if("string"==typeof t){if(e=this.components[t],i=t,!e)return console.warn("[Entity.Geometry.removeComponent]:","No such component found - "+t),void 0}else{for(var s in this.components)if(this.components[s]===t){e=t,i=s;break}if(!e)return console.warn("[Entity.Geometry.removeComponent]:","No such component found - "+t),void 0}e.unload&&e.unload(),this.numComponents--,this.numComponents<=0?(this.components=null,this.componentBuffer=null,this.numComponents=0):(this.componentBuffer[e.__id]=this.componentBuffer[this.numComponents],this.componentBuffer[e.__id].__id=e.__id,this.componentBuffer[this.numComponents]=null,delete this.components[i])}},removeComponents:function(){for(var t,e=0;e<this.numComponents;e++)t=this.componentBuffer[e],t.unload&&t.unload();this.components=null,this.componentBuffer=null,this.numComponents=0},lookAt:function(t,e){this.angleRad=-Math.atan2(t-(this.x+this._anchorPosX+this._parent.childOffsetX),e-(this.y+this._anchorPosY+this._parent.childOffsetY))+Math.PI},lookAtEntity:function(t){this.lookAt(t._x+t._parent.childOffsetX,t._y+t._parent.childOffsetY)},getLookAt:function(t,e){this.angleRad=-Math.atan2(t-(this.x+this._anchorPosX+this._parent.childOffsetX),e-(this.y+this._anchorPosY+this._parent.childOffsetY))+Math.PI},on:function(t,e){meta.subscribe(this,t,e)},emit:function(t,e){},updateState:function(){if(this.isNeedState=!1,this._brush){var t;if(this._state){if(t=this._brush.getState(this),!t)return console.warn("[Entity.Geometry.updateState]:","Could not get brush state from entity state: "+this._state),void 0}else t=null;t!==this._brushState&&(this._brushState&&t.discardState(this),this._brushState=t,this.setTexture(t.texture),t.applyState(this))}},setState:function(t,e,i){this._brush||(this._brush=new meta.Brush,this._brushParams={},this._texture&&this._brush.setState("default",this._texture,i)),this._brush.setState(t,e)},updateAnchor:function(t,e){if(this._isAnchor&&(this._ignoreZoom?(this._anchorPosX=this.parent.volume.width*(1/this.parent.volume.scaleX)*this._anchorX,this._anchorPosY=this.parent.volume.height*(1/this.parent.volume.scaleY)*this._anchorY):(this._anchorPosX=this.parent.volume.width*this._anchorX,this._anchorPosY=this.parent.volume.height*this._anchorY),this.updatePos(),this.children))for(var i=this.children.length,s=0;i>s;s++){var n=this.children[s];n.updateAnchor(null,null)}},set state(t){this._state=t,null===t?this.setTexture(null):this.isNeedState=!0},get state(){return this._state},print:function(t){t=t||"",console.log("[Entity",this.name+":"+this.id+"]",t)},get view(){return this._view},set parent(t){if(this._parent=t,this.children)for(var e=this.children.length,i=0;e>i;i++)this.children[i].parent=t},get parent(){return this._parent},set x(t){this.position(t,this._y)},set y(t){this.position(this._x,t)},get x(){return this._x},get y(){return this._y},get absoluteX(){return this._x+this._parent.childOffsetX+this._anchorPosX},get absoluteY(){return this._y+this._parent.childOffsetY+this._anchorPosY},get width(){return this.volume.width},get height(){return this.volume.height},set anchorX(t){this.anchor(t,this._anchorY)},set anchorY(t){this.anchor(this._anchorX,t)},get anchorX(){return this._anchorX},get anchorY(){return this._anchorY},set isAnchor(t){this._isAnchor!==t&&(t?(this._isAnchor=!0,this.onResize=this.updateAnchor,this.isNeedDraw=!0):(this._anchorX=0,this._anchorY=0,this._anchorPosX=0,this._anchorPosY=0,this._isAnchor=!1,this.onResize=meta.emptyFuncParam))},get isAnchor(){return this._isAnchor},get centerX(){return this._x+this._parent.childOffsetX+this.textureOffsetX},get centerY(){return this._y+this._parent.childOffsetY+this.textureOffsetY},set z(t){var e=this._parent._z+t;if(this._view&&(e+=this._view._z),this._depthNode.depth!==e&&(this._z=t,this._depthNode.depth=e,this._depthNode.entity&&(this._entityCtrl.entities.update(this._depthNode),this.isNeedDraw=!0,this.children)))for(var i=this.children.length,s=0;i>s;s++)this.children[s].z=t},set depthIndex(t){this.z=t},get z(){return this._z},get depthIndex(){return this._z},set texture(t){this.setTexture(t)},get texture(){return this._texture},set brush(t){this._brush=t,this._brushParams={},this.isNeedState=t?!0:!1},get brush(){return this._brush},set isNeedDraw(t){this._isLoaded&&(this._isNeedDraw=t,this._tChange=Date.now(),this._isCached&&this._entityCtrl.uncacheEntity(this),t&&(this._entityCtrl.isNeedRender=!0))},get isNeedDraw(){return this._isNeedDraw},set showBounds(t){this._showBounds!==t&&(this._showBounds=t,t?this._entityCtrl._addToDrawBounds():this._entityCtrl._removeToDrawBounds())},get showBounds(){return this._showBounds},get left(){return this.volume.minX},get right(){return this.volume.maxX},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},set alpha(t){var e=this._parent._alpha*t;if(this.totalAlpha!==e){if(this.totalAlpha=e,this._alpha=t,this.children)for(var i=this.children.length,s=0;i>s;s++){var n=this.children[s];if(n.ignoreParentAlpha)return;n.alpha=e}this.isNeedDraw=!0,this._draw=this._drawTransform}},get alpha(){return this._alpha},set angle(t){if(t=meta.math.toRadians(t),this._angleRad!==t){if(this._angleRad=t,this.children)for(var e=this.children.length,i=0;e>i;i++){var s=this.children[i];s.ignoreParentAngle||(s.angleRad=t)}this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0}},get angle(){return meta.math.toDegree(this._angleRad)},set angleRad(t){if(this._angleRad!==t){if(this._angleRad=t,this.children)for(var e=this.children.length,i=0;e>i;i++){var s=this.children[i];s.ignoreParentAngle||(s.angleRad=t)}this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0}},get angleRad(){return this._angleRad},updateScale:function(){this.volume.scale(this._scaleX,this._scaleY),this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0},set scale(t){this._scaleX=t,this._scaleY=t,this.updateScale()},set scaleX(t){this._scaleX=t,this.updateScale()},set scaleY(t){this._scaleY=t,this.updateScale()},get scale(){return this._scaleX},get scaleX(){return this._scaleX},get scaleY(){return this._scaleY},flip:function(t,e){void 0===t&&void 0===e?(t=-this._flipX,e=this._flipY):(t=void 0!==t?t:1,e=void 0!==e?e:1),t=Math.round(t),e=Math.round(e),t>1?t=1:-1>t?t=-1:0===t&&(t=1),e>1?e=1:-1>e?e=-1:0===e&&(e=1),(t!==this._flipX||e!==this._flipY)&&(this._flipX=t,this._flipY=e,this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0)},set flipX(t){this.flip(t,this._flipY)},set flipY(t){this.flip(this._flipX,t)},get flipX(){return this._flipX},get flipY(){return this._flipY},set visible(t){if(this.isVisible=t,this._entityCtrl.isNeedRender=!0,this.children)for(var e=this.children.length,i=0;e>i;i++)this.children[i].visible=t},get visible(){return this.isVisible},set isLoaded(t){if(this._isLoaded!==t)if(this._isLoaded=t,t){if(this.components){var e;for(var i in this.components)e=this.components[i],e.load&&e.load()}this._entityCtrl.cacheEntity(this)}else this._entityCtrl.uncacheEntity(this)},get isLoaded(){return this._isLoaded},set isUpdating(t){this._isUpdating!==t&&(this._isUpdating=t,t?this._entityCtrl._addToUpdating(this):this._entityCtrl._removeFromUpdating(this))},get isUpdating(){return this._isUpdating},set currFrame(t){if(this._texture){var e=t%this._texture.numFrames;if(e===this._currFrame)return;this._currFrame=e,this.isNeedDraw=!0}else this._currFrame=t},get currFrame(){return this._currFrame},set isAnimReverse(t){this._isAnimReverse=t,this.currFrame=t&&this._texture?this._texture.numFrames-1:0},get isAnimReverse(){return this._isAnimReverse},get tween(){return this._tween||(this._tween=new meta.Tween(this)),this._tween},_onResize:meta.emptyFunc,set onResize(t){this._onResize&&(meta.unsubscribe(this,meta.Event.RESIZE,this._onResize),meta.unsubscribe(this,meta.Event.CAMERA_RESIZE,this._onResize)),this._onResize=t,t&&(meta.subscribe(this,meta.Event.RESIZE,this._onResize),meta.subscribe(this,meta.Event.CAMERA_RESIZE,this._onResize))},get onResize(){return this._onResize},set isCached(t){this._isCached===t},get isCached(){return this._isCached},set ignoreZoom(t){this._ignoreZoom!==t&&(this._isAnchor&&this.updateAnchor(null,null),this._ignoreZoom=t,this.isNeedDraw=!0)},get ignoreZoom(){return this._ignoreZoom},_entityCtrl:null,id:-1,type:0,name:"unknown",_parent:null,_view:null,_depthNode:null,_viewNodeID:-1,_updateAnimNodeID:-1,_x:0,_y:0,_z:0,_anchorX:0,_anchorY:0,_anchorPosX:0,_anchorPosY:0,_dragOffsetX:0,_dragOffsetY:0,drawX:0,drawY:0,offsetX:0,offsetY:0,pivotX:0,pivotY:0,pivotRatioX:0,pivotRatioY:0,childOffsetX:0,childOffsetY:0,childPivotX:0,childPivotY:0,cellX:0,cellY:0,_cellIndex:0,_brush:null,_brushState:null,_brushParams:null,_state:"",_tween:null,volume:null,clipVolume:null,positionType:0,_angleRad:0,_scaleX:1,_scaleY:1,_flipX:1,_flipY:1,_alpha:1,totalAlpha:1,_texture:null,vbo:null,vertices:null,components:null,componentBuffer:null,numComponents:0,children:null,ignoreParentAngle:!1,ignoreParentAlpha:!1,isPickable:!0,isHover:!1,isPressed:!1,isDragged:!1,_ignoreZoom:!1,fps:0,animSpeed:1,_currFrame:0,isAnimating:!1,isLoop:!1,_isAnimReverse:!1,isEmulateReverse:!1,_tAnim:0,pauseAtEnd:!1,_tChange:0,_isAnchor:!1,isAdded:!1,_isLoaded:!1,isVisible:!0,isPaused:!1,isChild:!1,isRemoved:!1,_isUpdating:!1,_isNeedDraw:!1,isNeedState:!1,_isNeedOffset:!1,_cacheIndex:-1,_showBounds:!1,_isHighlight:!1,enableDebug:!0}),"use strict",Entity.Text=Entity.Geometry.extend({init:function(t){this.texture=new Resource.Texture,this._texture.resize(this._fontSize,this._fontSize),this.setText("")},setText:function(t){this._text=t;var e;e=this._texture.textureType===Resource.TextureType.WEBGL?this._texture._tmpCtx:this._texture.ctx,e.font=this._style+" "+this._fontSizePx+" "+this._font;var i=e.measureText(this._text),s=i.width+2*this.outlineWidth;if(this.resize(s,1.2*this._fontSize),this._texture.textureType===Resource.TextureType.WEBGL&&(this._texture._tmpImg.width=s,this._texture._tmpImg.height=1.2*this._fontSize),e.clearRect(0,0,this.volume.width,this.volume.height),e.font=this._style+" "+this._fontSizePx+" "+this._font,e.fillStyle=this._color,e.textBaseline="top",e.fillText(t,this.outlineWidth,0),this.isOutline&&(e.lineWidth=this._outlineWidth,e.strokeStyle=this._outlineColor,e.strokeText(t,this.outlineWidth,0)),this._texture.textureType===Resource.TextureType.WEBGL){var n=meta.ctx;n.bindTexture(n.TEXTURE_2D,this._texture.image),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,this._texture._tmpImg)}this._texture._isLoaded||(this._texture.isLoaded=!0),this.isNeedDraw=!0},resize:function(t,e){t=t||1,e=e||this.volume.height,this._texture.resize(t,e)},setFont:function(t){this._font=t,this.setText(this._text)},setSize:function(t){this._fontSize=t,this._fontSizePx=t+"px",this.setText(this._text)},setColor:function(t){this._color=t,this.setText(this._text)},setOutlineColor:function(t){this._outlineColor=t,this.isOutline=!0},setOutlineWidth:function(t){this._outlineWidth=t,this._isOutline&&this.setText(this._text)},setStyle:function(t){this._style=t,this.setText(this._text)},set text(t){this.setText(t)},get text(){return this._text},set font(t){this.setFont(t)},get font(){return this._font},set size(t){this.setSize(t)},get size(){return this._fontSize},set color(t){this.setColor(t)},get color(){return this._color},set outlineColor(t){this.setOutlineColor(t)},get outlineColor(){return this._outlineColor},set outlineWidth(t){this.setOutlineWidth(t)},get outlineWidth(){return this._outlineWidth},set style(t){this.setStyle(t)},get style(){return this._style},set isOutline(t){this._isOutline!==t&&(this._isOutline=t,this.setText(this._text))},get isOutline(){return this._isOutline},_text:"",_font:"Arial",_fontSize:18,_fontSizePx:"18px",_color:"#000000",_outlineColor:"#ffffff",_outlineWidth:1,_style:"",_isOutline:!1}),"use strict",Entity.DepthList=function(){this.length=0,this.first=new Entity.DepthList.Node(null),this.last=new Entity.DepthList.Node(null),this.bufferLength=64,this.buffer=new Array(this.bufferLength),this.first.depth=-2147483648,this.first.next=this.last,this.last.depth=2147483648,this.last.prev=this.first},Entity.DepthList.prototype={push:function(t){var e=this.last.prev;do{if(t.depth>=e.depth)return t.prev=e,t.next=e.next,e.next.prev=t,e.next=t,this.length>=this.bufferLength&&(this.bufferLength+=64,this.buffer.length=this.bufferLength),this.buffer[this.length]=t.entity,this.length++,void 0;e=e.prev}while(e);console.error("[Entity.DepthList.push]:","Node is out of the bounds!")},remove:function(t){t.next&&(t.next.prev=t.prev),t.prev&&(t.prev.next=t.next),t.next=null,t.prev=null,this.buffer[t.index]=this.buffer[this.length-1],this.buffer[this.length-1]=null,this.length--},clear:function(){this.length=0,this.buffer=new Array(this.bufferLength)},update:function(t){var e=t.prev;if(e!==this.first&&e.depth>t.depth){t.next.prev=t.prev,t.prev.next=t.next;do{if(e.depth<t.depth)return t.prev=e,t.next=e.next,t.next.prev=t,e.next=t,void 0;e=e.prev}while(e)}if(e=t.next,e!==this.last&&e.depth<t.depth){t.next.prev=t.prev,t.prev.next=t.next;do{if(e.depth>t.depth)return t.next=e,t.prev=e.prev,t.prev.next=t,e.prev=t,void 0;e=e.next}while(e)}},print:function(){if(0===this.length)return console.log("Empty"),void 0;var t=this.first.next;do console.log(t.entity.name,t.depth),t=t.next;while(t!==this.last)}},Entity.DepthList.Node=function(){this.entity=null,this.depth=0,this.prev=null,this.next=null,this.index=-1},"use strict",Entity.CellArray=function(){this.buffer=new Array(8),this.size=8,this.length=0,this.isVisible=!1},Entity.CellArray.prototype={push:function(t){this.size===this.length&&(this.size+=8,this.buffer.length=this.size),this.buffer[this.length]=t,t._cellIndex=this.length,this.length++},remove:function(t){this.length--,this.buffer[t._cellIndex]=this.buffer[this.length],this.length+8===this.size&&(this.size-=8,this.buffer.length=this.size)}},"use strict",window.Input={},Input.Controller=meta.Controller.extend({init:function(){this.keys=new Array(this.numKeys),this.inputs=new Array(this.numInputs),this.touches=[],this._event={event:null,x:0,y:0,prevScreenX:0,prevScreenY:0,screenX:0,screenY:0,keyCode:0,entity:null},this.addEventListeners(),this._loadIgnoreKeys(),meta.subscribe(this,meta.Event.FOCUS,this.onFocus)},release:function(){this.removeEventListeners(),meta.unsubscribe(this,meta.Event.FOCUS,this.onFocus)},onKeyDown:function(t){if(window.top&&this._iFrameKeys[t.keyCode]&&t.preventDefault(),void 0!==this._cmdKeys[t.keyCode]&&this._numCmdKeys++,void 0===this._ignoreKeys[t.keyCode]&&this._numCmdKeys<=0&&t.preventDefault(),!(this.blockInput||this.isStickyKeys&&this.keys[t.keyCode]||(this.keys[t.keyCode]=!0,this._event.Event=t,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.screenX=0,this._event.screenY=0,this._event.x=0,this._event.y=0,this._event.keyCode=t.keyCode,this._chnKeyDown.emit(this._event,Input.Event.KEY_DOWN),!this.keyRepeat))){if(!this._inputTimer){var e=this;this._inputTimer=meta.addTimer(this,function(){e._event.keyCode=e._repeatKey,e._chnKeyDown.emit(e._event,Input.Event.KEY_DOWN)},this.keyRepeat)}this._repeatKey=t.keyCode,this._inputTimer.resume(),this._inputTimer.tAccumulator=0}},onKeyUp:function(t){window.top&&this._iFrameKeys[t.keyCode]&&t.preventDefault(),void 0!==this._cmdKeys[t.keyCode]&&this.keys[t.keyCode]&&this._numCmdKeys--,void 0===this._ignoreKeys[t.keyCode]&&this._numCmdKeys<=0&&t.preventDefault(),this.blockInput||(this.keys[t.keyCode]=!1,this._event.Event=t,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=t.keyCode,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP),this.keyRepeat&&this._inputTimer&&this._inputTimer.pause())},onMouseDown:function(t){if(!this.blockInput){this.inputs[t.button]=!0;var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x,h=n*i.zoomRatio-i._y;this._event.Event=t,this._event.prevScreenX=s,this._event.prevScreenY=n,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=t.button,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN)}},onMouseUp:function(t){if(!this.blockInput){this.inputs[t.button]=!1;var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x,h=n*i.zoomRatio-i._y;this._event.Event=t,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=t.button,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP)}},onMouseMove:function(t){if(t.preventDefault(),!this.blockInput){var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x,h=n*i.zoomRatio-i._y;this._event.Event=t,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=-1,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE)}},onTouchDown:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a=t.changedTouches,u=a.length,c=0;u>c;c++)s=t.changedTouches[c],this.touches.push(s.identifier),this.numTouches++,n=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,o=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,h=n*i.zoomRatio-i._x,r=o*i.zoomRatio-i._y,this._event.Event=t,this._event.prevScreenX=n,this._event.prevScreenY=o,this._event.screenX=n,this._event.screenY=o,this._event.x=h,this._event.y=r,this._event.keyCode=this.numTouches-1,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN)},onTouchUp:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a,u=t.changedTouches,c=u.length,l=0;c>l;l++)s=t.changedTouches[l],n=this._getTouchID(s.identifier),-1!==n&&(this.touches.splice(n,1),this.numTouches--,o=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,h=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,r=o*i.zoomRatio-i._x,a=h*i.zoomRatio-i._y,this._event.Event=t,0===n?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY):(this._event.prevScreenX=o,this._event.prevScreenY=h),this._event.screenX=o,this._event.screenY=h,this._event.x=r,this._event.y=a,this._event.keyCode=n,this._chnInputDown.emit(this._event,Input.Event.INPUT_UP))},onTouchMove:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a,u=t.changedTouches,c=u.length,l=0;c>l;l++)s=t.changedTouches[l],n=this._getTouchID(s.identifier),-1!==n&&(o=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,h=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,r=o*i.zoomRatio-i._x,a=h*i.zoomRatio-i._y,this._event.Event=t,0===n?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY):(this._event.prevScreenX=o,this._event.prevScreenY=h),this._event.screenX=o,this._event.screenY=h,this._event.x=r,this._event.y=a,this._event.keyCode=n,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE))},onFocus:function(t,e){e===!1&&this.resetInput()},isDown:function(t){return this.keys[t]},isInputDown:function(t){return this.inputs[t]},addEventListeners:function(){var t=this;this._chnKeyDown=meta.createChannel(Input.Event.KEY_DOWN),this._chnKeyUp=meta.createChannel(Input.Event.KEY_UP),this._chnInputDown=meta.createChannel(Input.Event.INPUT_DOWN),this._chnInputUp=meta.createChannel(Input.Event.INPUT_UP),this._chnInputMove=meta.createChannel(Input.Event.INPUT_MOVE),this._onKeyDown=function(e){t.onKeyDown(e)},this._onKeyUp=function(e){t.onKeyUp(e)},this._onMouseDown=function(e){t.onMouseDown(e)},this._onMouseUp=function(e){t.onMouseUp(e)},this._onMouseMove=function(e){t.onMouseMove(e)},this._onTouchDown=function(e){t.onTouchDown(e)},this._onTouchUp=function(e){t.onTouchUp(e)},this._onTouchMove=function(e){t.onTouchMove(e)},this._onTouchCancel=function(e){t.onTouchCancel(e)},window.addEventListener("mousedown",this._onMouseDown),window.addEventListener("mouseup",this._onMouseUp),window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("touchstart",this._onTouchDown),window.addEventListener("touchend",this._onTouchUp),window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchcancel",this._onTouchUp),window.addEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.addEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.addEventListener("keyup",this._onKeyUp)},removeEventListeners:function(){window.removeEventListener("mousedown",this._onMouseDown),window.removeEventListener("mouseup",this._onMouseUp),window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("touchstart",this._onTouchDown),window.removeEventListener("touchend",this._onTouchUp),window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchcancel",this._onTouchUp),window.removeEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.removeEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.removeEventListener("keyup",this._onKeyUp)},resetInput:function(){var t;for(this._event.Event=null,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=0,t=0;t<this.numKeys;t++)this.keys[t]&&(this.keys[t]=!1,this._event.keyCode=t,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP));for(t=0;t<this.numInputs;t++)this.inputs[t]&&(this.inputs[t]=!1,this._event.keyCode=t,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP));if(this._numCmdKeys=0,this.numTouches){for(t=0;t<this.numTouches;t++)this._event.keyCode=t,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP);this.touches.length=0,this.numTouches=0}},_loadIgnoreKeys:function(){this._ignoreKeys=[],this._ignoreKeys[8]=1,this._ignoreKeys[9]=1,this._ignoreKeys[13]=1,this._ignoreKeys[17]=1,this._ignoreKeys[91]=1,this._ignoreKeys[38]=1,this._ignoreKeys[39]=1,this._ignoreKeys[40]=1,this._ignoreKeys[37]=1,this._ignoreKeys[112]=1,this._ignoreKeys[113]=1,this._ignoreKeys[114]=1,this._ignoreKeys[115]=1,this._ignoreKeys[116]=1,this._ignoreKeys[117]=1,this._ignoreKeys[118]=1,this._ignoreKeys[119]=1,this._ignoreKeys[120]=1,this._ignoreKeys[121]=1,this._ignoreKeys[122]=1,this._ignoreKeys[123]=1,this._ignoreKeys[124]=1,this._ignoreKeys[125]=1,this._ignoreKeys[126]=1,this._cmdKeys=[],this._cmdKeys[91]=1,this._cmdKeys[17]=1,this._iFrameKeys=[],this._iFrameKeys[37]=1,this._iFrameKeys[38]=1,this._iFrameKeys[39]=1,this._iFrameKeys[40]=1
},_getTouchID:function(t){for(var e=0;e<this.numTouches;e++)if(this.touches[e]===t)return e;return-1},keys:null,inputs:null,touches:null,blockInput:!1,isStickyKeys:!0,keyRepeat:0,_inputTimer:null,_repeatKey:0,numKeys:256,numInputs:10,numTouches:0,_event:null,_onKeyDown:null,_onKeyUp:null,_onMouseDown:null,_onMouseUp:null,_onMouseMove:null,_onTouchDown:null,_onTouchUp:null,_onTouchMove:null,_onTouchCancel:null,_chnKeyDown:null,_chnKeyUp:null,_chnInputDown:null,_chnInputUp:null,_chnInputMove:null,_ignoreKeys:null,_cmdKeys:null,_iFrameKeys:null,_numCmdKeys:0}),"use strict",Input.Event={KEY_DOWN:"keyDown",KEY_UP:"keyUp",INPUT_DOWN:"inputDown",INPUT_UP:"inputUp",INPUT_MOVE:"inputMove",INPUT_CLICK:"click"},Input.Key={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,ESC:27,SPACE:32,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,PLUS:187,MINUS:189,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,BUTTON_LEFT:0,BUTTON_MIDDLE:1,BUTTON_RIGHT:2},"use strict";var UI={};UI.Controller=meta.Controller.extend({init:function(){var t=new Resource.Texture;t.fillRect({color:"#333333",width:100,height:40});var e=new Resource.Texture;e.fillRect({color:"#ff0000",width:100,height:40});var i=new Resource.Texture;i.fillRect({color:"#ff4488",width:100,height:40}),this.style=new UI.Style({button:{"*":{texture:t,width:100,height:40},"*:hover":{texture:e},"*:active":{texture:i}}}),UI.Button.prototype._style=this.style.getStyle("button")},setStyle:function(t){this.style.setStyle(t)},getStyle:function(t){return this.style.getStyle(t)},style:null}),"use strict",UI.Style=function(t){this.style=null,this.generate(t)},UI.Style.prototype={generate:function(t){this.style={},this.setStyle(t)},setStyle:function(t){var e,i,s,n,o,h;for(var r in t){h=this.style[r],h||(h={},this.style[r]=h),e=t[r];for(o in e)if(i=e[o],s=o.indexOf("@"),-1!==s&&(o=o.substr(0,s)),s=o.indexOf(":"),-1!==s)n=o.substr(s+1,o.length-s-1),o=o.substr(0,s),i?h[o].setState(n,null,i):h[o].removeState(n);else{var a=new meta.Brush;a.setState("default",null,i),h[o]=a}}},getStyle:function(t){var e=t.indexOf("."),i,s;return-1===e?(i=t,s="*"):(i=t.substr(0,e),s=t.substr(e+1,t.length-e-1)),this.style[i][s]}},"use strict",UI.Button=Entity.Geometry.extend({init:function(t){this.brush=this._style,this.state="default"},_updateState:function(){return this._style?this.isHover&&this._style.states.hover?(this.state="hover",void 0):this._isActive&&this._style.states.active?(this.state="active",void 0):(this.state="default",void 0):void 0},onAdded:function(){this._label&&this.attach(this._label)},_onHoverEnter:function(t){document.body.style.cursor="pointer",this._updateState()},_onHoverExit:function(t){document.body.style.cursor="auto",this._updateState()},_onPress:function(t){this.move(2,2)},_onClick:function(t){this._style&&(this.move(-2,-2),this._style.states.active&&(this.isActive=!this._isActive,this._updateState(),this.onActive(this._isActive)))},_onRelease:function(t){this.move(-2,-2)},onActive:meta.emptyFuncParam,set style(t){"string"==typeof t&&(t=UI.ctrl.getStyle("button."+t)),this._style=t,this.brush=t,this._isNeedDraw=!0},get style(){return this._style},set text(t){this._label?this._label.setText(t):(this._label=new Entity.Text,this._label.color="white",this._label.size=20,this._label.text=t,this._label.position(0,0),this._label.isPickable=!1,this.attach(this._label))},get text(){return this._label?this._label._text:""},get label(){return this._label},set width(t){this._width=t,this.isNeedDraw=!0},set height(t){this._height=t,this.isNeedDraw=!0},get width(){return this._width},get height(){return this._height},set isActive(t){this._isActive=t,this._updateState()},get isActive(){return this._isActive},_style:null,_text:null,_width:1,_height:1,_isActive:!1}),"use strict",UI.ProgressBar=Entity.Geometry.extend({}),"use strict",function(){meta.enableDefault&&meta.createEngine()}();