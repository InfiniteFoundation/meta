"use strict";var meta={};meta.engine=null,meta.device=null,meta.element=null,meta.elementId="",meta.canvas=null,meta.ctx=null,meta.width=0,meta.height=0,meta.channels={},meta.shaders=null,meta.loadingView=null,meta.world=null,meta.camera=null,meta.shader=null,meta.version="1.1.2",meta.enableDefault=!0,meta.enablemeta=!0,meta.enableWebGL=!0,meta.enableAdaptive=!0,meta.tUpdate=1e3/60,meta.unitSize=1,meta.unitRatio=1,meta.maxUnitSize=1,meta.maxUnitRatio=1,meta.utils={},meta.modules={},meta.importUrl="http://infinite-games.com/store/",meta._cache={ismetaAdded:!1,init:null,load:null,ready:null,view:null,views:{},queue:[],scripts:null,pendingScripts:null,numScriptsToLoad:0,resolutions:null,currResolution:null,imageSmoothing:!0},meta.Engine=function(){this.controllers=[],this.controllersToRemove=[],this._timers=[],this._timersToRemove=[],this._numTimers=0,this.unsubscribesetLeft=0,this.unsubscribesetTop=0,this._onResizeCB=null,this._onVisibilityChangeCB=null,this._onFullScreenChangeCB=null,this._onFocusCB=null,this._onBlurCB=null,this._onCtxLostCB=null,this._onCtxRestoredCB=null,this._chnResize=null,this._chnFocus=null,this._chnFullScreen=null,this._chnAdapt=null,this.isCreated=!1,this.isFocus=!1,this.isWebGL=!1,this.isInited=!1,this.isLoaded=!1,this.isLoading=!1,this.isCtrlLoaded=!1,this.isReady=!1,this.pause=!1,this.projection=null,this._updateLoop=null,this._renderLoop=null,this.tUpdate=0,this.tRender=0,this.tFPS=0,this.tNow=0,this.fps=0,this._fpsCounter=0,this.frameID=0,this.updateFrameID=0,this.enablePauseOnBlur=!0,this._bgColor="#ddd",this._bgTransparent=!1},meta.Engine.prototype={create:function(){if(this.isCreated)return console.error("[meta.Engine.create]:","Engine instance is already created."),void 0;console.log("%c META v"+meta.version+" ","background: #000; color: white; font-size: 12px; padding: 2px 0 1px 0;","http://infinite-games.com "),console.log("%cBrowser: %c"+meta.device.name+" "+meta.device.version+"	","font-weight: bold; padding: 2px 0 1px 0;","padding: 2px 0 1px 0;"),meta.enablemeta&&this._createmeta(),meta.shaders={},meta.camera=new meta.Camera,this._chnResize=meta.createChannel(meta.Event.RESIZE),this._chnFocus=meta.createChannel(meta.Event.FOCUS),this._chnFullScreen=meta.createChannel(meta.Event.FULLSCREEN),this._chnAdapt=meta.createChannel(meta.Event.ADAPT),this._resolveElement(),this._createCanvas(),this.sortAdaptions(),this.onResize(),meta.world=new meta.World(this.width,this.height);var t=this;this._onResizeCB=function(e){t.onResize()},this._onFocusCB=function(e){t.onFocusChange(!0)},this._onBlurCB=function(e){t.onFocusChange(!1)},window.addEventListener("resize",this._onResizeCB,!1),window.addEventListener("orientationchange",this._onResizeCB,!1),meta.device.hidden?(this._onVisibilityChangeCB=function(){t.onVisibilityChange()},document.addEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB)):(window.addEventListener("focus",this._onFocusCB),window.addEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&(this._onFullScreenChangeCB=function(){t.onFullScreenChangeCB()},document.addEventListener(meta.device.fullScreenOnChange,this._onFullScreenChangeCB)),this.tNow=Date.now(),this.start(),this.isCreated=!0},release:function(){return this.isCreated?(this._chnFocus.remove(),this._chnResize.remove(),this._chnFullScreen.remove(),this._chnAdapt.remove(),window.removeEventListener("resize",this._onResizeCB),window.removeEventListener("orientationchange",this._onResizeCB),meta.device.hidden?document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB):(window.removeEventListener("focus",this._onFocusCB),window.removeEventListener("blur",this._onBlurCB)),meta.device.support.fullScreen&&document.removeEventListener(meta.device.visibilityChange,this._onVisibilityChangeCB),this.isWebGL&&(window.removeEventListener("webglcontextlost",this._onCtxLostCB),window.removeEventListener("webglcontextrestored",this._onCtxRestoredCB)),meta.removeAllControllers(),meta.channels=null,meta.shaders=null,meta.world=null,meta.shader=null,this.isCreated=!1,void 0):(console.error("[meta.Engine.release]:","Can't release uninitialized engine instance."),void 0)},start:function(){var t=meta._cache,e=new meta.View("master");t.views.master=e,t.view=e,t.init&&"function"==typeof t.init&&t.init(),this._addCorePlugins(),this.isInited=!0,console.log(" "),this._load()},_load:function(){console.log("%c(Loading started)","background: #eee; font-weight: bold;"),this.isLoading=!0,meta._loadAllScripts()||this._continueLoad()},_continueLoad:function(){var t,e=meta._cache.queue,i=e.length;for(t=0;i>t;t++)e[t]();meta._cache.load&&"function"==typeof meta._cache.load&&meta._cache.load();var s,n=this.controllers.length;for(t=0;n>t;t++)s=this.controllers[t],s.load(),s.isLoaded=!0;this.isCtrlLoaded=!0,meta._cache.view.isActive=!0,this.isLoading=!1,0===Resource.ctrl.numToLoad&&this.onResourcesLoaded()},update:function(){this.updateFrameID++,this.tNow=Date.now();var t=this.tNow-this.tUpdate;this.pause&&(t=0),t>250&&(t=250);for(var e=t/1e3,i=this.controllers.length,s=0;i>s;s++)this.controllers[s].update(e);if(this.controllersToRemove.length){for(var n,o=this.controllers.length,h=this.controllersToRemove.length,r=0;h>r;r++)for(n=this.controllersToRemove[r],s=0;o>s;s++)if(this.controllers[s]===n){this.controllers[s]=this.controllers[o-1],this.controllers.pop();break}this.controllersToRemove.length=0}meta.update&&meta.update(e),this._updateTimers(t),this.tUpdate=this.tNow;var a=Date.now(),u=Math.max(0,meta.tUpdate-(a-this.tNow));window.setTimeout(this._updateLoop,u)},_updateTimers:function(t){var e,i;for(i=0;i<this._numTimers;i++)if(e=this._timers[i],!e.isPaused)for(e.tAccumulator+=t;e.tAccumulator>=e.tDelta;)if(e.tAccumulator-=e.tDelta,0!==e.numTimes&&e.func.call(e.owner,e),e.tStart+=e.tDelta,-1!==e.numTimes&&(e.numTimes--,e.numTimes<=0)){this._timersToRemove.push(e);break}if(this._timersToRemove.length){var s,n=this._timersToRemove.length;for(i=0;n>i;i++){s=this._timersToRemove[i];for(var o=0;o<this._numTimers;o++)if(e=this._timers[o],e.id===s.id){e.onRemove&&e.onRemove(),this._timers[o]=this._timers[this._numTimers-1],this._timers.pop(),this._numTimers--;break}}}},render:function(){this.frameID++;var t=Date.now(),e=t-this.tRender;e>250&&(e=250);var i=e/1e3;t-this.tFPS>=1e3&&(this.tFPS=t,this.fps=this._fpsCounter,this._fpsCounter=0),Renderer.ctrl.render(i),meta.render&&meta.render(i),this._fpsCounter++,this.tRender=t,requestAnimationFrame(this._renderLoop)},sortAdaptions:function(){var t=meta,e=t._cache.resolutions;if(e){var i=e.length;if(!(1>=i)){e.sort(function(e,i){var s=t.math.length2(e.width,e.height),n=t.math.length2(i.width,i.height);return s-n});for(var s=e[0],n,o,h=1;i>h;h++)o=e[h-1],n=e[h],n.unitSize=n.height/s.height,n.zoomThreshold=o.unitSize+(n.unitSize-o.unitSize)/100*33.3;meta.maxUnitSize=e[i-1].unitSize,meta.maxUnitRatio=1/meta.maxUnitSize,t.camera.bounds(s.width,s.height)}}},adapt:function(){var t=meta,e=t._cache.resolutions;if(!e)return!1;var i=e.length;if(1>i)return!1;for(var s,n=e[0],o=t.camera.zoom,h=i-1;h>=0;h--)if(s=e[h],o>=s.zoomThreshold){n=s;break}return n===t._cache.currResolution?!0:(t._cache.currResolution=n,t.unitSize=n.unitSize,t.unitRatio=1/t.unitSize,this._chnAdapt.emit(n,meta.Event.ADAPT),!0)},onResourcesLoaded:function(){this.isLoaded=!0,console.log("%c(Loading ended)","background: #eee; font-weight: bold;");for(var t=this.controllers.length,e=0;t>e;e++)this.controllers[e].ready();this.isReady=!0,meta._cache.ready&&"function"==typeof meta._cache.ready&&meta._cache.ready(),this._start()},onResize:function(){var t=meta,e,i;t.element===document.body?(e=window.innerWidth,i=window.innerHeight):(e=t.element.clientWidth,i=t.element.clientHeight);var s=window.devicePixelRatio;this.width=e*s|0,this.height=i*s|0,this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=e+"px",this.canvas.style.height=i+"px",this.ctx.imageSmoothingEnabled=meta._cache.imageSmoothing,t.width=this.width,t.height=this.height,this.isWebGL&&(this.projection.ortho(0,this.width,this.height,0,0,100),meta.shader.uniformMatrix("projection",this.projection),this.ctx.viewport(0,0,this.width,this.height)),this._updateOffset(),this._chnResize.emit(this,meta.Event.RESIZE)},onFocusChange:function(t){this.isFocus=t,this.enablePauseOnBlur&&(this.pause=!t),this._chnFocus.emit(t,meta.Event.FOCUS)},onVisibilityChange:function(){this.onFocusChange(document[meta.device.hidden]?!1:!0)},onFullScreenChangeCB:function(){var t=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;meta.device.isFullScreen=!!t},onCtxLost:function(){console.log("(Context lost)")},onCtxRestored:function(){console.log("(Context restored)")},_resolveElement:function(){meta.elementId?(this.element=document.getElementById(meta.elementId),this.element||(console.warn("[meta.engine.create]:","Could not find element with id - "+meta.elementId),this.element=document.body)):this.element=document.body,this.element.style.cssText+=this.elementStyle,meta.element=this.element},_createmeta:function(){if(!meta._cache.ismetaAdded){var t=document.createElement("meta");t.setAttribute("http-equiv","Content-Type"),t.setAttribute("content","text/html; charset=utf-8"),document.head.appendChild(t);var e=document.createElement("meta");e.setAttribute("http-equiv","encoding"),e.setAttribute("content","utf-8"),document.head.appendChild(e);var i="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height",s=document.createElement("meta");s.setAttribute("name","viewport"),s.setAttribute("content",i),document.head.appendChild(s);var n=document.createElement("meta");n.setAttribute("name","apple-mobile-web-app-capable"),n.setAttribute("content","yes"),document.head.appendChild(n);var o=document.createElement("meta");o.setAttribute("name","apple-mobile-web-app-status-bar-style"),o.setAttribute("content","black-translucent"),document.head.appendChild(o),meta._cache.ismetaAdded=!0}},_createCanvas:function(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","meta-canvas"),this.canvas.style.cssText=this.canvasStyle,this.element.appendChild(this.canvas),meta.canvas=this.canvas;var t={};if(meta.enableWebGL&&meta.device.support.webgl){t.stencil=!0,t.preserveDrawingBuffer=!1,this.ctx=this.canvas.getContext("experimental-webgl",t),meta.ctx=this.ctx,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1;var e=this;this._onCtxLostCB=function(t){e.onCtxLost()},this._onCtxRestoredCB=function(t){e.onCtxRestored()},window.addEventListener("webglcontextlost",this._onCtxLostCB),window.addEventListener("webglcontextrestored",this._onCtxRestoredCB),this._initShaders(),this.isWebGL=!0,console.log("%cRenderer: %cWebGL ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;"),this.bgColor=this._bgColor}else this.ctx=this.canvas.getContext("2d",t),meta.ctx=this.ctx,console.log("%cRenderer: %cCanvas ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")},_initShaders:function(){this.projection=new meta.math.Matrix4;var t=new meta.Shader;return t.vertexShader="precision mediump float; attribute vec2 vertexPos; attribute vec2 texCoord; uniform vec2 cameraPos; uniform float zoom; uniform vec2 pos; uniform vec2 center; uniform vec2 scale; uniform vec4 frameCoord; uniform float angle; uniform mat4 projection; varying highp vec2 frameTexCoord; void main(void) { float rotX = sin(-angle);float rotY = cos(-angle);vec2 scaled = floor(vertexPos * scale);vec2 origin = vec2(scaled.x + floor(pos.x) - floor(center.x), scaled.y + floor(pos.y) - floor(center.y));vec2 newPos = vec2(origin.x * rotY + origin.y * rotX, origin.y * rotY - origin.x * rotX) + floor(center) + cameraPos;newPos *= zoom;gl_Position = projection * vec4(newPos, 0.0, 1.0);frameTexCoord = vec2(frameCoord.x + (texCoord.x * frameCoord.z), frameCoord.y + (texCoord.y * frameCoord.w)); }",t.fragmentShader="precision mediump float; uniform sampler2D sampler; uniform float alpha; varying highp vec2 frameTexCoord; void main(void) { vec4 color = texture2D(sampler, frameTexCoord); color.a *= alpha; gl_FragColor = color; }",meta.shaders.default=t,t.compile()?(meta.setShader("default"),t.bindAttrib("vertexPos"),t.bindAttrib("texCoord"),void 0):(console.error("[meta.Engine._initShaders]:","Could not compile shaders."),void 0)},_updateOffset:function(){this.unsubscribesetLeft=0,this.unsubscribesetTop=0;var t=meta.element;if(t.unsubscribesetParent)do this.unsubscribesetLeft+=t.unsubscribesetLeft,this.unsubscribesetTop+=t.unsubscribesetTop;while(t=t.unsubscribesetParent);var e=meta.element.getBoundingClientRect();this.unsubscribesetLeft+=e.left,this.unsubscribesetTop+=e.top},_addCorePlugins:function(){meta.register("Resource"),meta.register("UI"),meta.register(this.isWebGL?"Renderer.WebGL":"Renderer.Canvas"),meta.register("Input")},_start:function(){var t=this;this._updateLoop=function(){t.update()},this._renderLoop=function(){t.render()},this.tUpdate=Date.now(),this.tRender=this.tUpdate,this.tFPS=this.tUpdate,setTimeout(this._updateLoop),requestAnimationFrame(this._renderLoop)},fullscreen:function(t){var e=meta.device;if(e.isFulScreen!==t)if(t){if(!e.support.fullScreen)return console.warn("[meta.engine.enterFullScreen]:","Device does not support fullscreen."),void 0;document.documentElement[e.fullScreenRequest](Element.ALLOW_KEYBOARD_INPUT)}else document[meta.device.fullScreenExit]()},toggleFullscreen:function(){this.fullscreen(!meta.device.isFullScreen)},set imageSmoothing(t){meta._cache.imageSmoothing=t,this.isReady&&this.onResize()},get imageSmoothing(){return meta._cache.imageSmoothing},set cursor(t){meta.element.style.cursor=t},get cursor(){return meta.element.style.cursor},set bgColor(t){if(meta.engine.isWebGL){3===t.length&&(t+=t.substr(1,3));var e=meta.hexToRgb(t);e.r>0&&(e.r=e.r/255),e.g>0&&(e.g=e.g/255),e.b>0&&(e.b=e.b/255),this._bgTransparent?meta.ctx.clearColor(0,0,0,0):meta.ctx.clearColor(e.r,e.g,e.b,1)}else this._bgColor=t},get bgColor(){return this._bgColor},set bgTransparent(t){this._bgTransparent=t,this.bgColor=this._bgColor},get bgTransparent(){return this._bgTransparent},elementStyle:"padding:0; margin:0;",canvasStyle:"position:absolute; overflow:hidden; translateZ(0); -webkit-backface-visibility:hidden; -webkit-perspective: 1000; -webkit-touch-callout: none; -webkit-user-select: none; zoom: 1;"},Object.defineProperty(meta,"init",{set:function(t){meta._cache.init=t,meta.engine&&meta.engine.isInited&&t()},get:function(){return meta._cache.init}}),Object.defineProperty(meta,"load",{set:function(t){meta._cache.load=t,meta.engine&&meta.engine.isLoaded&&t()},get:function(){return meta._cache.load}}),Object.defineProperty(meta,"ready",{set:function(t){meta._cache.ready=t,meta.engine&&meta.engine.isReady&&t()},get:function(){return meta._cache.ready}}),meta.render=null,meta.update=null,"use strict",meta.Device=function(){this.name="unknown",this.version="0",this.versionBuffer=null,this.vendors=["","webkit","moz","ms","o"],this.support={},this.audioFormats=[],this.isMobile=!1,this.isPortrait=!1,this.isAudioAPI=!1,this.hidden=null,this.visibilityChange=null,this.fullScreenRequest=null,this.fullScreenExit=null,this.fullScreenOnChange=null,this.isFullScreen=!1},meta.Device.prototype={load:function(){this.checkBrowser(),this.isMobile=this.isMobileAgent(),this.support.onloadedmetadata="object"==typeof window.onloadedmetadata,this.support.onkeyup="object"==typeof window.onkeyup,this.support.onkeydown="object"==typeof window.onkeydown,this.support.canvas=this.isCanvasSupport(),this.support.webgl=this.isWebGLSupport(),this.modernize()},checkBrowser:function(){var t={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/OPR\/(\S+)/,/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},e=navigator.userAgent,i,s,n,o=2;for(i in t)for(;s=t[i].shift();)if(n=e.match(s)){this.version=n[1].match(new RegExp("[^.]+(?:.[^.]+){0,"+--o+"}"))[0],this.name=i,this.versionBuffer=this.version.split(".");for(var h=this.versionBuffer.length,r=0;h>r;r++)this.versionBuffer[r]=parseInt(this.versionBuffer[r]);break}(null===this.versionBuffer||"unknown"===this.name)&&console.warn("[meta.Device.checkBrowser]:","Could not detect browser.")},modernize:function(){this.supportConsole(),this.supportPageVisibility(),this.supportFullScreen(),this.supportRequestAnimFrame(),this.supportPerformanceNow(),this.supportAudioFormats(),this.supportAudioAPI()},isMobileAgent:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isCanvasSupport:function(){return!!window.CanvasRenderingContext2D},isWebGLSupport:function(){var t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return!!e},supportConsole:function(){window.console||(window.console={},window.console.log=meta.emptyFuncParam,window.console.warn=meta.emptyFuncParam,window.console.error=meta.emptyFuncParam)},supportPageVisibility:function(){void 0!==document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):void 0!==document.hidden?(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"):void 0!==document.hidden?(this.hidden="mozhidden",this.visibilityChange="mozvisibilitychange"):void 0!==document.hidden&&(this.hidden="mshidden",this.visibilityChange="msvisibilitychange")},supportFullScreen:function(){this._fullScreenRequest(),this._fullScreenExit(),this._fullScreenOnChange(),this.support.fullScreen=document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled},_fullScreenRequest:function(){var t=document.documentElement;void 0!==t.requestFullscreen?this.fullScreenRequest="requestFullscreen":void 0!==t.webkitRequestFullscreen?this.fullScreenRequest="webkitRequestFullscreen":void 0!==t.mozRequestFullScreen?this.fullScreenRequest="mozRequestFullScreen":void 0!==t.msRequestFullscreen&&(this.fullScreenRequest="msRequestFullscreen")},_fullScreenExit:function(){void 0!==document.exitFullscreen?this.fullScreenExit="exitFullscreen":void 0!==document.webkitExitFullscreen?this.fullScreenExit="webkitExitFullscreen":void 0!==document.mozCancelFullScreen?this.fullScreenExit="mozCancelFullScreen":void 0!==document.msExitFullscreen&&(this.fullScreenExit="msExitFullscreen")},_fullScreenOnChange:function(){void 0!==document.onfullscreenchange?this.fullScreenOnChange="fullscreenchange":void 0!==document.onwebkitfullscreenchange?this.fullScreenOnChange="webkitfullscreenchange":void 0!==document.onmozfullscreenchange?this.fullScreenOnChange="mozfullscreenchange":void 0!==document.onmsfullscreenchange&&(this.fullScreenOnChange="msfullscreenchange")},supportRequestAnimFrame:function(){window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)}}())},supportPerformanceNow:function(){void 0===window.performance&&(window.performance={}),void 0===window.performance.now&&(window.performance.now=Date.now)},supportAudioFormats:function(){var t=document.createElement("audio");""!=t.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/i,"")&&this.audioFormats.push("m4a"),t.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&this.audioFormats.push("ogg"),t.canPlayType("audio/mpeg;").replace(/no/,"")&&this.audioFormats.push("mp3"),t.canPlayType('audio/wav; codecs="1"').replace(/no/,"")&&this.audioFormats.push("wav")},supportAudioAPI:function(){window.AudioContext||(window.AudioContext=window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext)}},function(){meta.device=new meta.Device,meta.device.load()}(),"use strict",meta.device.isMobile&&(window.onerror=function(t,e,i){alert(e+": "+i+" "+t)}),"use strict",meta.emptyFunc=function(){},meta.emptyFuncParam=function(t){},meta.loadTexture=function(t,e,i){meta._loadResource("Texture",t,e,i)||console.warn("[meta.loadTexture]:","Unsupported parameter was passed.")},meta.preloadTexture=function(t,e,i){meta._preloadResource("Texture",t,e,i)||console.warn("[meta.preloadTexture]:","Unsupported parameter was passed.")},meta.loadSound=function(t,e){meta._loadResource("Sound",t,e)||console.warn("[meta.loadSound]:","Unsupported parameter was passed.")},meta.preloadSound=function(t,e){meta._preloadResource("Sound",t,e)||console.warn("[meta.preloadSound]:","Unsupported parameter was passed.")},meta.loadSpriteSheet=function(t,e){meta._preloadResource("SpriteSheet",t,e)||console.warn("[meta.loadSpriteSheet]:","Unsupported parameter was passed.")},meta.loadFont=function(t,e){meta._preloadResource("Font",t,e)||console.warn("[meta.loadFont]:","Unsupported parameter was passed.")},meta._loadResource=function(t,e,i){if(i){var s=i.lastIndexOf("/");0>=s&&(i+="/")}else i="";if(e instanceof Array)for(var n=e.length,o=0;n>o;o++)meta._addResource(t,e[o],i);else{if("object"!=typeof e&&"string"!=typeof e)return!1;meta._addResource(t,e,i)}return!0},meta._preloadResource=function(t,e,i){if(i){var s=i.lastIndexOf("/");s!==i.length-1&&(i+="/")}else i="";if(e instanceof Array)for(var n=e.length,o=0;n>o;o++)meta._addResource(t,e[o],i).load();else{if("object"!=typeof e&&"string"!=typeof e)return!1;meta._addResource(t,e,i).load()}return!0},meta._addResource=function(t,e,i){var s;return s="object"==typeof e?new Resource[t](e,i+e.path):new Resource[t](i+e),Resource.ctrl.add(s),s},meta.getTexture=function(t){return Resource.ctrl.getTexture(t)},meta.getSound=function(t){return Resource.ctrl.getSound(t)},meta.createCtrl=function(t,e){if(!t)return console.error("(meta.createCtrl)No controller name is defined."),null;var i=t.split(".");if(i.length>2)return console.error('(meta.createCtrl) Name should be in format "MyScope.Controller".'),null;var s=i[0],n=window[s];if(!n)return console.error("(meta.createCtrl) No such scope defined: "+s),null;if(n.ctrl)return console.error("(meta.register) Controller ("+h.name+") is already added in scope."),null;var o;if(o=1===i.length?"Controller":i[1],!n[o])return console.error("(meta.createCtrl) No Controller ("+o+") found in scope: "+s),null;e=e||meta.view;var h=new n[o](e);return n.ctrl=h,h.name=s,h.view=e,h},meta.addCtrl=function(t){if(!t)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var e=window[t.name];e.ctrl=t,meta.engine.controllers.push(t),meta.engine.isCtrlLoaded&&t.load(),meta.engine.isReady&&t.ready()},meta.removeCtrl=function(t){if(!t)return console.error("[meta.addCtrl]:","Invalid controller passed."),void 0;var e=window[t.name];return e.ctrl?e.ctrl!==t?(console.error("[meta.removeCtrl]:","Controller ("+t.name+") is not the same what is already added to the scope."),void 0):(t.unload(),t.release(),meta.engine.controllersToRemove.push(t),void 0):(console.error("[meta.removeCtrl]:","No controller added to the scope."),void 0)},meta.register=function(t,e){var i=meta.createCtrl(t,e);if(i)return meta.engine.controllers.push(i),meta.engine.isCtrlLoaded&&i.load(),meta.engine.isReady&&i.ready(),i},meta.unregister=function(t){if(!t)return console.error("[meta.unregister]:","No controller name is defined."),void 0;var e=t.split(".");if(e.length>2)return console.error("[meta.unregister]:",'Name should be in format "MyScope.Controller".'),void 0;var i=e[0],s=window[i];if(!s)return console.error("[meta.unregister]:","No such scope defined: "+i),void 0;if(s[i])return console.error("[meta.unregister]:","Controller ("+i+") is already added in scope."),void 0;var n;if(n=1===e.length?"Controller":e[1],!s[n])return console.error("[meta.unregister]:","No Controller ("+n+") found in scope: "+i),void 0;var o=s.ctrl;return o?(o.unload(),o.release(),meta.engine.controllersToRemove.push(o),void 0):(console.error("[meta.unregister]:","No Controller ("+n+") found in scope: "+i),void 0)},meta.unregisterAll=function(){for(var t,e=meta.engine.controllers,i=e.length,s=0;i>s;s++)t=window[e[s].name].ctrl,t.unload(),t.release(),window[e[s].name].ctrl=null;e.length=0},meta.onDomLoad=function(t){if(("interactive"===document.readyState||"complete"===document.readyState)&&!meta.debug)return t(),void 0;var e=function(i){t(),window.removeEventListener("DOMContentLoaded",e)};window.addEventListener("DOMContentLoaded",e)},meta.createEngine=function(){meta.onDomLoad(function(){return meta.engine?(meta.engine.release(),void 0):(meta.engine=new meta.Engine,meta.engine.create(),void 0)})},meta.enumToString=function(t,e){if(void 0===t)return"unknown";for(var i in t)if(t[i]===e)return i;return"unknown"},meta.hexToRgb=function(t){t.length<6&&(t+=t.substr(1,4));var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}},meta.isUrl=function(t){return-1!==t.indexOf("http://")||-1!==t.indexOf("https://")?!0:!1},meta.toUpperFirstChar=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},meta.loadScript=function(t,e){meta.engine&&meta.engine.isLoaded?meta._loadScript({s:t,c:callback}):(meta._cache.scripts||(meta._cache.scripts=[]),meta._cache.scripts.push({s:t,c:e}))},meta._loadScript=function(t){var e=document.createElement("script"),i=document.scripts[0];"async"in i?(e.async=!1,e.onload=t.c,e.src=t.s,document.head.appendChild(e)):i.readyState?(meta._cache.pendingScripts||(meta._cache.pendingScripts=[]),meta._cache.pendingScripts.push(e),e.onreadystatechange=meta._onReadyStateChange,e.src=t.s):document.write("<script src='"+src+"' defer></script>")},meta._onReadyStateChange=function(){for(var t,e=meta._cache.pendingScripts;e[0]&&"loaded"===e[0].s.readyState;)t=e.shift(),t.s.onreadystatechange=null,document.scripts[0].parentNode.insertBefore(t.s,firstScript),t.c&&t.c()},meta._loadAllScripts=function(){var t=meta._cache.scripts;if(!t)return!1;var e=t.length;if(0===e)return!1;var i=function(){var t=meta._cache;t.numScriptsToLoad--;var e=meta._cache.scripts,s=e.length;if(s>0){t.numScriptsToLoad+=s,t.scripts=[];for(var n,o=0;s>o;o++)n=e[o],n.c=i,meta._loadScript(n)}0===t.numScriptsToLoad&&(t.scripts=null,meta.engine._continueLoad())},s,n=meta._cache;n.numScriptsToLoad+=t.length,n.scripts=[];for(var o=0;e>o;o++)s=t[o],s.c=i,meta._loadScript(s);return!0},meta.import=function(t){if(t){var e=t.split("/"),i=e[0],s;1===e.length?(s="latest",t+="/latest"):s=e[e.length-1];var n=meta.modules[i];if(n)return n.version!==s&&console.error("[meta.loadPackage]:","There is already added module ["+n.name+"] but with different version: "+n.version),void 0;n={name:i,version:s},meta.modules[i]=n,meta.isUrl(t)||(t=meta.importUrl+t+"/module.js"),meta.loadScript(t,null)}},meta.serialize=function(t){var e=[];for(var i in t)e.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return e.join("&")},meta.addDescription=function(t){var e=new Entity.Text(t);e.color="#ffffff",e.anchor(.5);var i=new Resource.Texture;i.fillRect({width:e.width+10,height:e.height+10,color:"#000000"});var s=new Entity.Geometry(i);s.z=9999,s.anchor(.5,0),s.positionTop(0,10),s.isPickable=!1,s.ignoreZoom=!0,s.disableDebug=!0,meta.view.attach(s),s.attach(e)},meta.adaptTo=function(t,e,i){if(meta.engine&&meta.engine.isInited)return console.warn("[meta.adaptTo]:","Only usable before engine is initialized."),void 0;var s=meta._cache.resolutions;s||(s=[],meta._cache.resolutions=s);var n=i.charAt(i.length-1);"/"!==n&&(i+="/");var o={width:t,height:e,path:i,unitSize:1,zoomThreshold:1};s.push(o)},meta.removeFromArray=function(t,e){for(var i=e.length,s=0;i>s;s++)if(t===e[s]){e[s]=e[i-1],e.pop();break}},meta.shuffleArray=function(t){for(var e=t.length,i,s;e;)s=Math.floor(Math.random()*e--),i=t[e],t[e]=t[s],t[s]=i;return t},meta.rotateArray=function(t){for(var e=t[0],i=t.length-1,s=0;i>s;s++)t[s]=t[s+1];t[i]=e},meta.nextPowerOfTwo=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t},meta.pluginLoad=function(t){var e=meta.engine;e&&e.isInited?t():meta._cache.queue.push(t)},"use strict",meta.Channel=function(t){this.name=t,this.subs=[],this.numSubs=0,this._isEmiting=!1,this._subsToRemove=null},meta.Channel.prototype={remove:function(){meta.channels[this.name]=null},emit:function(t,e){this._isEmiting=!0;for(var i,s=0;s<this.numSubs;s++)i=this.subs[s],i.func.call(i.owner,t,e);if(this._isEmiting=!1,this._subsToRemove){for(var n=this._subsToRemove.length,o=0;n>o;o++)this.unsubscribe(this._subsToRemove[o]);this._subsToRemove=null}},subscribe:function(t,e,i){if(i=i||0,!e)return console.warn("(meta.Channel.subscribe) No callback function passed."),void 0;for(var s=0;s<this.numSubs;s++)if(this.subs[s].owner===t)return console.warn("(meta.Channel.subscribe) Already subscribed to channel: "+this.name),void 0;var n=new meta.Subscriber(t,e,i);this.subs.push(n),this.numSubs++,i?(this._havePriority=!0,this.subs.sort(this._sortFunc)):this._havePriority&&this.subs.sort(this._sortFunc)},unsubscribe:function(t){if(this._isEmiting)return this._subsToRemove||(this._subsToRemove=[]),this._subsToRemove.push(t),void 0;for(var e,i=0;i<this.numSubs;i++)if(e=this.subs[i],e.owner===t){this.subs[i]=this.subs[this.numSubs-1],this.subs.pop(),this.numSubs--;break}this._havePriority&&this.subs.sort(this._sortFunc)},_sortFunc:function(t,e){return t.priority>e.priority?-1:1},_havePriority:!1},meta.Subscriber=function(t,e,i){this.owner=t,this.func=e,this.priority=i},meta.createChannel=function(t){if(!t)return console.warn("(meta.createChannel) No name was specified!"),null;var e=meta.channels[t];return e||(e=new meta.Channel(t),meta.channels[t]=e),e},meta.releaseChannel=function(t){return t?(meta.channels[t]&&(meta.channels[t]=null),void 0):(console.warn("(meta.releaseChannel) No name was specified!"),void 0)},meta.subscribe=function(t,e,i,s){if("object"!=typeof t)return console.warn("(meta.subscribe) No owner passed."),void 0;if(!i)return console.warn("(meta.subscribe) No callback function passed."),void 0;if("string"!=typeof e){if("[object Array]"===Object.prototype.toString.call(e)){for(var n=e.length,o=0;n>o;o++)meta.subscribe(t,e[o],i,s);return}return console.warn("(meta.subscribe) Wrong type for channel object: "+typeof e),void 0}var h=meta.channels[e];if(h)e=h;else if(e=meta.createChannel(e),!e)return;e.subscribe(t,i,s)},meta.unsubscribe=function(t,e){if("string"!=typeof e){if("[object Array]"===Object.prototype.toString.call(e)){for(var i=e.length,s=0;i>s;s++)meta.unsubscribe(t,e[s]);return}return console.warn("(meta.unsubscribe) Wrong type for channel object."),void 0}return e=meta.channels[e],e?(e.unsubscribe(t),void 0):(console.warn("(meta.unsubscribe) No name was specified!"),void 0)},meta.emit=function(t,e,i){return"string"!=typeof t||(t=meta.channels[t],t)?(t.emit(e,i),void 0):(console.warn("(meta.emit) No name was specified!"),void 0)},"use strict",meta.View=function(t){this.name=t,this.entities=[],this.views=null,this.parentView=null,this.numEntities=0,this._x=0,this._y=0,this._z=0,this._tween=null,this._isActive=!1},meta.View.prototype={remove:function(){if("master"===this.name)return console.warn("(meta.View.remove) Master view can't be removed"),void 0;if(this.parentView&&this.parentView.detachView(this),this.views)for(var t=this.views.length,e=0;t>e;e++)this.views[e].remove();this.isActive=!1,this._unregisterFromEngine();for(var i,s=this.entities.length,n=0;s>n;n++)i=this.entities[n],i._view=null,i.remove();this.entities.length=0,this.numEntities=0},attach:function(t){return t instanceof Entity.Geometry?t.isRemoved?(console.warn("(meta.View.attach) Removed entity can not be added to the view."),void 0):t._view?(console.warn(t._view===this?"(meta.View.attach) Entity is already added to this view.":"(meta.View.attach) Entity is already added to some other view."),void 0):((0!==this._x||0!==this._y)&&t.updatePos(),this.entities.push(t),this.numEntities++,this._attachChildren(t.children),t._view=this,t._viewNodeID=this.numEntities,this._z&&(t.z=t._z),t.texture||(t.isLoaded=!0),this._isActive&&Renderer.ctrl.isLoaded&&Renderer.ctrl.addEntities(t),void 0):(console.warn("(meta.View.attach) Object should have inherited Entity.Geometry class."),void 0)
},_attachChildren:function(t){if(t)for(var e,i=t.length,s=0;i>s;s++)e=t[s],e.isRemoved||(e._view=this,this._attachChildren(e.children))},detach:function(t){if(!t.isRemoved){if(!t._view)return console.warn("(meta.View.detach) Entity does not have view."),void 0;if(t._view!==this)return console.warn("(meta.View.detach) Entity is part of other view: "+t.view.name),void 0;if(t._parent!==t._entityCtrl)return console.warn("(meta.View.detach) Entity children are not part of view."),void 0;t.isRemoved=!0,t.removeCore(),this.numEntities--;var e=this.entities[this.numEntities];e.core.viewIndex=this.numEntities,this.entities[this.numEntities]=e,this.entities.pop(),this._isActive&&Renderer.ctrl.removeEntities(t)}},attachView:function(t){if(!t)return this.parentView?(console.warn("(meta.View.attach) No view was passed."),void 0):(meta._cache.view.attachView(this),void 0);if("string"==typeof t){var e=meta._cache.views[t];if(!e)return console.warn("(meta.View.attach) No such view found: "+t),void 0;t=e}else if(!(t instanceof meta.View))return console.warn("(meta.View.attach) Trying to attach invalid view object."),void 0;return t._isActive?(console.warn("(meta.View.attach) Can't attach an active view."),void 0):t.parentView?(console.warn("(meta.View.attach) View is already part of other view."),void 0):(this.views||(this.views=[]),this.views.push(t),t.parentView=this,this._isActive&&(t.isActive=!0),void 0)},detachView:function(t){if(!t)return this.parentView?(this.parentView.detachView(this),void 0):(console.warn("(meta.View.detachView) No view was passed."),void 0);if("string"==typeof t){var e=meta._cache.views[t];if(!e)return console.warn('(meta.View.detachView) No such view found: "'+t+'"'),void 0;t=e}if(!t.parentView)return console.warn("(meta.View.detachView) View has not parents to detach from"),void 0;if(t.parentView!==this)return console.warn("(meta.View.detachView) Detaching from wrong parent"),void 0;for(var i=this.views.length,s=0;i>s;s++)if(this.views[s]===t){this.views[s]=this.views[i-1],this.views.pop();break}t.isActive=!1,t.parentView=null},detachViews:function(){if(this.views){for(var t,e=this.views.length,i=this.views.length,s=0;i>s;s++)t=this.views[s],t.isActive=!1,t.parentView=null;this.views.length=0}},register:function(t){var e=meta.createCtrl(t,this);this.controllers?this.controllers.push(e):this.controllers=[e],this._isActive&&(!this.parentView||this.parentView._isActive)&&meta.addCtrl(e)},unregister:function(t){for(var e=this.controllers.length,i=0;e>i;i++)this.controllers[i].name===t&&(this._isActive&&meta.unregister(t),this.controllers[i]=this.controllers[e-1],this.controllers.pop())},_unregisterFromEngine:function(){if(this.controllers)for(var t=this.controllers.length,e=0;t>e;e++)meta.unregister(this.controllers[e])},_makeActive:function(){var t;if(this.controllers){var e=this.controllers.length;for(t=0;e>t;t++)meta.addCtrl(this.controllers[t])}if(this._isActive&&(Renderer.ctrl.addEntities(this.entities),this.views)){var i=this.views.length;for(t=0;i>t;t++)this.views[t].isActive=!0}},_makeInactive:function(){var t;if(this.controllers){var e=this.controllers.length;for(t=0;e>t;t++)meta.removeCtrl(this.controllers[t])}if(Renderer.ctrl.removeEntities(this.entities),this.views){var i=this.views.length;for(t=0;i>t;t++)this.views[t].isActive=!1}},set isActive(t){if(this._isActive!==t)if(t){if(this.parentView&&!this.parentView._isActive)return;this._isActive=t,this._makeActive()}else this._isActive=t,this._makeInactive()},get isActive(){return this._isActive},set x(t){if(this._x!==t){this._x=t;for(var e,i=this.entities.length,s=0;i>s;s++)e=this.entities[s],e.forcePosition(e._x,e._y)}},set y(t){if(this._y!==t){this._y=t;for(var e,i=this.entities.length,s=0;i>s;s++)e=this.entities[s],e.forcePosition(e._x,e._y)}},set z(t){this._z=t;for(var e=this.entities.length,i=0;e>i;i++)this.entities[i].z=this.entities[i]._z},get x(){return this._x},get y(){return this._y},get z(){return this._z},get tween(){return this._tween||(this._tween=new meta.Tween(this)),this._tween},controllers:null},meta.createView=function(t,e){if(!t||"string"!=typeof t)return console.error("(meta.createView) Invalid name of the view"),void 0;var i=meta._cache.views[t];if(i)return console.error("(meta.createView) View with a name - "+t+", already exist"),void 0;if(i=new meta.View(t),meta._cache.views[t]=i,e)if(e instanceof Array)for(var s=e.length,n=0;s>n;n++)i.register(e[n]);else i.register(e)},meta.setView=function(t){if(!t)return console.error("(meta.setView) No view passed"),void 0;var e=meta._cache;if("string"==typeof t){var i=t;t=e.views[i],t||(console.warn("(meta.setView) Creating empty view, could be unintended - "+i),t=new meta.View(i),e.views[i]=t)}t.isActive||(e.view.detachViews(),e.view.attachView(t))},meta.getView=function(t){if(!t)return console.error("(meta.getView) No name specified"),null;var e=meta._cache.views[t];return e||(e=new meta.View(t),meta._cache.views[t]=e),e},meta.attachView=function(t){if(!meta._cache.view)return console.warn("(meta.attachView) No current active view"),void 0;if("string"==typeof t){var e=meta._cache.views[t];if(!e)return console.warn("(meta.attachView) No such view found: "+t),void 0;t=e}meta._cache.view.attachView(t)},meta.detachView=function(t){if(!meta._cache.view)return console.warn("(meta.detachView) No current active view."),void 0;if("string"==typeof t){var e=meta._cache.views[t];if(!t)return console.warn("(meta.detachView) No such view found: "+t),void 0;t=e}meta._cache.view.detachView(t)},Object.defineProperty(meta,"view",{get:function(){return meta._cache.view}}),"use strict",meta.Camera=function(){this._x=0,this._y=0,this.volume=new meta.math.AdvAABB(0,0,0,0),this.zoomBounds=null,this._zoom=1,this.prevZoom=1,this.zoomRatio=1,this._draggable=!1,this._isDraggable=!1,this._isAutoZoom=!1,this._enableBorderIgnore=!0,this._enableCentering=!1,this._enableCenteringX=!0,this._enableCenteringY=!0,this._chnMove=null,this._chnResize=null,this._wasMoved=!1,this.init()},meta.Camera.prototype={init:function(){this._chnMove=meta.createChannel(meta.Event.CAMERA_MOVE),this._chnResize=meta.createChannel(meta.Event.CAMERA_RESIZE),meta.subscribe(this,meta.Event.RESIZE,this._onResize),meta.subscribe(this,meta.Event.WORLD_RESIZE,this._onWorldResize),this.zoomBounds={width:-1,height:-1,minWidth:-1,minHeight:-1,maxWidth:-1,maxHeight:-1}},release:function(){this._chnMove.release(),meta.unsubscribe(this,meta.Event.RESIZE),meta.unsubscribe(this,meta.Event.WORLD_RESIZE)},updateView:function(){if(this._isAutoZoom?this.updateAutoZoom():this.updateZoom(),!this._wasMoved){if(this._enableCentering){var t=meta.world;this._x=this._enableCenteringX?Math.floor((this.volume.width-t.width)/2):0,this._y=this._enableCenteringY?Math.floor((this.volume.height-t.height)/2):0}else this._x=0,this._y=0;this.volume.move(this._x,this._y)}this._chnMove.emit(this,meta.Event.CAMERA_MOVE)},updateZoom:function(){this.prevZoom!==this._zoom&&(this.zoomRatio=1/this._zoom,this.volume.scale(this.zoomRatio,this.zoomRatio),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE))},updateAutoZoom:function(){var t=meta,e=this.zoomBounds.width,i=this.zoomBounds.height,s=t.width/e,n=t.height/i;this.prevZoom=this._zoom,this._zoom=s,s>n&&(this._zoom=n),t.engine.adapt()&&(e=this.zoomBounds.width,i=this.zoomBounds.height,s=t.width/e,n=t.height/i,this._zoom=s,s>n&&(this._zoom=n),this.volume.resize(t.width,t.height)),this.updateZoom()},bounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.width=t,this.zoomBounds.height=e,(0!==this.width||0!==this.height)&&this.updateView()},minBounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.minWidth=t,this.zoomBounds.minHeight=e,this.updateView()},maxBounds:function(t,e){this._isAutoZoom=!0,this.zoomBounds.maxWidth=t,this.zoomBounds.maxHeight=e,this.updateView()},_onInput:function(t,e){var i=Input.Event;if(e===i.INPUT_MOVE)this._drag(t);else if(e===i.INPUT_DOWN){if(0!==t.keyCode)return;this._startDrag(t)}else if(e===i.INPUT_UP){if(0!==t.keyCode)return;this._endDrag(t)}},_onResize:function(t,e){this.volume.resize(t.width,t.height),this.updateView(),this._chnResize.emit(this,meta.Event.CAMERA_RESIZE)},_onWorldResize:function(t,e){},_startDrag:function(t){this._draggable&&(this._isDraggable=!0)},_endDrag:function(t){this._isDraggable=!1},_drag:function(t){if(this._isDraggable){var e=meta,i=(t.screenX-t.prevScreenX)*this.zoomRatio,s=(t.screenY-t.prevScreenY)*this.zoomRatio;this._x+=i,this._y+=s,this.volume.move(-i,-s),this._wasMoved=!0,this.enableBorderIgnore||(-this._x<0&&(this._x=0),-this._y<0&&(this._y=0)),this._chnMove.emit(this,e.Event.CAMERA_MOVE)}},set x(t){this._x!==t&&(this._x=t,this._wasMoved=!0,this.updateView())},set y(t){this._y!==t&&(this._y=t,this._wasMoved=!0,this.updateView())},get x(){return this._x},get y(){return this._y},get width(){return this.volume.width},get height(){return this.volume.height},set zoom(t){this._zoom!==t&&(this.prevZoom=this._zoom,this._zoom=t,this.updateView())},get zoom(){return this._zoom},set enableBorderIgnore(t){this._enableBorderIgnore=t,this.updateView()},get enableBorderIgnore(){return this._enableBorderIgnore},set draggable(t){this._draggable!==t&&(this._draggable=t,t?meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE],this._onInput):(meta.unsubscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP,Input.Event.INPUT_MOVE]),this._isDraggable=!1))},get draggable(){return this._draggable},set isAutoZoom(t){this._isAutoZoom!==t&&(this._isAutoZoom=t,this.updateView())},get isAutoZoom(){return this._isAutoZoom},set enableCentering(t){this._enableCentering=t,this.updateView()},set enableCenteringX(t){this._enableCenteringX=t,this.updateView()},set enableCenteringY(t){this._enableCenteringY=t,this.updateView()},get enableCentering(){return this._enableCentering},get enableCenteringX(){return this._enableCenteringX},get enableCenteringY(){return this._enableCenteringY}},"use strict",meta.World=function(t,e){this.chn=null,this.volume=new meta.math.AdvAABB(0,0,0,0),this.minWidth=-1,this.minHeight=-1,this.maxHeight=-1,this.maxHeight=-1,this.centerX=0,this.centerY=0,this.gridX=0,this.gridY=0,this.gridWidth=0,this.gridHeight=0,this.numGridX=0,this.numGridY=0,this.haveGrid=!1,this._discardUnusedSpace=!1,this.lockGrid=!1,this.showBounds=!1,this.init(t,e)},meta.World.prototype={init:function(t,e){this.bounds(t,e),this.chn=meta.createChannel(meta.Event.WORLD_RESIZE),meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onCameraResize)},updateVolume:function(){var t=meta,e=t.camera.width+.5|0,i=t.camera.height+.5|0;this.centerX=e/2,this.centerY=i/2,this.volume.resize(e,i),this.chn&&this.chn.emit(t.Event.WORLD_RESIZE,this)},bounds:function(t,e){this.volume.resize(t,e),this.updateVolume()},minBounds:function(t,e){this.minWidth=t,this.minHeight=e,this.updateVolume()},maxBounds:function(t,e){this.maxWidth=t,this.maxHeight=e,this.updateVolume()},setGrid:function(t){t.x=t.x||0,t.y=t.y||0,t.width=t.width||16,t.height=t.height||16,t.sizeX=t.sizeX||1,t.sizeY=t.sizeY||1,this.setGridPosition(t.x,t.y),this.setGridResolution(t.width,t.height),this.setGridSize(t.sizeX,t.sizeY)},setGridResolution:function(t,e){this.gridWidth=t,this.gridHeight=e,this.haveGrid=t||e,this.lockGrid||(this.numGridX=Math.floor(this.width/t),this.numGridY=Math.floor(this.height/e)),this.haveGrid&&this._discardUnusedSpace&&this.setBounds(this.numGridX*this.gridWidth,this.numGridY*this.gridHeight)},setGridSize:function(t,e){if(this.numGridX=t,this.numGridY=e,this.lockGrid=t||e,this.haveGrid){var i=this.numGridX*this.gridWidth,s=this.numGridY*this.gridHeight;this.width>i&&(i=this.width),this.height>s&&(s=this.height),this.setBounds(i,s),this.lockGrid||(this.numGridX=Math.floor(this.width/this.gridWidth),this.numGridY=Math.floor(this.height/this.gridHeight))}},setGridPosition:function(t,e){this.gridX=t,this.gridY=e},getGridPosX:function(t){return this.gridX+this.gridWidth*t},getGridPosY:function(t){return this.gridY+this.gridHeight*t},getGridFromWorldX:function(t){var e=Math.floor((t-this.gridX)/this.gridWidth);return-1>e?e=-1:e>=this.numGridX&&(e=-1),e},getGridFromWorldY:function(t){var e=Math.floor((t-this.gridY)/this.gridHeight);return-1>e?e=-1:e>=this.numGridY&&(e=-1),e},get randX(){return meta.random.number(0,this.volume.width)},get randY(){return meta.random.number(0,this.volume.height)},onCameraResize:function(t,e){this.updateVolume()},set discardUnusedSpace(t){this._discardUnusedSpace=t,t&&this.haveGrid&&this.setBounds(this.gridX+this.numGridX*this.gridWidth,this.gridY+this.numGridY*this.gridHeight)},get discardUnusedSpace(){return this._discardUnusedSpace},get left(){return this.volume.minX},get right(){return this.volume.maxX},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},get width(){return this.volume.width},get height(){return this.volume.height}},"use strict",function(t){var e=!1,i=/\b_super\b/;t.meta.Class=function(){},t.meta.Class.extend=function(t){function s(t,i,s,n,o,h){e||(this._init&&this._init(t,i,s,n,o,h),this.init&&this.init(t,i,s,n,o,h))}var n=this.prototype;e=!0;var o=new this;e=!1;for(var h in t){var r=Object.getOwnPropertyDescriptor(t,h);r.get||r.set?Object.defineProperty(o,h,r):o[h]="function"==typeof t[h]&&"function"==typeof n[h]&&i.test(t[h])?function(t,e){return function(i,s,o,h,r,a){var u=this._super;this._super=n[t],this._fn=e;var c=this._fn(i,s,o,h,r,a);return this._super=u,c}}(h,t[h]):t[h]}return s.prototype=o,s.prototype.constructor=o.init,s.extend=this.extend,s},t.meta.Class=t.meta.Class}(void 0!==typeof window?window:global),"use strict",meta.Controller=meta.Class.extend({init:meta.emptyFunc,_init:function(t){this.view=t},release:meta.emptyFunc,load:meta.emptyFunc,unload:meta.emptyFunc,ready:meta.emptyFunc,update:meta.emptyFuncParam,view:null,name:"unknown",isLoaded:!1}),"use strict",meta._cache.timerIndex=0,meta.Timer=function(t,e,i,s){this.owner=t,this.id=meta._cache.timerIndex++,this.func=e,this.onRemove=null,this.tDelta=i,this.numTimes=s,void 0===this.numTimes&&(this.numTimes=-1),this.tAccumulator=0,this.tStart=Date.now()},meta.Timer.prototype={remove:function(){this.numTimes=0},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1,this.tStart=Date.now()},onRemove:null,isPaused:!1},meta.addTimer=function(t,e,i,s){"function"==typeof t&&(s=i,i=e,e=t,t=window);var n=new meta.Timer(t,e,i,s);return meta.engine._timers.push(n),meta.engine._numTimers++,n},"use strict",meta.shaders={},meta.Shader=function(){this.program=null,this.attrib={},this.uniform={},this._vertexShader=null,this._fragmentShader=null},meta.Shader.prototype={compile:function(){var t=meta.ctx;return this.program=t.createProgram(),t.attachShader(this.program,this._vertexShader),t.attachShader(this.program,this._fragmentShader),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?!0:(console.error("[meta.Shader.compile]:","Unable to initialize the shader program."),!1)},use:function(){meta.ctx.useProgram(this.program)},bindAttrib:function(t){if(!t)return console.error("[meta.Shader.bindAttrib]:","No name specified!"),void 0;var e=meta.ctx;this.attrib[t]=e.getAttribLocation(this.program,t),e.enableVertexAttribArray(this.attrib[t])},bindBuffer2f:function(t,e){var i=meta.ctx;i.bindBuffer(i.ARRAY_BUFFER,e),i.vertexAttribPointer(this.attrib[t],2,i.FLOAT,!1,0,0)},bindBuffer3f:function(t,e){var i=meta.ctx;i.bindBuffer(i.ARRAY_BUFFER,e),i.vertexAttribPointer(this.attrib[t],3,i.FLOAT,!1,0,0)},uniformMatrix:function(t,e){var i=meta.ctx,s=this.uniform[t];s||(s=i.getUniformLocation(this.program,t),this.uniform[t]=s),i.uniformMatrix4fv(s,!1,e.m)},set vertexShader(t){var e=meta.ctx;this._vertexShader=e.createShader(e.VERTEX_SHADER),e.shaderSource(this._vertexShader,t),e.compileShader(this._vertexShader),e.getShaderParameter(this._vertexShader,e.COMPILE_STATUS)||console.error("[meta.Shader.vetexShader]:",e.getShaderInfoLog(this._vertexShader))},get vertexShader(){return this._vertexShader},set fragmentShader(t){var e=meta.ctx;this._fragmentShader=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(this._fragmentShader,t),e.compileShader(this._fragmentShader),e.getShaderParameter(this._fragmentShader,e.COMPILE_STATUS)||console.error("[meta.Shader.fragmentShader]:","An error occurred compiling the shaders: "+e.getShaderInfoLog(this._fragmentShader))},get fragmentShader(){return this._fragmentShader}},meta.setShader=function(t){if(!t)return console.error("[meta.setShader]:","No name specified."),null;var e=meta.shaders[t];return e?(meta.shader=e,e.use(),e):(console.error("[meta.setShader]:","No shader found with a name: "+t),null)},meta.getShader=function(t){if(!t)return console.error("[meta.getShader]:","No name specified."),null;var e=meta.shaders[t];return e?e:(console.error("[meta.getShader]:","No shader found with a name: "+t),null)},"use strict",meta.Style=function(t){this.states={},this.setStates(t),this.defaultState||this.setState("*",null)},meta.Style.prototype={setState:function(t,e){if(-1!==t.indexOf(","))for(var i=t.split(/[ ,]+/),s=i.length,n=0;s>n;n++)this.defineState(i[n],e);else this.defineState(t,e)},defineState:function(t,e){var i,s,n,o,h;if("string"==typeof e&&(e={texture:e}),"["===t.charAt(0))return t=t.substr(1,t.length-2),this.childStyle||(this.childStyle=new meta.Style),this.childStyle.setState(t,e),void 0;var r=t.indexOf(":");if(-1!==r){var a=t.substr(r+1,t.length-r-1);t=t.substr(0,r),t||(t="*"),i=this.states[t],i?i.actions||(i.actions={}):(i=new meta.StyleState(t),i.actions={},this.states[t]=i);var u;if("*"===t){this.defaultState=i;for(n in this.states)if(h=this.states[n],h.actions&&(u=h.actions[a],u)){s=u.params;for(o in e)s[o]||(s[o]=e[o])}}else if(this.defaultState&&this.defaultState.actions&&(u=this.defaultState.actions[a],u)){s=u.params;for(o in s)e[o]||(e[o]=s[o])}i.actions[a]=new meta.StyleState(a,e),this.haveActions=!0}else if(t||(t="*"),i=this.states[t],i){s=i.params;for(o in s)s[o]||(s[o]=e[o]);i._updateTexture()}else{if(this.defaultState){s=this.defaultState.params;for(o in s)e[o]||(e[o]=s[o])}if(i=new meta.StyleState(t,e),"*"===t){this.defaultState=i;for(n in this.states){s=this.states[n].params;for(o in e)s[o]||(s[o]=e[o])}}this.states[t]=i}return this},setStates:function(t){for(var e in t)this.setState(e,t[e])},setHiddenState:function(t,e,i){var s=this.setState(t,e,i);return s&&(s.isHidden=!0),s},removeState:function(t){return this.states[t]?(delete this.states[t],void 0):(console.warn("[meta.Brush.removeState]:","No such state: "+t),void 0)},update:function(t){if(t.isNeedStyle=!1,this.states){var e=this.states[t._state];if(!e){if(!this.defaultState)return console.warn("[meta.Style.update]:","Could not get state from the style: "+t._state),void 0;e=this.defaultState}if(e!==t._styleState){var i,s=t._styleParams;for(i in s)t[i]=s[i];s={},t._styleParams=s;var n=e.params;for(i in n)s[i]=t[i],t[i]=n[i];t._styleState=e,t._inputFlags&&this.updateAction(t)}}},updateAction:function(t){var e=t._styleActionParams;for(var i in e)t[i]=e[i];e={},t._styleActionParams=e;var s,n=this.states[t._state];if(!n){if(!this.defaultState)return;n=this.defaultState}if(n.actions)s=n.actions[t._action];else{if(!this.defaultState.actions)return;s=this.defaultState.actions[t._action]}if(s){var o=s.params;for(var i in o)e[i]=t[i],t[i]=o[i]}},getRandomState:function(){if(!this.states)return null;var t=null,e=0;for(var i in this.states)this.states[i].isHidden||Math.random()<1/++e&&(t=i);return t},states:null,defaultState:null,haveActions:!1,childStyle:null},meta.StyleState=function(t,e){this.name=t,this.params=e,this.isHidden=!1,this._updateTexture()},meta.StyleState.prototype={_updateTexture:function(){if(this.params&&void 0!==this.params.texture){var t=this.params.texture;if("string"!=typeof t)return;var e=meta.getTexture(t);if(!e)return console.warn("[meta.StyleState]:","Could not get texture from texture name: "+t),void 0;this.params.texture=e}}},meta.createStyle=function(t,e){if(!t)return e?e:null;e=e||null;var i=Object.create(e);if("string"==typeof t||t instanceof Resource.Texture)i["*"]?i["*"].texture=t:i["*"]={texture:t};else if("object"==typeof t){var s,n,o,n,h,r,a,u,c,l,d;for(n in t)if(s=t[n],"string"==typeof s&&(s={texture:s}),-1!==n.indexOf(","))for(l=n.split(/[ ,]+/),d=l.length,h=0;d>h;h++){if(c=l[h],a=i[c],a){u={};for(r in a)u[r]=a[r];a=u}else a={};for(r in s)a[r]=s[r];i[c]=a}else{if(a=i[n],a){u={};for(r in a)u[r]=a[r];a=u}else a={};for(r in s)a[r]=s[r];i[n]=a}}return i},"use strict",meta.Event={RESIZE:"resize",WORLD_RESIZE:"world-resize",CAMERA_MOVE:"camera-move",CAMERA_RESIZE:"camera-resize",FOCUS:"focus",FULLSCREEN:"fullscreen",ADAPT:"adapt"},meta.Priority={LOW:0,MEDIUM:5e3,HIGH:1e4},meta.Cursor={ALIAS:"alias",ALL_SCROLL:"all-scroll",CELL:"cell",CONTEXT_MENU:"context-menu",COL_RESIZE:"col-resize",COPY:"copy",CROSSHAIR:"crosshair",DEFAULT:"default",E_RESIZE:"e-resize",EW_RESIZE:"ew-resize",GRAB:"grab",GRABBING:"grabbing",HELP:"help",MOVE:"move",N_RESIZE:"n-resize",NE_RESIZE:"ne-resize",NESW_RESIZE:"nesw-resize",NS_RESIZE:"ns-reisize",NW_RESIZE:"nw-resize",NWSE_RESIZE:"nwse-resize",NO_DROP:"no-drop",NONE:"none",NOT_ALLOWED:"not-allowed",POINTER:"pointer",PROGRESS:"progress",ROW_RESIZE:"row-resize",S_RESIZE:"s-resize",SE_RESIZE:"se-resize",SW_RESIZE:"sw-resize",TEXT:"text",VERTICAL_TEXT:"vertical-text",W_RESIZE:"w-resize",WAIT:"wait",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",INITIAL:"initial"},"use strict",meta.getTexture=function(t){return Resource.ctrl.getTexture(t)},"use strict",meta.ajax=function(params){params.responseType="html"===params.dataType?"document":"script"===params.dataType||"json"===params.dataType?"text":void 0===params.dataType?"GET":params.dataType,void 0===params.type&&(params.type="GET");var data=meta.serialize(params.data),xhr=new XMLHttpRequest;return xhr.open(params.type,params.url,!0),xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xhr.onload=function(){4===xhr.readyState&&200===xhr.status?void 0!==params.success&&params.success("document"===params.responseType?xhr.responseXML:"script"===params.dataType?eval(xhr.responseText):"json"===params.dataType?JSON.parse(xhr.responseText):xhr.responseText):void 0!==params.error&&params.error()},xhr.send(data),xhr},"use strict",meta.utils.LinkedList=function(){this.length=0,this.first=new meta.utils.LinkedListNode(null),this.last=new meta.utils.LinkedListNode(null),this.first.next=this.last,this.last.prev=this.first},meta.utils.LinkedList.prototype={push:function(t){this.last.prev.next=t,this.last.prev=t,t.prev=this.last.prev,t.next=this.last,this.length++},remove:function(t){t.prev.next=t.next,t.next.prev=t.prev,t.prev=null,t.next=null,this.length--}},meta.utils.LinkedListNode=function(t){this.data=t,this.prev=null,this.next=null},"use strict",meta.math={},meta.math={degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},radiansToPoint:function(t,e,i,s){var n=i-t,o=s-e;return Math.atan(n/o)},clamp:function(t,e,i){return e>t?e:t>i?i:t},map:function(t,e,i,s,n){return t==e?s:(t-e)*(n-s)/(i-e)+s},length:function(t,e,i,s){var n=i-t,o=s-e;return Math.sqrt(n*n+o*o)},length2:function(t,e){return Math.sqrt(t*t+e*e)},limit:function(t,e){return t>e?e:-e>t?-e:t},lerp:function(t,e,i){return t+(e-t)*i},lookAt:function(t,e,i,s){return Math.atan2(i-t,e-s)},lookAtEntity:function(t,e){return meta.math.lookAt(t.x,t.y,e.x,e.y)}},"use strict",meta.math.Vector2=function(t,e){this.x=t,this.y=e},meta.math.Vector2.prototype={reset:function(){this.x=0,this.y=0},set:function(t,e){this.x=t,this.y=e},add:function(t){this.x+=t,this.y+=t},sub:function(t){this.x-=t,this.y-=t},mul:function(t){this.x*=t,this.y*=t},div:function(t){this.x/=t,this.y/=t},addVec2:function(t){this.x+=t.x,this.y+=t.y},subVec2:function(t){this.x-=t.x,this.y-=t.y},mulVec2:function(t){this.x*=t.x,this.y*=t.y},divVec2:function(t){this.x/=t.x,this.y/=t.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);t>0?(this.x/=t,this.y/=t):(this.x=0,this.y=0)},dot:function(t,e){return this.x*t+this.y*e},truncate:function(t){var e=Math.sqrt(this.x*this.x+this.y*this.y);e>t&&(this.x*=t/e,this.y*=t/e)},limit:function(t){this.x>t?this.x=t:this.x<-t&&(this.x=-t),this.y>t?this.y=t:this.y<-t&&(this.y=-t)},lengthSq:function(){return this.x*this.x+this.y*this.y},heading:function(){var t=Math.atan2(-this.y,this.x);return-t+.5*Math.PI},perp:function(){var t=this.x;this.x=-this.y,this.y=t},print:function(t){console.log(t?'[vec "'+t+'"] x: '+this.x+" y: "+this.y:"[vec] x: "+this.x+" y: "+this.y)}},"use strict",meta.math.AABB=function(t,e,i,s){this.minX=t,this.minY=e,this.maxX=i,this.maxY=s},meta.math.AABB.prototype={move:function(t,e){this.minX+=t,this.minY+=e,this.maxX+=t,this.maxY+=e},set:function(t,e){var i=this.maxX-this.minX,s=this.maxY-this.minY;this.minX=t,this.minY=e,this.maxX=t+i,this.maxY=e+s},resize:function(t,e){this.maxX=this.minX+t,this.maxY=this.minY+e},copy:function(t){this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY},vsAABB:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?!1:!0},vsBorderAABB:function(t){return this.minX>=t.maxX||this.maxX<=t.minX||this.minY>=t.maxY||this.maxY<=t.minY?!1:!0},vsAABBIntersection:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?0:this.minX>t.minX||this.minY>t.minY?1:this.maxX<t.maxX||this.maxY<t.maxY?1:2},vsPoint:function(t,e){return this.minX>t||this.maxX<t?!1:this.minY>e||this.maxY<e?!1:!0},vsBorderPoint:function(t,e){return this.minX>=t||this.maxX<=t?!1:this.minY>=e||this.maxY<=e?!1:!0},getSqrDistance:function(t,e){var i,s=0;return t<this.minX&&(i=this.minX-t,s+=i*i),t>this.maxX&&(i=t-this.maxX,s+=i*i),e<this.minY&&(i=this.minY-e,s+=i*i),e>this.maxY&&(i=e-this.maxY,s+=i*i),s},getDistanceVsAABB:function(t){var e=this.minX+(this.maxX-this.minX)/2,i=this.minY+(this.maxY-this.minY)/2,s=t.minX+(t.maxY-t.minY)/2,n=t.minY+(t.maxY-t.minY)/2,o=s-e,h=n-i;return Math.sqrt(o*o+h*h)},get width(){return this.maxX-this.minX},get height(){return this.maxY-this.minY},isUndefined:function(){return void 0===this.maxY},draw:function(t){var e=meta.unitSize,i,s,n,o;1===e?(i=Math.floor(this.minX),s=Math.floor(this.minY),n=Math.ceil(this.maxX),o=Math.ceil(this.maxY)):(i=Math.floor(this.minX)*e-this.halfWidth*e,s=Math.floor(this.minY)*e-this.halfHeight*e,n=Math.ceil(this.maxX)*e-this.halfWidth*e,o=Math.ceil(this.maxY)*e-this.halfHeight*e),t.beginPath(),t.moveTo(i,s),t.lineTo(n,s),t.lineTo(n,o),t.lineTo(i,o),t.lineTo(i,s),t.stroke()},drawTranslated:function(t,e){var i,s;e?(i=e.x,s=e.y):(i=0,s=0),this.translate(i,s),this.draw(t),this.translate(-i,-s)},print:function(t){console.log(t?"(AABB) "+t+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.AdvAABB=function(t,e,i,s){this.minX=t,this.minY=e,this.maxX=i,this.maxY=s,this.initWidth=i-t,this.initHeight=s-e,this.initHalfWidth=.5*this.initWidth,this.initHalfHeight=.5*this.initHeight,this.width=this.initWidth,this.height=this.initHeight,this.halfWidth=this.initHalfWidth,this.halfHeight=this.initHalfHeight,this.x=t+this.halfWidth|0,this.y=e+this.halfHeight|0,this.scaleX=1,this.scaleY=1},meta.math.AdvAABB.prototype={move:function(t,e){this.x+=t,this.y+=e,this.minX+=t,this.minY+=e,this.maxX+=t,this.maxY+=e},set:function(t,e){this.x=t,this.y=e,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.x+this.halfWidth,this.maxY=this.y+this.halfHeight},resize:function(t,e){this.initWidth=t,this.initHeight=e,this.initHalfWidth=.5*t,this.initHalfHeight=.5*e,this.width=t*this.scaleX,this.height=e*this.scaleY,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},scale:function(t,e){this.scaleX=t,this.scaleY=e,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},scalePivoted:function(t,e,i,s){this.scaleX=t,this.scaleY=e,this.width=this.initWidth*this.scaleX,this.height=this.initHeight*this.scaleY,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.x=i,this.y=s,this.minX=this.x-this.halfWidth,this.minY=this.y-this.halfHeight,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},vsAABB:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?!1:!0},vsBorderAABB:function(t){return this.minX>=t.maxX||this.maxX<=t.minX||this.minY>=t.maxY||this.maxY<=t.minY?!1:!0},vsAABBIntersection:function(t){return this.minX>t.maxX||this.maxX<t.minX||this.minY>t.maxY||this.maxY<t.minY?0:this.minX>t.minX||this.minY>t.minY?1:this.maxX<t.maxX||this.maxY<t.maxY?1:2},vsPoint:function(t,e){return this.minX>t||this.maxX<t?!1:this.minY>e||this.maxY<e?!1:!0},vsBorderPoint:function(t,e){return this.minX>=t||this.maxX<=t?!1:this.minY>=e||this.maxY<=e?!1:!0},getSqrDistance:function(t,e){var i,s=0;return t<this.minX&&(i=this.minX-t,s+=i*i),t>this.maxX&&(i=t-this.maxX,s+=i*i),e<this.minY&&(i=this.minY-e,s+=i*i),e>this.maxY&&(i=e-this.maxY,s+=i*i),s},getDistanceVsAABB:function(t){var e=this.minX+.5*(this.maxX-this.minX),i=this.minY+.5*(this.maxY-this.minY),s=t.minX+.5*(t.maxY-t.minY),n=t.minY+.5*(t.maxY-t.minY),o=s-e,h=n-i;return Math.sqrt(o*o+h*h)},isUndefined:function(){return void 0===this.maxY},draw:function(t){var e=meta.unitSize,i,s,n,o;i=0|this.minX,s=0|this.minY,n=this.maxX+.5|0,o=this.maxY+.5|0,t.beginPath(),t.moveTo(i,s),t.lineTo(n,s),t.lineTo(n,o),t.lineTo(i,o),t.lineTo(i,s),t.stroke()},drawTranslated:function(t){var e=meta.camera;this.translate(e._x,e._y),this.draw(t),this.translate(-e._x,-e._y)},print:function(t){console.log(t?"(AABB) "+t+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY:"(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}},"use strict",meta.math.Matrix4=function(){this.m=new Float32Array(16),this.m[0]=1,this.m[5]=1,this.m[10]=1,this.m[15]=1},meta.math.Matrix4.prototype={reset:function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},scale:function(t,e,i){this.m[0]=t,this.m[5]=e,this.m[10]=i},ortho:function(t,e,i,s,n,o){this.m[0]=2/(e-t),this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=2/(s-i),this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=-2/(o-n),this.m[11]=0,this.m[12]=-(e+t)/(e-t),this.m[13]=-(s+i)/(s-i),this.m[14]=-(o+n)/(o-n),this.m[15]=1}},"use strict",meta.math.Random=function(){this.seed=0,this.a=0,this.m=0,this.q=0,this.r=0,this.oneOverM=0,this.init()},meta.math.Random.prototype={init:function(){this.setSeed(3456789012,!0)},generate:function(){var t=Math.floor(this.seed/this.q),e=this.seed%this.q,i=this.a*e-this.r*t;return this.seed=i>0?i:i+this.m,this.seed*this.oneOverM},number:function(t,e){var i=this.generate();return Math.round((e-t)*i+t)},numberF:function(t,e){var i=this.generate();return(e-t)*i+t},setSeed:function(t,e){if(void 0!==e&&(e=!0),e===!0){var i=new Date;this.seed=t+16777215*i.getSeconds()+65535*i.getMinutes()}else this.seed=t;this.a=48271,this.m=2147483647,this.q=Math.floor(this.m/this.a),this.r=this.m%this.a,this.oneOverM=1/this.m}},meta.random=new meta.math.Random,"use strict",meta.Tween=function(){this.cache=null,this.chain=[]},meta.Tween.prototype={play:function(){if(this.cache){var t=this.cache;if(!t.owner)return this;if(t.owner.isRemoved)return this;t.isPaused=!1,t.numRepeat=this.numRepeat,this.next(),this._play(),this.cache=null}else this.autoPlay=!0;return this},_play:function(){Renderer.ctrl._addToUpdating(this.cache)&&this._group&&this._group.activeUsers++},stop:function(t){return this.linkIndex=0,this._stop(t),this.cache&&(this.autoPlay=!1,this.cache=null),this
},_stop:function(t){Renderer.ctrl._removeFromUpdating(this.cache)&&(t&&t(this.cache.owner),this.cache.currLink._onDone&&this.cache.currLink._onDone.call(this.cache.owner),this._group&&(this._group.activeUsers--,0===this._group.activeUsers&&this._group.callback&&this._group.callback()))},paused:function(t){return void 0===t&&(t=!0),this.cache.isPaused=t,this},resume:function(){return this.cache.isPaused=!1,this},clear:function(){return this.stop(),this._tStart=0,this.chain.length=0,this.linkIndex=0,this.currLink=null,this._group&&(this._group.users--,this._group=null),this},reset:function(){var t=this.cache;if(t.linkIndex=0,t.currLink=this.chain[0],!t.currLink)return this;for(var e in t.currLink.startValues)t.owner[e]=t.currLink.startValues[e];return this.stop(!1),this},next:function(){var t=!1,e=this.cache;if(e.linkIndex===this.chain.length){if(0===e.numRepeat)return this.stop(),this;if(e.linkIndex=0,-1!==e.numRepeat&&(e.numRepeat--,0===e.numRepeat))return this.stop(),this;t=!0}e._isLinkDone=!1;var i,s=this.chain[e.linkIndex++],n=e.owner;if(t)for(i in s.startValues)n[i]=s.startValues[i];else for(i in s.endValues)s.startValues[i]=n[i];return s._onStart&&s._onStart.call(this),e._tStart=meta.engine.tNow,e.currLink=s,this},repeat:function(t){return void 0===t&&(t=-1),this.numRepeat=t,this},set reverse(t){return void 0===t&&(t=!0),this.cache.isReverse=t,this},get reverse(){return this.cache.isReverse},update:function(t){var e=this.cache;if(!e.currLink)return this.stop(!1),void 0;var i=meta.engine.tNow,s=i-e._tFrame;if(!(s<e.currLink.tFrameDelay)){var n=(i-e._tStart)/e.currLink.duration;if(n>1&&(n=1),e._isLinkDone){if(s<e.currLink.tDelay)return}else e._tFrame=i,e.currLink.update(n),e.currLink._onTick&&e.currLink._onTick.call(this);if(1===n){if(!e._isLinkDone&&e.currLink.tDelay>0)return e._isLinkDone=!0,void 0;this.next()}}},to:function(t,e,i){var s=new meta.Tween.Link(this,t,e,i);return this.chain.push(s),s},wait:function(t){var e=this.to(null,0,null);return e.wait(t),e},group:function(t){return t?this._group?(console.warn("[meta.Tween.group]:","Tween already is part of a group."),this):("object"==typeof t&&(this._group=t),this._group.users++,this):(console.warn("[meta.Tween.group]:","No group name specified."),this)},autoPlay:!1,_group:null,_isReversing:!1,_removeFlag:0,numRepeat:0},meta.Tween.Cache=function(t){this.owner=t,this.tween=null,this.linkIndex=0,this.currLink=null,this.numRepeat=0,this._updateNodeID=-1,this._isLinkDone=!1,this._tStart=0,this._tFrame=0},meta.Tween.Cache.prototype={update:function(t){this.tween.cache=this,this.tween.update(t),this.tween.cache=null},isPaused:!1,isRemoved:!1,reverse:!1,_flags:0},meta.Tween.Group=function(t,e){"function"==typeof t&&(e=t,t=""),this.name=t,this.users=0,this.activeUsers=0,this.callback=e||null},"use strict",meta.Tween.Easing={linear:function(t){return t},quadIn:function(t){return t*t},quadOut:function(t){return t*(2-t)},quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:function(t){return t*t*t},cubicOut:function(t){return--t*t*t+1},cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quartIn:function(t){return t*t*t*t},quartOut:function(t){return 1- --t*t*t*t},quartInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quintIn:function(t){return t*t*t*t*t},quintOut:function(t){return--t*t*t*t*t+1},quintIntOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sineIn:function(t){return 1-Math.cos(t*Math.PI/2)},sineOut:function(t){return Math.sin(t*Math.PI/2)},sineIntOut:function(t){return.5*(1-Math.cos(Math.PI*t))},expoIn:function(t){return 0===t?0:Math.pow(1024,t-1)},expoOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},expoInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)},circIn:function(t){return 1-Math.sqrt(1-t*t)},circOut:function(t){return Math.sqrt(1- --t*t)},circInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s)))},elasticOut:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/s)+1)},elasticInOut:function(t){var e,i=.1,s=.4;return 0===t?0:1===t?1:(!i||1>i?(i=1,e=s/4):e=s*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?-.5*i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s):i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/s)*.5+1)},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},backInOut:function(t){var e=2.5949095;return(t*=2)<1?.5*t*t*((e+1)*t-e):.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:function(t){return 1-meta.Tween.Easing.bounceOut(1-t)},bounceOut:function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},bounceInOut:function(t){return.5>t?.5*meta.Tween.Easing.bounceIn(2*t):.5*meta.Tween.Easing.bounceOut(2*t-1)+.5}},"use strict",meta.Tween.Link=function(t,e,i,s){this.tween=t,this.startValues={},this.endValues=e,this.duration=i,this._onDone=s},meta.Tween.Link.prototype={play:function(){return this.tween.play(),this},stop:function(){return this.tween.stop(),this},paused:function(t){return this.tween.paused(t),this},resume:function(){return this.tween.resume(),this},clear:function(){return this.tween.clear(),this},reset:function(){return this.tween.reset(),this},update:function(t){var e=this._easing(t),i,s,n,o=this.tween.cache.owner;for(var h in this.endValues)i=this.startValues[h],s=this.endValues[h],"string"==typeof i&&(s=i+parseFloat(s,4)),n=i+(s-i)*e,this.isRounding&&(n=Math.round(n)),o[h]=n},next:function(){return this.tween.next(),this},wait:function(t){return this.tDelay=t,this},frameDelay:function(t){return this.tFrameDelay=t,this},round:function(t){return void 0===t&&(t=!0),this.isRounding=t,this},repeat:function(t){return this.tween.repeat(t),this},reverse:function(t){return this.tween.reverse(t),this},easing:function(t){return this._easing="function"==typeof t?t:meta.Tween.Easing[t],void 0===this._easing&&(this._easing=meta.Tween.Easing.linear),this},onStart:function(t){return this._onStart=t,this},onDone:function(t){return this._onDone=t,this},onTick:function(t){return this._onTick=t,this},to:function(t,e,i){return this.tween.to(t,e,i)},group:function(t){return this.tween.group(t)},_easing:meta.Tween.Easing.linear,_onStart:null,_onDone:null,_onTick:null,tDelay:0,tFrameDelay:0,isRounding:!1},"use strict",window.Component={},"use strict";var Resource={};Resource.Controller=meta.Controller.extend({init:function(){this.resources={},this.resourcesInUse={},this._chn_added=meta.createChannel(Resource.Event.ADDED),this._chn_allLoaded=meta.createChannel(Resource.Event.ALL_LOADED);var t=document.createElement("canvas");Resource.Texture.prototype._tmpImg=t,Resource.Texture.prototype._tmpCtx=t.getContext("2d"),meta.subscribe(this,meta.Event.ADAPT,this.onAdapt);var e=Resource.Sound.prototype;meta.device.isAudioAPI?(e._context=new AudioContext,console.log("%cAudio: %cWebAudio ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")):(e._loadFromUrl=e._loadFromUrl_legacy,e._clear=e._clear_legacy,e._createInstance=e._createInstance_legacy,e._syncLoading=!0,console.log("%cAudio: %c<audio> ","font-weight: bold; padding: 2px 0 1px 0; width: 500px;","padding: 2px 0 1px 0;"))},add:function(t){var e=this.resources[t.type];e||(e={},this.resources[t.type]=e);var i=t.path;if("unknown"===t.name&&i){var s=i.lastIndexOf("."),n=i.lastIndexOf("/");t.name=0>s||i.length-s>5?i.slice(n+1):i.slice(n+1,s)}return e[t.name]?(console.warn("[Resource.Manager.add]:","There is already a resource("+meta.enumToString(Resource.Type,t.type)+") added with a name: "+t.name),null):(e[t.name]=t,this._chn_added.emit(t,Resource.Event.ADDED),t)},remove:function(t){var e=this.resources[t.type];return e&&e[t.name]?(e[t.name]=null,void 0):(console.warn("[Resource.Manager.remove]:","Resource("+meta.enumToString(Resource.Type,t.type)+")("+t.name+") is not added to the manager."),void 0)},addToLoad:function(t){t.isLoading=!0,meta.engine.isReady||this.numToLoad++},loadSuccess:function(t){var e=this.resourcesInUse[t.type];e||(e=[],this.resourcesInUse[t.type]=e),e.push(t),t.isLoading=!1,t.inUse=!0,meta.engine.isReady||(this.numToLoad--,this.numLoaded++,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn_allLoaded.emit(this,Resource.Event.ALL_LOADED)))},loadFailed:function(t){t.isLoading=!1,meta.engine.isReady||(this.numToLoad--,0!==this.numToLoad||meta.engine.isLoading||(meta.engine.onResourcesLoaded(),this._chn_allLoaded.emit(this,Resource.Event.ALL_LOADED)))},getTexture:function(t){if(!t)return console.warn("[Resource.Manager.getTexture]:","No name specified."),null;var e=this.resources[Resource.Type.TEXTURE];if(!e)return null;var i=e[t];return i?i:null},getSound:function(t){if(!t)return console.warn("[Resource.Manager.getSound]:","No name specified."),null;var e=this.resources[Resource.Type.SOUND];if(!e)return null;var i=e[t];return i?i:null},addToQueue:function(t){this._syncQueue||(this._syncQueue=[]),this._syncQueue.push(t)},loadNextFromQueue:function(){this.isSyncLoading=!1,this._syncQueue&&this._syncQueue.length&&(this._syncQueue[this._syncQueue.length-1].forceLoad(!0),this._syncQueue.pop())},onAdapt:function(t,e){var i=meta.unitRatio,s,n=this.resources[Resource.Type.TEXTURE];for(var o in n)s=n[o],s.unitRatio=i,s.load()},getUniqueID:function(){return++this._uniqueID},resources:null,resourcesInUse:null,rootPath:"",numLoaded:0,numToLoad:0,_syncQueue:null,isSyncLoading:!1,_chn_added:null,_chn_allLoaded:null,_uniqueID:0}),"use strict",Resource.Event={UNLOADED:"res-unloaded",LOADED:"res-loaded",RESIZE:"res-resize",CHANGED:"res-changed",ADDED:"res-added",ALL_LOADED:"res-all-loaded"},Resource.Type={BASIC:0,TEXTURE:1,SOUND:2,SPRITE_SHEET:3,FONT:4},Resource.TextureType={UNKNOWN:-1,CANVAS:0,WEBGL:1},Resource.AnimType={NONE:0,LINEAR_H:1,LINEAR_V:2,RADIAL:3,RADIAL_TOP_LEFT:4,RADIAL_TOP_RIGHT:5,RADIAL_BOTTOM_LEFT:6,RADIAL_BOTTOM_RIGHT:7},"use strict",Resource.Basic=meta.Class.extend({_init:function(){this.id=Resource.ctrl.getUniqueID()},subscribe:function(t,e){this.chn||(this.chn=meta.createChannel("__res"+this.id)),this.chn.subscribe(t,e)},unsubscribe:function(t){this.chn&&(this.chn.unsubscribe(t),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(t,e){this.chn&&this.chn.emit(t,e)},set isLoaded(t){t?this._isLoaded?(this._isLoaded=t,this.emit(this,Resource.Event.CHANGED)):(this._isLoaded=t,this.emit(this,Resource.Event.LOADED)):this._isLoaded&&(this._isLoaded=t,this.emit(this,Resource.Event.UNLOADED))},get isLoaded(){return this._isLoaded},id:0,type:Resource.Type.BASIC,name:"unknown",path:"",fullPath:"",chn:null,_isLoaded:!1,isLoading:!1,inUse:!1}),"use strict",Resource.Texture=Resource.Basic.extend({init:function(t,e){if(void 0!==t){var i=typeof t;if("object"===i)for(var s in t)this[s]=t[s];else"string"===i?this.path=t:(this.textureType=t,e&&(this.path=e));if(this.path){var n=this.path.lastIndexOf(".");(-1===n||this.path.length-n>4)&&(this.path+=".png")}}-1===this.textureType&&(this.textureType=meta.engine.isWebGL?Resource.TextureType.WEBGL:Resource.TextureType.CANVAS),this.numFrames>1?(this.numFramesX=this.numFrames,this.isAnimated=!0):(this.numFramesX>1||this.numFramesY>1)&&(this.numFrames=this.numFramesX*this.numFramesY,this.isAnimated=!0),this.generate(this.textureType)},remove:function(){},generate:function(t){if(this.isLoaded=!1,t===Resource.TextureType.WEBGL){var e=meta.ctx;this.image=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),this._vertices=new Float32Array([0,0,this.trueWidth,0,0,this.trueHeight,this.trueWidth,this.trueHeight]),this.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vbo),e.bufferData(e.ARRAY_BUFFER,this._vertices,e.DYNAMIC_DRAW)}else this.image=document.createElement("canvas"),this.ctx=this.image.getContext("2d"),this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight,this.textureType=Resource.TextureType.CANVAS},load:function(t){if(!this.isLoading){if(t)this.path=t;else if(!this.path)return;this.fullPath=meta._cache.currResolution?Resource.ctrl.rootPath+meta._cache.currResolution.path+this.path:Resource.ctrl.rootPath+this.path,Resource.ctrl.addToLoad(this);var e=this,i=new Image;meta.engine.isWebGL&&(i.crossOrigin="anonymous"),i.onload=function(){return i.complete?(e.createFromImg(i),Resource.ctrl.loadSuccess(e),void 0):(console.warn("[Resource.Texture.load]:","Could not load texture from - "+i.src),Resource.ctrl.loadFailed(e),void 0)},i.onerror=function(t){Resource.ctrl.loadFailed(e)},this._isLoaded&&(this._isReloading=!0),i.src=this.fullPath}},createFromImg:function(t){if(this._isLoaded&&this.clear(),this.resize(t.width,t.height),this.textureType!==Resource.TextureType.WEBGL)this.ctx.drawImage(t,0,0);else{var e=meta.ctx;e.bindTexture(e.TEXTURE_2D,this.image),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}this.unitRatio=meta.unitRatio,this._isReloading=!1,this.isLoaded=!0},_createCachedImg:function(){this._cachedImg||(this._cachedImg=document.createElement("canvas"),this._cachedImg.width=this.trueFullWidth,this._cachedImg.height=this.trueFullHeight,this._cachedCtx=this._cachedImg.getContext("2d"))},resize:function(t,e){if(this.trueFullWidth!==t||this.trueFullHeight!==e){this.trueFullWidth=t,this.trueFullHeight=e,this.isAnimated?(this.trueWidth=t/this.numFramesX,this.trueHeight=e/this.numFramesY):(this.trueWidth=t,this.trueHeight=e);var i=meta.unitRatio;if(this.width=this.trueWidth*i+.5|0,this.height=this.trueHeight*i+.5|0,this.fullWidth=this.trueFullWidth*i+.5|0,this.fullHeight=this.trueFullHeight*i+.5|0,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this.textureType){var s=meta.ctx;this._vertices[2]=this.trueWidth,this._vertices[5]=this.trueHeight,this._vertices[6]=this.trueWidth,this._vertices[7]=this.trueHeight,this._xRatio=1/this.numFramesX,this._yRatio=1/this.numFramesY,this.fromAtlas?(this._widthRatio=1/(this.ptr.trueFullWidth/this.trueWidth/this.numFramesX),this._heightRatio=1/(this.ptr.trueFullHeight/this.trueHeight/this.numFramesY)):(this._widthRatio=1/this.numFramesX,this._heightRatio=1/this.numFramesY),s.bindBuffer(s.ARRAY_BUFFER,this.vbo),s.bufferData(s.ARRAY_BUFFER,this._vertices,s.DYNAMIC_DRAW),this._isLoaded&&this._cachedImg&&(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this._cachedImg,0,0),this._cachedImg.width=this.trueFullWidth,this._cachedImg.height=this.trueFullHeight,this._cachedCtx.drawImage(this._cachedImg,0,0),s.bindTexture(s.TEXTURE_2D,this.image),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,this._cachedImg))}else this._isLoaded&&this.image.width>0&&this.image.height>0?(this._tmpImg.width=this.image.width,this._tmpImg.height=this.image.height,this._tmpCtx.drawImage(this.image,0,0),this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight,this.ctx.drawImage(this._tmpImg,0,0)):(this.image.width=this.trueFullWidth,this.image.height=this.trueFullHeight);this._isLoaded&&!this._isReloading&&this.emit(this,Resource.Event.RESIZE)}},upResize:function(t,e){t<this.trueFullWidth&&(t=this.trueFullWidth),e<this.trueFullHeight&&(e=this.trueFullHeight),this.resize(t,e)},draw:function(t,e,i){this._bgTexture&&this._bgTexture.draw(t,e,i),this.fromAtlas?t.drawImage(this.ptr.image,this._x,this._y,this.trueWidth,this.trueHeight,e,i,this.trueWidth,this.trueHeight):t.drawImage(this.image,e,i)},drawFrame:function(t,e,i,s,n){if(this._bgTexture&&t.drawImage(this._bgTexture.image,e,i),this._anim){var o,h;if(1===this._anim.type){var r=this._anim.fill*s;0===r?r=.01:r>this.trueFullWidth&&(r=this.trueFullWidth),n?t.drawImage(this.image,this.trueFullWidth-r,0,r,this.trueFullHeight,e+this.trueFullWidth-r,i,r,this.trueFullHeight):t.drawImage(this.image,0,0,r,this.trueFullHeight,e,i,r,this.trueFullHeight)}else if(2===this._anim.type){var a=this._anim.fill*s;0===a?a=.01:a>this.trueHeight&&(r=this.trueHeight),n?t.drawImage(this.image,0,this.trueFullHeight-a,this.trueFullWidth,a,e,i+this.trueFullHeight-a,this.trueFullWidth,a):t.drawImage(this.image,0,0,this.trueFullWidth,a,e,i,this.trueFullWidth,a)}else 3===this._anim.type||(4===this._anim.type?(n?(o=this._anim.fill*(-this.numFrames+s+1)+Math.PI/2,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h+this.trueFullWidth,i),t.closePath(),t.clip()):(o=this._anim.fill*-s+Math.PI/2,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h,i+this.trueFullHeight),t.lineTo(e,i+this.trueFullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):5===this._anim.type?(n?(o=this._anim.fill*(this.numFrames-s-1)+Math.PI/2,h=e+Math.cos(o)*this._anim.length+this.trueFullWidth,t.save(),t.beginPath(),t.moveTo(e+this.trueFullWidth,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(e,i+this.trueFullHeight),t.lineTo(e,i),t.closePath(),t.clip()):(o=this._anim.fill*s+Math.PI/2,h=e+Math.cos(o)*this._anim.length+this.trueFullWidth,t.save(),t.beginPath(),t.moveTo(e+this.trueFullWidth,i),t.lineTo(h,i+Math.sin(o)*this._anim.length),t.lineTo(h,i+this.trueFullHeight),t.lineTo(e+this.trueFullWidth,i+this.trueFullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):6===this._anim.type?(n?(o=this._anim.fill*(-this.numFrames+s+1),h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i+this.trueFullHeight),t.lineTo(h,i+Math.sin(o)*this._anim.length+this.trueFullHeight),t.lineTo(e+this.trueFullWidth,i),t.lineTo(e,i),t.closePath(),t.clip()):(o=this._anim.fill*-s,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e,i+this.trueFullHeight),t.lineTo(h,i+Math.sin(o)*this._anim.length+this.trueFullHeight),t.lineTo(e+this.trueFullWidth,i),t.lineTo(e+this.trueFullWidth,i+this.trueFullHeight),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()):7===this._anim.type&&(n?(o=this._anim.fill*(this.numFrames-1-s)+Math.PI,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e+64,i+this.trueFullHeight),t.lineTo(h+64,i+Math.sin(o)*this._anim.length+64),t.lineTo(e,i),t.lineTo(e+64,i),t.closePath(),t.clip()):(o=this._anim.fill*s+Math.PI,h=e+Math.cos(o)*this._anim.length,t.save(),t.beginPath(),t.moveTo(e+64,i+this.trueFullHeight),t.lineTo(h+64,i+Math.sin(o)*this._anim.length+64),t.lineTo(e,i),t.lineTo(e,i+64),t.closePath(),t.clip()),t.drawImage(this.image,e,i),t.restore()))}else t.drawImage(this.image,this.trueWidth*(s%this.numFramesX),this.trueHeight*Math.floor(s/this.numFramesX),this.trueWidth,this.trueHeight,e,i,this.trueWidth,this.trueHeight)},clear:function(){if(this.textureType===Resource.TextureType.WEBGL){if(!this._cachedCtx)return;this._cachedCtx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);var t=meta.ctx;t.bindTexture(t.TEXTURE_2D,this.image),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);this._isReloading||(this.isLoaded=!0)},clearSilent:function(){if(this.textureType===Resource.TextureType.WEBGL){this._tmpCtx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight);var t=meta.ctx;t.bindTexture(t.TEXTURE_2D,this.image),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._cachedImg)}else this.ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight)},drawOver:function(t,e,i){if(!t)return console.warn("[Resource.Texture.drawOver]:","No texture specified."),void 0;if(e=e||0,i=i||0,"string"==typeof t){var s=meta.getTexture(t);if(!s)return console.warn("[Resource.Texture.drawOver]:","No such texture with name - "+t),void 0;t=s}if(t.textureType===Resource.TextureType.WEBGL){if(!t._canvasCache)return t._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,t.path),t._canvasCache.load(),t=t._canvasCache,this._loadCache={name:"drawOver",texture:t,x:e,y:i},this.isLoaded=!1,t.subscribe(this,this.onTextureCacheEvent),void 0;t=t._canvasCache}var n=this.ctx;if(this.textureType&&(this._createCachedImg(),n=this._cachedCtx),n.drawImage(t.image,e,i),this.textureType){var o=meta.ctx;o.bindTexture(o.TEXTURE_2D,this.image),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},fillRect:function(t,e,i){if(!t)return console.warn("[Resource.Texture.fillRect]:","No parameters specified."),void 0;if("number"==typeof t)return this.fillRect({width:t,height:e,color:i}),void 0;var s=meta,n=this.ctx;t.x=t.x||0,t.y=t.y||0;var o=(t.width||this.trueFullWidth||1)+t.x,e=(t.height||this.trueFullHeight||1)+t.y;if(this.upResize(o,e),this.textureType&&(this._createCachedImg(),n=this._cachedCtx),n.fillStyle=t.color||"#000000",n.fillRect(t.x,t.y,o,e),this.textureType){var h=s.ctx;h.bindTexture(h.TEXTURE_2D,this.image),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},tile:function(t,e,i){if("number"==typeof t)return this.tile({width:t,height:e,texture:i}),void 0;if(!t)return console.warn("[Resource.Texture.tile]:","No parameters specified."),void 0;if("string"==typeof t.texture&&(t.texture=Resource.ctrl.getTexture(t.texture)),!t.texture)return console.warn("[Resource.Texture.tile]:","Undefined texture."),void 0;var i=t.texture;if(i.textureType===Resource.TextureType.WEBGL){if(!i._canvasCache)return i._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,i.path),i._canvasCache.load(),i=i._canvasCache,this._loadCache={name:"tile",data:t},this.isLoaded=!1,i.subscribe(this,this.onTextureCacheEvent),void 0;i=i._canvasCache}if(!i._isLoaded)return i._isLoading||i.load(),this._loadCache={name:"tile",data:t},this.isLoaded=!1,i.subscribe(this,this.onTextureCacheEvent),void 0;var s=meta;t.x=t.x||0,t.y=t.y||0,t.width=t.width||i.fullWidth,t.height=t.height||i.fullHeight,t.width*=s.unitSize,t.height*=s.unitSize,this.resize(t.width,t.height),t.center&&(t.x+=(this.trueFullWidth&i.trueFullWidth-1)/2,t.y+=(this.trueFullHeight&i.trueFullHeight-1)/2);var n=this.ctx;this.textureType&&(this._createCachedImg(),n=this._cachedCtx);var o=t.x,h=t.y,r=Math.ceil(this.trueFullWidth/i.trueFullWidth)||1,a=Math.ceil(this.trueFullHeight/i.trueFullHeight)||1;o>0&&(r+=Math.ceil(o/i.trueFullWidth),o-=i.trueFullWidth),h>0&&(a+=Math.ceil(h/i.trueFullHeight),h-=i.trueFullHeight);for(var u=h,c=0;r>c;c++){for(var l=0;a>l;l++)n.drawImage(i.image,o,h),h+=i.trueHeight;o+=i.trueWidth,h=u}if(this.textureType){var d=s.ctx;d.bindTexture(d.TEXTURE_2D,this.image),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},stroke:function(t){if(!t)return console.warn("[Resource.Texture.stroke]:","No parameters specified."),void 0;if(!t.buffer)return console.warn("[Resource.Texture.stroke]:","No buffer defined."),void 0;var e=meta,i=e.unitSize,s=Number.POSITIVE_INFINITY,n=s,o=Number.NEGATIVE_INFINITY,h=o,r,a,u,c,l=t.buffer,d=l.length;for(a=0;d>a;a+=2)u=l[a]*i|0,c=l[a+1]*i|0,s>u&&(s=u),n>c&&(n=c),u>o&&(o=u),c>h&&(h=c),l[a]=u,l[a+1]=c;s>0&&(s=0),n>0&&(n=0);var m=this.ctx;t.addWidth=t.addWidth||0,t.addHeight=t.addHeight||0,t.lineWidth=t.lineWidth||1,t.color||t.fillColor||(t.color="#000000");var _=t.lineWidth/2,f=-s+_+.5*t.addWidth,p=-n+_+.5*t.addHeight;for(this.resize(o-s+t.lineWidth+t.addWidth,h-n+t.lineWidth),this.textureType&&(this._createCachedImg(),m=this._cachedCtx),m.lineWidth=t.lineWidth,t.lineCap&&(m.lineCap=t.lineCap),t.lineDash&&m.setLineDash(t.lineDash),m.beginPath(),m.moveTo(l[0]+f,l[1]+p),a=2;d>a;a+=2)m.lineTo(l[a]+f,l[a+1]+p);if(t.fillColor&&(m.fillStyle=t.fillColor,m.closePath(),m.fill()),t.color&&(m.strokeStyle=t.color,m.stroke()),this.textureType===Resource.TextureType.WEBGL){var v=e.ctx;v.bindTexture(v.TEXTURE_2D,this.image),v.texImage2D(v.TEXTURE_2D,0,v.RGBA,v.RGBA,v.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},border:function(t){if(!t)return console.warn("[Resource.Texture.strokeBorder]:","No parameters specified."),void 0;t.width=t.width||this.trueFullWidth,t.height=t.height||this.trueFullHeight;var e=1;t.borderWidth&&(e=t.borderWidth),t.buffer=[0,0,t.width-e,0,t.width-e,t.height-e,0,t.height-e,0,0],this.stroke(t)},arc:function(t){if(!t)return console.warn("[Resource.Texture.arc]:","No parameters specified."),void 0;var e=this.ctx;t.x=t.x||0,t.y=t.y||0,t.radius=t.radius||5,t.startAngle=t.startAngle||0,t.endAngle=t.endAngle||2*Math.PI,t.borderWidth=t.borderWidth||1,t.color||t.borderColor||(t.borderColor=t.borderColor||"#000000"),t.closePath=void 0===t.closePath?!0:t.closePath;var i=2*t.radius+t.borderWidth;if(t.drawOver||this.resize(t.x+i+1,t.y+i+1),this.textureType&&(this._createCachedImg(),e=this._cachedCtx),e.lineWidth=t.borderWidth,e.clearRect(0,0,this.trueFullWidth,this.trueFullHeight),t.closePath?(e.beginPath(),e.arc(t.x+t.radius+t.borderWidth/2+.5,t.y+t.radius+t.borderWidth/2+.5,t.radius,t.startAngle,t.endAngle,!1),e.closePath()):e.arc(t.x+t.radius+t.borderWidth/2,t.y+t.radius+t.borderWidth/2,t.radius,t.startAngle,t.endAngle,!1),t.color&&(e.fillStyle=t.color,e.fill()),t.borderColor&&(e.strokeStyle=t.borderColor,e.stroke()),this.textureType===Resource.TextureType.WEBGL){var s=meta.ctx;s.bindTexture(s.TEXTURE_2D,this.image),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},rect:function(t,e,i,s){if("object"!=typeof t)return this.rect({width:t,height:e,color:i,borderWidth:s}),void 0;if(!t)return console.warn("[Resource.Texture.rect]:","No parameters specified."),void 0;var n=this.ctx,o=t.width||1,e=t.height||1;t.color=t.color||"#0000000";var s=t.borderWidth||1;t.drawOver||this.resize(o,e),this.textureType&&(this._createCachedImg(),n=this._cachedCtx),n.strokeStyle=t.color,n.lineWidth=s;var h=Math.ceil(s/2);if(s%2===1?(n.save(),n.translate(.5,.5),n.beginPath(),n.moveTo(h,h),n.lineTo(o-h-1,h),n.lineTo(o-h-1,e-h-1),n.lineTo(h,e-h-1),n.closePath(),n.stroke(),n.restore()):(n.beginPath(),n.moveTo(h,h),n.lineTo(o-h,h),n.lineTo(o-h,e-h),n.lineTo(h,e-h),n.closePath(),n.stroke()),t.fillColor&&(n.fillStyle=t.fillColor,n.fill()),this.textureType===Resource.TextureType.WEBGL){var r=meta.ctx;r.bindTexture(r.TEXTURE_2D,this.image),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},roundRect:function(t,e,i,s,n){if("object"!=typeof t)return this.roundRect({width:t,height:e,radius:i,color:s,borderWidth:n}),void 0;if(!t)return console.warn("[Resource.Texture.rect]:","No parameters specified."),void 0;var o=this.ctx,h=t.width||1,e=t.height||1;t.color=t.color||"#0000000";var i=t.radius||1,n=t.borderWidth||3;t.drawOver||this.resize(h,e),this.textureType&&(this._createCachedImg(),o=this._cachedCtx),o.strokeStyle=t.color,o.lineWidth=n;var r=Math.ceil(n/2);if(n%2===1?(o.save(),o.translate(.5,.5),o.beginPath(),o.moveTo(r+i,r),o.lineTo(h-r-i,r),o.quadraticCurveTo(h-r,r,h-r,r+i),o.lineTo(h-r,e-r-i),o.quadraticCurveTo(h-r,e-r,h-r-i,e-r),o.lineTo(r+i,e-r),o.quadraticCurveTo(r,e-r,r,e-r-i),o.lineTo(r,i+r),o.quadraticCurveTo(r,r,r+i,r),o.closePath(),o.stroke(),o.restore()):(o.beginPath(),o.moveTo(r+i,r),o.lineTo(h-r-i,r),o.quadraticCurveTo(h-r,r,h-r,r+i),o.lineTo(h-r,e-r-i),o.quadraticCurveTo(h-r,e-r,h-r-i,e-r),o.lineTo(r+i,e-r),o.quadraticCurveTo(r,e-r,r,e-r-i),o.lineTo(r,i+r),o.quadraticCurveTo(r,r,r+i,r),o.closePath(),o.stroke()),t.fillColor&&(o.fillStyle=t.fillColor,o.fill()),this.textureType===Resource.TextureType.WEBGL){var a=meta.ctx;a.bindTexture(a.TEXTURE_2D,this.image),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},bazier:function(t,e,i){this.isLoaded=!0},emulateAnim:function(t,e){if(!this._isLoaded)return console.warn("[Resource.Texture.emulateAnim]:","Texture is not loaded yet."),void 0;var i=Resource.AnimType;t===i.NONE?this._anim=null:(this._anim={type:t},this.isAnimated=!0,this.numFrames=e,t===i.LINEAR_H?this._anim.fill=this.trueWidth/(e-1):t===i.LINEAR_V?this._anim.fill=this.trueHeight/(e-1):t===i.RADIAL?(console.log("[Resource.Texture.emulateAnim]:","RADIAL is currently unsupported type."),this._anim.halfWidth=this.trueFullWidth/2,this._anim.halfHeight=this.trueFullHeight/2,this._anim.fill=2*Math.PI/(e-1),this._anim.length=Math.sqrt(this._anim.halfWidth*this._anim.halfWidth+this._anim.halfHeight*this._anim.halfHeight)+1|0):(t===i.RADIAL_TOP_LEFT||t===i.RADIAL_TOP_RIGHT||t===i.RADIAL_BOTTOM_LEFT||t===i.RADIAL_BOTTOM_RIGHT)&&(this._anim.fill=2*Math.PI/(4*(e-1)),this._anim.length=Math.sqrt(this.trueFullWidth*this.trueFullWidth+this.trueFullHeight*this.trueFullHeight)+1|0)),this.isLoaded=!0},gradient:function(t){if(!t)return console.warn("[Resource.Texture.gradient]:","No data specified."),void 0;if(!t.colors||!t.colors.length)return console.warn("[Resource.Texture.gradient]:","No data.colors specified."),void 0;var e=this.ctx;t.dirX=t.dirX||0,t.dirY=t.dirY||0,t.width=t.width||this.trueFullWidth||1,t.height=t.height||this.trueFullHeight||1,t.drawOver||this.resize(t.width,t.height),this.textureType&&(this._createCachedImg(),e=this._cachedCtx);var i=t.colors,s=i.length,n,o,h,r;t.dirX<0?(n=this.trueFullWidth,o=0):(n=0,o=this.trueFullWidth*t.dirX),t.dirY<0?(h=this.trueFullHeight,r=0):(h=0,r=this.trueFullHeight*t.dirY);for(var a=e.createLinearGradient(n,h,o,r),u=0;s>u;u++)a.addColorStop(i[u][0],i[u][1]);if(e.fillStyle=a,e.clearRect(0,0,this.trueFullWidth,this.trueFullHeight),e.fillRect(0,0,this.trueFullWidth,this.trueFullHeight),this.textureType){var c=meta.ctx;c.bindTexture(c.TEXTURE_2D,this.image),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},grid:function(t,e,i,s){if("number"==typeof t)return this.grid({cellWidth:t,cellHeight:e,numCellsX:i,numCellsY:s}),void 0;if(!t)return console.warn("[Resource.Texture.grid]:","No params specified."),void 0;var n=t.cellWidth||1,e=t.cellHeight||1,i=t.numCellsX||1,s=t.numCellsY||1;t.x=t.x||0,t.y=t.y||0,t.color=t.color||"#000000",t.borderWidth=t.borderWidth||1,t.drawOver=t.drawOver||!1;var o=t.x+t.cellWidth*t.numCellsX+1,h=t.y+t.cellHeight*t.numCellsY+1;t.drawOver||this.resize(o,h);var r=this.ctx;this.textureType&&(this._createCachedImg(),r=this._cachedCtx),r.strokeStyle=t.color,r.lineWidth=t.borderWidth,r.save(),r.translate(.5,.5);for(var a=0;i+1>a;a++)r.moveTo(a*e,0),r.lineTo(a*e,h);for(var u=0;s+1>u;u++)r.moveTo(0,u*e),r.lineTo(o,u*e);if(r.stroke(),r.restore(),this.textureType){var c=meta.ctx;c.bindTexture(c.TEXTURE_2D,this.image),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},onTextureEvent:function(t,e){t===Resource.Event.LOADED&&(this.tile(e),e.unsubscribe(this))},construct:function(t){if(!t)return console.warn("[Resource.Texture.buildMatrix]:","No parameters specified."),void 0;this._constructTex(t,"center"),this._constructTex(t,"left"),this._constructTex(t,"right"),t.width=t.width||this.trueFullWidth,t.height=t.height||this.trueFullHeight,this.resize(t.width,t.height),console.log(this.trueWidth,this.trueHeight);var e=t.width/2-t.center.width/2|0,i=t.height/2-t.center.height/2|0;console.log(e);var s=this.ctx;if(s.drawImage(t.center,e,i),this.textureType){var n=meta.ctx;n.bindTexture(n.TEXTURE_2D,this.image),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,this._cachedImg)}this.isLoaded=!0},_constructTex:function(t,e){if(t[e]&&"string"==typeof t[e]){if(t[e]=Resource.ctrl.getTexture(t[e]),!t[e])return console.warn("[Resource.Texture.buildMatrix]:","Undefined texture for: "+e),void 0;t[e]=t[e].image}},generateAlphaMask:function(){if(!this._isLoaded)return console.warn("[Resource.Texture.generateMask]:","Texture is not loaded yet."),void 0;
if(0!==this.textureType)return console.warn("[Resource.Texture.generateMask]:","Only canvas textures are supported currently."),void 0;var t=new Resource.Texture(Resource.TextureType.CANVAS);t.resize(this.trueFullWidth,this.trueFullHeight);for(var e=this.ctx.getImageData(0,0,this.trueFullWidth,this.trueFullHeight),i=e.data,s=i.length,n=0;s>n;n+=4)i[n]=255,i[n+1]=255,i[n+2]=255;return t.ctx.putImageData(e,0,0),t.isLoaded=!0,t},onTextureCacheEvent:function(t,e){e===Resource.Event.LOADED&&(t.unsubscribe(this),"drawOver"===this._loadCache.name?this.drawOver(this._loadCache.texture,this._loadCache.x,this._loadCache.y):this[this._loadCache.name](this._loadCache.data),this._loadCache=null)},set x(t){return this.ptr?(this.textureType?(this._xRatio=1/this.ptr.trueFullWidth,this._x=this._xRatio*t):this._x=t,void 0):(this._x=0,void 0)},set y(t){return this.ptr?(this.textureType?(this._yRatio=1/this.ptr.trueFullHeight,this._y=this._yRatio*t):this._y=t,void 0):(this._y=0,void 0)},get x(){return this._x},get y(){return this._y},set offsetX(t){this._offsetX=t,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},set offsetY(t){this._offsetY=t,this._isLoaded&&this.emit(this,Resource.Event.CHANGED)},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},set bgTexture(t){if("string"==typeof t){var e=Resource.ctrl.getTexture(t);if(!e)return console.warn("[Resource.Texture.bgTexture]:","No such texture found: "+t),void 0;t=e}this._bgTexture=t,this.isLoaded=!0},get bgTexture(){return this._bgTexture},type:Resource.Type.TEXTURE,textureType:Resource.TextureType.UNKNOWN,image:null,ctx:null,_bgTexture:null,vbo:null,_vertices:null,_x:0,_y:0,_xRatio:0,_yRatio:0,_width:0,_height:0,fullWidth:0,fullHeight:0,_widthRatio:0,_heightRatio:0,_offsetX:0,_offsetY:0,unitRatio:1,fps:0,numFrames:1,numFramesX:1,numFramesY:1,isAnimated:!1,isLoop:!1,autoPlay:!0,isAnimReverse:!1,isEmulateReverse:!1,fromAtlas:!1,isReloading:!1,_tmpImg:null,_tmpCtx:null,_cachedImg:null,_cachedCtx:null,_anim:null,_frames:null,_loadCache:null,_canvasCache:null,_maxResCanvasCache:null,_maxResCtxCache:null}),"use strict",Resource.Sound=Resource.Basic.extend({init:function(t,e){if("string"==typeof t&&(e=t,t=void 0),e){var i=e.lastIndexOf(".");-1!==i&&e.length-i<=5&&(this.format=e.substr(i+1,e.length-i-1),e=e.substr(0,i)),this.path=Resource.ctrl.rootPath+e}this._instances=[];var s=this;meta.device.isAudioAPI?(this._request=new XMLHttpRequest,this._request.responseType="arraybuffer",this._request.onreadystatechange=function(){s._onStateChange()}):(this._context=this._getInstance(),this._context.audio.addEventListener("error",function(){s.format?s._onLoadFailed():s._loadNextExtension()}),this._numInstancesUsed=0)},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,Resource.ctrl.addToLoad(this);var t=Resource.ctrl;t.isSyncLoading?t.addToQueue(this):(this.syncLoading||(t.isSyncLoading=!0),this._loadNextExtension())}},forceLoad:function(){this._loadNextExtension()},_loadNextExtension:function(){var t;if(this.format)t=this.path;else{var e=meta.device.audioFormats;if(this._requestFormat++,this._requestFormat>e.length)return this._onLoadFailed(),void 0;t=this.path+"."+meta.device.audioFormats[this._requestFormat-1]}this._loadFromUrl(t)},_loadFromUrl:function(t){this._request.open("GET",t,!0),this._request.send()},_loadFromUrl_legacy:function(t){this._context.audio.src=t,this._context.audio.load()},_clear:function(){this._request.onreadystatechange=null,this._request=null},_clear_legacy:function(){},_onStateChange:function(){if(4===this._request.readyState)if(200===this._request.status){var t=this;this._context.decodeAudioData(this._request.response,function(e){t._onDecodeSuccess(e)},function(){t._onDecodeError()}),this._request=null}else this.format?this._onLoadFailed():this._loadNextExtension()},_onDecodeSuccess:function(t){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),this._buffer=t,this._isLoading=!1,this._clear(),this.isLoaded=!0,Resource.ctrl.loadSuccess(this);for(var e=this._instances.length,i=0;e>i;i++)this._createSource(this._instances[i])},_onDecodeError:function(){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),console.warn("[Resource.Sound.load]:","Error decoding file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},_onLoadFailed:function(){if(!this.format){var t=meta.device.audioFormats[this._requestFormat-1];t&&(this.path+="."+t)}console.warn("[Resource.Sound.load]:","Error loading file: "+this.path),this._isLoading=!1,this._clear(),Resource.ctrl.loadFailed(this)},play:function(t,e){var i=this._getInstance();i.isLoop=t||!1,i.play(e)},stop:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t]._stop();this._numInstancesUsed=0},pause:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t].pause()},resume:function(){for(var t=0;t<this._numInstancesUsed;t++)this._instances[t].resume()},_createSource:function(t){var e=this._context.createGain();e.connect(this._context.destination);var i=this._context.createBufferSource();i.buffer=this._buffer,i.loop=t._isLoop,i.connect(e),i.start||(i.start=i.noteOn),i.stop||(i.stop=i.noteOff);var s=this;return i.onended=function(){s._clearInstance(t)},t.source=i,t.gainNode=e,i},_createInstance:function(){return new Resource.AudioInstance},_createInstance_legacy:function(){return new Resource.AudioInstance_legacy(this)},_getInstance:function(){this._instances.length===this._numInstancesUsed&&(this._instances.length+=1,this._instances[this._numInstancesUsed]=this._createInstance());var t=this._instances[this._numInstancesUsed];return t.id=this._numInstancesUsed,this._numInstancesUsed++,t},_clearInstance:function(t){this._numInstancesUsed--;var e=this._instances[this._numInstancesUsed];e.id=t.id,this._instances[t.id]=e},set volume(t){if(this._volume!==t){this._volume=t;for(var e=this._instances.length,i=0;e>i;i++)this._instances[i].volume=t}},get volume(){return this._volume},get isPlaying(){return this._numInstancesUsed>0?!0:!1},type:Resource.Type.SOUND,format:"",_instances:null,_numInstancesUsed:0,_autoIsLoop:!1,_autoTime:0,_context:null,_buffer:null,_request:null,_requestFormat:0,_volume:1,_isInQueue:!1,_syncLoading:!1}),Resource.AudioInstance=function(){this.id=-1,this.source=null,this.gainNode=null,this.auto,this._volume=1,this._mixedVolume=1},Resource.AudioInstance.prototype={set volume(t){this._mixedVolume=this._volume*t,this.gainNode.gain.value=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume}},Resource.AudioInstance_legacy=function(t){this.id=-1,this.parent=t,this.isPlaying=!1,this.isLoop=!1,this._canPlay=!1,this._metaLoaded=!1,this._isLoaded=!1,this._volume=1,this._mixedVolume=1,this.audio=new Audio,this.audio.preload="auto",this._addEvents(t)},Resource.AudioInstance_legacy.prototype={play:function(t){this.isPlaying=!0,this._isLoaded?(this.audio.currentTime=t||0,this.audio.play()):this._autoPlay=!0},stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause(),this.parent._clearInstance(this)},_stop:function(){this.isPlaying=!1,this.isLoop=!1,this.audio.pause()},pause:function(){this.isPlaying=!1,this.audio.pause()},resume:function(){this.isPlaying=!0,this.audio.play()},_addEvents:function(){var t=this,e=function(){t.audio.removeEventListener("canplaythrough",e),t._canPlay=!0,meta.device.support.onloadedmetadata&&t._metaLoaded&&t._onLoaded()};if(this.audio.addEventListener("canplaythrough",e,!1),meta.device.support.onloadedmetadata){var i=function(){t.audio.removeEventListener("loadedmetadata",i),t._metaLoaded=!0,t._canPlay&&t._onLoaded()};this.audio.addEventListener("loadedmetadata",i,!1)}this.audio.addEventListener("ended",function(){t._onEnd()},!1),this.parent._isLoaded&&(this.audio.src=this.parent.path,this.audio.load())},_onLoaded:function(){if(!this.parent._isLoaded){this.parent.format||(this.parent.path+="."+meta.device.audioFormats[this.parent._requestFormat-1]),this.parent._isLoading=!1,this.parent.isLoaded=!0;for(var t,e=this.parent._instances,i=this.parent._instances.length,s=1;i>s;s++)t=e[s],t.audio.src=this.parent.path,t.audio.load();Resource.ctrl.loadSuccess(parent),Resource.ctrl.loadNextFromQueue()}this._isLoaded=!0,this._autoPlay&&this.audio.play()},_onEnd:function(){this.isLoop?(this.audio.play(),this.audio.currentTime=0):this.isPlaying&&(this.isPlaying=!1,this.parent._clearInstance(this))},set currentTime(t){this.isPlaying?this.audio.currentTime=t||0:(this.audio.play(),this.audio.currentTime=t||0,this.audio.pause())},get currentTime(){return this.audio.currentTime},set volume(t){t>1?t=1:0>t&&(t=0),this._mixedVolume=this._volume*t,this.audio.volume=this._mixedVolume},get volume(){return this._volume},get mixedVolume(){return this._mixedVolume},_autoPlay:!1},"use strict",Resource.SpriteSheet=Resource.Basic.extend({init:function(t,e){if("string"==typeof t)e=t,t=void 0;else for(var i in t)this[i]=t[i];if(e){var s=e.lastIndexOf(".");-1!==s&&e.length-s<=5&&(this.format=e.substr(s+1,e.length-s-1),e=e.substr(0,s)),this.path=Resource.ctrl.rootPath+e,this.format||(this.format="xml")}},load:function(){if(!this.isLoading){this.isLoading=!0,this.isLoaded=!1,this._isAtlasLoaded=!1,this.texture?"string"==typeof this.texture&&(this.texture=new Resource.Texture(this.texture)):this.texture=new Resource.Texture(this.path),this.texture._isLoaded||(this.texture.subscribe(this,this._onTextureEvent),this.texture._isLoading||this.texture.load());var t=this,e=this.path+"."+this.format;this._request=new XMLHttpRequest,this._request.open("GET",e,!0),this._request.onreadystatechange=function(){t._onStateChange()},this._request.send(),Resource.ctrl.addToLoad(this)}},loadData:function(t,e){if(e=e||this.format,e||(e="xml"),this.format=e,this.isLoaded=!0,"xml"===e){var i=new DOMParser,s=i.parseFromString(t,"text/xml");return this.loadXML(s)}if("json"===e){var n=JSON.parse(t);return this.loadJSON(n)}if("plist"===e){var i=new DOMParser,o=i.parseFromString(t,"text/xml");return this.loadPlist(o)}return console.warn("[Resource.SpriteSheet.loadData]:","Trying to load an unsupported format - "+this.format),!1},loadXML:function(t){if(!t)return console.warn("[Resource.SpriteSheet.loadXML]:","Invalid XML file."),!1;for(var e=t.documentElement.childNodes,i=e.length,s,n=0;i>n;n++)if(s=e[n],"SubTexture"===s.nodeName)this._loadXML_Starling(s);else if("sprite"===s.nodeName)this._loadXML_genericXML(s);else if("dict"===s.nodeName)return this.loadPlist(t);return!0},_loadXML_Starling:function(t){var e=new Resource.Texture;e.fromAtlas=!0,e.ptr=this.texture,e.name=t.getAttribute("name"),e.x=t.getAttribute("x"),e.y=t.getAttribute("y"),e.resize(t.getAttribute("width"),t.getAttribute("height")),e.isLoaded=!0,Resource.ctrl.add(e)},_loadXML_genericXML:function(t){var e=new Resource.Texture;e.fromAtlas=!0,e.ptr=this.texture,e.name=t.getAttribute("n"),e.x=t.getAttribute("x"),e.y=t.getAttribute("y"),e.resize(t.getAttribute("w"),t.getAttribute("h")),e.isLoaded=!0,Resource.ctrl.add(e)},loadPlist:function(t){if(!t)return console.warn("[Resource.SpriteSheet.loadPlist]:","Invalid Plist file."),!1;for(var e=t.documentElement.childNodes,i=e.length,s,n=0;i>n;n++)if(s=e[n],"dict"===s.nodeName)return this._loadPlist_dict(s)},_loadPlist_dict:function(t){for(var e=t.childNodes,i=e.length,s="",n=0;i>n;n++)if(t=e[n],"key"===t.nodeName)s=t.textContent;else if("dict"===t.nodeName){if(!s)continue;"frames"===s&&this._loadPlist_frames(t)}},_loadPlist_frames:function(t){for(var e=t.childNodes,i=e.length,s="",n=0;i>n;n++)t=e[n],"key"===t.nodeName?s=t.textContent:"dict"===t.nodeName&&this._loadPlist_frame(t,s)},_loadPlist_frame:function(t,e){var i=new Resource.Texture;i.fromAtlas=!0,i.ptr=this.texture,i.name=e;for(var s=t.childNodes,n=s.length,o="",h,r=0;n>r;r++)if(t=s[r],"key"===t.nodeName)o=t.textContent;else if("string"===t.nodeName&&"frame"===o)return h=t.textContent.match(/[0-9]+/g),i.x=parseInt(h[0]),i.y=parseInt(h[1]),i.resize(parseInt(h[2]),parseInt(h[3])),i.isLoaded=!0,Resource.ctrl.add(i),void 0},loadJSON:function(t){return t?(t.frames instanceof Array?this._loadJSON_array(t):this._loadJSON_hash(t),!0):(console.warn("[Resource.SpriteSheet.loadFromJSON]:","Invalid JSON file."),!1)},_loadJSON_array:function(t){for(var e,i,s=t.frames,n=s.length,o=0;n>o;o++)e=s[o],i=new Resource.Texture,i.fromAtlas=!0,i.ptr=this.texture,i.name=e.filename,e=e.frame,i.x=e.x,i.y=e.y,i.resize(e.w,e.h),i.isLoaded=!0,Resource.ctrl.add(i)},_loadJSON_hash:function(t){var e,i,s=t.frames;for(var n in s)e=s[n].frame,i=new Resource.Texture,i.fromAtlas=!0,i.ptr=this.texture,i.name=n,i.x=e.x,i.y=e.y,i.resize(e.w,e.h),i.isLoaded=!0,Resource.ctrl.add(i)},loadAtlas:function(){if("object"!=typeof this.atlas)return console.warn("[Resource.SpriteSheet.loadFromAtlas]:","Incorrect atlas object, expected to be an Array."),!1;for(var t=[],e,i,s,n=this.atlas.length,o=0;n>o;o++)e=this.atlas[o],s=e.name||this.params,s?(e.x=e.x||this.params.x||0,e.y=e.y||this.params.y||0,e.width=e.width||this.params.width||1,e.height=e.height||this.params.height||1,t.push(e),i=new Resource.Texture,i.fromAtlas=!0,i.ptr=this.texture,i.name=s,i.x=e.x,i.y=e.y,i.resize(e.width,e.height),i.numFrames=e.numFrames||this.params.numFrames||1,i.isLoaded=!0,Resource.ctrl.add(i)):console.warn("[Resource.SpriteSheet.loadFromAtlas]:","No name defined for atlas item in "+this.name+" spritesheet.");return this.texture._frames=t,this.atlas=null,this.isLoaded=!0,!0},_onTextureEvent:function(t,e){e===Resource.Event.LOADED&&(this.texture.unsubscribe(this),this._isAtlasLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null))},_onStateChange:function(){4===this._request.readyState&&(200===this._request.status?(this._isAtlasLoaded=!0,this._response=this._request.response,this._request=null,this.texture._isLoaded&&(this.loadData(this._response,this.format),Resource.ctrl.loadSuccess(this),this._response=null)):(this._isLoading=!1,this._request.onreadystatechange=null,this._request=null,Resource.ctrl.loadFailed(this)))},type:Resource.Type.SPRITE_SHEET,format:"",atlas:null,params:null,texture:null,_request:null,_response:null,_isAtlasLoaded:!1}),"use strict",Resource.Font=Resource.Basic.extend({init:function(t,e){if("string"==typeof t)e=t,t=void 0;else for(var i in t)this[i]=t[i];if(e){var s=e.lastIndexOf(".");-1!==s&&e.length-s<=5&&(this.format=e.substr(s+1,e.length-s-1),e=e.substr(0,s)),this.path=Resource.ctrl.rootPath+e,this.format||(this.format="fnt")}},load:function(){console.log("load")},type:Resource.Type.FONT,format:""}),"use strict",window.Entity={},Entity.Controller=meta.Controller.extend({init:function(){var t=Entity.Geometry.prototype;t._entityCtrl=this,t._parent=this,this.InputFlag=t.InputFlag,this.entities=[],this.entitiesToUpdate=[],this.entitiesToRemove=[],this.entitiesRemoveUpdate=[],this.detachBuffer=[],this._centerTex=new Resource.Texture,this._centerTex.fillRect({color:"#ff0000",width:6,height:6});var e=meta;this._chnOnDown=e.createChannel(Entity.Event.INPUT_DOWN),this._chnOnUp=e.createChannel(Entity.Event.INPUT_UP),this._chnOnClick=e.createChannel(Entity.Event.CLICK),this._chnOnDbClick=e.createChannel(Entity.Event.DBCLICK),this._chnOnDrag=e.createChannel(Entity.Event.DRAG),this._chnOnDragStart=e.createChannel(Entity.Event.DRAG_START),this._chnOnDragEnd=e.createChannel(Entity.Event.DRAG_END),this._chnOnHover=e.createChannel(Entity.Event.HOVER),this._chnOnHoverEnter=e.createChannel(Entity.Event.HOVER_ENTER),this._chnOnHoverExit=e.createChannel(Entity.Event.HOVER_EXIT),e.subscribe(this,e.Event.RESIZE,this.onResize),e.subscribe(this,e.Event.CAMERA_MOVE,this.onMove),e.subscribe(this,e.Event.ADAPT,this.onAdapt),this.volume=e.camera.volume,this.onMove(e.camera,null)},load:function(){meta.subscribe(this,[Input.Event.INPUT_DOWN,Input.Event.INPUT_UP],this.onInput,meta.Priority.HIGH),meta.subscribe(this,Input.Event.INPUT_DBCLICK,this.onInputDbCLick,meta.Priority.HIGH),meta.subscribe(this,Input.Event.INPUT_MOVE,this.onInputMove,meta.Priority.HIGH)},update:function(t){this.updateFlag|=0;var e,i,s,n,o;for(this._flags&this.Flag.UPDATE_HOVER&&(this._checkHover(Input.ctrl.getEvent()),this._flags&=~this.Flag.UPDATE_HOVER),e=0;e<this.numEntitiesToUpdate;e++)s=this.entitiesToUpdate[e],s.isPaused||s.isRemoved||(s.update&&s.update(t),s.components&&s._updateComponents(t));if(this.numDetachItems){for(e=0;e<this.numDetachItems;e++)if(s=this.detachBuffer[e],n=s._parent.children,o=n.length,0!==o)for(i=0;o>i;i++)if(n[i]===s){n[i]=n[o-1],n.pop();break}this.detachBuffer.length=0,this.numDetachItems=0}if(this.entitiesToRemove.length&&(this._removeEntities(this.entitiesToRemove),this.entitiesToRemove.length=0),this.numEntitiesRemoveUpdate){var h;for(e=0;e<this.numEntitiesRemoveUpdate;e++)s=this.entitiesRemoveUpdate[e],this.entitiesRemoveUpdate[e]=null,4===(4&s._removeFlag)&&(this.numEntitiesToUpdate--,h=this.entitiesToUpdate[this.numEntitiesToUpdate],h._updateNodeID=s._updateNodeID,this.entitiesToUpdate[s._updateNodeID]=h,this.entitiesToUpdate[this.numEntitiesToUpdate]=null,s._removeFlag&=-5,s._updateNodeID=-1);this.numEntitiesRemoveUpdate=0}this.needDepthSort&&(this.entities.sort(this._sortEntities),this.needDepthSort=!1),this.updateFlag&=-2},_addToDrawBounds:function(){this.numShowBounds++,this.isNeedRender=!0},_removeToDrawBounds:function(){this.numShowBounds--,this.isNeedRender=!0},addEntities:function(t){if(t instanceof Array){var e=t.length;this.entities.length+=e;for(var i=0;e>i;i++)this._addEntity(t[i])}else{if(!(t instanceof Entity.Geometry))return console.warn("(Entity.Controller.addEntities) Invalid type for entities"),void 0;this.entities.length++,this._addEntity(t)}this._flags|=this.Flag.UPDATE_HOVER,this.isNeedRender=!0},_addEntity:function(t){if(!t.isRemoved&&(this.entities[this.numEntities++]=t,t.texture||(t.isLoaded=!0),t.update&&(t.isUpdating=!0),t.isNeedStyle&&t._style.update(t),0!==t.totalZ&&(this.needDepthSort=!0),t.isLoaded&&t._onResize(this),t.children))for(var e=t.children.length,i=0;e>i;i++)this._addEntity(t.children[i])},removeEntities:function(t){if(t instanceof Array)if(this.updateFlag){var e=t.length;this.entitiesToRemove.length+=e;for(var i=0;e>i;i++)this.entitiesToRemove.push(t[i])}else this._removeEntities(t);else{if(!(t instanceof Entity.Geometry))return console.warn("(Entity.Controller.removeEntities) Invalid type for entities"),void 0;if(this.updateFlag)this.entitiesToRemove.push(t);else for(var s=0;s<this.numEntities;s++)if(this.entities[s]===t){this.numEntities--,this.entities[s]=this.entities[this.numEntities],this.entities.pop(),t.children&&this._removeEntities(t.children);break}}this._flags|=this.Flag.UPDATE_HOVER,this.isNeedRender=!0,this.needDepthSort=!0},_removeEntities:function(t){for(var e,i,s=t.length,n=0;s>n;n++)for(e=t[n],i=0;i<this.numEntities;i++)if(this.entities[i]===e){this.numEntities--,this.entities[i]=this.entities[this.numEntities],this.entities.pop(),e.children&&this._removeEntities(e.children);break}},_addToUpdating:function(t){return t?4===(4&t._removeFlag)?(t._removeFlag&=-5,!0):-1!==t._updateNodeID?!1:(t._updateNodeID=this.numEntitiesToUpdate,this.entitiesToUpdate.length===this.numEntitiesToUpdate&&(this.entitiesToUpdate.length+=8),this.entitiesToUpdate[this.numEntitiesToUpdate]=t,this.numEntitiesToUpdate++,!0):(console.warn("(Entity.Controller._addToUpdating) Invalid or object is null."),void 0)},_removeFromUpdating:function(t){return t?-1===t._updateNodeID||4===(4&t._removeFlag)?!1:(this.entitiesRemoveUpdate.length===this.numEntitiesRemoveUpdate&&(this.entitiesRemoveUpdate.length+=4),t._removeFlag|=4,this.entitiesRemoveUpdate[this.numEntitiesRemoveUpdate]=t,this.numEntitiesRemoveUpdate++,!0):(console.warn("[Entity.Controller._addToUpdating]:","Invalid or object is null."),void 0)},_sortEntities:function(t,e){return t.totalZ-e.totalZ},getFromVolume:function(t){for(var e,i=this.entities.last.prev,s=this.entities.first;i!==s;i=i.prev)if(e=i.entity,e.pickable&&e.volume!==t&&e.volume.vsAABB(t))return e;return null},getFromPoint:function(t,e,i){for(var s,n=this.entities.last.prev,o=this.entities.first;n!==o;n=n.prev)if(s=n.entity,s.pickable&&s!==i&&s.volume.vsPoint(t,e))return s;return null},getFromEntity:function(t){return this.getFromVolume(t.volume)},cacheEntity:meta.emptyFuncParam,uncacheEntity:meta.emptyFuncParam,onResize:function(t,e){for(var i=0;i<this.numEntities;i++)this.entities[i]._onResize(this);this.isNeedRender=!0},onMove:function(t,e){var i=t.volume;this.prevStartCellX=this.startCellX,this.prevStartCellY=this.startCellY,this.prevEndCellX=this.endCellX,this.prevEndCellY=this.endCellY,this.startCellX=Math.floor(i.minX/this._cellSizeX),this.startCellY=Math.floor(i.minY/this._cellSizeY),this.endCellX=Math.floor(i.maxX/this._cellSizeX),this.endCellY=Math.floor(i.maxY/this._cellSizeY);for(var s=Math.min(this.prevStartCellX,this.startCellX),n=Math.min(this.prevStartCellY,this.startCellY),o=Math.max(this.prevEndCellX,this.endCellX),h=Math.max(this.prevEndCellY,this.endCellY),r,a,u=n;h>u;u++)for(var c=s;o>c;c++)r=c|u<<16;this.x=0|t._x,this.y=0|t._y,this.isNeedRender=!0},onAdapt:function(t,e){for(var i=0;i<this.numEntities;i++)this.entities[i].adapt()},onInput:function(t,e){if(this.enablePicking){this._checkHover(t);var i=Input.Event;if(i.INPUT_DOWN===e){if(!this.hoverEntity||!this.hoverEntity.clickable)return;t.entity=this.hoverEntity,this.pressedEntity=this.hoverEntity,this.pressedEntity._inputFlags|=this.InputFlag.PRESSED,this.pressedEntity._style&&this.pressedEntity._onDown.call(this.pressedEntity,t),this.pressedEntity.onDown.call(this.pressedEntity,t),this._chnOnDown.emit(t,Entity.Event.INPUT_DOWN)}else i.INPUT_UP===e&&this.pressedEntity&&this.pressedEntity.clickable&&(t.entity=this.hoverEntity,this.pressedEntity._inputFlags&=~this.InputFlag.PRESSED,this.pressedEntity._style&&this.pressedEntity._onUp.call(this.pressedEntity,e),this.pressedEntity.onUp.call(this.pressedEntity,e),this._chnOnUp.emit(this.pressedEntity,Entity.Event.INPUT_UP),this.pressedEntity===this.hoverEntity&&(this.pressedEntity._onClick.call(this.pressedEntity,t),this.pressedEntity.onClick.call(this.pressedEntity,t),this._chnOnClick.emit(t,Entity.Event.CLICK)),this.pressedEntity._inputFlags&this.InputFlag.DRAGGED&&(t.entity=this.pressedEntity,this.pressedEntity._inputFlags&=~this.InputFlag.DRAGGED,this.pressedEntity._style&&this.pressedEntity._onDragEnd.call(this.pressedEntity,t),this.pressedEntity.onDragEnd.call(this.pressedEntity,t),this._chnOnDragEnd.emit(t,Entity.Event.DRAG_END),t.entity=this.hoverEntity),this.pressedEntity=null)}},onInputDbCLick:function(t,e){this.enablePicking&&(this._checkHover(t),this.hoverEntity?(this.hoverEntity._onDbClick.call(this.hoverEntity,t),this.hoverEntity.onDbClick.call(this.hoverEntity,t),this._chnOnDbClick.emit(t,Entity.Event.DBCLICK),t.entity=this.hoverEntity):t.entity=null)},_checkHover:function(t){for(var e,i=this.numEntities-1;i>=0;i--)if(e=this.entities[i],e.pickable&&e.isInside(t.x,t.y))return this.hoverEntity!==e?(this.hoverEntity&&(t.entity=this.hoverEntity,this.hoverEntity._inputFlags&=~this.InputFlag.HOVER,this.hoverEntity._style&&this.hoverEntity._onHoverExit.call(this.hoverEntity,t),this.hoverEntity.onHoverExit.call(this.hoverEntity,t),this._chnOnHoverExit.emit(t,Entity.Event.HOVER_EXIT)),t.entity=e,e._inputFlags|=this.InputFlag.HOVER,e._style&&e._onHoverEnter.call(e,t),e.onHoverEnter.call(e,t),this._chnOnHoverEnter.emit(t,Entity.Event.HOVER_ENTER),this.hoverEntity=e):(t.entity=e,e.onHover.call(e,t),this._chnOnHover.emit(t,Entity.Event.HOVER)),t.entity=null,void 0;this.hoverEntity&&(t.entity=this.hoverEntity,this.hoverEntity._inputFlags&=~this.InputFlag.HOVER,this.hoverEntity._style&&this.hoverEntity._onHoverExit.call(this.hoverEntity,t),this.hoverEntity.onHoverExit.call(this.hoverEntity,t),this._chnOnHoverExit.emit(t,Entity.Event.HOVER_EXIT)),this.hoverEntity=null},_checkDrag:function(t){return this.pressedEntity&&this.pressedEntity.clickable?(t.entity=this.pressedEntity,this.pressedEntity._inputFlags&this.InputFlag.DRAGGED?(this.pressedEntity.onDrag.call(this.pressedEntity,t),this._chnOnDrag.emit(t,Entity.Event.DRAG),!1):(this.pressedEntity._inputFlags|=this.InputFlag.DRAGGED,this.pressedEntity._style&&this.pressedEntity._onDragStart.call(this.pressedEntity,t),this.pressedEntity.onDragStart.call(this.pressedEntity,t),this._chnOnDragStart.emit(t,Entity.Event.DRAG_START),!1)):!0},onInputMove:function(t,e){return this.enablePicking?(this._checkHover(t),this._checkDrag(t)?(t.entity=this.hoverEntity,void 0):(t.entity=this.hoverEntity,void 0)):void 0},getByID:function(t){for(var e=this.entities.buffer,i=this.entities.length,s=0;i>s;s++)if(t===e[s].id)return e[s]},getByName:function(t){for(var e=this.entities.buffer,i=this.entities.length,s=0;i>s;s++)if(t===e[s].name)return e[s]},getUniqueID:function(){return++this._uniqueID},set cellMagnitue(t){this._cellMagnitue!==t&&(this._cellMagnitue=t,this._cellSizeX=128*t,this._cellSizeY=128*t,this.isNeedRender=!0)},get cellMagnitue(){return this._cellMagnitue},Flag:{UPDATE_HOVER:128},InputFlag:null,_x:0,_y:0,totalZ:0,_depthNode:null,totalAngleRad:0,totalAlpha:1,totalScaleX:1,totalScaleY:1,volume:null,pivotX:0,pivotY:0,_flags:0,cells:null,_cellSizeX:128,_cellSizeY:128,_cellMagnitue:1,startCellX:0,startCellY:0,endCellX:0,endCellY:0,prevStartCellX:0,prevStartCellY:0,prevEndCellX:0,prevEndCellY:0,_numCellX:0,_numCellY:0,entities:null,numEntities:0,updateFlag:0,entitiesToCheck:null,entitiesToRemove:null,entitiesToUpdate:null,entitiesRemoveUpdate:null,detachBuffer:null,dynamicEntities:null,numEntitiesToCheck:0,numEntitiesToUpdate:0,numEntitiesRemoveUpdate:0,numShowBounds:0,numDetachItems:0,isLoaded:!0,_parent:null,childOffsetX:0,childOffsetY:0,hoverEntity:null,pressedEntity:null,isNeedRender:!0,needDepthSort:!1,enablePicking:!0,showBounds:!1,showCells:!1,_uniqueID:0,_centerTex:null,_chnOnDown:null,_chnOnUp:null,_chnOnClick:null,_chnOnDbClick:null,_chnOnDrag:null,_chnOnDragStart:null,_chnOnDragEnd:null,_chnOnHover:null,_chnOnHoverEnter:null,_chnOnHoverExit:null}),"use strict",Entity.Event={INPUT_UP:"entityUp",INPUT_DOWN:"entityDown",CLICK:"entityClick",DBCLICK:"entityDbClick",DRAG:"drag",DRAG_START:"dragStart",DRAG_END:"dragEnd",HOVER:"hover",HOVER_ENTER:"hoverEnter",HOVER_EXIT:"hoverExit",STATE_CHANGE:"stateChange"},Entity.PositionType={CENTER:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_LEFT:3,BOTTOM_RIGHT:4,TOP:5,BOTTOM:6,LEFT:7,RIGHT:8},"use strict";var Renderer={};Renderer.WebGL=Entity.Controller.extend({init:function(){this._super();var t=meta.ctx;this._worldTex=new Resource.Texture,this._worldTex.fillRect({color:"#7AA3CC",width:1,height:1}),this._highlightTex=new Resource.Texture,this._highlightTex.fillRect({color:"#339933",width:6,height:6}),this._position=new Float32Array([0,0]),this._center=new Float32Array([0,0]),this._scale=new Float32Array([0,0]),this.cameraPos=new Float32Array([0,0]);var e=[0,0,1,0,0,1,1,1];this.texCoord=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texCoord),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);var i=[0,1,3,2,0];this._lineIndices=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._lineIndices),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),t.STATIC_DRAW),this._frameCoord=new Float32Array(4),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.activeTexture(t.TEXTURE0),t.enable(t.BLEND);var s=meta.shader;this.locCameraPos=t.getUniformLocation(s.program,"cameraPos"),this.locZoom=t.getUniformLocation(s.program,"zoom"),this.locSampler=t.getUniformLocation(s.program,"sampler"),this.locAlpha=t.getUniformLocation(s.program,"alpha"),this.locPos=t.getUniformLocation(s.program,"pos"),this.locCenter=t.getUniformLocation(s.program,"center"),this.locScale=t.getUniformLocation(s.program,"scale"),this.locFrameCoord=t.getUniformLocation(s.program,"frameCoord"),this.locAngle=t.getUniformLocation(s.program,"angle")},ready:function(){meta.shader.bindBuffer2f("texCoord",this.texCoord)},render:function(t){this.updateFlag|=2;var e,i;for(i=0;i<this.numEntities;i++)e=this.entities[i],e.isNeedStyle&&e._style.update(e),e._texture&&e.isAnimating&&e._updateAnim(t);if(!this.isNeedRender)return this.updateFlag&=-3,void 0;var s=meta,n=s.ctx,o=s.shader,h=s.camera,r=s.unitSize,a,u,c,l,d;for(this.clearScreen(),this.cameraPos[0]=h._x*meta.unitSize|0,this.cameraPos[1]=h._y*meta.unitSize|0,n.uniform2fv(this.locCameraPos,this.cameraPos),n.uniform1f(this.locZoom,meta.camera._zoom*meta.unitRatio),n.uniform1i(this.locSampler,0),i=0;i<this.numEntities;i++)e=this.entities[i],e.isVisible&&e.isLoaded&&e.texture&&(a=e._texture,o.bindBuffer2f("vertexPos",a.vbo),this._clipVolume!==e.clipVolume&&(e.clipVolume?(this._clipVolume||n.enable(n.SCISSOR_TEST),this._clipVolume=e.clipVolume,u=(this._clipVolume.minX+h._x)*h._zoom,l=(this._clipVolume.maxX+h._x)*h._zoom,c=(h.volume.height-(this._clipVolume.maxY+h._y))*h._zoom,d=(h.volume.height-(this._clipVolume.minY+h._y))*h._zoom,n.scissor(0|u,0|c,Math.ceil(l-u),Math.ceil(d-c))):(n.disable(n.SCISSOR_TEST),this._clipVolume=null)),this._position[0]=1===e._flipX?e.volume.minX*r|0:(e.volume.minX+e.volume.width)*r|0,this._position[1]=1===e._flipY?e.volume.minY*r|0:(e.volume.minY+e.volume.height)*r|0,this._center[0]=(e.volume.x-e.pivotX)*r,this._center[1]=(e.volume.y-e.pivotY)*r,this._scale[0]=e.totalScaleX*e._flipX,this._scale[1]=e.totalScaleY*e._flipY,this._frameCoord[0]=a._x+e.currFrame%e._texture.numFramesX*a._xRatio,this._frameCoord[1]=a._y+Math.floor(e.currFrame/e._texture.numFramesX)*a._yRatio,this._frameCoord[2]=a._widthRatio,this._frameCoord[3]=a._heightRatio,n.uniform1f(this.locAlpha,e.totalAlpha),n.uniform2fv(this.locPos,this._position),n.uniform2fv(this.locCenter,this._center),n.uniform2fv(this.locScale,this._scale),n.uniform4fv(this.locFrameCoord,this._frameCoord),n.uniform1f(this.locAngle,e.totalAngleRad),a.fromAtlas?n.bindTexture(n.TEXTURE_2D,a.ptr.image):n.bindTexture(n.TEXTURE_2D,a.image),e.ignoreZoom?(n.uniform1f(this.locZoom,1),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.uniform1f(this.locZoom,meta.camera._zoom)):n.drawArrays(n.TRIANGLE_STRIP,0,4),e._isNeedDraw=!1);if(this._clipVolume&&n.disable(n.SCISSOR_TEST),this.numShowBounds>0||this.showBounds){for(n.disable(n.BLEND),n.uniform1f(this.locAlpha,1),n.lineWidth(2),i=0;i<this.numEntities;i++)e=this.entities[i],(e.showBounds||this.showBounds)&&!e.disableDebug&&e.isVisible&&e.isLoaded&&(this._position[0]=1===e._flipX?e.volume.minX*r|0:(e.volume.minX+e.volume.width)*r|0,this._position[1]=1===e._flipY?e.volume.minY*r|0:(e.volume.minY+e.volume.height)*r|0,e.isChild?(this._center[0]=(e._parent.volume.x-e._parent.pivotX+e.volume.x)*r,this._center[1]=(e._parent.volume.y-e._parent.pivotY+e.volume.y)*r):(this._center[0]=(e.volume.x-e.pivotX)*r,this._center[1]=(e.volume.y-e.pivotY)*r),this._scale[0]=e.totalScaleX*e._flipX,this._scale[1]=e.totalScaleY*e._flipY,e.isHighlight?n.bindTexture(n.TEXTURE_2D,this._highlightTex.image):n.bindTexture(n.TEXTURE_2D,this._centerTex.image),n.uniform2fv(this.locPos,this._position),n.uniform2fv(this.locCenter,this._center),n.uniform2fv(this.locScale,this._scale),n.uniform1f(this.locAngle,e.totalAngleRad),o.bindBuffer2f("vertexPos",e.texture.vbo),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._lineIndices),n.drawElements(n.LINE_STRIP,5,n.UNSIGNED_SHORT,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),o.bindBuffer2f("vertexPos",this._centerTex.vbo),e.isHighlight?n.bindTexture(n.TEXTURE_2D,this._highlightTex.image):n.bindTexture(n.TEXTURE_2D,this._centerTex.image),n.lineWidth(2),this._position[0]=(e.volume.x-e.pivotX-3)*r,this._position[1]=(e.volume.y-e.pivotY-3)*r,this._scale[0]=r,this._scale[1]=r,n.uniform2fv(this.locPos,this._position),n.uniform2fv(this.locScale,this._scale),e.ignoreZoom?(n.uniform1f(this.locZoom,1),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.uniform1f(this.locZoom,meta.camera._zoom)):n.drawArrays(n.TRIANGLE_STRIP,0,4));n.enable(n.BLEND)
}var m=meta.world;if(m.showBounds){if(o.bindBuffer2f("vertexPos",this._worldTex.vbo),n.bindTexture(n.TEXTURE_2D,this._worldTex.image),this._scale[0]=m.width,this._scale[1]=m.height,n.uniform2fv(this.locScale,this._scale),this._position[0]=0,this._position[1]=0,n.uniform2fv(this.locPos,this._position),this._center[0]=0,this._center[1]=0,n.uniform2fv(this.locCenter,this._center),n.uniform1f(this.locAngle,0),n.uniform1f(this.locAlpha,1),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._lineIndices),n.lineWidth(2),n.drawElements(n.LINE_STRIP,5,n.UNSIGNED_SHORT,0),m.haveGrid){var _=m.numGridX,f=m.numGridY;this._scale[0]=m.gridWidth,this._scale[1]=m.gridHeight,n.uniform2fv(this.locScale,this._scale);for(var p=0;f>p;p++)for(var v=0;_>v;v++)this._position[0]=v*m.gridWidth+m.gridX,this._position[1]=p*m.gridHeight+m.gridY,n.uniform2fv(this.locPos,this._position),n.drawElements(n.LINE_STRIP,5,n.UNSIGNED_SHORT,0)}n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}this.isNeedRender=!1,this.updateFlag&=-3},clearScreen:function(){var t=meta.ctx;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)},_worldTex:null,_highlightTex:null,_position:null,_center:null,_scale:null,_frameCoord:null,_clipVolume:null,locCameraPos:null,locZoom:null,locSampler:null,locAlpha:null,locPos:null,locCenter:null,locScale:null,locFrameCoord:null,locAngle:null}),"use strict",Renderer.Canvas=Entity.Controller.extend({init:function(){meta.subscribe(this,meta.Event.CAMERA_RESIZE,this.onCameraResize),this._super(),this._tStaticCheck=Date.now()},release:function(){this._super(),meta.unsubscribe(this,meta.Event.CAMERA_RESIZE)},render:function(t){if(this.isNeedRender)this._renderAll(i,t);else for(var e,i=0;i<this.numEntities;i++)if(e=this.entities[i],e.isNeedStyle&&e._style.update(e),e._texture&&e.isAnimating&&e._updateAnim(t),e._isLoaded&&e.isNeedDraw){this._reRender(i,t);break}},_reRender:function(t,e){this.clearScreen();var i=meta,s=i.ctx,n=i.camera,o=i.unitRatio,h=i.unitSize;s.save(),s.translate(this.x*n._zoom|0,this.y*n._zoom|0),s.scale(n._zoom*o,n._zoom*o);for(var r,t=0;t<this.numEntities;t++)if(r=this.entities[t],!r._isCached&&r.isVisible&&r._isLoaded){if(this._clipVolume!==r.clipVolume){if(null===r.clipVolume)s.restore();else{s.save();var a=r.clipVolume;s.beginPath(),s.rect(a.minX*h|0,a.minY*h|0,a.width*h,a.height*h),s.closePath(),s.clip()}this._clipVolume=r.clipVolume}r.ignoreZoom?(s.restore(),s.save(),r.draw(s),s.scale(n._zoom*o,n._zoom*o)):r.draw(s),r._isNeedDraw=!1}for(;t<this.numEntities;t++)if(r=this.entities[t],r.isNeedStyle&&r._style.update(r),r._texture&&r.isAnimating&&r._updateAnim(e),!r._isCached&&r.isVisible&&r._isLoaded){if(this._clipVolume!==r.clipVolume){if(null===r.clipVolume)s.restore();else{s.save();var a=r.clipVolume;s.beginPath(),s.rect(a.minX*h|0,a.minY*h|0,a.width*h,a.height*h),s.closePath(),s.clip()}this._clipVolume=r.clipVolume}r.ignoreZoom?(s.restore(),s.save(),r.draw(s),s.scale(n._zoom*o,n._zoom*o)):r.draw(s),r._isNeedDraw=!1}null!==this._clipVolume&&(this._clipVolume=null,s.restore()),s.restore(),s.save(),s.scale(n._zoom,n._zoom),s.translate(0|this.x,0|this.y),this._drawBounds(),this.showCells&&this._drawCells(),s.restore(),this.isNeedRender=!1},_renderAll:function(t,e){this.clearScreen();var i=meta,s=i.ctx,n=i.camera,o=i.unitRatio,h=i.unitSize;s.save(),s.translate(this.x*n._zoom|0,this.y*n._zoom|0),s.scale(n._zoom*o,n._zoom*o);for(var r,a=0;a<this.numEntities;a++)if(r=this.entities[a],r.isNeedStyle&&r._style.update(r),r._texture&&r.isAnimating&&r._updateAnim(e),!r._isCached&&r.isVisible&&r._isLoaded){if(this._clipVolume!==r.clipVolume){if(null===r.clipVolume)s.restore();else{s.save();var u=r.clipVolume;s.beginPath(),s.rect(u.minX*h|0,u.minY*h|0,u.width*h,u.height*h),s.closePath(),s.clip()}this._clipVolume=r.clipVolume}r.ignoreZoom?(s.restore(),s.save(),r.draw(s),s.scale(n._zoom*o,n._zoom*o)):r.draw(s),r._isNeedDraw=!1}null!==this._clipVolume&&(this._clipVolume=null,s.restore()),s.restore(),s.save(),s.scale(n._zoom,n._zoom),s.translate(0|this.x,0|this.y),this._drawBounds(),this.showCells&&this._drawCells(),s.restore(),this.isNeedRender=!1},clearScreen:function(){var t=meta;t.view.bgTransparent?t.ctx.clearRect(0,0,t.width,t.height):(t.ctx.fillStyle=t.engine.bgColor,t.ctx.fillRect(0,0,t.width,t.height))},_drawBounds:function(){if(this.numShowBounds>0||this.showBounds){var t=!1,e=meta.unitSize,i=meta.unitRatio,s=meta.camera,n=meta.ctx;n.strokeStyle="#ff0000",n.lineWidth=2;for(var o,h,r,a,u,c=0;c<this.numEntities;c++)o=this.entities[c],(o.showBounds||this.showBounds)&&!o.disableDebug&&o.isVisible&&o.isLoaded&&o.drawBounds(n)}},_drawWorldBounds:function(){var t=meta.world;if(t.showBounds){var e=meta.ctx;if(e.translate(this.x,this.y),e.strokeStyle="#7AA3CC",e.lineWidth=2,t.volume.draw(e),t.haveGrid){var i=t.numGridX,s=t.numGridY,n=i*t.gridWidth,o=s*t.gridHeight;e.translate(t.gridX,t.gridY);for(var h=0;i>=h;h++)e.moveTo(h*t.gridWidth,0),e.lineTo(h*t.gridHeight,o);for(var r=0;s>=r;r++)e.moveTo(0,r*t.gridHeight),e.lineTo(n,r*t.gridHeight);e.stroke()}}},_drawCells:function(){var t=meta.unitSize,e=meta.ctx;e.strokeStyle="orange",e.lineWidth=2,e.beginPath();for(var i=this.x%this._cellSizeX,s=this.y%this._cellSizeY,n=this.endCellX-this.startCellX,o=this.endCellY-this.startCellY,h=0;n>=h;h++)e.moveTo(i+h*this._cellSizeX,0),e.lineTo(i+h*this._cellSizeX,meta.camera.height);for(var r=0;o>=r;r++)e.moveTo(0,s+r*this._cellSizeY),e.lineTo(meta.camera.width,s+r*this._cellSizeY);e.stroke()},cacheEntity:function(t){},uncacheEntity:function(t){},onCameraResize:function(t,e){},_cachedCanvas:null,_cachedCtx:null,_cacheOffsetX:0,_cacheOffsetY:0,_tStaticCheck:0,tStaticCheckDelay:500,_clipVolume:null,x:0,y:0}),"use strict",Entity.Geometry=meta.Class.extend({_init:function(t){this.id=this._entityCtrl.getUniqueID(),this.name="entity"+this.id,this.core=new this.Core,this.volume=new meta.math.AdvAABB(0,0,0,0),this._parent=this._entityCtrl,this._initParams(t)},_initParams:function(t){if(t)if("object"==typeof t)if(t instanceof Resource.Texture)this.texture=t;else if(t instanceof Entity.Geometry)this.texture=t.texture;else for(var e in t)this[e]=t[e];else"string"==typeof t&&(this.texture=t)},get parent(){return this._parent},remove:function(){this._parent===this._entityCtrl?this._view.detach(this):this.removeCore()},removeCore:function(){this.isRemoved||(this.isUpdating=!1,this.isRemoved=!0,this._view=null,this._texture&&this._texture.unsubscribe(this),this._tween&&(this._tween.clear(),this._tween.owner=null),this.removeChildren(),this.removeComponents())},removeChildren:function(){if(this.children)for(var t=this.children.length,e=0;t>e;e++)this.children[e].removeCore()},clone:function(){var t=new Entity.Geometry;for(var e in this)t[e]!==this[e]&&(t[e]=this[e]);return t.id=this._entityCtrl.getUniqueID(),t},draw:function(t){this._draw(t)},_draw:function(t){this._drawDefault(t)},_drawDefault:function(t){if(this._texture){var e=this.meta.unitSize;this._texture.isAnimated?this._texture.drawFrame(t,(0|this.drawX)*e,(0|this.drawY)*e,this._currFrame,this.isEmulateReverse):this._texture.draw(t,(0|this.drawX)*e,(0|this.drawY)*e)}},_drawTransform:function(t){if(this._texture){t.save(),t.globalAlpha=this.totalAlpha;var e=this.meta.unitSize,i=(this.volume.x-this.pivotX)*e,s=(this.volume.y-this.pivotY)*e;if(this.isChild){var n=(this._parent.volume.x-this._parent.pivotX)*e,o=(this._parent.volume.y-this._parent.pivotY)*e;t.translate(n,o),t.rotate(this._parent.totalAngleRad),t.translate(-n,-o)}t.translate(i,s),t.rotate(this._angleRad),t.scale(this.totalScaleX*this._flipX,this.totalScaleY*this._flipY),t.translate(-i,-s),this.texture.isAnimated?this._texture.drawFrame(t,(0|this.drawX)*e,(0|this.drawY)*e,this._currFrame,this.isEmulateReverse):this._texture.draw(t,(0|this.drawX)*e,(0|this.drawY)*e),t.restore()}},renderBounds:function(t){isCached!==entity._isCached&&(t.strokeStyle=entity.isCached||entity.isHighlight?"#339933":"#ff0000",isCached=!isCached),t.save(),pivotOffsetX=entity.volume.x-entity.pivotX,pivotOffsetY=entity.volume.y-entity.pivotY,entity.isChild||(parentOffsetX=entity._parent.volume.x-entity._parent.pivotX,parentOffsetY=entity._parent.volume.y-entity._parent.pivotY,t.translate(parentOffsetX,parentOffsetY),t.rotate(entity._parent.totalAngleRad),t.scale(this.totalScaleX*this._flipX,this.totalScaleY*this._flipY),t.translate(-parentOffsetX,-parentOffsetY)),t.translate(pivotOffsetX,pivotOffsetY),t.rotate(entity._angleRad),t.scale(this.totalScaleX*this._flipX,this.totalScaleY*this._flipY),t.translate(-pivotOffsetX,-pivotOffsetY),this._centerTex.draw(t,pivotOffsetX-3,pivotOffsetY-3),t.restore()},drawBounds:function(t){this.volume.draw(t)},update:null,_updateComponents:function(t){for(var e,i=this.components.length,s=0;i>s;s++)e=this.components[s],e.update&&e.update(t)},_updateAnim:function(t){if(!(this.animSpeed<=0||this._texture.numFrames<2)){var e=1/(this.fps*this.animSpeed);if(this._tAnim+=t,!(this._tAnim<e)){this.isNeedDraw=!0;var i=this._tAnim/e|0;this._tAnim-=e*i,this._isAnimReverse?(this._currFrame-=i,this._currFrame<0&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=0):this.isLoop||this._texture.isLoop?this._currFrame=(this._texture.numFrames+this._currFrame)%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1),this.onAnimEnd&&this.onAnimEnd())):(this._currFrame+=i,this._currFrame>=this._texture.numFrames&&(this.pauseAtEnd?(this.isAnimating=!1,this._currFrame=this._texture.numFrames-1):this.isLoop||this._texture.isLoop?this._currFrame=this._currFrame%this._texture.numFrames:(this.isAnimating=!1,this._currFrame=0),this.onAnimEnd&&this.onAnimEnd()))}}},play:function(t,e){this.texture&&this.texture.isAnimated&&(this.isLoop=t?!0:!1,this.fps=e||this.texture.fps,this.currFrame=0,this.isAnimating=!0,this.pauseAtEnd=!1,this._isAnimReverse=!1)},playAndPause:function(t){this.play(!1,t),this.pauseAtEnd=!0},playReverse:function(t,e){this.texture&&(this.play(t,e),this.currFrame=this.texture.numFrames-1,this._isAnimReverse=!0)},playReverseAndPause:function(t){this.playReverse(!1,t),this.pauseAtEnd=!0},stop:function(){this._texture?(this.isLoop=this._texture.isLoop,this.currFrame=this._isAnimReverse?this._texture.numFrames-1:0):(this.isLoop=!1,this.currFrame=0),this.isAnimating=!1},pause:function(){this.isAnimating=!1},resume:function(){this.isAnimating=!0},forcePosition:function(t,e){this._x=t,this._y=e,this.updatePos()},updatePos:function(){if(this._tmpX=this._x+this.textureOffsetX+this.offsetX+this._anchorPosX+this._parent.childOffsetX,this._tmpY=this._y+this.textureOffsetY+this.offsetY+this._anchorPosY+this._parent.childOffsetY,this._view&&(this._tmpX+=this._view._x,this._tmpY+=this._view._y),this.volume.set(this._tmpX+this.pivotX,this._tmpY+this.pivotY),this.drawX=this._tmpX-this.volume.initHalfWidth+this.pivotSrcX,this.drawY=this._tmpY-this.volume.initHalfHeight+this.pivotSrcY,this.children){this.childOffsetX=this._x+this._parent.childOffsetX+this.childPivotX+this._anchorPosX+this.offsetX,this.childOffsetY=this._y+this._parent.childOffsetY+this.childPivotY+this._anchorPosY+this.offsetY;for(var t=this.children.length,e=0;t>e;e++)this.children[e].updatePos()}this.isNeedDraw=!0},updatePosType:function(){0!==this.positionType&&(1===this.positionType?(this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0):2===this.positionType?(this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0):3===this.positionType?(this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0):4===this.positionType?(this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0):5===this.positionType?this._y=this.typeY+this.volume.halfHeight|0:6===this.positionType?this._y=this.typeY-this.volume.halfHeight|0:7===this.positionType?this._x=this.typeX+this.volume.halfWidth|0:8===this.positionType&&(this._x=this.typeX-this.volume.halfWidth|0))},updateFromTexture:function(){var t=this.meta.unitRatio;if(this.volume.resize(this._texture.trueWidth*t,this._texture.trueHeight*t),this.updatePivot(),this.updatePosType(),this.updatePos(),this.children)for(var e=this.children.length,i=0;e>i;i++){var s=this.children[i];s.positionType&&s.updatePosType(),s.updateAnchor()}},adapt:function(){this._texture||(this.volume.unitSize=meta.unitSize,this.updatePosType(),this.updatePos())},position:function(t,e){this.positionType=0,(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this.updatePos())},move:function(t,e){var i=this._x+t,s=this._y+e;(this._x!==i||this._y!==s)&&this.forcePosition(i,s)},moveForward:function(t){var e=this._x+t*Math.cos(this._angleRad-1.57079),i=this._y+t*Math.sin(this._angleRad-1.57079);(this._x!==e||this._y!==i)&&this.forcePosition(e,i)},moveDirected:function(t,e){var i=this._x+-t*Math.cos(this._angleRad-1.57079+e),s=this._y+-t*Math.sin(this._angleRad-1.57079+e);(this._x!==i||this._y!==s)&&this.forcePosition(i,s)},strafe:function(t){var e=this._x+-t*Math.cos(this._angleRad+Math.PI),i=this._y+-t*Math.sin(this._angleRad+Math.PI);(this._x!==e||this._y!==i)&&this.forcePosition(e,i)},positionTopLeft:function(t,e){(this._x!==t||this._y!==e||1!==this.positionType)&&(this.positionType=1,this.typeX=t,this.typeY=e,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionTopRight:function(t,e){(this._x!==t||this._y!==e||2!==this.positionType)&&(this.positionType=2,this.typeX=t,this.typeY=e,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionBottomLeft:function(t,e){(this._x!==t||this._y!==e||3!==this.positionType)&&(this.positionType=3,this.typeX=t,this.typeY=e,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionBottomRight:function(t,e){(this._x!==t||this._y!==e||4!==this.positionType)&&(this.positionType=4,this.typeX=t,this.typeY=e,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionTop:function(t,e){(this._x!==t||this._y!==e||5!==this.positionType)&&(this.positionType=5,this.typeX=t,this.typeY=e,this._x=t,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},positionBottom:function(t,e){(this._x!==t||this._y!==e||6!==this.positionType)&&(this.positionType=6,this.typeX=t,this.typeY=e,this._x=t,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},positionLeft:function(t,e){(this._x!==t||this._y!==e||7!==this.positionType)&&(this.positionType=7,this.typeX=t,this.typeY=e,this._x=this.typeX+this.volume.halfWidth|0,this._y=e,this.updatePos())},positionRight:function(t,e){(this._x!==t||this._y!==e||8!==this.positionType)&&(this.positionType=8,this.typeX=t,this.typeY=e,this._x=this.typeX-this.volume.halfWidth|0,this._y=e,this.updatePos())},topLeft:function(t,e){(this._x!==t||this._y!==e||1!==this.positionType)&&(this.positionType=1,this.typeX=t,this.typeY=e,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},topRight:function(t,e){(this._x!==t||this._y!==e||2!==this.positionType)&&(this.positionType=2,this.typeX=t,this.typeY=e,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY+this.volume.halfHeight|0,this.updatePos())},bottomLeft:function(t,e){(this._x!==t||this._y!==e||3!==this.positionType)&&(this.positionType=3,this.typeX=t,this.typeY=e,this._x=this.typeX+this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},bottomRight:function(t,e){(this._x!==t||this._y!==e||4!==this.positionType)&&(this.positionType=4,this.typeX=t,this.typeY=e,this._x=this.typeX-this.volume.halfWidth|0,this._y=this.typeY-this.volume.halfHeight|0,this.updatePos())},set top(t){this.positionTop(this._x,t)},set bottom(t){this.positionBottom(this._x,t)},set left(t){this.positionLeft(t,this._y)},set right(t){this.positionRight(t,this._y)},get top(){return this.volume.minY},get bottom(){return this.volume.maxY},get left(){return this.volume.minX},get right(){return this.volume.maxX},pivot:function(t,e){void 0===e&&(e=t),this.pivotRatioX=t,this.pivotRatioY=e,this.updatePivot(),this.updatePos()},updatePivot:function(){this.pivotSrcX=-this.pivotRatioX*this._flipX*this.volume.initHalfWidth,this.pivotSrcY=-this.pivotRatioY*this._flipY*this.volume.initHalfHeight,this.pivotX=this.pivotSrcX*this._scaleX,this.pivotY=this.pivotSrcY*this._scaleY,this.children&&(this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight)},pivotPx:function(t,e){void 0===e&&(e=t),this.pivotX=t,this.pivotY=e,this.children&&(this.childOffsetX=this._x+pivotX+this._anchorPosX,this.childOffsetY=this._y+pivotY+this._anchorPosY),this.updatePos()},pivotCenter:function(t,e){return 0!==this.pivotRatioX||0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotTopLeft:function(t,e){return-1!==this.pivotRatioX||-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotTopRight:function(t,e){return 1!==this.pivotRatioX||-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotBottomLeft:function(t,e){return-1!==this.pivotRatioX||1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotBottomRight:function(t,e){return 1!==this.pivotRatioX||1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotTop:function(t,e){return 0!==this.pivotRatioX||-1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,-1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotBottom:function(t,e){return 0!==this.pivotRatioX||1!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(0,1),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotLeft:function(t,e){return-1!==this.pivotRatioX||0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(-1,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},pivotRight:function(t,e){return 1!==this.pivotRatioX||0!==this.pivotRatioY?(this._x=t,this._y=e,this.pivot(1,0),void 0):((this._x!==t||this._y!==e)&&this.forcePosition(t,e),void 0)},anchor:function(t,e){void 0===e&&(e=t),(this._anchorX!==t||this._anchorY!==e)&&(this._anchorX=t,this._anchorY=e,this._flags|=this.Flag.ANCHOR,this.updateAnchor())},updateAnchor:function(){this._flags&this.Flag.IGNORE_ZOOM?(this._anchorPosX=this._parent.volume.width*(1/this._parent.volume.scaleX)*this._anchorX+.5|0,this._anchorPosY=this._parent.volume.height*(1/this._parent.volume.scaleY)*this._anchorY+.5|0):(this._anchorPosX=this._parent.volume.width*this._anchorX+.5|0,this._anchorPosY=this._parent.volume.height*this._anchorY+.5|0),this.updatePos()},dragStart:function(t,e){this._dragOffsetX=this._x+this._anchorPosX-t,this._dragOffsetY=this._y+this._anchorPosY-e},dragEnd:function(){this._dragOffsetX=0,this._dragOffsetY=0},dragTo:function(t,e){t-=this._anchorPosX-this._dragOffsetX,e-=this._anchorPosY-this._dragOffsetY,(this._x!==t||this._y!==e)&&this.forcePosition(t,e)},isInside:function(t,e){return this.volume.vsBorderPoint(t-this.offsetX,e-this.offsetY)},_isInsideDefault:function(t,e){return this.volume.vsBorderPoint(t-this.offsetX,e-this.offsetY)},_isInsideTransform:function(t,e){var i=this._anchorPosX+this._parent.childOffsetX,s=this._anchorPosY+this._parent.childOffsetY;this.isChild||(i+=this._x,s+=this._y);var n=t-i,o=e-s,h=Math.sin(-this._angleRad),r=Math.cos(-this._angleRad),a=n*r-o*h+i,u=o*r+n*h+s;return this.volume.vsBorderPoint(a,u)},vsEntity:function(t){return this.volume.vsAABB(t.volume)},resize:function(t,e){if(void 0===e&&(e=this.volume.height),this.volume.resize(t,e),this.children)for(var i=this.children.length,s=0;i>s;s++)this.children[s]._onResize(this)},_onTextureEvent:function(t,e){var i=Resource.Event;e===i.LOADED?(this.updateFromTexture(),this.isLoaded=!0):e===i.UNLOADED?this.isLoaded=!1:e===i.RESIZE?this.updateFromTexture():e===i.CHANGED&&this.updateFromTexture(),this.isNeedDraw=!0},_onResAllLoaded:function(t,e){if("string"==typeof this._texture){var i=meta.getTexture(this._texture);i?this.texture=i:(console.warn("[Entity.Geometry._onResAllLoaded]:","Could not find texture with a name: "+this._texture),this._texture=null),meta.unsubscribe(this,Resource.Event.ALL_LOADED)}},attach:function(t,e){if(!t)return console.error("(Entity.Geometry.attach) Invalid child object passed."),void 0;if(t.isChild)return console.error("(Entity.Geometry.attach) Entity is already a child of someone else."),void 0;if(t.isRemoved)return console.error("(Entity.Geometry.attach) Entity is marked as removed ro to be removed."),void 0;if(!t._view||t._view===this._view&&t.isChild||t._view._removeFromBuffer(t),e&&t.move(-this._x-this._anchorPosX-this.pivotX+this.volume.halfWidth,-this._y-this._anchorPosY-this.pivotY+this.volume.halfHeight),t._parent=this,t.isChild=!0,t.ignoreZoom=this.ignoreZoom,t.disableDebug=this.disableDebug,t._view=this._view,this.clipVolume&&!t.clipVolume&&t.clip(this.clipVolume),this.pickable||(t.pickable=!1),this.clickable||(t.clickable=!1),t.updateAngle(),t.updateAlpha(),(1!==this.totalScaleX||1!==this.totalScaleY)&&t.updateScale(),t.updateZ(),this.children)this.children.push(t);else{this.children=[t],this.childPivotX=(-this.pivotRatioX-1)*this.volume.halfWidth,this.childPivotY=(-this.pivotRatioY-1)*this.volume.halfHeight,this.childOffsetX=this._x+this.childPivotX+this._anchorPosX,this.childOffsetY=this._y+this.childPivotY+this._anchorPosY;for(var i=this._parent;i;)this.childOffsetX+=i.childOffsetX,this.childOffsetY+=i.childOffsetY,i=i._parent;this.updatePos()}t._flags&this.Flag.ANCHOR&&t.updateAnchor(),this._flags&this.Flag.IGNORE_ZOOM&&(t.ignoreZoom=this.ignoreZoom),t.updatePos(),this._view&&this._view._isActive&&this._entityCtrl.addEntities(t),this.onChildAdded(t),t.onParentAdded(this)},detach:function(t){if(t){if(!this.children)return;for(var e,i=this.children.length,s=0;i>s;s++)if(e=this.children[s],!e.isRemoved&&e===t)return e._parent=this._entityCtrl,e._view=null,e.isChild=!1,this._view.add(e),e.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight),this.onChildRemoved(e),e.onParentRemoved(this),void 0}else{if(!this.isChild)return;this._parent.detach(this)}},detachChildren:function(){if(this.children){var t,e,i=this.children.length;for(t=0;i>t;t++)e=this.children[t],e.isRemoved||(e._parent=this._entityCtrl,e._view=null,e.isChild=!1,this._view.add(e),e.move(this._x+this._anchorPosX+this.pivotX-this.volume.halfWidth,this._y+this._anchorPosY+this.pivotY-this.volume.halfHeight),this.onChildRemoved(e),e.onParentRemoved(this));this.children.length=0}},detachExact:function(){for(var t,e=this.children.length,i=0;e>i;i++)t=this.children[i],t.isRemoved||(t._x+=this.childOffsetX,t._y+=this.childOffsetY,t._parent=this._entityCtrl,t._view=null,t.isChild=!1,this._view.add(t),t.forcePosition(t._x,t._y),this.onChildRemoved(t),t.onParentRemoved(this));this.children.length=0},clip:function(t,e,i,s){if(this.clipVolume="object"==typeof t?t instanceof meta.math.AdvAABB||t instanceof meta.math.AABB?t:t.volume:new meta.math.AdvAABB(t,e,i,s),this.children)for(var n=this.children.length,o=0;n>o;o++)this.children[o].clip(this.clipVolume);return this.isNeedDraw=!0,this.clipVolume},_onClick:meta.emptyFuncParam,_onDbClick:meta.emptyFuncParam,_onDown:function(t){this._action="pressed",this._style.updateAction(this)},_onUp:function(t){this._inputFlags>0?this._inputFlags&this.InputFlag.DRAGGED?this._action="drag":this._inputFlags&this.InputFlag.HOVER?this._action="hover":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},_onDragStart:function(){this._action="drag",this._style.updateAction(this)},_onDragEnd:function(){this._inputFlags>0?this._inputFlags&this.InputFlag.PRESSED?this._action="pressed":this._inputFlags&this.InputFlag.HOVER?this._action="hover":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},_onHoverEnter:function(){this._action="hover",this._style.updateAction(this)},_onHoverExit:function(){this._inputFlags>0?this._inputFlags&this.InputFlag.DRAGGED?this._action="drag":this._inputFlags&this.InputFlag.PRESSED?this._action="pressed":(console.warn("[Entity.Geometry._onAction_hoverExit]:","Unhandled action caught: "+this._inputFlags),this._action=""):this._action="",this._style.updateAction(this)},onDown:meta.emptyFuncParam,onUp:meta.emptyFuncParam,onClick:meta.emptyFuncParam,onDbClick:meta.emptyFuncParam,onDrag:meta.emptyFuncParam,onDragStart:meta.emptyFuncParam,onDragEnd:meta.emptyFuncParam,onHover:meta.emptyFuncParam,onHoverEnter:meta.emptyFuncParam,onHoverExit:meta.emptyFuncParam,onAnimEnd:null,onChildAdded:meta.emptyFuncParam,onChildRemoved:meta.emptyFuncParam,onParentAdded:meta.emptyFuncParam,onParentRemoved:meta.emptyFuncParam,_onChange:meta.emptyFunc,onChange:meta.emptyFunc,addComponent:function(t,e){if(!t)return console.warn("[Entity.Geometry.addComponent]:","No component specified."),null;var i=window.Component,s=null,n;if("string"==typeof t){for(n in i)if(n===t){s=new i[n];break}}else for(n in i)if(i[n]===t){s=new t;break}if(!s)return console.warn("[Entity.Geometry.addComponent]:","Invalid component - "+t),null;if(this.components?this.components.push(s):this.components=[s],s.owner=this,this[n]=s,e)for(n in e)s[n]=e[n];return this._isLoaded&&s.load&&s.load(),this.isReady&&s.update&&!this._isUpdating&&(this.isUpdating=!0),s},removeComponent:function(t){if(!t)return console.warn("[Entity.Geometry.removeComponent]:","No component specified."),void 0;if(!this.components)return console.warn("[Entity.Geometry.removeComponent]:","No such component found:",t),void 0;var e=this[t];if(this[t]=null,!e)return console.warn("[Entity.Geometry.removeComponent]:","No such component found:",t),void 0;e.unload&&e.unload();for(var i=this.components.length,s=0;i>s;s++)if(this.components[s]===e){this.components[s]=this.components[i-1],this.components.pop();break}},removeComponents:function(){if(this.components){for(var t,e=this.components.length,i=0;e>i;i++)t=this.components[i],t.unload&&t.unload();this.components.length=0}},distanceToEntity:function(t){var e=t.volume.x-this.volume.x,i=t.volume.y-this.volume.y;return Math.sqrt(e*e+i*i)},lookAt:function(t,e){this.angleRad=-Math.atan2(t-(this.volume.x+this.pivotX),e-(this.volume.y-this.pivotY))+Math.PI},lookAtEntity:function(t){this.lookAt(t._x+t._parent.childOffsetX,t._y+t._parent.childOffsetY)},getLookAt:function(t,e){this.angleRad=-Math.atan2(t-(this.x+this._anchorPosX+this._parent.childOffsetX),e-(this.y+this._anchorPosY+this._parent.childOffsetY))+Math.PI},subscribe:function(t,e){this.chn||(this.chn=meta.createChannel("__ent"+this.id)),this.chn.subscribe(t,e)},unsubscribe:function(t){this.chn&&(this.chn.unsubscribe(t),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(t,e){this.chn&&this.chn.emit(t,e)},print:function(t){t=t||"",console.log("[Entity",this.name+":"+this.id+"]",t)},get view(){return this._view},set x(t){this.position(t,this._y)},set y(t){this.position(this._x,t)},get x(){return this._x},get y(){return this._y},get absX(){return this.volume.x},get absY(){return this.volume.y},get width(){return this.volume.width},get height(){return this.volume.height},set anchorX(t){this.anchor(t,this._anchorY)},set anchorY(t){this.anchor(this._anchorX,t)},get anchorX(){return this._anchorX},get anchorY(){return this._anchorY},offset:function(t,e){(this._offsetX!==t||this._offsetY!==e)&&(this._offsetX=t,this._offsetY=e,this.updatePos())},set offsetX(t){this._offsetX!==t&&(this._offsetX=t,this.updatePos())},set offsetY(t){this._offsetY!==t&&(this._offsetY=t,this.updatePos())},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},set isAnchor(t){(this._flags&this.Flag.ANCHOR)!==t&&(t?this._flags|=this.Flag.ANCHOR:(this._anchorX=0,this._anchorY=0,this._anchorPosX=0,this._anchorPosY=0,this._flags^=this.Flag.ANCHOR),this.isNeedDraw=!0)},get isAnchor(){return this._flags&this.Flag.ANCHOR},get centerX(){return this._x+this._parent.childOffsetX+this.textureOffsetX},get centerY(){return this._y+this._parent.childOffsetY+this.textureOffsetY},set z(t){this._z=t,this.updateZ(),this._view&&(this._entityCtrl.needDepthSort=!0)},get z(){return this._z},updateZ:function(){var t=this._parent.totalZ+this._z+1;if(this._view&&(t+=this._view._z),this.totalZ!==t&&(this.totalZ=t,this.children))for(var e=this.children.length,i=0;e>i;i++)this.children[i].updateZ()},set texture(t){if("string"==typeof t){if(this._texture&&this._texture.name===t)return;var e=t;if(t=meta.getTexture(e),!t)return this._texture=e,meta.subscribe(this,Resource.Event.ALL_LOADED,this._onResAllLoaded),void 0}else if(this._texture===t)return;return this._texture instanceof Resource.Texture&&this._texture.unsubscribe(this),t?t instanceof Resource.Texture?(this._texture=t,this._texture.subscribe(this,this._onTextureEvent),this.textureOffsetX=this._texture._offsetX,this.textureOffsetY=this._texture._offsetY,this._texture._isLoaded?(this.isLoaded=!0,this.updateFromTexture()):(this.isLoaded=!1,this._texture.isLoading||this._texture.load()),t.isAnimated&&(this.isAnimating||(this.isAnimating=t.autoPlay),t.isEmulateReverse&&(this.isEmulateReverse=!0),this.isAnimReverse=t.isAnimReverse),t):(console.warn("[Entity.Geometry.texture]:","Texture should extend Resource.Texture class."),null):(this._texture=null,this.isLoaded=!1,void 0)},get texture(){return this._texture},set isNeedDraw(t){this._isLoaded&&(this._isNeedDraw=t,this._tChange=Date.now(),this._isCached&&this._entityCtrl.uncacheEntity(this),t&&(this._entityCtrl.isNeedRender=!0))},get isNeedDraw(){return this._isNeedDraw},updateStyle:function(){this._style&&this._style.update(this)},setState:function(t,e,i){e&&(i||(i={texture:e})),this._style||(t="*",this._style=new meta.Style,this._styleParams={}),this._style.setState(t,e)},set style(t){if(this._style)for(var e in this._styleParams)this[e]=this._styleParams[e];this._style=t instanceof meta.Style?t:new meta.Style(t),this.isNeedStyle=t?!0:!1},get style(){return this._style},set state(t){t||(t="*"),this._state!==t&&(this._state=t,this._onChange(),this.onChange(),this.chn&&this.chn.emit(Entity.Event.STATE_CHANGE,this),this._style&&(null===t?(this._styleState=null,this._styleAction=null,this.isNeedStyle=!1,this.texture=null):this.isNeedStyle=!0))},set action(t){this._action!==t&&(this._action=t,this._style&&this._style.updateAction(this))},get state(){return this._state},get action(){return this._action},updateAlpha:function(){var t;if(t=this._flags&this.Flag.IGNORE_PARENT_ALPHA?this._alpha:this._alpha*this._parent.totalAlpha,this.totalAlpha!==t){if(this.totalAlpha=t,this.children)for(var e=this.children.length,i=0;e>i;i++){var s=this.children[i];if(s._flag&this.Flag.IGNORE_PARENT_ALPHA)return;s.updateAlpha()}this._draw=this._drawTransform,this.isNeedDraw=!0}},set alpha(t){this._alpha!==t&&(this._alpha=t,this.updateAlpha())},get alpha(){return this._alpha},set ignoreParentAlpha(t){this._flags|=this.Flag.IGNORE_PARENT_ALPHA},get ignoreParentAlpha(){return this._flags&this.Flag.IGNORE_PARENT_ALPHA},updateAngle:function(){var t;if(t=this._flags&this.Flag.IGNORE_PARENT_ANGLE?this._angleRad:this._angleRad+this._parent.totalAngleRad,t!==this.totalAngleRad){if(this.totalAngleRad=t,this.children)for(var e=this.children.length,i=0;e>i;i++){var s=this.children[i];s._flags&this.Flag.IGNORE_PARENT_ANGLE||s.updateAngle()}this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0}},set angle(t){t=meta.math.degToRad(t),this._angleRad!==t&&(this._angleRad=t,this.updateAngle())
},get angle(){return meta.math.radToDeg(this._angleRad)},set angleRad(t){this._angleRad!==t&&(this._angleRad=t,this.updateAngle())},get angleRad(){return this._angleRad},set ignoreParentAngle(t){this._flags|=this.Flag.IGNORE_PARENT_ANGLE},get ignoreParentAngle(){return this._flags&this.Flag.IGNORE_PARENT_ANGLE},updateScale:function(){var t,e;if(this._flags&this.Flag.IGNORE_PARENT_SCALE?(t=this._scaleX,e=this._scaleY):(t=this._scaleX*this._parent.totalScaleX,e=this._scaleY*this._parent.totalScaleY),t!==this.totalScaleX||e!==this.totalScaleY){if(this.totalScaleX=t,this.totalScaleY=e,this.pivotX=this.pivotSrcX*t,this.pivotY=this.pivotSrcY*e,this.volume.scalePivoted(this.totalScaleX,this.totalScaleY,this.drawSrcX+this.pivotX,this.drawSrcY+this.pivotY),this.children)for(var i,s=this.children.length,n=0;s>n;n++)i=this.children[n],i._flag&this.Flag.IGNORE_PARENT_SCALE||i.updateScale();this.updatePivot(),this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0}},scale:function(t,e){e=e||t,this._scaleX=t,this._scaleY=e,this.updateScale(),this.updatePos()},set scaleX(t){this._scaleX=t,this.updateScale(),this.updatePos()},set scaleY(t){this._scaleY=t,this.updateScale(),this.updatePos()},get scaleX(){return this._scaleX},get scaleY(){return this._scaleY},set ignoreParentScale(t){this._flags|=this.Flag.IGNORE_PARENT_SCALE},get ignoreParentScale(){return this._flags&this.Flag.IGNORE_PARENT_SCALE},flip:function(t,e){void 0===t&&void 0===e?(t=-this._flipX,e=this._flipY):(t=void 0!==t?t:1,e=void 0!==e?e:1),t=0|t,e=0|e,t>1?t=1:-1>t?t=-1:0===t&&(t=1),e>1?e=1:-1>e?e=-1:0===e&&(e=1),(t!==this._flipX||e!==this._flipY)&&(this._flipX=t,this._flipY=e,this._draw=this._drawTransform,this.isInside=this._isInsideTransform,this.isNeedDraw=!0)},set flipX(t){this.flip(t,this._flipY)},set flipY(t){this.flip(this._flipX,t)},get flipX(){return this._flipX},get flipY(){return this._flipY},set visible(t){if(this.isVisible!==t&&(this.isVisible=t,this._entityCtrl.isNeedRender=!0,this.children))for(var e=this.children.length,i=0;e>i;i++)this.children[i].visible=t},get visible(){return this.isVisible},set isLoaded(t){if(this._isLoaded!==t)if(this._isLoaded=t,t){this.ready&&this.ready();var e,i;if(this.components){var s;for(i=this.components.length,e=0;i>e;e++)s=this.components[e],s.ready&&s.ready()}if(this.children)for(i=this.children.length,e=0;i>e;e++)this.children[e]._onResize(this);this._entityCtrl.cacheEntity(this)}else this._entityCtrl.uncacheEntity(this)},get isLoaded(){return this._isLoaded},set isUpdating(t){this._isUpdating!==t&&(this._isUpdating=t,t?this._entityCtrl._addToUpdating(this):this._entityCtrl._removeFromUpdating(this))},get isUpdating(){return this._isUpdating},set currFrame(t){if(this._texture){var e=t%this._texture.numFrames;if(e===this._currFrame)return;this._currFrame=e,this.isNeedDraw=!0}else this._currFrame=t},get currFrame(){return this._currFrame},set isAnimReverse(t){this._isAnimReverse=t,this.currFrame=t&&this._texture?this._texture.numFrames-1:0},get isAnimReverse(){return this._isAnimReverse},set tween(t){if(this._tweenCache||(this._tweenCache=new meta.Tween.Cache(this)),t instanceof meta.Tween.Link)this._tweenCache.tween=t.tween;else{if(!(t instanceof meta.Tween))return console.warn("[Entity.Geometry.set::tween]:","Ivalid object! Should be meta.Tween or meta.Tween.Link object."),void 0;this._tweenCache.tween=t}var e=this._tweenCache.tween;e.autoPlay&&(e.cache=this._tweenCache,e.play())},get tween(){return this._tweenCache||(this._tweenCache=new meta.Tween.Cache(this),this._tweenCache.tween=new meta.Tween),this._tweenCache.tween.cache=this._tweenCache,this._tweenCache.tween},_onResize:function(t){this.onResize&&this.onResize(t),this._flags&this.Flag.ANCHOR&&this._onResize_anchor(t)},onResize:null,_onResize_anchor:function(){this.updateAnchor()},set isCached(t){this._isCached===t},get isCached(){return this._isCached},click:function(){var t=Input.ctrl.getEvent();this._onClick(t),this.onClick(t)},set hover(t){var e=Input.ctrl.getEvent();t?0===(this._inputFlags&this.InputFlag.HOVER)?(this._inputFlags|=this.InputFlag.HOVER,this._onHoverEnter(e),this.onHoverEnter(e)):(this._onHover(e),this.onHover(e)):(this._inputFlags&=~this.InputFlag.HOVER,this._onHoverExit(e),this.onHoverExit(e))},set pressed(t){if(!!(this._inputFlags&this.InputFlag.PRESSED)!==t){var e=Input.ctrl.getEvent();t?(this._inputFlags|=this.InputFlag.PRESSED,this._onDown(e),this.onDown(e)):(this._inputFlags&=~this.InputFlag.PRESSED,this._onUp(e),this.onUp(e))}},set dragged(t){var e=Input.ctrl.getEvent();t?0===(this._inputFlags&this.InputFlag.DRAGGED)?(this._inputFlags|=this.InputFlag.DRAGGED,this._onDragStart(e),this.onDragStart(e)):(this._onDrag(e),this.onDrag(e)):(this._inputFlags&=~this.InputFlag.DRAGGED,this._onDragEnd(e),this.onDragEnd(e))},get hover(){return!!(this._inputFlags&this.InputFlag.HOVER)},get pressed(){return!!(this._inputFlags&this.InputFlag.PRESSED)},get dragged(){return!!(this._inputFlags&this.InputFlag.DRAGGED)},set ignoreZoom(t){!!(this._flags&this.Flag.IGNORE_ZOOM)!==t&&(this._flags&this.Flag.ANCHOR&&this.updateAnchor(),t?this._flags|=this.Flag.IGNORE_ZOOM:this._flags&=~this.Flag.IGNORE_ZOOM,this.isNeedDraw=!0)},get ignoreZoom(){return!!(this._flags&this.Flag.IGNORE_ZOOM)},set showBounds(t){!!(this._flags&this.Flag.SHOW_BOUNDS)!==t&&(t?(this._flags|=this.Flag.SHOW_BOUNDS,this._entityCtrl._addToDrawBounds()):(this._flags&=~this.Flag.SHOW_BOUNDS,this._entityCtrl._removeToDrawBounds()))},get showBounds(){return!!(this._flags&this.Flag.SHOW_BOUNDS)},set disableDebug(t){!!(this._flags&this.Flag.DISABLE_DEBUG)!==t&&(t?this._flags|=this.Flag.DISABLE_DEBUG:this._flags&=~this.Flag.DISABLE_DEBUG,this.isNeedDraw=!0)},get disableDebug(){return!!(this._flags&this.Flag.DISABLE_DEBUG)},set cursor(t){meta.engine.cursor=t},get cursor(){return meta.engine.cursor},Flag:{REMOVED:4,ANCHOR:128,IGNORE_ZOOM:256,IGNORE_PARENT_ANGLE:512,IGNORE_PARENT_SCALE:1024,IGNORE_PARENT_ALPHA:2048,SHOW_BOUNDS:4096,DISABLE_DEBUG:16384},InputFlag:{HOVER:1,PRESSED:2,DRAGGED:4},Core:function(){this.viewIndex=-1},meta:meta,_entityCtrl:null,_tmpX:0,_tmpY:0,id:-1,type:0,name:"unknown",_parent:null,_view:null,_depthNode:null,_checkID:-1,_updateNodeID:-1,_updateAnimNodeID:-1,_removeFlag:0,_flags:0,_inputFlags:0,chn:null,_x:0,_y:0,_z:0,totalZ:0,typeX:0,typeY:0,_anchorX:0,_anchorY:0,_anchorPosX:0,_anchorPosY:0,_dragOffsetX:0,_dragOffsetY:0,drawX:0,drawY:0,drawSrcX:0,drawSrcY:0,_offsetX:0,_offsetY:0,textureOffsetX:0,textureOffsetY:0,pivotX:0,pivotY:0,pivotRatioX:0,pivotRatioY:0,pivotSrcX:0,pivotSrcY:0,childOffsetX:0,childOffsetY:0,childPivotX:0,childPivotY:0,_cellIndex:0,_style:null,_styleState:null,_styleAction:null,_styleParams:null,_styleActionParams:null,_state:"*",_action:"",_tweenCache:null,volume:null,clipVolume:null,positionType:0,_angleRad:0,_scaleX:1,_scaleY:1,_flipX:1,_flipY:1,_alpha:1,totalAngleRad:0,totalScaleX:1,totalScaleY:1,totalAlpha:1,_texture:null,vbo:null,vertices:null,components:null,children:null,pickable:!0,clickable:!0,fps:0,animSpeed:1,_currFrame:0,isAnimating:!1,isLoop:!1,_isAnimReverse:!1,isEmulateReverse:!1,_tAnim:0,pauseAtEnd:!1,_tChange:0,isAdded:!1,_isLoaded:!1,isVisible:!0,isPaused:!1,isChild:!1,isRemoved:!1,_isUpdating:!1,_isNeedDraw:!1,isNeedStyle:!1,_isNeedOffset:!1,_cacheIndex:-1,_isHighlight:!1}),"use strict",Entity.Text=Entity.Geometry.extend({init:function(t){this.texture=new Resource.Texture,this._texture.resize(this._fontSize,this._fontSize);var e=typeof t;this.setText("string"===e||"number"===e?t:"")},_initParams:function(t){},setText:function(t){this._text=t;var e;e=this._texture.textureType===Resource.TextureType.WEBGL?this._texture._tmpCtx:this._texture.ctx,e.font=this._style+" "+this._fontSizePx+" "+this._font;var i=e.measureText(this._text),s=i.width+2*this.outlineWidth;if(this.resize(s,1.2*this._fontSize),this._texture.textureType===Resource.TextureType.WEBGL&&(this._texture._tmpImg.width=s,this._texture._tmpImg.height=1.2*this._fontSize),e.clearRect(0,0,this.volume.width,this.volume.height),e.font=this._style+" "+this._fontSizePx+" "+this._font,e.fillStyle=this._color,e.textBaseline="top",e.fillText(t,this.outlineWidth,0),this.isOutline&&(e.lineWidth=this._outlineWidth,e.strokeStyle=this._outlineColor,e.strokeText(t,this.outlineWidth,0)),this._texture.textureType===Resource.TextureType.WEBGL){var n=meta.ctx;n.bindTexture(n.TEXTURE_2D,this._texture.image),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,this._texture._tmpImg)}this._texture._isLoaded||(this._texture.isLoaded=!0),this.isNeedDraw=!0},resize:function(t,e){t=t||1,e=e||this.volume.height,this._texture.resize(t,e)},setFont:function(t){this._font=t,this.setText(this._text)},setSize:function(t){this._fontSize=t,this._fontSizePx=t+"px",this.setText(this._text)},setColor:function(t){this._color=t,this.setText(this._text)},setOutlineColor:function(t){this._outlineColor=t,this.isOutline=!0},setOutlineWidth:function(t){this._outlineWidth=t,this._isOutline&&this.setText(this._text)},setStyle:function(t){this._style=t,this.setText(this._text)},set text(t){this.setText(t)},get text(){return this._text},set font(t){this.setFont(t)},get font(){return this._font},set size(t){this.setSize(t)},get size(){return this._fontSize},set color(t){this.setColor(t)},get color(){return this._color},set outlineColor(t){this.setOutlineColor(t)},get outlineColor(){return this._outlineColor},set outlineWidth(t){this.setOutlineWidth(t)},get outlineWidth(){return this._outlineWidth},set style(t){this.setStyle(t)},get style(){return this._style},set isOutline(t){this._isOutline!==t&&(this._isOutline=t,this.setText(this._text))},get isOutline(){return this._isOutline},_text:"",_font:"Verdana",_fontSize:14,_fontSizePx:"14px",_color:"#000000",_outlineColor:"#ffffff",_outlineWidth:1,_style:"",_isOutline:!1}),"use strict",window.Input={},Input.Controller=meta.Controller.extend({init:function(){this.keys=new Array(this.numKeys),this.inputs=new Array(this.numInputs),this.touches=[],this._event={event:null,x:0,y:0,prevScreenX:0,prevScreenY:0,screenX:0,screenY:0,keyCode:0,entity:null},this.addEventListeners(),this._loadIgnoreKeys(),meta.subscribe(this,meta.Event.FOCUS,this.onFocus)},release:function(){this.removeEventListeners(),meta.unsubscribe(this,meta.Event.FOCUS,this.onFocus)},onKeyDown:function(t){if(window.top&&this._iFrameKeys[t.keyCode]&&t.preventDefault(),void 0!==this._cmdKeys[t.keyCode]&&this._numCmdKeys++,void 0!==this._ignoreKeys[t.keyCode]&&this._numCmdKeys<=0&&t.preventDefault(),!(this.blockInput||this.isStickyKeys&&this.keys[t.keyCode])){if(this.keys[t.keyCode]=!0,this._event.event=t,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.screenX=0,this._event.screenY=0,this._event.x=0,this._event.y=0,this._event.keyCode=t.keyCode,this._chnKeyDown.emit(this._event,Input.Event.KEY_DOWN),this._callbacks&&this._callbacks[t.keyCode])for(var e=this._callbacks[t.keyCode],i=e.length,s=0;i>s;s++)e[s]();if(this.keyRepeat){if(!this._inputTimer){var n=this;this._inputTimer=meta.addTimer(this,function(){n._event.keyCode=n._repeatKey,n._chnKeyDown.emit(n._event,Input.Event.KEY_DOWN)},this.keyRepeat)}this._repeatKey=t.keyCode,this._inputTimer.resume(),this._inputTimer.tAccumulator=0}}},onKeyUp:function(t){window.top&&this._iFrameKeys[t.keyCode]&&t.preventDefault(),void 0!==this._cmdKeys[t.keyCode]&&this.keys[t.keyCode]&&this._numCmdKeys--,void 0===this._ignoreKeys[t.keyCode]&&this._numCmdKeys<=0&&t.preventDefault(),this.blockInput||(this.keys[t.keyCode]=!1,this._event.event=t,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=t.keyCode,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP),this.keyRepeat&&this._inputTimer&&this._inputTimer.pause())},onMouseDown:function(t){if(!this.blockInput){this.inputs[t.button]=!0;var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x|0,h=n*i.zoomRatio-i._y|0;this._event.event=t,this._event.prevScreenX=s,this._event.prevScreenY=n,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=t.button,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN),this._event.entity=null}},onMouseUp:function(t){if(!this.blockInput){this.inputs[t.button]=!1;var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x|0,h=n*i.zoomRatio-i._y|0;this._event.event=t,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=t.button,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP),this._event.entity=null}},onMouseMove:function(t){if(t.preventDefault(),!this.blockInput){var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x|0,h=n*i.zoomRatio-i._y|0;this._event.event=t,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=-1,this.inputX=o,this.inputY=h,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE),this._event.entity=null}},onMouseDbClick:function(t){if(!this.blockInput){this.inputs[t.button]=!1;var e=meta,i=e.camera,s=(t.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,n=(t.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,o=s*i.zoomRatio-i._x|0,h=n*i.zoomRatio-i._y|0;this._event.event=t,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=s,this._event.screenY=n,this._event.x=o,this._event.y=h,this._event.keyCode=t.button,this._chnInputDbClick.emit(this._event,Input.Event.INPUT_DBCLICK),this._event.entity=null}},onTouchDown:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a=t.changedTouches,u=a.length,c=0;u>c;c++)s=t.changedTouches[c],this.touches.push(s.identifier),this.numTouches++,n=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,o=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,h=n*i.zoomRatio-i._x|0,r=o*i.zoomRatio-i._y|0,this._event.event=t,this._event.prevScreenX=n,this._event.prevScreenY=o,this._event.screenX=n,this._event.screenY=o,this._event.x=h,this._event.y=r,this._event.keyCode=this.numTouches-1,this._chnInputDown.emit(this._event,Input.Event.INPUT_DOWN),this._event.entity=null},onTouchUp:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a,u=t.changedTouches,c=u.length,l=0;c>l;l++)s=t.changedTouches[l],n=this._getTouchID(s.identifier),-1!==n&&(this.touches.splice(n,1),this.numTouches--,o=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,h=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,r=o*i.zoomRatio-i._x|0,a=h*i.zoomRatio-i._y|0,this._event.event=t,0===n?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY):(this._event.prevScreenX=o,this._event.prevScreenY=h),this._event.screenX=o,this._event.screenY=h,this._event.x=r,this._event.y=a,this._event.keyCode=n,this._chnInputDown.emit(this._event,Input.Event.INPUT_UP),this._event.entity=null)},onTouchMove:function(t){t.preventDefault();for(var e=meta,i=e.camera,s,n,o,h,r,a,u=t.changedTouches,c=u.length,l=0;c>l;l++)s=t.changedTouches[l],n=this._getTouchID(s.identifier),-1!==n&&(o=(s.pageX-e.engine.unsubscribesetLeft)*window.devicePixelRatio,h=(s.pageY-e.engine.unsubscribesetTop)*window.devicePixelRatio,r=o*i.zoomRatio-i._x|0,a=h*i.zoomRatio-i._y|0,this._event.event=t,0===n?(this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this.inputX=r,this.inputY=a):(this._event.prevScreenX=o,this._event.prevScreenY=h),this._event.screenX=o,this._event.screenY=h,this._event.x=r,this._event.y=a,this._event.keyCode=n,this._chnInputMove.emit(this._event,Input.Event.INPUT_MOVE),this._event.entity=null)},onFocus:function(t,e){e===!1&&this.resetInput()},isDown:function(t){return this.keys[t]},isInputDown:function(t){return this.inputs[t]},addEventListeners:function(){var t=this;this._chnKeyDown=meta.createChannel(Input.Event.KEY_DOWN),this._chnKeyUp=meta.createChannel(Input.Event.KEY_UP),this._chnInputDown=meta.createChannel(Input.Event.INPUT_DOWN),this._chnInputUp=meta.createChannel(Input.Event.INPUT_UP),this._chnInputMove=meta.createChannel(Input.Event.INPUT_MOVE),this._chnInputDbClick=meta.createChannel(Input.Event.INPUT_DBCLICK),this._onKeyDown=function(e){t.onKeyDown(e)},this._onKeyUp=function(e){t.onKeyUp(e)},this._onMouseDown=function(e){t.onMouseDown(e)},this._onMouseUp=function(e){t.onMouseUp(e)},this._onMouseDbClick=function(e){t.onMouseDbClick(e)},this._onMouseMove=function(e){t.onMouseMove(e)},this._onTouchDown=function(e){t.onTouchDown(e)},this._onTouchUp=function(e){t.onTouchUp(e)},this._onTouchMove=function(e){t.onTouchMove(e)},this._onTouchCancel=function(e){t.onTouchCancel(e)},window.addEventListener("mousedown",this._onMouseDown),window.addEventListener("mouseup",this._onMouseUp),window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("dblclick",this._onMouseDbClick),window.addEventListener("touchstart",this._onTouchDown),window.addEventListener("touchend",this._onTouchUp),window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchcancel",this._onTouchUp),window.addEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.addEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.addEventListener("keyup",this._onKeyUp)},removeEventListeners:function(){window.removeEventListener("mousedown",this._onMouseDown),window.removeEventListener("mouseup",this._onMouseUp),window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("dblclick",this._onMouseDbClick),window.removeEventListener("touchstart",this._onTouchDown),window.removeEventListener("touchend",this._onTouchUp),window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchcancel",this._onTouchUp),window.removeEventListener("touchleave",this._onTouchUp),meta.device.support.onkeydown&&window.removeEventListener("keydown",this._onKeyDown),meta.device.support.onkeyup&&window.removeEventListener("keyup",this._onKeyUp)},resetInput:function(){var t;for(this._event.event=null,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=0,t=0;t<this.numKeys;t++)this.keys[t]&&(this.keys[t]=!1,this._event.keyCode=t,this._chnKeyUp.emit(this._event,Input.Event.KEY_UP));for(t=0;t<this.numInputs;t++)this.inputs[t]&&(this.inputs[t]=!1,this._event.keyCode=t,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP));if(this._numCmdKeys=0,this.numTouches){for(t=0;t<this.numTouches;t++)this._event.keyCode=t,this._chnInputUp.emit(this._event,Input.Event.INPUT_UP);this.touches.length=0,this.numTouches=0}},onKey:function(t,e){this._callbacks?this._callbacks[t]?this._callbacks[t].push(e):this._callbacks[t]=[e]:(this._callbacks={},this._callbacks[t]=[e])},getEvent:function(){return this._event.event=null,this._event.prevScreenX=this._event.screenX,this._event.prevScreenY=this._event.screenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.inputX,this._event.y=this.inputY,this._event.keyCode=-1,this._event},_loadIgnoreKeys:function(){this._ignoreKeys=[],this._ignoreKeys[8]=1,this._ignoreKeys[9]=1,this._ignoreKeys[13]=1,this._ignoreKeys[17]=1,this._ignoreKeys[91]=1,this._ignoreKeys[38]=1,this._ignoreKeys[39]=1,this._ignoreKeys[40]=1,this._ignoreKeys[37]=1,this._ignoreKeys[112]=1,this._ignoreKeys[113]=1,this._ignoreKeys[114]=1,this._ignoreKeys[115]=1,this._ignoreKeys[116]=1,this._ignoreKeys[117]=1,this._ignoreKeys[118]=1,this._ignoreKeys[119]=1,this._ignoreKeys[120]=1,this._ignoreKeys[121]=1,this._ignoreKeys[122]=1,this._ignoreKeys[123]=1,this._ignoreKeys[124]=1,this._ignoreKeys[125]=1,this._ignoreKeys[126]=1,this._cmdKeys=[],this._cmdKeys[91]=1,this._cmdKeys[17]=1,this._iFrameKeys=[],this._iFrameKeys[37]=1,this._iFrameKeys[38]=1,this._iFrameKeys[39]=1,this._iFrameKeys[40]=1},_getTouchID:function(t){for(var e=0;e<this.numTouches;e++)if(this.touches[e]===t)return e;return-1},keys:null,inputs:null,touches:null,blockInput:!1,isStickyKeys:!0,keyRepeat:0,_inputTimer:null,_repeatKey:0,numKeys:256,numInputs:10,numTouches:0,inputX:0,inputY:0,_event:null,_onKeyDown:null,_onKeyUp:null,_onMouseDown:null,_onMouseUp:null,_onMouseMove:null,_onMouseDbClick:null,_onTouchDown:null,_onTouchUp:null,_onTouchMove:null,_onTouchCancel:null,_chnKeyDown:null,_chnKeyUp:null,_chnInputDown:null,_chnInputUp:null,_chnInputMove:null,_chnInputDbClick:null,_ignoreKeys:null,_cmdKeys:null,_iFrameKeys:null,_numCmdKeys:0,_callbacks:null}),"use strict",Input.Event={KEY_DOWN:"keyDown",KEY_UP:"keyUp",INPUT_DOWN:"onDown",INPUT_UP:"onUp",INPUT_MOVE:"onMove",INPUT_CLICK:"onClick",INPUT_DBCLICK:"onDbClick"},Input.Key={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,ESC:27,SPACE:32,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,DELETE:127,PLUS:187,MINUS:189,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,BUTTON_LEFT:0,BUTTON_MIDDLE:1,BUTTON_RIGHT:2},"use strict";var UI={};UI.Controller=meta.Controller.extend({init:function(){var t=new Resource.Texture;t.fillRect({color:"#111",width:120,height:30});var e=new Resource.Texture;e.fillRect({color:"#ff0000",width:120,height:30}),this.coreStyle={button:{"*:hover":{cursor:"pointer"},"*:pressed, *:drag":{cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*:hover":{cursor:"pointer"},"*:pressed, *:drag":{cursor:"pointer",offsetX:1,offsetY:1}}},this.style={button:{"*":{texture:t},"*:hover":{texture:e,cursor:"pointer"},"*:pressed":{texture:e,cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*":{texture:t},"*:hover":{texture:e,cursor:"pointer"},"*:pressed":{texture:e,cursor:"pointer",offsetX:1,offsetY:1},"[off]":{texture:t},"[on]":{texture:e}}}},coreStyle:null,style:null}),"use strict",UI.Button=Entity.Geometry.extend({_initParams:function(t){this.style=t?meta.createStyle(t,UI.ctrl.coreStyle.button):UI.ctrl.style.button},set text(t){this._text?this._text.setText(t):(this._text=new Entity.Text(t),this._text.size=12,this._text.color="#ffffff",this.attach(this._text),this._text.anchor(.5),this._text.pickable=!1)},get text(){return this._text?this._text._text:""},_text:null}),"use strict",UI.Checkbox=Entity.Geometry.extend({_initParams:function(t){this.style=t?meta.createStyle(t,UI.ctrl.coreStyle.checkbox):UI.ctrl.style.checkbox;var e=this,i=new Entity.Geometry;i.style=this._style.childStyle,i.anchor(.5),i.pickable=!1,i.onChange=function(){e._onChildChange(this)},this.attach(i),this.state="off",this._onClick=this.toggle},toggle:function(){var t=this.children[0];t.state=this.group?"on":"on"===t.state?"off":"on"},_onChange:function(){this.children[0].state=this._state,this.group&&"on"===this._state&&this.group._onStateChange(this)},_onChildChange:function(t){this.state=this.children[0]._state},set checked(t){this.state=t?"on":"off"},get checked(){return"on"===this._state},set text(t){this._text?this._text.setText(t):(this._text=new Entity.Text(t),this._text.size=12,this._text.color="#ffffff",this.attach(this._text),this._text.anchor(.5),this._text.pickable=!1)},get text(){return this._text?this._text._text:""},_text:null,group:null,value:""}),"use strict",UI.ProgressBar=Entity.Geometry.extend({init:function(){this.texture=new Resource.Texture,this.volume.resize(300,30),this.buildElement()},buildElement:function(){this.texture.fillRect({width:this.width,height:this.height,color:"white"})},updateElement:function(){},set min(t){this._min!==t&&(this._min=t,this.updateElement())},set max(t){this._max!==t&&(this._max=t,this.updateElement())},set value(t){this._value!==t&&(this._value=t,this.updateElement())},get min(){return this._min},get max(){return this._max},get value(){return this._value},_min:0,_max:100,_value:0}),"use strict",UI.Group=Entity.Geometry.extend({add:function(t){t.group&&t.detach(),this.children||(t.state="on",this._value=t.value),this.attach(t),t.group=this},_onStateChange:function(t){this.prevValue=this._value,this._value=t.value;for(var e,i=this.children.length,s=0;i>s;s++)e=this.children[s],e!==t&&(this.children[s].state="off");this.onChange(this)},set value(t){if(this.children)for(var e=this.children.length,i=0;e>i;i++)if(this.children[i].value===t){this.children[i].state="on";break}},get value(){return this._value},prevValue:"",_value:""}),"use strict",function(){meta.enableDefault&&meta.createEngine()}();